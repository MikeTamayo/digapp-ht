<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel='import' href='../../bower_components/polymer/polymer.html'>
<link rel='import' href='../dateformat.html'>

<script src='../../bower_components/d3/d3.min.js' charset='utf-8'></script>

<dom-module id='zoomable-bar-chart'>
  <template>
    <style include="web-component-styles"></style>

    <style>
      :host {
        display: block;
        --bar-chart-axis: var(--secondary-text-color);
        --bar-chart-text: var(--main-text-color);
        --bar-chart-amber: var(--amber);
        --bar-chart-black: var(--dark-primary-color);
        --bar-chart-blue: var(--blue);
        --bar-chart-cyan: var(--cyan);
        --bar-chart-deep-orange: var(--deep-orange);
        --bar-chart-deep-purple: var(--deep-purple);
        --bar-chart-green: var(--green);
        --bar-chart-grey: var(--grey);
        --bar-chart-indigo: var(--indigo);
        --bar-chart-light-blue: var(--light-blue);
        --bar-chart-light-green: var(--light-green);
        --bar-chart-lime: var(--lime);
        --bar-chart-orange: var(--orange);
        --bar-chart-pink: var(--pink);
        --bar-chart-purple: var(--purple);
        --bar-chart-red: var(--red);
        --bar-chart-teal: var(--teal);
        --bar-chart-yellow: var(--yellow);
      }

      #barChart {
        display: none;
        height: 0;
        width: 0;
      }

      #barChart[show] {
        display: block;
      }

      .axis {
        font-size: 11px;
        fill: var(--bar-chart-axis);
      }

      .axis line, .axis path {
        fill: none;
        stroke: var(--bar-chart-axis);
        shape-rendering: crispEdges;
      }

      .brush .extent {
        fill-opacity: 0.25;
        shape-rendering: crispEdges;
      }
    </style>

    <div class="loading-container">
      <template is="dom-if" if="[[loading]]">
        <paper-spinner active$="[[loading]]"></paper-spinner>
        <span class="button-height-text">Loading Bar Chart...</span>
      </template>
    </div>

    <div class="layout horizontal">
      <div id="chartContainer" class="flex auto">
        <svg id="barChart" show$="[[!loading]]"></svg>
      </div>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      /* globals _, d3, dateFormat */
      Polymer({
        is: 'zoomable-bar-chart',

        properties: {
          data: {
            type: Array,
            value: function() {
              return [];
            },
            notify: true
          },

          barChartData: {
            type: Array,
            value: function() {
              return [];
            },
            notify: true
          },

          barChartLegend: {
            type: Array,
            value: function() {
              return [];
            }
          },

          /**
           * The source of the data to use in the title for this bar chart.
           */
          source: {
            type: String,
            value: 'Data'
          },

          /**
           * The title for this bar chart.
           */
          barChartTitle: {
            type: String,
            value: 'No Data',
            computed: 'computeTitle(source, barChartData.length)',
            notify: true
          },

          /**
           * Whether the data is loading.
           */
          loading: {
            type: Boolean,
            value: false,
            notify: true
          }
        },

        observers: [
          'checkData(data)'
        ],

        checkData: function(data) {
          if(data && data.length) {
            this.processData(data);
            this.createElements();
          }
        },

        /**
         * Returns the title for this bar chart based on the source and the barChartData.
         */
        computeTitle: function(source, count) {
          if(count > 1) {
            return source + ' from ' + this.barChartData[count - 1].dateString + ' to ' + this.barChartData[0].dateString;
          }
          return count ? (source + ' at ' + this.barChartData[0].dateString) : ('No ' + source);
        },

        processData: function(data) {
          var barChartData = [];
          var barChartLegend = {};

          if(data) {
            data.forEach(function(item) {
              var yMax = 0; // keeps track of where the 'previous' value 'ended'
              var bars = [];
              item.locations.forEach(function(location) {
                if(location.count) {
                  bars.push({
                    date: item.date,
                    name: location.name || 'Other',
                    yAxisStart: yMax,
                    yAxisEnd: yMax + location.count
                  });
                  yMax += location.count;
                  barChartLegend[location.name || 'Other'] = true;
                }
              });
              bars.forEach(function(bar) {
                bar.yMax = yMax;
              });
              barChartData.push({
                bars: bars,
                dateObject: new Date(item.date),
                dateString: item.date,
                yMax: yMax
              });
            });
          }

          this.barChartData = barChartData;
          this.barChartLegend = Object.keys(barChartLegend).sort();
        },

        createElements: function() {
          // setup complete, let's get some data!
          var data = this.barChartData;

          var self = this;
          this.width = 600;
          this.height = 400;

          // Use the width of the bar chart container.
          var container = document.getElementById('chartContainer');
          if(container) {
            this.width = parseInt(container.offsetWidth, 10);
          }

          // sizing information, including margins so there is space for labels, etc
          var marginLeft = 40;
          var marginRight = 20;
          var marginTopInfo = 20;
          var marginTopMain = 35;
          var marginBottomMain = 135;
          var marginTopInstructions = 310;
          var marginTopOverview = 325;
          var marginBottomOverview = 20;

          var chartWidth = this.width - marginLeft - marginRight;
          var chartHeight = this.height - marginTopMain - marginBottomMain;
          var overviewHeight = this.height - marginTopOverview - marginBottomOverview;

          // some colors to use for the bars
          var overviewColor = this.getComputedStyleValue('--bar-chart-black');
          var otherGroupColor = this.getComputedStyleValue('--bar-chart-grey');
          var color = d3.scale.ordinal().range([
            this.getComputedStyleValue('--bar-chart-blue'),
            this.getComputedStyleValue('--bar-chart-orange'),
            this.getComputedStyleValue('--bar-chart-green'),
            this.getComputedStyleValue('--bar-chart-red'),
            this.getComputedStyleValue('--bar-chart-purple'),
            this.getComputedStyleValue('--bar-chart-yellow'),
            this.getComputedStyleValue('--bar-chart-indigo'),
            this.getComputedStyleValue('--bar-chart-cyan'),
            this.getComputedStyleValue('--bar-chart-deep-orange'),
            this.getComputedStyleValue('--bar-chart-lime'),
            this.getComputedStyleValue('--bar-chart-pink'),
            this.getComputedStyleValue('--bar-chart-deep-purple'),
            this.getComputedStyleValue('--bar-chart-amber'),
            this.getComputedStyleValue('--bar-chart-teal'),
            this.getComputedStyleValue('--bar-chart-light-green'),
            this.getComputedStyleValue('--bar-chart-light-blue'),
          ]);

          // mathematical scales for the x and y axes
          var x = d3.time.scale().range([0, chartWidth]);
          var y = d3.scale.linear().range([chartHeight, 0]);
          var xOverview = d3.time.scale().range([0, chartWidth]);
          var yOverview = d3.scale.linear().range([overviewHeight, 0]);

          // rendering for the x and y axes
          var xAxis = d3.svg.axis().scale(x).orient('bottom');
          var yAxis = d3.svg.axis().scale(y).orient('left').tickFormat(d3.format('.0f'));
          var xAxisOverview = d3.svg.axis().scale(xOverview).orient('bottom');

          var svg = d3.select(document.createElement('div')).append('svg');

          var info = svg.append('text')
            .attr('class', 'info')
            .attr('transform', 'translate(' + marginLeft + ',' + marginTopInfo + ')')
            .style('fill', this.getComputedStyleValue('--bar-chart-text'))
            .style('font-size', '14px')
            .style('font-weight', 'bold')
            .text('');

          var main = svg.append('g')
            .attr('class', 'main')
            .attr('transform', 'translate(' + marginLeft + ',' + marginTopMain + ')');

          svg.append('text')
            .attr('class', 'instructions')
            .attr('transform', 'translate(' + marginLeft + ',' + marginTopInstructions + ')')
            .style('fill', this.getComputedStyleValue('--bar-chart-text'))
            .style('font-size', '14px')
            .style('font-weight', 'bold')
            .text('Click and drag on the chart below to zoom.  Click elsewhere to reset the zoom.');

          var overview = svg.append('g')
            .attr('class', 'overview')
            .attr('transform', 'translate(' + marginLeft + ',' + marginTopOverview + ')');

          // data ranges for the x and y axes
          x.domain(d3.extent(data, function(d) { return d.dateObject; }));
          var xAxisMax = x(data[0].dateObject);
          var yAxisMax = d3.max(data, function(d) { return d.yMax; });
          y.domain([0, yAxisMax]);
          yAxis.tickValues(this.getYAxisTickValues(yAxisMax));
          xOverview.domain(x.domain());
          yOverview.domain(y.domain());

          var createExtentText = function() {
            var domain = x.domain();
            // TODO Combine with use of dateFormat in commonTransforms.getDate().
            return dateFormat(domain[0], 'mmmm dd, yyyy', true) + ' to ' + dateFormat(domain[1], 'mmmm dd, yyyy', true);
          };

          info.text(createExtentText());

          // data range for the bar colors
          // (essentially maps attribute names to color values)
          color.domain(this.barChartLegend.filter(function(key) {
            return key !== 'Other';
          }));

          // draw the axes now that they are fully set up
          main.append('g')
            .attr('class', 'x axis')
            .attr('transform', 'translate(0,' + chartHeight + ')')
            .call(xAxis);
          main.append('g')
            .attr('class', 'y axis')
            .call(yAxis);
          overview.append('g')
            .attr('class', 'x axis')
            .attr('transform', 'translate(0,' + overviewHeight + ')')
            .call(xAxisOverview);

          var grid = main.append('g').attr('class', 'grid');

          var createGridLines = function(yAxisMax) {
            grid.selectAll('line.gridline').remove();
            grid.selectAll('line.gridline')
              .data(self.getYAxisTickValues(yAxisMax))
              .enter()
              .append('line')
              .attr('class', 'gridline')
              .attr('x1', 0)
              .attr('x2', xAxisMax)
              .attr('y1', function(d) { return y(d); })
              .attr('y2', function(d) { return y(d); })
              .style('fill', 'none')
              .style('shape-rendering', 'crispEdges')
              .style('stroke', self.getComputedStyleValue('--bar-chart-axis'))
              .style('stroke-width', '1px');
          };

          createGridLines(yAxisMax);

          // draw the bars
          main.append('g')
            .attr('class', 'bars')
            // a group for each stack of bars, positioned in the correct x position
            .selectAll('.bar.stack')
            .data(data)
            .enter().append('g')
              .attr('class', 'bar stack')
              .attr('transform', function(d) { return 'translate(' + x(d.dateObject) + ',0)'; })
            // a bar for each value in the stack, positioned in the correct y positions
            .selectAll('rect')
            .data(function(d) { return d.bars; })
            .enter().append('rect')
              .attr('class', 'bar')
              .attr('width', 8)
              .attr('y', function(d) { return y(d.yAxisEnd); })
              .attr('height', function(d) { return y(d.yAxisStart) - y(d.yAxisEnd); })
              .style('fill', function(d) {
                if(d.name === 'Other' || d.name === 'other') {
                  return otherGroupColor;
                }
                return color(d.name);
              })
              .style('cursor', 'pointer')
              .on('mouseout', function() {
                info.text(createExtentText());
              })
              .on('mousemove', function(d) {
                info.text(d.date + ':  ' + d.name + ' (' + (d.yAxisEnd - d.yAxisStart) + ' of ' + d.yMax + ')');
              });

          overview.append('g')
            .attr('class', 'bars')
            .selectAll('.bar')
            .data(data)
            .enter().append('rect')
              .attr('class', 'bar')
              .attr('x', function(d) { return xOverview(d.dateObject) - 3; })
              .attr('width', 8)
              .attr('y', function(d) { return yOverview(d.yMax); })
              .attr('height', function(d) { return overviewHeight - yOverview(d.yMax); })
              .style('fill', overviewColor);

          var brush = d3.svg.brush().x(xOverview);

          var onBrushed = function() {
            // update the main chart's x axis data range
            x.domain(brush.empty() ? xOverview.domain() : brush.extent());

            info.text(createExtentText());

            // redraw the bars on the main chart
            var yAxisMax = 0;
            main.selectAll('.bar.stack')
              .attr('transform', function(d) {
                var barX = x(d.dateObject);
                // A buffer (5 pixels seems sufficient) is needed to show the bars at the start and end of the chart.
                if(barX > -5 && barX < xAxisMax + 5) {
                  yAxisMax = Math.max(yAxisMax, d.yMax);
                  return 'translate(' + barX + ',0)';
                } else {
                  return 'translate(0,0),scale(0)';
                }
              });

            y.domain([0, yAxisMax]);
            yAxis.tickValues(self.getYAxisTickValues(yAxisMax));

            // redraw the x axis of the main chart
            main.select('.x.axis').call(xAxis);
            main.select('.y.axis').call(yAxis);

            main.selectAll('.bar.stack rect')
              .attr('y', function(d) { return y(d.yAxisEnd); })
              .attr('height', function(d) { return y(d.yAxisStart) - y(d.yAxisEnd); });

            grid.selectAll('line.gridline').remove();
            createGridLines(yAxisMax);
          };

          // brush tool to let us zoom and pan using the overview chart
          brush.on('brush', onBrushed);

          // add the brush target area on the overview chart
          overview.append('g')
            .attr('class', 'x brush')
            .call(brush)
            .selectAll('rect')
            // -6 is magic number to offset positions for styling/interaction to feel right
            .attr('y', -6)
            // need to manually set the height because the brush has
            // no y scale, i.e. we should see the extent being marked
            // over the full height of the overview chart
            .attr('height', overviewHeight + 7);  // +7 is magic number for styling

          // Add chart to DOM
          //this.$.barChart.style.height = this.height;
          //this.$.barChart.style.width = this.width;
          Polymer.dom(this.$.barChart).setAttribute('style', 'height: ' + this.height + 'px; width: ' + this.width + 'px;');

          var children = Polymer.dom(this.$.barChart).children;
          // delete previous nodes if they exist
          for(var i = 0; i < children.length; i++) {
            Polymer.dom(this.$.barChart).removeChild(children[i]);
          }

          Polymer.dom(this.$.barChart).appendChild(svg.node());

          d3.select(window).on('resize', function() {
            self.resize();
          });
        },

        getYAxisTickValues: function(yAxisMax) {
          if(yAxisMax < 10) {
            return _.range(yAxisMax + 1);
          }
          // Return at most 10 tick values based on the number of digits in the maximum.
          var string = yAxisMax.toString();
          var digits = string.length;
          var step = Math.pow(10, digits - 1);
          if(string.indexOf('1') === 0) {
            step = 2 * Math.pow(10, digits - 2);
          }
          if(string.indexOf('2') === 0 || string.indexOf('3') === 0 || string.indexOf('4') === 0) {
            step = 5 * Math.pow(10, digits - 2);
          }
          // Set the end to the max plus one so the max is added to the range if evenly divisible.
          return _.range(0, yAxisMax + 1, step);
        },

        resize: function() {
          d3.select('#chartContainer').style('width', 0);
          this.createElements();
        }
      });
    })();
  </script>
</dom-module>
