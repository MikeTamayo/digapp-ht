<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../d3.html">
<link rel="import" href="../eventdrops.html">
<link rel="import" href="../../styles/chart-styles.html">
<link rel="import" href="../../bower_components/moment-element/moment-with-locales-import.html">

<dom-module id="drops-timeline">
  <style include="chart-styles"></style>
  <style>
    :host {
      display: block;
    }

    #eventDropsInfo {
      /* Match the style of the label in the zoomable-bar-chart */
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    #eventDropsTimeline {
      font-size: 12px;
      width: 100%;
      /* Must manually hide the overflow for IE. */
      overflow: hidden;
    }
  </style>

  <template>
    <div id="eventDropsInfo"></div>
    <div id="eventDropsTimeline"></div>
    <div class="layout horizontal flex center-justified">
      <button-action text="Reset Timeline" click-listener="[[_createResetListener()]]"></button-action>
    </div>
  </template>

  <script>
    (function() {
      'use strict';
      /* globals _, d3, moment */
      Polymer({
        is: 'drops-timeline',

        behaviors: [
          Polymer.IronResizableBehavior
        ],

        properties: {
          payload: {
            type: Object,
            notify: true,
            observer: '_createChart',
            value: function() {
              return {};
            }
          },

          _domain: {
            type: Array
          }
        },

        listeners: {
          // Delete the chart on resize because the chart won't shrink and the width of the chart may make the columns on the page uneven.
          'iron-resize': '_redrawChart'
        },

        _createChart: function() {
          if(!_.isEmpty(this.payload)) {
            this._drawChart();
          }
        },

        _createResetListener: function() {
          var self = this;
          return {
            onClick: function() {
              self._drawChart();
            }
          };
        },

        _redrawChart: function() {
          d3.select('#eventDropsTimeline svg').remove();
          this._createChart();
        },

        _drawChart: function() {
          var color = d3.scale.ordinal().range([
            this.getComputedStyleValue('--chart-blue'),
            this.getComputedStyleValue('--chart-orange'),
            this.getComputedStyleValue('--chart-green'),
            this.getComputedStyleValue('--chart-red'),
            this.getComputedStyleValue('--chart-purple'),
            this.getComputedStyleValue('--chart-yellow'),
            this.getComputedStyleValue('--chart-indigo'),
            this.getComputedStyleValue('--chart-cyan'),
            this.getComputedStyleValue('--chart-deep-orange'),
            this.getComputedStyleValue('--chart-lime'),
            this.getComputedStyleValue('--chart-pink'),
            this.getComputedStyleValue('--chart-deep-purple'),
            this.getComputedStyleValue('--chart-amber'),
            this.getComputedStyleValue('--chart-teal'),
            this.getComputedStyleValue('--chart-light-green'),
            this.getComputedStyleValue('--chart-light-blue')
          ]);

          var endTime = this._getEndTime();
          var startTime = this._getStartTime();

          // Use the width of the timeline container.
          var container = document.getElementById('eventDropsTimeline');
          var width = (container ? parseInt(container.offsetWidth, 10) : 600);

          var chart = d3.chart.eventDrops();
          chart.eventLineColor(function(datum, index) {
            return color(index);
          });
          chart.start(new Date(startTime));
          chart.end(new Date(endTime));
          chart.width(width);
          chart.margin({
            top: 60,
            left: 175,
            bottom: 20,
            right: 20
          });
          chart.eventHover(this._showDataItemInfo());
          chart.eventZoom(this._updateZoom());

          d3.select('#eventDropsTimeline')
            .datum(this.payload.data)
            .call(chart);

          // The library fails to set the fill making it black by default so we must set the fill to transparent ourselves.
          d3.select('.zoom').style('fill', 'transparent');
        },

        _getEndTime: function() {
          if(this.payload.timestamps.length) {
            return Math.max.apply(null, this.payload.timestamps) + (60 * 60 * 24 * 30 * 1000);
          }
          return Date.now();
        },

        _getStartTime: function() {
          if(this.payload.timestamps.length) {
            return Math.min.apply(null, this.payload.timestamps) - (60 * 60 * 24 * 30 * 1000);
          }
          return Date.now();
        },

        _showDataItemInfo: function() {
          var self = this;
          return function(data) {
            if(data) {
              var object = d3.select(data).data()[0];
              d3.select('#eventDropsInfo').html(object.count + ' in ' + object.name + ' on ' + moment.utc(new Date(object.date)).format('MMM D, YYYY'));
            } else if(self.domain) {
              self._updateZoomInfo(self.domain);
            }
          };
        },

        _updateZoom: function() {
          var self = this;
          return function(zoom) {
            self.domain = zoom.domain();
            self._updateZoomInfo(self.domain);
          };
        },

        _updateZoomInfo: function(domain) {
          d3.select('#eventDropsInfo').html('Showing ' + moment.utc(new Date(domain[0])).format('MMM D, YYYY') + ' to ' + moment.utc(new Date(domain[1])).format('MMM D, YYYY'));
        }
      });
    })();
  </script>
</dom-module>
