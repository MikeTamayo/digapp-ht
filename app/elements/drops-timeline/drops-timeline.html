<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles-classes.html">
<script src="../../bower_components/d3/d3.min.js" charset="utf-8"></script>
<script src="../../bower_components/eventDrops/index.js"></script>

<dom-module id="drops-timeline">
  <style>
    :host {
      display: block;
      font-size: 14px;
    }

    #timeline {
      width: 100%;
    }
  </style>

  <template>
    <div id="timeline"></div>
    <div class="layout horizontal flex center-justified">
      <button-action text="Reset Timeline" click-listener="[[_createResetListener()]]"></button-action>
    </div>
  </template>

  <script>
    (function() {
      'use strict';
      /* globals _, d3 */
      Polymer({
        is: 'drops-timeline',

        properties: {
          payload: {
            type: Array,
            value: function() {
              return {};
            },
            notify: true
          }
        },

        observers: [
          '_createChart(payload)'
        ],

        _createChart: function() {
          if(_.isEmpty(this.payload)) {
            return;
          }

          this._drawChart();

          var self = this;
          d3.select(window).on('resize', function() {
            self._drawChart();
          });
        },

        _createResetListener: function() {
          var self = this;
          return {
            onClick: function() {
              self._drawChart();
            }
          };
        },

        _drawChart: function() {
          var color = d3.scale.category20();
          var endTime = this._getEndTime();
          var startTime = this._getStartTime();

          var chart = d3.chart.eventDrops();
          chart.eventLineColor(function(datum, index) {
            return color(index);
          });
          chart.start(new Date(startTime));
          chart.end(new Date(endTime));
          chart.metaballs(true);

          d3.select(this.$$('#timeline'))
            .datum(this.payload.data)
            .call(chart);

          this.$$('.event-drops-chart').setAttribute('style', 'width: 100%;');
        },

        _getEndTime: function() {
          if(this.payload.timestamps.length) {
            return Math.max.apply(null, this.payload.timestamps) + (60 * 60 * 24 * 30 * 1000);
          }
          return Date.now();
        },

        _getStartTime: function() {
          if(this.payload.timestamps.length) {
            return Math.min.apply(null, this.payload.timestamps) - (60 * 60 * 24 * 30 * 1000);
          }
          return Date.now();
        }
      });
    })();
  </script>
</dom-module>
