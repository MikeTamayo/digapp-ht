<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/breadbox-item/breadbox-item.html">
<link rel="import" href="../../bower_components/button-action/button-action.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/modal-icon/modal-icon.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../lodash.html">

<script src="../../scripts/google-analytics.js"></script>

<dom-module id="user-settings">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-dialog {
        background-color: white;
        border-radius: 5px;
        margin: 50px;
        overflow: auto;
        white-space: nowrap;
      }

      #settingsDialog {
        height: 100%;
        width: 100%;
      }

      .settings {
        min-height: 700px;
        min-width: 900px;
      }

      .settings > div {
        margin: 10px;
      }

      .bold {
        color: var(--primary-text-color);
        font-size: 20px;
        font-weight: bold;
      }

      .name {
        color: var(--secondary-text-color);
        font-size: 14px;
        line-height: 20px;
        min-height: 20px;
        text-transform: uppercase;
      }

      .text {
        color: var(--primary-text-color);
        font-size: 18px;
        line-height: 24px;
        min-height: 24px;
      }

      .right-space {
        margin-right: 10px;
      }

      .tall {
        line-height: 40px;
        min-height: 40px;
      }

      .divider {
        border: 1px solid #eee;
      }

      .pointer:hover {
        cursor: pointer;
      }

      .checkbox {
        height: 20px;
        width: 20px;
        /* Align the checkbox with the text. */
        top: 1px;
      }

      .search {
        margin: 5px 5px 0;
      }

      .search-text {
        /* Align the left of the text with the left of the facets. */
        margin-left: 5px;
        /* Align the height of the text with the height of the paper-icon-button elements. */
        margin-top: 8px;
        margin-bottom: 3px;
        white-space: normal;
      }

      .facets {
        /* Align the left of the facets with the left of the search-text. */
        margin: 2px;
      }

      .search-settings {
        /* Align the left of the search-settings with the left of the search-text and the facets. */
        margin-left: 125px;
      }

      button-action {
        /* Align the height of the button with the height of the paper-input-container elements. */
        margin: 5px 10px;
      }

      modal-icon {
        align-items: inherit;
      }
    </style>

    <!-- find user if record exists -->
    <template is="dom-if" if="{{_userTypeAsArray}}">
      <elastic-client-query-builder
        type="term"
        field="username"
        values="[[username]]"
        ejs-query="{{_userQuery}}">
      </elastic-client-query-builder>

      <elastic-client-search
        client="[[client]]"
        index="[[userIndex]]"
        elastic-types="[[_userTypeAsArray]]"
        query="[[_userQuery]]"
        sort-field="dateCreated"
        sort-order="desc"
        aggregations="[]"
        filters="[]"
        results="{{_userSearchResult}}"
        last-error="{{error}}">
      </elastic-client-search>
    </template>

    <save-search
      client="[[client]]"
      username="[[username]]"
      user-id="[[_userId]]"
      existing-searches="{{_searches}}"
      search-text="[[searchText]]"
      facets="[[facets]]"
      es-request="[[esRequest]]"
      user-index="[[userIndex]]"
      user-type="[[userType]]"
      show-save-btn="[[showSaveBtn]]"
      user-record-exists="[[_userRecordExists]]">
    </save-search>

    <!-- User preferences dialog -->
    <user-preferences show-search
      preferences="{{_preferences}}"
      client="[[client]]"
      user-id="[[_userId]]"
      loading="[[loading]]"
      username="[[username]]"
      advanced-search="{{advancedSearch}}"
      blur-images="{{blurImages}}"
      search-text="{{searchText}}"
      facets="{{facets}}"
      es-request="{{esRequest}}"
      user-index="[[userIndex]]"
      user-type="[[userType]]"
      user-record-exists="[[_userRecordExists]]">
    </user-preferences>

    <!-- if no user record found, create it -->
    <elastic-create
      client="[[client]]"
      index="[[userIndex]]"
      elastic-type="[[userType]]"
      body='{{_userCreateBody}}'
      results="{{_createdUser}}"
      last-error="{{createError}}">
    </elastic-create>

  </template>

  <script>
  (function() {
    /* globals _ */
    'use strict';

    Polymer({
      is: 'user-settings',

      properties: {
        /**
         * The name of this user.
         */
        username: {
          type: String,
          notify: true,
          observer: '_usernameObserver'
        },

        /**
         * an instance of elasticsearch.Client which is connected to
         * an elasticsearch server
         */
        client: {
          type: Object
        },

        /**
         * The index where users are stored
         */
        userIndex: {
          type: String,
          notify: true
        },

        /**
         * The user type
         */
        userType: {
          type: String,
          notify: true
        },

        /**
         * Whether to show search options.
         */
        showSearch: {
          type: Boolean,
          value: false
        },

        /**
         * The text on which to search.
         */
        searchText: {
          type: String,
          notify: true
        },

        /**
         * The facets used (if any) along with searchText.
         */
        facets: {
          type: Object,
          notify: true
        },

        /**
         * Whether or not to show save search button.
         */
        showSaveBtn: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * Most recent request to elasticsearch.
         */
        esRequest: {
          type: Object,
          notify: true
        },

        _preferences: {
          type: Object,
          notify: true
        },
        /**
         * The query to use to find if user record exists already or needs to be created.
         */
        _userQuery: {
          type: Object
        },
        /**
         * Search result from elastic-client-search query if user record already exists.
         */
        _userSearchResult: {
          type: Object,
          observer: '_transformUserSearchResult'
        },
        /**
         * userType variable converted to an array for elastic-client-search
         */
        _userTypeAsArray: {
          type: Array,
          computed: '_computeTypeArray(userType)'
        },
        /**
         * Boolean variable to track if/when user record is created in elasticsearch.
         */
        _userRecordExists: {
          type: Boolean,
          value: undefined,
          notify: true
        },
        /**
         * Document info to pass into the elastic-create component
         */
        _userCreateBody: {
          type: Object,
          readOnly: true
        },
        /**
         * _id from existing user record (used to make updates)
         */
        _userId: {
          type: String
        },
        /**
         * Result from elastic-create.
         */
        _createdUser: {
          type: Object,
          notify: true,
          observer: '_getUserId'
        },

        /**
         * Boolean to track when associated elastic-client-search query has finished loading.
         */
        loading: {
          type: Boolean,
          notify: true
        }
      },
      observers: [
        '_createUserRecord(_userRecordExists, username, advancedSearch, blurImages)'
      ],

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */

      /**
       * If user record does not exist, create it.
       */
      _createUserRecord: function() {
        var self = this;

        if(this._userRecordExists === false) {
          this._set_userCreateBody({
            username: self.username,
            advancedSearch: self.advancedSearch,
            blurImages: self.blurImages,
            dateCreated: new Date(),
            notificationFrequency: 'never',
            lastRunDate: new Date(),
            notificationDate: new Date(),
            notificationHasRun: false,
          });
        }
      },

      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      /**
       * Observes and logs changes to the username.
       */
      _usernameObserver: function() {
        /* jshint ignore:start */
        ga('set', 'dimension1', window.btoa(this.username));
        ga('set', 'userId', window.btoa(this.username));
        ga('send', 'pageview');
        /* jshint ignore:end */
      },
      /**
       * Create type array for elastic-client-search.
       */
      _computeTypeArray: function(userType) {
        return [userType];
      },
      /**
       * Get _id from user record.
       */
      _getUserId: function(userRecord) {
        if(userRecord && userRecord._id) {
          this._userRecordExists = true;
          this._userId = userRecord._id;
        }
      },
      /**
       * Populate properties based on search results.
       */
      _transformUserSearchResult: function() {
        if(this._userSearchResult) {
          if(this._userSearchResult.hits.hits.length > 0) {
            /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
            this._getUserId(this._userSearchResult.hits.hits[0]);
            this.set('_preferences', this._userSearchResult.hits.hits[0]._source);
            /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */
          } else {
            this._userRecordExists = false;
          }
        }
      }
    });
  })();
  </script>
</dom-module>
