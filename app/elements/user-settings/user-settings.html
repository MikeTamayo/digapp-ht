<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/breadbox-item/breadbox-item.html">
<link rel="import" href="../../bower_components/button-action/button-action.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/modal-icon/modal-icon.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../lodash.html">

<script src="../../scripts/google-analytics.js"></script>

<dom-module id="user-settings">
  <template>
    <style>
      :host {
        display: block;
        --paper-listbox-background-color: #FFFFFF;
      }

      paper-listbox {
        padding-top: 0px;
      }

      paper-dialog {
        background-color: white;
        border-radius: 5px;
        margin: 50px;
        overflow: auto;
        white-space: nowrap;
      }

      #settingsDialog {
        height: 100%;
        width: 100%;
      }

      #saveSearchDialog {
        height: 100%;
        width: 100%;
      }

      .settings {
        min-height: 700px;
        min-width: 900px;
      }

      .settings > div {
        margin: 10px;
      }

      .bold {
        color: var(--primary-text-color);
        font-size: 20px;
        font-weight: bold;
      }

      .name {
        color: var(--secondary-text-color);
        font-size: 14px;
        line-height: 20px;
        min-height: 20px;
        text-transform: uppercase;
      }

      .text {
        color: var(--primary-text-color);
        font-size: 18px;
        line-height: 24px;
        min-height: 24px;
      }

      .right-space {
        margin-right: 10px;
      }

      .tall {
        line-height: 40px;
        min-height: 40px;
      }

      .divider {
        border: 1px solid #eee;
      }

      .pointer:hover {
        cursor: pointer;
      }

      .checkbox {
        height: 20px;
        width: 20px;
        /* Align the checkbox with the text. */
        top: 1px;
      }

      .search {
        margin: 5px 5px 0;
      }

      .search-text {
        /* Align the left of the text with the left of the facets. */
        margin-left: 5px;
        /* Align the height of the text with the height of the paper-icon-button elements. */
        margin-top: 8px;
        margin-bottom: 3px;
        white-space: normal;
      }

      .facets {
        /* Align the left of the facets with the left of the search-text. */
        margin: 2px;
      }

      .search-settings {
        /* Align the left of the search-settings with the left of the search-text and the facets. */
        margin-left: 125px;
      }

      button-action {
        /* Align the height of the button with the height of the paper-input-container elements. */
        margin: 5px 10px;
      }

      modal-icon {
        align-items: inherit;
      }
    </style>

    <!-- find user if record exists -->
    <template is="dom-if" if="{{_userTypeAsArray}}">
      <elastic-client-query-builder
        type="term"
        field="username"
        values="[[username]]"
        ejs-query="{{_userQuery}}">
      </elastic-client-query-builder>

      <elastic-client-search
        client="[[client]]"
        index="[[userIndex]]"
        elastic-types="[[_userTypeAsArray]]"
        query="[[_userQuery]]"
        sort-field="dateCreated"
        sort-order="desc"
        aggregations="[]"
        filters="[]"
        results="{{_userSearchResult}}"
        last-error="{{error}}">
      </elastic-client-search>
    </template>

    <!-- Save Search Dialog -->
    <!-- TODO: hide save button if no search exists yet or if original search text caused errors -->
    <template is="dom-if" if="{{searchText}}" restamp="true">
      <paper-icon-button icon="save" title="Save Search" on-tap="_openSaveSearchDialog"></paper-icon-button>
    </template>

    <paper-dialog id="saveSearchDialog" modal entry-animation="fade-in-animation" exit-animation="fade-out-animation">
      <div class="layout vertical flex">
        <div class="layout horizontal">
          <span class="bold tall flex">Save Search</span>
          <paper-icon-button icon="clear" dialog-confirm title="Close Save Search"></paper-icon-button>
        </div>

        <div class="divider"></div>

        <template is="dom-if" if="{{_userRecordExists}}" restamp="true">
          <div class="layout vertical flex">
            <span class="name tall">Previously Saved Searches</span>
            <paper-listbox>
              <template is="dom-repeat" items="[[_searches]]" as="search">
                <paper-item on-tap="_useExistingSearchName">{{search.name}}</paper-item>
              </template>
            </paper-listbox>
            <span class="name tall right-space">Name of New Search</span>
            <div class="layout horizontal">
              <paper-input class="flex right-space" label="Enter Name" value="{{_savedSearchName}}" no-label-float></paper-input>
              <button-action title="Save Name" text="Save" disabled="[[!_checkSavedSearchName()]]" click-listener="[[_createSavedSearchListener()]]"></button-action>
              <!-- Confirm dialog for saving over an existing search -->
              <paper-dialog id="saveAlert"  modal entry-animation="fade-in-animation" exit-animation="fade-out-animation">
                <div class="layout horizontal">
                  <span class="bold tall flex">Are you sure you want to save over existing saved search "[[_savedSearchName]]"?</span>
                </div>
                <div class="buttons">
                  <paper-button dialog-confirm on-tap="_confirmSaveSearch">OK</paper-button>
                  <paper-button dialog-dismiss>Cancel</paper-button>
                </div>
              </paper-dialog>
            </div>
          </div>
        </template>
      </div>
    </paper-dialog>

    <!-- User preferences dialog -->
    <paper-icon-button id="settingsButton" icon="settings" title="Open User Settings" on-tap="_openSettingsDialog"></paper-icon-button>

    <paper-dialog id="settingsDialog" modal entry-animation="fade-in-animation" exit-animation="fade-out-animation">
      <div class="settings">
        <div class="layout horizontal">
          <span class="bold tall flex">User Settings</span>
          <paper-icon-button icon="clear" dialog-confirm title="Close User Settings"></paper-icon-button>
        </div>

        <div class="divider"></div>

        <template is="dom-if" if="{{_userRecordExists}}" restamp="true">
          <div class="layout horizontal">
            <div class="start-justified flex">
              <span class="name right-space">Logged in as:</span>
              <span class="text">[[username]]</span>
            </div>
            <div class="end-justified">
              <span class="name right-space">DIG Version:</span>
              <span class="text">DIG_VERSION</span>
            </div>
          </div>

          <div class="layout horizontal">
            <span class="name tall right-space">Email Address for Notifications:</span>
            <paper-input class="right-space" label="Enter Email Address" value="{{_emailAddress}}" no-label-float></paper-input>
            <button-action title="Save Email Address" text="Save" disabled="[[!_emailAddress]]" click-listener="[[_createSaveEmailAddressListener()]]"></button-action>
          </div>

          <div class="divider"></div>

          <template is="dom-if" if="[[showSearch]]">
            <div class="layout horizontal pointer" title="Toggle Advanced Search" on-tap="_toggleAdvancedSearch">
              <iron-icon class="checkbox right-space" icon$="[[_getCheckboxIconToShow(advancedSearch)]]"></iron-icon>
              <span class="text">Advanced Search</span>
            </div>
          </template>

          <div class="layout horizontal pointer" title="Toggle Blur Images" on-tap="_toggleBlur">
            <iron-icon class="checkbox right-space" icon$="[[_getCheckboxIconToShow(blurImages)]]"></iron-icon>
            <span class="text">Blur Images</span>
          </div>

          <div class="divider"></div>

          <div class="layout vertical">
            <div class="name">Saved Searches</div>
            <template is="dom-repeat" items="[[_searches]]" as="search">
              <div class="layout vertical search">
                <div class="layout horizontal">
                  <modal-icon openable open="[[!_isFalse(search.open)]]" ripple title="[[_getModalIconTitle(search.open)]]" on-tap="_toggleSearchSettings"></modal-icon>
                  <paper-icon-button icon="search" title="Run Saved Search" on-tap="_runSearch" disabled="[[!showSearch]]"></paper-icon-button>
                  <paper-icon-button icon="delete" title="Delete Saved Search" on-tap="_deleteSearch"></paper-icon-button>
                  <div class="layout vertical flex">
                    <div class="text search-text">[[search.name]]</div>
                    <div class="name search-text">Search Text</div>
                    <div class="text search-text">[[search.digUIState.searchText]]</div>
                    <template is="dom-if" if="[[search.digUIState.facets]]">
                      <div class="name search-text">Facets</div>
                      <div class="layout horizontal wrap facets">
                        <template is="dom-repeat" items="[[_getFacetGroups(search.digUIState.facets)]]" as="facetGroupName">
                          <template is="dom-repeat" items="[[_getFacetGroupKeys(search.digUIState.facets, facetGroupName)]]" as="key">
                            <breadbox-item
                              text="[[_getFacetProperty(search.digUIState.facets, facetGroupName, key, 'category')]]: [[_getFacetProperty(search.digUIState.facets, facetGroupName, key, 'text')]]"
                              title$="[[_getFacetProperty(search.digUIState.facets, facetGroupName, key, 'category')]]: [[_getFacetProperty(search.digUIState.facets, facetGroupName, key, 'text')]]">
                            </breadbox-item>
                          </template>
                        </template>
                      </div>
                    </template>
                  </div>
                </div>
                <iron-collapse opened="[[search.open]]">
                  <div class="layout horizontal search-settings">
                    <div class="layout vertical right-space">
                      <div class="name tall right-space">Created By</div>
                      <div class="name tall right-space">Created At</div>
                    </div>
                    <div class="layout vertical right-space">
                      <div class="text tall right-space">[[search.createdBy]]</div>
                      <div class="text tall right-space">[[search.createdAt]]</div>
                    </div>
                    <div class="layout vertical right-space">
                      <div class="name tall right-space">Send Saved Search to User</div>
                      <div class="name tall right-space">Automatically Run Query</div>
                    </div>
                    <div class="layout vertical right-space">
                      <paper-input label="Enter Username" value="{{search.sendTo}}" no-label-float></paper-input>
                      <paper-dropdown-menu disabled="[[_noEmailAddress]]" label="Interval" no-label-float on-iron-select="_updateNotification">
                        <paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{search.frequency}}">
                          <paper-item value="never">Never</paper-item>
                          <paper-item value="hourly">Every Hour</paper-item>
                          <paper-item value="daily">Every Day</paper-item>
                          <paper-item value="weekly">Every Week</paper-item>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </div>
                    <div class="layout vertical">
                      <button-action title="Send this Search to User" text="Send" disabled="[[!search.sendTo]]" click-listener="[[_createSendSearchListener(index)]]"></button-action>
                      <template is="dom-if" if="[[_noEmailAddress]]">
                        <paper-icon-button icon="error" title="Please enter your email address above before setting a notification interval." noink></paper-icon-button>
                      </template>
                    </div>
                  </div>
                </iron-collapse>
              </div>
            </template>
          </div>
        </template>
        <template is="dom-if" if="{{!_userRecordExists}}" restamp="true">
          Creating user record...
        </template>
      </div>
    </paper-dialog>
    <!-- if no user record found, create it -->
    <elastic-create
      client="[[client]]"
      index="[[userIndex]]"
      elastic-type="[[userType]]"
      body='{{_userCreateBody}}'
      results="{{_createdUser}}"
      last-error="{{createError}}">
    </elastic-create>
    <!--Updates to user record initiated by user preferences dialog-->
    <elastic-update
      client="[[client]]"
      index="[[userIndex]]"
      elastic-type="[[userType]]"
      id="{{_userId}}"
      body='{{_userUpdateBody}}'
      results="{{_updatedUser}}"
      last-error="{{updateError}}">
    </elastic-update>
  </template>

  <script>
  (function() {
    'use strict';
    /* globals _ */

    Polymer({
      is: 'user-settings',

      properties: {
        /**
         * The name of this user.
         */
        username: {
          type: String,
          notify: true,
          observer: '_usernameObserver'
        },

        /**
         * an instance of elasticsearch.Client which is connected to
         * an elasticsearch server
         */
        client: {
          type: Object
        },

        /**
         * The index where users are stored
         */
        userIndex: {
          type: String,
          notify: true
        },

        /**
         * The user type
         */
        userType: {
          type: String,
          notify: true
        },

        /**
         * Whether to show search options.
         */
        showSearch: {
          type: Boolean,
          value: false
        },

        /**
         * Whether advanced search is enabled.
         */
        advancedSearch: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * Whether image blurring is enabled.
         */
        blurImages: {
          type: Boolean,
          value: true,
          notify: true
        },

        /**
         * The text on which to search.
         */
        searchText: {
          type: String,
          notify: true
        },

        /**
         * The facets used (if any) along with searchText.
         */
        facets: {
          type: Object,
          notify: true
        },

        /**
         * The email address of this user.
         */
        _emailAddress: {
          type: String
        },

        /**
         * Whether this user has entered an email address.
         */
        _noEmailAddress: {
          type: Boolean,
          value: true
        },

        /**
         * The saved searches for this user.
         */
        _searches: {
          type: Array,
          value: function() {
            return [];
          }
        },
        /**
         * The query to use to find if user record exists already or needs to be created.
         */
        _userQuery: {
          type: Object
        },
        /**
         * Search result from elastic-client-search query if user record already exists.
         */
        _userSearchResult: {
          type: Object,
          observer: '_transformUserSearchResult'
        },
        /**
         * userType variable converted to an array for elastic-client-search
         */
        _userTypeAsArray: {
          type: Array,
          computed: '_computeTypeArray(userType)'
        },
        /**
         * Boolean variable to track if/when user record is created in elasticsearch.
         */
        _userRecordExists: {
          type: Boolean,
          value: undefined,
          notify: true
        },
        /**
         * Document info to pass into the elastic-create component
         */
        _userCreateBody: {
          type: Object,
          readOnly: true
        },
        /**
         * Document info to pass into the elastic-update component
         */
        _userUpdateBody: {
          type: Object,
          readOnly: true
        },
        /**
         * _id from existing user record (used to make updates)
         */
        _userId: {
          type: Object
        },
        /**
         * Result from elastic-create.
         */
        _createdUser: {
          type: Object,
          notify: true,
          observer: '_getUserId'
        },
        /**
         * Result from elastic-update.
         */
        _updatedUser: {
          type: Object,
          notify: true
        },
        /**
         * Name chosen by user to save a new search.
         */
        _savedSearchName: {
          type: String
        },
        /**
         * Index to replace in _searches if saving over existing search.
         */
        _saveOverIndex: {
          type: Number
        }
      },
      observers: [
        '_createUserRecord(_userRecordExists, username, advancedSearch, blurImages)'
      ],

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */

      /**
       * Creates and returns a listener to save the user's email address.
       */
      _createSaveEmailAddressListener: function() {
        var self = this;
        return {
          onClick: function() {
            if(self._emailAddress) {
              console.log('Save ' + self._emailAddress);
              self.set('_noEmailAddress', false);

              self._set_userUpdateBody({
                doc: {
                  emailAddress: self._emailAddress
                }
              });
            }
          }
        };
      },

      /**
       * Toggles the user's advanced search setting.
       */
      _toggleAdvancedSearch: function() {
        var self = this;
        this.advancedSearch = !this.advancedSearch;

        self._set_userUpdateBody({
          doc: {
            advancedSearch: self.advancedSearch
          }
        });
      },

      /**
       * Toggles the user's blur setting.
       */
      _toggleBlur: function() {
        var self = this;
        this.blurImages = !this.blurImages;

        self._set_userUpdateBody({
          doc: {
            blurImages: self.blurImages
          }
        });
      },

      /**
       * If user record does not exist, create it.
       */
      _createUserRecord: function() {
        var self = this;

        if(this._userRecordExists === false) {
          this._set_userCreateBody({
            username: self.username,
            advancedSearch: self.advancedSearch,
            blurImages: self.blurImages,
            dateCreated: new Date()
          });
        }
      },

      /**
       * Creates and returns a listener to save a user's query.
       */
      _createSavedSearchListener: function() {
        var self = this;
        return {
          onClick: function() {
            if(self._checkSavedSearchName()) {
              var indexToReplace = _.findIndex(self._searches, {name: self._savedSearchName});

              if(indexToReplace !== -1) {
                self._saveOverIndex = indexToReplace;
                self.$$('#saveAlert').open();
              } else {
                self._addNewSearch();
                self._saveSearches();
              }
            }
          }
        };
      },

      /**
       * Add new search to _searches array.
       */
      _addNewSearch: function() {
        var queryToAdd = this._createSearchRecord();

        if(!this._searches) {
          this._searches = [];
        }
        this.push('_searches', queryToAdd);
      },

      /**
       * Save over an existing record in _searches.
       */
      _confirmSaveSearch: function() {
        this.splice('_searches', this._saveOverIndex, 1, this._createSearchRecord());
        this._saveSearches();
      },

      /**
       * Returns a new search record.
       */
      _createSearchRecord: function() {
        return {
          name: this._savedSearchName,
          digUIState: {
            searchText: this.searchText,
            facets: this.facets
          },
          esState: '',
          frequency: 'never',
          lastRunDate: new Date(),
          notificationDate: new Date(),
          notificationHasRun: false,
          createdBy: this.username,
          createdAt: new Date()
        };
      },

      /**
       * Update savedQueries in elasticsearch.
       */
      _saveSearches: function() {
        var self = this;
        self._set_userUpdateBody({
          doc: {
            savedQueries: self._searches
          }
        });
        self.$$('#saveSearchDialog').close();
      },

      /**
       * Make sure user has entered a valid name for a search record.
       */
      _checkSavedSearchName: function() {
        return !_.isEmpty(_.trim(this._savedSearchName));
      },

      /**
       * Deletes the given saved search.
       */
      _deleteSearch: function(event) {
        var self = this;
        console.log('Delete ' + event.model.search + ' index ' + event.model.index);
        self.splice('_searches', event.model.index, 1);
        self._set_userUpdateBody({
          doc: {
            savedQueries: self._searches
          }
        });
      },

      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      /**
       * Creates and returns a listener to send the given saved search to another user.
       */
      _createSendSearchListener: function(index) {
        var self = this;
        return {
          onClick: function() {
            console.log('Send ' + self._searches[index].text + ' to ' + self._searches[index].sendTo);
            self.set('_searches.' + index + '.sendTo', '');
            // TODO Save the search in the other user's data.
          }
        };
      },

      /**
       * Returns the checkbox icon for the given setting.
       */
      _getCheckboxIconToShow: function(setting) {
        return setting ? 'check-box' : 'check-box-outline-blank';
      },

      /**
       * Returns the title of the modal-icon for the given open setting.
       */
      _getModalIconTitle: function(open) {
        return (open ? 'Close' : 'Open') + ' Search Settings';
      },

      /**
       * Returns whether the given value is false.
       */
      _isFalse: function(value) {
        return !value;
      },

      /**
       * Opens the settings dialog.
       */
      _openSettingsDialog: function() {
        this.$$('#settingsDialog').open();
      },

      /**
       * Opens the save search dialog and reset variables.
       */
      _openSaveSearchDialog: function() {
        if(this._savedSearchName) {
          this._savedSearchName = undefined;
        }
        this.$$('#saveSearchDialog').open();
      },

      /**
       * Save selected search name from list as _savedSearchName.
       */
      _useExistingSearchName: function(event) {
        this._savedSearchName = event.model.search.name;
      },

      /**
       * Populates the properties in this user-settings component using the given settings object.
       */
      _populateUserSettings: function(settings) {
        //var self = this;

        if(settings.advancedSearch !== undefined) {
          this.set('advancedSearch', settings.advancedSearch);
        }

        if(settings.blurImages !== undefined) {
          this.set('blurImages', settings.blurImages);
        }

        if(settings.emailAddress) {
          this.set('_emailAddress', settings.emailAddress);
          this.set('_noEmailAddress', false);
        }

        if(settings.savedQueries) {
          /*var searches = _.reduce(settings.searches, function(searches, search) {
            if(search.text) {
              searches.push({
                date: search.date || 'Unknown',
                facets: (search.facets || []).map(function(facet) {
                  return facet.key + ': ' + facet.value;
                }),
                interval: search.interval || 'off',
                open: false,
                sendTo: '',
                text: search.text,
                user: search.user || 'Unknown'
              });
            }
            return searches;
          }, []);*/
          this.set('_searches', settings.savedQueries);
        }
      },

      /**
       * Runs the given saved search.
       */
      _runSearch: function(event) {
        this.$$('#settingsDialog').close();
        this.set('searchText', event.model.search.digUIState.searchText);
        this.set('facets', event.model.search.digUIState.facets);
        // TODO Save the query in elasticsearch format
      },

      /**
       * Toggles the open setting of the given saved search.
       */
      _toggleSearchSettings: function(event) {
        this.set('_searches.' + event.model.index + '.open', !event.model.search.open);
      },

      /**
       * Updates the notification setting of the given saved search.
       */
      _updateNotification: function(event) {
        console.log('Notify ' + event.model.search.text + ' index ' + event.model.index + ' interval ' + event.model.search.interval);
        // TODO Update the notification interval for the search in the user's data.
      },

      /**
       * Observes and logs changes to the username.
       */
      _usernameObserver: function() {
        /* jshint ignore:start */
        ga('set', 'dimension1', window.btoa(this.username));
        ga('set', 'userId', window.btoa(this.username));
        ga('send', 'pageview');
        /* jshint ignore:end */
      },
      /**
       * Create type array for elastic-client-search.
       */
      _computeTypeArray: function(userType) {
        return [userType];
      },
      /**
       * Get _id from user record.
       */
      _getUserId: function(userRecord) {
        if(userRecord && userRecord._id) {
          this._userRecordExists = true;
          this._userId = userRecord._id;
        }
      },
      /**
       * Populate properties based on search results.
       */
      _transformUserSearchResult: function() {
        if(this._userSearchResult) {
          if(this._userSearchResult.hits.hits.length > 0) {
            /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
            this._getUserId(this._userSearchResult.hits.hits[0]);
            this._populateUserSettings(this._userSearchResult.hits.hits[0]._source);
            /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */
          } else {
            this._userRecordExists = false;
          }
        }
      },
      /**
       * Get all the facet selection groups.
       */
      _getFacetGroups: function(facets) {
        return _.keys(facets);
      },
      /**
       * Get the selected facets from the facet group.
       */
      _getFacetGroupKeys: function(facets, facetGroupName) {
        return _.keys(facets[facetGroupName]);
      },
      /**
       * Get the property of a selected facet.
       */
      _getFacetProperty: function(facets, facetGroupName, key, prop) {
        return facets[facetGroupName][key][prop];
      }
    });
  })();
  </script>
</dom-module>
