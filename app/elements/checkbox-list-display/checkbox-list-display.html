<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="checkbox-list-display">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <template is="dom-repeat" items="{{facets}}" as="facet">
      <template is="dom-if" if="{{computeShowResult(show, index)}}">
        <paper-checkbox name="[[facet.key]]" checked="{{facet.enabled}}" on-tap="updateFacetSelection" class="layout horizontal">
          [[getFacetContent(facet)]]
        </paper-checkbox>
      </template>
    </template>
  </template>
  <script>
  (function() {
    'use strict';
    /* globals _ */

    Polymer({
      is: 'checkbox-list-display',

      properties: {
        /**
         * the list of buckets from an elastic search
         * aggregation result
        */
        buckets: {
          type: Array
        },

        /**
         * Computed list of facet buckets used for displaying
         * checkboxes
        */
        facets: {
          type: Array,
          value: function() {
            return [];
          },
          computed: 'extractFacets(buckets.*)',
          notify: true
        },

        /**
         * Contains state of facet checkboxes to persist
         * selection state between queries.
        */
        facetSelection: {
          type: Object,
          value: function() {
            return {};
          },
          notify: true
        },

        /**
         * If aggregation has many buckets, show only the first few (defaults to 10).
         */
        show: {
          type: Number,
          value: 10
        },
        /**
         * Identifier for checkbox filter set
         */
        category: {
          type: String
        }
      },

      updateFacetSelection: function(event) {
        var facet = event.model.facet;

        this.facetSelection[facet.key] = {
          text: facet.text,
          key: facet.key,
          count: facet.count,
          enabled: facet.enabled,
          category: this.category
        };

        this.notifyPath('facetSelection.*', {
          text: facet.text,
          key: facet.key,
          count: facet.count,
          enabled: facet.enabled,
          category: this.category
        });
      },

      /**
       * Compute whether to show a facet based on its index and whether
       * or not its under the limit specified by the show property.
       */
      computeShowResult: function(show, index) {
        if(show === 0) {
          return true;
        }
        return index < show;
      },

      /**
       * Builds the state of the facet checkboxes based on the inputted
       * buckets list and the saved state of selections
      */
      extractFacets: function(buckets) {
        var me = this;
        var facets = {};
        var facetsList = [];
        /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
        _.each(buckets.value, function(bucket) {
          facets[bucket.key] = {
            text: (bucket.text) ? bucket.text : bucket.key,
            key: bucket.key,
            count: bucket.doc_count,
            enabled: (me.facetSelection[bucket.key] ? me.facetSelection[bucket.key].enabled : false)
          };

          facetsList.push(facets[bucket.key]);

          if(me.show !== 0 && facetsList.length === me.show) {
            return false;
          }
        });
        /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

        return facetsList;
      },

      /**
       * Returns the content for the checkbox containing the given facet.
       */
      getFacetContent: function(facet) {
        return facet.text + (facet.count ? ' (' + facet.count + ')' : '');
      }
    });
  })();
  </script>
</dom-module>


