<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel='import' href='../mustache.html'>

<script>
(function() {
  'use strict';
  Polymer({
    is: 'query-builder',

    properties: {
      /**
       * The elastic search query which this element builds
       */
      query: {
        type: Object,
        notify: true,
        readOnly: true
      },

      /**
       * The query template object passed in from the config.
       */
      queryTemplate: {
        type: Object,
        notify: true
      },

      /**
       * Application scope javascript object which contains query templates
       * and other configuration data
       */ 
      appConfig: {
        type: Object
      },

      /**
       * The elasticsearch field on which to perform query
       */
      field: {
        type: String,
        notify: true

      }, 

      /**
       * The value of the elasticsearch field
       */
      value: {
        type: Object,
        notify: true
      }
    },
    observers: [
      'waitForQueryTemplate(queryTemplate, field, value)'
    ],

    /**
     * Get query string parameters and then build the query based on the queryTemplate
     */
    waitForQueryTemplate: function() {
      this.buildElasticQuery();
    },

    /**
     * Build a query from query string parameters and a query template
     */
    buildElasticQuery: function() {
      /* globals Mustache */
      var view = {
        field: this.field,
        value: encodeURIComponent(this.value)
      };
      
      var query = JSON.parse(decodeURIComponent(Mustache.render(JSON.stringify(this.queryTemplate), view)));
      this._setQuery(query);
    }

  });
})();
</script>
