<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/button-action/button-action.html">
<link rel="import" href="../../bower_components/double-bar-chart/double-bar-chart.html">
<link rel="import" href="../../bower_components/horizontal-bar-chart/horizontal-bar-chart.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/loading-spinner/loading-spinner.html">
<link rel="import" href="../../styles/icon-styles.html">
<link rel="import" href="../lodash.html">

<dom-module id="feature-aggregation">
  <template>
    <style include="icon-styles"></style>
    <style include="iron-flex iron-flex-alignment iron-flex-factors"></style>

    <style>
      :host {
        display: block;
      }

      .add-margins {
        margin: 0 5px;
      }

      .data {
        /* Max Height = Height of 20 Items */
        max-height: 480px;
        /* Must add bottom padding otherwise the scrollbar will be displayed due to the paper-checkbox ripple element. */
        padding-bottom: 15px;
      }

      .overflow {
        overflow: auto;
      }

      .scroll-margin {
        /* Add right margin to the header equal to the width of a scrollbar. */
        margin-right: 15px;
      }

      .show-more {
        text-align: center;
      }

      .large {
        /* Max Height = Height of 20 Items with Images */
        max-height: 1200px;
      }

      .small {
        /* Max Height = Height of 10 Items + Height of Show More Button */
        max-height: 270px;
      }

      .text {
        color: var(--primary-text-color);
        font-size: 14px;
        line-height: 20px;
      }

      .header .text {
        color: var(--secondary-text-color);
        margin: 0 5px;
        text-transform: uppercase;
      }

      iron-image {
        margin: 5px;
        background-color: transparent;
      }
    </style>

    <template is="dom-if" if="[[_showHeader(itemType, countType, showOtherCounts)]]">
      <div class$="layout horizontal header [[_doesOverflow(_shownItems.length, small, 'scroll-margin')]]">
        <template is="dom-if" if="[[!showOtherCounts]]">
          <div class="text flex">[[itemType]]</div>
          <template is="dom-if" if="[[_showCountsHeaderText(_combinedItems.length, loading)]]">
            <div class="text">[[countType]]</div>
          </template>
        </template>

        <template is="dom-if" if="[[showOtherCounts]]">
          <div class="layout horizontal flex-8 text">
            <div class="flex">[[itemType]]</div>
            <template is="dom-if" if="[[_showCountsHeaderText(_combinedItems.length, loading)]]">
              <div class="end-justified">[[_getCountHeader(countType, entityName)]]</div>
            </template>
          </div>

          <div class="layout horizontal end-justified flex-4 text">
            <template is="dom-if" if="[[_showCountsHeaderText(_combinedItems.length, loading)]]">
              <div>[[_getOtherCountHeader(countType)]]</div>
            </template>
          </div>
        </template>
      </div>
    </template>

    <template is="dom-if" if="[[_showNoDataText(hideNoDataText, _combinedItems.length, loading)]]">
      <div class="add-margins text">None</div>
    </template>

    <template is="dom-if" if="[[_shownItems.length]]">
      <div class$="data [[_doesOverflow(_shownItems.length, small, 'overflow')]] [[_isSmallOrLarge(small)]]">
        <template is="dom-if" if="[[!showOtherCounts]]">
          <horizontal-bar-chart
            show-checkboxes="[[showCheckboxes]]"
            checkbox-name="[[checkboxName]]"
            count-property="[[countProperty]]"
            icon-property="[[iconProperty]]"
            id-property="[[idProperty]]"
            link-property="[[linkProperty]]"
            max-property="[[maxProperty]]"
            style-class-property="[[styleClassProperty]]"
            text-property="[[textProperty]]"
            data="[[_shownItems]]"
            selected-ids="{{selectedIds}}">
          </horizontal-bar-chart>
        </template>

        <template is="dom-if" if="[[showOtherCounts]]">
          <double-bar-chart
            client="[[client]]"
            index-name="[[indexName]]"
            index-types="[[indexTypes]]"
            query-field="[[queryField]]"
            show-checkboxes="[[showCheckboxes]]"
            checkbox-name="[[checkboxName]]"
            count-property="[[countProperty]]"
            icon-property="[[iconProperty]]"
            id-property="[[idProperty]]"
            link-property="[[linkProperty]]"
            max-property="[[maxProperty]]"
            style-class-property="[[styleClassProperty]]"
            text-property="[[textProperty]]"
            data="[[_shownItems]]"
            max-other-count="{{_maxOtherCount}}"
            selected-ids="{{selectedIds}}">
          </double-bar-chart>

          <!--
          <template is="dom-if" if="[[showImages]]">
            <template is="dom-if" if="[[_getProperty(item, linkProperty)]]">
              <a href$="[[_getProperty(item, linkProperty)]]" title="Open Image">
                <iron-image class$="[[_getBlurStyleClass(blur)]]" style="width:50px; height:50px;" sizing="contain" src$="[[_getProperty(item, sourceProperty)]]"></iron-image>
              </a>
            </template>
            <template is="dom-if" if="[[!_getProperty(item, linkProperty)]]">
              <iron-image class$="[[_getBlurStyleClass(blur)]]" style="width:50px; height:50px;" sizing="contain" src$="[[_getProperty(item, sourceProperty)]]"></iron-image>
            </template>
          </template>
          -->
        </template>
      </div>
    </template>

    <loading-spinner show="[[loading]]"></loading-spinner>

    <template is="dom-if" if="[[_showMore]]">
      <div class="show-more">
        <button-action text="Show More" click-listener="[[_createShowMoreListener()]]"></button-action>
      </div>
    </template>
  </template>

  <script>
  (function() {
    'use strict';

    /* globals _ */
    Polymer({
      is: 'feature-aggregation',

      properties: {
        /**
         * (Optional)
         *
         * The count property in the data.
         *
         * @type {String}
         * @default 'count'
         */
        countProperty: {
          type: String,
          value: 'count'
        },

        /**
         * (Optional)
         *
         * The icon property in the each item.
         *
         * @type {String}
         * @default 'icon'
         */
        iconProperty: {
          type: String,
          value: 'icon'
        },

        /**
         * (Optional)
         *
         * The ID property in each item (used to set the selected IDs).
         *
         * @type {String}
         * @default 'id'
         */
        idProperty: {
          type: String,
          value: 'id'
        },

        /**
         * (Optional)
         *
         * The link property in the each item.
         *
         * @type {String}
         * @default 'link'
         */
        linkProperty: {
          type: String,
          value: 'link'
        },

        /**
         * (Optional)
         *
         * The max property in the each item.
         *
         * @type {String}
         * @default 'max'
         */
        maxProperty: {
          type: String,
          value: 'max'
        },

        /**
         * (Optional)
         *
         * The source property in the each item.
         *
         * @type {String}
         * @default 'source'
         */
        sourceProperty: {
          type: String,
          value: 'source'
        },

        /**
         * (Optional)
         *
         * The style class property in the each item.
         *
         * @type {String}
         * @default 'styleClass'
         */
        styleClassProperty: {
          type: String,
          value: 'styleClass'
        },

        /**
         * (Optional)
         *
         * The text property in the each item.
         *
         * @type {String}
         * @default 'text'
         */
        textProperty: {
          type: String,
          value: 'text'
        },

        /**
         * (Required)
         *
         * The list of items.
         *
         * @type {Array}
         */
        items: {
          type: Array
        },

        /**
         * (Optional)
         *
         * The limit on the initial number of items to show in this component (or 0 to show all items).
         *
         * @type {Number}
         * @default 10
         */
        limit: {
          type: Number,
          value: 10
        },

        /**
         * (Optional)
         *
         * The type for the items to show in the header.
         *
         * @type {String}
         * @default ''
         */
        itemType: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The type for the counts to show in the header.
         *
         * @type {String}
         * @default ''
         */
        countType: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The name for the entity to show in the header.
         *
         * @type {String}
         * @default ''
         */
        entityName: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * Whether or not to display images next to each horizontal-bar.
         *
         * @type {Boolean}
         * @default false
         */
        showImages: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * Whether to blur the images.
         *
         * @type {Boolean}
         * @default false
         */
        blur: {
          notify: true,
          type: Boolean,
          value: true
        },

        /**
         * (Optional)
         *
         * Whether or not to display a checkbox in each horizontal-bar.
         *
         * @type {Boolean}
         * @default false
         */
        showCheckboxes: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * The name of the checkboxes.
         *
         * @type {String}
         * @default 'Filter'
         */
        checkboxName: {
          type: String,
          value: 'Filter'
        },

        /**
         * (Optional)
         *
         * Whether to show a second horizontal bar with counts of other results not included in the item counts.  Runs an elasticsearch query for each item.
         * Requires the properties:  client, indexName, indexTypes, queryField
         *
         * @type {Boolean}
         * @default false
         */
        showOtherCounts: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * The elasticsearch client.  Required if showOtherCounts is true.
         *
         * @type {Object}
         */
        client: {
          type: Object
        },

        /**
         * (Optional)
         *
         * The elasticsearch index name.  Required if showOtherCounts is true.
         *
         * @type {String}
         */
        indexName: {
          type: String
        },

        /**
         * (Optional)
         *
         * The list of elasticsearch index type strings.  Required if showOtherCounts is true.
         *
         * @type {Array}
         */
        indexTypes: {
          type: Array
        },

        /**
         * (Optional)
         *
         * The elasticsearch query field.  Required if showOtherCounts is true.
         *
         * @type {String}
         */
        queryField: {
          type: String
        },

        /**
         * (Optional)
         *
         * Whether the items for this component are loading.
         *
         * @type {Boolean}
         * @default false
         */
        loading: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * (Optional)
         *
         * Whether to hide the 'no data' text.
         *
         * @type {Boolean}
         * @default false
         */
        hideNoDataText: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * Whether to hide the 'show more' button.
         *
         * @type {Boolean}
         * @default false
         */
        hideShowMore: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * Whether this component should be shown as its smaller version.
         *
         * @type {Boolean}
         * @default false
         */
        small: {
          type: Boolean,
          value: false
        },

        /**
         * (Output)
         *
         * The selected string IDs on which to filter.
         *
         * @type {Array}
         * @default []
         */
        selectedIds: {
          notify: true,
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * The combined list of selected items and input items for this component.
         *
         * @type {Array}
         * @private
         */
        _combinedItems: {
          type: Array,
          notify: true,
          computed: '_computeCombinedItems(items.length)',
          observer: '_updateShownItems'
        },

        /**
         * The shown items for this component.
         *
         * @type {Array}
         * @private
         */
        _shownItems: {
          type: Array
        },

        /**
         * The maximum 'other count' value.
         *
         * @type {Number}
         * @default 0
         * @private
         */
        _maxOtherCount: {
          notify: true,
          type: Number,
          value: 0
        },

        /**
         * Whether this component has more items to show.
         *
         * @type {Boolean}
         * @default false
         * @private
         */
        _showMore: {
          type: Boolean,
          value: false
        }
      },

      /**
       * Returns the combined list of selected items and input items for this component.  Sets the 'selected' and 'max' properties for the items.
       */
      _computeCombinedItems: function() {
        var self = this;
        var combinedItems = [];

        var itemMax = _.max(this.items.map(function(item) {
          return item[self.countProperty];
        })) || 0;

        this.items.forEach(function(item) {
          // Ensure that this component does not affect the input items by creating a copy.
          var clonedItem = _.cloneDeep(item);
          clonedItem[self.maxProperty] = itemMax;
          clonedItem.select = (self.selectedIds.indexOf(item[self.idProperty]) >= 0);
          combinedItems.push(clonedItem);
        });

        return combinedItems;
      },

      /**
       * Returns a listener that shows the full list of items on clicking the Show More button.
       */
      _createShowMoreListener: function() {
        var self = this;
        return {
          onClick: function() {
            var shownItems = self._shownItems;
            self.set('_shownItems', []);
            for(var i = self.limit; i < self._combinedItems.length; ++i) {
              shownItems.push(self._combinedItems[i]);
            }
            self.set('_shownItems', shownItems);
            self.set('_showMore', false);
          }
        };
      },

      /**
       * Returns whether this component has items that may overflow its list (requiring a scrollbar).
       */
      _doesOverflow: function(length, small, string) {
        // Overflow causes a scrollbar to be displayed when the bottom checkbox in the list is checked because of the
        // ripple effect so only add overflow if needed because there are more than a specific number of items.
        return length > (small ? 11 : 20) ? string : '';
      },

      _getBlurStyleClass: function(blur) {
        return (blur ? 'small-blur' : '');
      },

      /**
       * Returns the count header using the given countType and entityName.  Only used if showOtherCounts is true.
       */
      _getCountHeader: function(countType, entityName) {
        return (countType ? countType + ' ' : '') + 'Co-occurring' + (entityName ? ' With ' + entityName : '');
      },

      /**
       * Returns the checkbox tooltip.
       */
      _getCheckboxTooltip: function(item, textProperty, checkboxName) {
        return 'Toggle ' + checkboxName + ' on ' + this._getProperty(item, textProperty);
      },

      /**
       * Returns the other count header using the given countType.
       */
      _getOtherCountHeader: function(countType) {
        return (countType ? countType + ' ' : '') + 'Not Co-occurring';
      },

      /**
       * Returns the value of the given item.
       */
      _getProperty: function(item, property, defaultValue) {
        return item[property] || defaultValue;
      },

      /**
       * Returns whether this component is marked as small or large.
       */
      _isSmallOrLarge: function(small, showImages) {
        return small ? 'small' : (showImages ? 'large' : '');
      },

      /**
       * Returns whether this component should show its counts header text.
       */
      _showCountsHeaderText: function(length, loading) {
        return !!length && !loading;
      },

      /**
       * Returns whether this component should show its header text.
       */
      _showHeader: function(itemType, countType, showOtherCounts) {
        return (itemType && countType) || showOtherCounts;
      },

      /**
       * Returns whether this component should show its 'no data' text.
       */
      _showNoDataText: function(hideNoDataText, length, loading) {
        return !hideNoDataText && !length && !loading;
      },

      /**
       * Updates the list of display items using the combined list of selected items and input items and the limit.
       */
      _updateShownItems: function() {
        this.set('_shownItems', []);
        this.set('_maxOtherCount', 0);
        var limit = (this.limit > 0 ? Math.min(this._combinedItems.length, this.limit) : this._combinedItems.length);
        var shownItems = [];
        for(var i = 0; i < limit; ++i) {
          shownItems.push(this._combinedItems[i]);
        }
        this.set('_shownItems', shownItems);
        this.set('_showMore', (!this.hideShowMore && this.limit && this._combinedItems.length > this.limit));
      }
    });
  })();
  </script>
</dom-module>
