<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/button-action/button-action.html">
<link rel="import" href="../../bower_components/double-bar-chart/double-bar-chart.html">
<link rel="import" href="../../bower_components/horizontal-bar-chart/horizontal-bar-chart.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/loading-spinner/loading-spinner.html">
<link rel="import" href="../lodash.html">

<dom-module id="feature-aggregation">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors"></style>

    <style>
      :host {
        display: block;
      }

      .data {
        overflow: auto;
        /* Max Height = Height of 20 Items */
        max-height: 480px;
        /* Must add bottom padding otherwise the scrollbar will be displayed due to the paper-checkbox ripple element. */
        padding-bottom: 15px;
      }

      .add-margin-left: {
        margin-left: 5px;
      }

      .add-margin-right: {
        margin-right: 5px;
      }

      .scroll-margin {
        /* Add right margin to the header equal to the width of a scrollbar. */
        margin-right: 15px;
      }

      .small {
        /* Max Height = Height of 10 Items + Height of Show More Button */
        max-height: 270px;
      }

      .text {
        color: var(--secondary-text-color);
        font-size: 14px;
        line-height: 20px;
        text-transform: uppercase;
      }
    </style>

    <template is="dom-if" if="[[headerDataName]]">
      <div id="header" class$="layout horizontal [[_getHeaderStyleClass(_barChartData.length, small)]]">
        <template is="dom-if" if="[[!showDoubleBarChart]]">
          <div class="text flex">[[headerDataName]]</div>
          <template is="dom-if" if="[[_barChartData.length]]">
            <div class="text">[[headerCountsName]]</div>
          </template>
        </template>

        <template is="dom-if" if="[[showDoubleBarChart]]">
          <div class="layout horizontal flex-2 add-margin-right">
            <div class="text flex">[[headerDataName]]</div>
            <template is="dom-if" if="[[_barChartData.length]]">
              <div class="text">[[_getCountsHeader('Co-occurring', headerCountsName, headerEntityName)]]</div>
            </template>
          </div>

          <div class="layout horizontal end-justified flex-1 add-margin-left">
            <template is="dom-if" if="[[_barChartData.length]]">
              <div class="text">[[_getCountsHeader('Not Co-occurring', headerCountsName)]]</div>
            </template>
          </div>
        </template>
      </div>
    </template>

    <status-text
      count="[[_barChartData.length]]"
      error="[[errorMessage]]"
      loading="[[loading]]"
      empty="None">
    </status-text>

    <template is="dom-if" if="[[_barChartData.length]]">
      <div class$="data [[_getBarChartStyleClass(small)]]">
        <template is="dom-if" if="[[!showDoubleBarChart]]">
          <horizontal-bar-chart
            show-checkboxes="[[showCheckboxes]]"
            checkbox-name="[[checkboxName]]"
            data="[[_barChartData]]"
            selected-ids="{{selectedIds}}">
          </horizontal-bar-chart>
        </template>

        <template is="dom-if" if="[[showDoubleBarChart]]">
          <double-bar-chart
            client="[[client]]"
            index-name="[[indexName]]"
            index-types="[[indexTypes]]"
            query-field="[[queryField]]"
            show-checkboxes="[[showCheckboxes]]"
            checkbox-name="[[checkboxName]]"
            data="[[_barChartData]]"
            max-other-count="{{_maxOtherCount}}"
            selected-ids="{{selectedIds}}">
          </double-bar-chart>
        </template>
      </div>
    </template>

    <loading-spinner show="[[loading]]"></loading-spinner>

    <template is="dom-if" if="[[_showMore]]">
      <div class="layout horizontal center-justified">
        <button-action text="Show More" click-listener="[[_createShowMoreListener()]]"></button-action>
      </div>
    </template>
  </template>

  <script>
  (function() {
    'use strict';

    /* globals _ */
    Polymer({
      is: 'feature-aggregation',

      properties: {
        /**
         * (Required)
         *
         * The list of data.
         *
         * @type {Array}
         */
        data: {
          type: Array
        },

        /**
         * (Optional)
         *
         * The count property in the data.
         *
         * @type {String}
         * @default 'count'
         */
        countProperty: {
          type: String,
          value: 'count'
        },

        /**
         * (Optional)
         *
         * The icon property in the each item.
         *
         * @type {String}
         * @default 'icon'
         */
        iconProperty: {
          type: String,
          value: 'icon'
        },

        /**
         * (Optional)
         *
         * The ID property in each item (used to set the selected IDs).
         *
         * @type {String}
         * @default 'id'
         */
        idProperty: {
          type: String,
          value: 'id'
        },

        /**
         * (Optional)
         *
         * The link property in the each item.
         *
         * @type {String}
         * @default 'link'
         */
        linkProperty: {
          type: String,
          value: 'link'
        },

        /**
         * (Optional)
         *
         * The style class property in the each item.
         *
         * @type {String}
         * @default 'styleClass'
         */
        styleClassProperty: {
          type: String,
          value: 'styleClass'
        },

        /**
         * (Optional)
         *
         * The text property in the each item.
         *
         * @type {String}
         * @default 'text'
         */
        textProperty: {
          type: String,
          value: 'text'
        },

        /**
         * (Optional)
         *
         * The error message.
         *
         * @type {String}
         */
        errorMessage: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The header counts name.
         *
         * @type {String}
         * @default ''
         */
        headerCountsName: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The header data name.
         *
         * @type {String}
         * @default ''
         */
        headerDataName: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The header entity name used if showDoubleBarChart is true.
         *
         * @type {String}
         * @default ''
         */
        headerEntityName: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * Whether to hide the 'show more' button.
         *
         * @type {Boolean}
         * @default false
         */
        hideShowMore: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * The limit on the initial number of items from the data to show in this component (or 0 to show all items).
         *
         * @type {Number}
         * @default 10
         */
        limit: {
          type: Number,
          value: 10
        },

        /**
         * (Optional)
         *
         * Whether the data is loading.
         *
         * @type {Boolean}
         * @default false
         */
        loading: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * Whether or not to display a checkbox in each horizontal-bar.
         *
         * @type {Boolean}
         * @default false
         */
        showCheckboxes: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * The name of the checkboxes.
         *
         * @type {String}
         * @default 'Filter'
         */
        checkboxName: {
          type: String,
          value: 'Filter'
        },

        /**
         * (Optional)
         *
         * Whether to show a double-bar-chart element with counts of other results not included in the item counts.  Runs an elasticsearch query for each item.
         * Requires the properties:  client, indexName, indexTypes, queryField
         *
         * @type {Boolean}
         * @default false
         */
        showDoubleBarChart: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * The elasticsearch client.  Required if showDoubleBarChart is true.
         *
         * @type {Object}
         */
        client: {
          type: Object
        },

        /**
         * (Optional)
         *
         * The elasticsearch index name.  Required if showDoubleBarChart is true.
         *
         * @type {String}
         */
        indexName: {
          type: String
        },

        /**
         * (Optional)
         *
         * The list of elasticsearch index type strings.  Required if showDoubleBarChart is true.
         *
         * @type {Array}
         */
        indexTypes: {
          type: Array
        },

        /**
         * (Optional)
         *
         * The elasticsearch query field.  Required if showDoubleBarChart is true.
         *
         * @type {String}
         */
        queryField: {
          type: String
        },

        /**
         * (Optional)
         *
         * Whether this component should be shown as its smaller version.
         *
         * @type {Boolean}
         * @default false
         */
        small: {
          type: Boolean,
          value: false
        },

        /**
         * (Output)
         *
         * The selected string IDs on which to filter.
         *
         * @type {Array}
         * @default []
         */
        selectedIds: {
          notify: true,
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * The transformed data used to create the _barChartData.
         *
         * @type {Array}
         * @private
         */
        _aggregationDisplayData: {
          computed: '_createAggregationDisplayData(data)',
          observer: '_updateBarChartData',
          type: Array
        },

        /**
         * The data to show in the bar chart.
         *
         * @type {Array}
         * @private
         */
        _barChartData: {
          type: Array
        },

        /**
         * The maximum 'other count' value.
         *
         * @type {Number}
         * @default 0
         * @private
         */
        _maxOtherCount: {
          notify: true,
          type: Number,
          value: 0
        },

        /**
         * Whether this component has more items to show.
         *
         * @type {Boolean}
         * @default false
         * @private
         */
        _showMore: {
          type: Boolean,
          value: false
        }
      },

      /**
       * Creates and returns the transformed list of the given data so each item has the 'max' and 'select' properties.
       *
       * @param {Array} data
       * @return {Array}
       * @private
       */
      _createAggregationDisplayData: function(data) {
        var self = this;
        var aggregationDisplayData = [];

        var max = _.max(data.map(function(item) {
          return item[self.countProperty];
        })) || 0;

        data.forEach(function(item) {
          aggregationDisplayData.push({
            count: item[self.countProperty],
            icon: item[self.iconProperty],
            id: item[self.idProperty],
            link: item[self.linkProperty],
            max: max,
            select: (self.selectedIds.indexOf(item[self.idProperty]) >= 0),
            styleClass: item[self.styleClassProperty],
            text: item[self.textProperty]
          });
        });

        return aggregationDisplayData;
      },

      /**
       * Returns a listener on clicking the Show More button to update _barChartData with all the _aggregationDisplayData.
       *
       * @return {Object}
       * @private
       */
      _createShowMoreListener: function() {
        var self = this;
        return {
          onClick: function() {
            var barChartData = self._barChartData;
            self.set('_barChartData', []);
            for(var i = self.limit; i < self._aggregationDisplayData.length; ++i) {
              barChartData.push(self._aggregationDisplayData[i]);
            }
            self.set('_barChartData', barChartData);
            self.set('_showMore', false);
          }
        };
      },

      /**
       * Returns the style class for the bar chart.
       *
       * @param {Boolean} small
       * @return {String}
       * @private
       */
      _getBarChartStyleClass: function(small) {
        return small ? 'small' : '';
      },

      /**
       * Returns the count header using the given text.
       *
       * @param {String} text
       * @param {String} headerCountsName
       * @param {String} headerEntityName
       * @return {String}
       * @private
       */
      _getCountsHeader: function(text, headerCountsName, headerEntityName) {
        return (headerCountsName ? headerCountsName + ' ' : '') + text + (headerEntityName ? ' With ' + headerEntityName : '');
      },

      /**
       * Returns the style class for the header.
       *
       * @param {Number} length
       * @param {Boolean} small
       * @return {String}
       * @private
       */
      _getHeaderStyleClass: function(length, small) {
        return length > (small ? 11 : 20) ? 'scroll-margin' : '';
      },

      /**
       * Updates the _barChartData with the _aggregationDisplayData up to the limit.  Resets _maxOtherCount and _showMore.
       *
       * @private
       */
      _updateBarChartData: function() {
        this.set('_barChartData', []);
        this.set('_maxOtherCount', 0);
        var limit = (this.limit > 0 ? Math.min(this._aggregationDisplayData.length, this.limit) : this._aggregationDisplayData.length);
        var barChartData = [];
        for(var i = 0; i < limit; ++i) {
          barChartData.push(this._aggregationDisplayData[i]);
        }
        this.set('_barChartData', barChartData);
        this.set('_showMore', (!this.hideShowMore && this.limit && this._aggregationDisplayData.length > this.limit));
      }
    });
  })();
  </script>
</dom-module>
