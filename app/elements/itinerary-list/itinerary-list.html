<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">

<dom-module id="itinerary-list">
  <template>
    <style include="icon-styles"></style>
    <style include="list-item-styles"></style>

    <style>
      :host {
        display: block;
        /* Max Height = Height of 50 Items */
        max-height: 3000px;
        overflow: auto;
      }

      .list-item-body paper-item {
        padding: 0 40px;
      }
    </style>

    <template is="dom-repeat" items="{{data}}">
      <div class="itinerary">
        <paper-material class$="list-item-head {{getHeaderClass(item.opened)}}" clickable on-tap="toggleItinerary">
          <paper-icon-item>
            <iron-icon class="list-item-icon entity-date-font" icon="icons:date-range" item-icon></iron-icon>
            <iron-icon class="closed-icon" icon="icons:expand-more" item-icon></iron-icon>
            <iron-icon class="opened-icon" icon="icons:expand-less" item-icon></iron-icon>

            <paper-item-body two-line>
              <div><strong>{{formatDate(item.date)}}</strong></div>
              <div secondary><strong>{{getLocationsForHeader(item.city)}}</strong></div>
            </paper-item-body>
          </paper-icon-item>
        </paper-material>

        <iron-collapse id="itinerary_{{item.date}}">
          <div class="list-item-collapse-body">
            <template is="dom-repeat" items='{{item.city}}' as="city">
              <paper-material class="list-item-body">
                <paper-icon-item>
                  <iron-icon class="list-item-icon entity-location-font" icon="communication:location-on" item-icon></iron-icon>
                  <paper-item-body>
                    <div><strong>{{getLocation(city.city)}}</strong></div>
                  </paper-item-body>
                </paper-icon-item>

                <template is="dom-repeat" items='{{city.data}}' as="cityItem">
                  <paper-item>
                    <paper-item-body>
                      <span>
                        <strong class="capitalize">{{cityItem.key}}:</strong>
                        <span>{{cityItem.value}}</span>
                      </span>
                    </paper-item-body>
                  </paper-item>
                </template>
              </paper-material>
            </template>
          </div>
        </iron-collapse>
      </div>
    </template>
  </template>

  <script>
    Polymer({
      is: 'itinerary-list',

      properties: {
        data: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
      },

      getLocation: function(city) {
        return city.split(':').slice(0,2).join(', ');
      },

      getHeaderClass: function(opened) {
        return (opened ? 'opened' : 'closed');
      },

      toggleItinerary: function(event) {
        event.model.set('item.opened', !event.model.item.opened);
        this.$$('#itinerary_' + event.model.item.date).toggle();
      },

      formatDate: function(date) {
        return new Date(date).toDateString();
      },

      getLocationsForHeader: function(cities) {
        var locations = '';
        for(var i = 0; i < cities.length; ++i) {
          if(i > 2) {
            locations += ', and ' + (cities.length - 3) + ' more';
            break;
          } else {
            locations += (i > 0 ? ', ' : '') + cities[i].city.split(':')[0];
          }
        }
        return locations;
      }
    });
  </script>
</dom-module>
