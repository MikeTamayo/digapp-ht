<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/aggregation-display/aggregation-display.html">
<link rel="import" href="../../bower_components/array-behavior/array-behavior.html">
<link rel="import" href="../../bower_components/build-and-run-aggregation/build-and-run-aggregation.html">
<link rel="import" href="../../bower_components/elastic-client-aggregation-builder/elastic-client-aggregation-builder.html">
<link rel="import" href="../../bower_components/elastic-client-query-builder/elastic-client-query-builder.html">
<link rel="import" href="../../bower_components/elastic-client-search/elastic-client-search.html">
<link rel="import" href="../../bower_components/elastic-error/elastic-error.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/json-combine/json-combine.html">
<link rel="import" href="../../styles/icon-styles.html">
<link rel="import" href="../behaviors.html">

<dom-module id="feature-query-and-display">
  <template>
    <style include="icon-styles"></style>
    <style include="iron-flex"></style>

    <style>
      :host {
        display: block;
      }
    </style>

    <!-- Use a template to ensure that the aggregation query is built and run only once the transform config is created. -->
    <template is="dom-if" if="[[_exists(aggregationName, dataType)]]">
      <build-and-run-aggregation
        aggregation-count="[[aggregationCount]]"
        aggregation-field="[[aggregationField]]"
        aggregation-name="[[aggregationName]]"
        query-fields="[[queryField]]"
        query-values="[[queryValue]]"
        client="[[client]]"
        index-name="[[indexName]]"
        index-types="[[indexTypes]]"
        filters="[[filterList]]"
        transform-config="[[_createConfig(aggregationName, dataType, ignoreId)]]"
        transform-function="[[transformFunction]]"
        error="{{error}}"
        loading="{{loading}}"
        results="{{_transformResults}}">
      </build-and-run-aggregation>
    </template>

    <elastic-error error="[[error]]" message="{{errorMessage}}"></elastic-error>

    <aggregation-display class="flex"
      count-property="[[dataCountProperty]]"
      icon-property="[[dataIconProperty]]"
      id-property="[[dataIdProperty]]"
      link-property="[[dataLinkProperty]]"
      max-property="[[dataMaxProperty]]"
      style-class-property="[[dataStyleClassProperty]]"
      text-property="[[dataTextProperty]]"
      data="[[data]]"
      header-data-name="[[headerDataName]]"
      header-counts-name="[[headerCountsName]]"
      header-entity-name="[[headerEntityName]]"
      error-message="[[errorMessage]]"
      loading="[[loading]]"
      small="[[small]]"
      show-checkboxes="[[showCheckboxes]]"
      show-double-bar-chart="[[showDoubleBarChart]]"
      client="[[client]]"
      index-name="[[indexName]]"
      index-types="[[indexTypes]]"
      query-field="[[aggregationField]]"
      selected-ids="{{selected}}">
    </aggregation-display>
  </template>

  <script>
  (function() {
    /* globals DigBehaviors */
    'use strict';

    Polymer({
      is: 'feature-query-and-display',

      behaviors: [
        DigBehaviors.TypeBehavior
      ],

      properties: {
        /**
         * The name for the elasticsearch aggregation.
         */
        aggregationName: {
          type: String
        },

        /**
         * The field for the elasticsearch aggregation.
         */
        aggregationField: {
          type: String
        },

        /**
         * The count of results for the elasticsearch aggregation.  Default is 0 (all results).
         */
        aggregationCount: {
          type: Number,
          value: 0
        },

        /**
         * The list of strings selected for the elasticsearch filter.
         */
        selected: {
          type: Array,
          notify: true
        },

        /**
         * The field for the elasticsearch query.
         */
        queryField: {
          type: String
        },

        /**
         * The value for the elasticsearch query.
         */
        queryValue: {
          type: String
        },

        /**
         * The elasticjs query created by this component.
         */
        query: {
          type: Object,
          notify: true
        },

        /**
         * The elasticsearch client.
         */
        client: {
          type: Object
        },

        /**
         * The elasticsearch index to query.
         */
        indexName: {
          type: String
        },

        /**
         * The elasticsearch index types to query.
         */
        indexTypes: {
          type: Array
        },

        /**
         * The list of elasticjs filters used in the aggregations run by this component.
         */
        filterList: {
          type: Array,
          notify: true
        },

        /**
         * The error message.
         */
        errorMessage: {
          notify: true,
          type: String,
          value: ''
        },

        /**
         * Whether the query run by this component is loading.
         */
        loading: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * The elasticsearch query error.
         */
        error: {
          type: Object
        },

        /**
         * The ID to ignore in the feature transform (if any).
         */
        ignoreId: {
          type: String,
          value: ''
        },

        /**
         * The transform function for the query results.
         */
        transformFunction: {
          type: Object
        },

        /**
         * The property with the data in the transform results object.  By default, uses the transform results object itself.
         */
        dataProperty: {
          type: String,
          value: 'data'
        },

        /**
         * The data from the transform results object.
         */
        data: {
          notify: true,
          type: Array,
          computed: '_getData(_transformResults, dataProperty)'
        },

        /**
         * Property in the data objects containing the count to display.
         */
        dataCountProperty: {
          type: String,
          value: 'count'
        },

        /**
         * Property in the data objects containing the icon to display.
         */
        dataIconProperty: {
          type: String,
          value: 'icon'
        },

        /**
         * Property in the data objects containing a unique ID (used to set the filter values).
         */
        dataIdProperty: {
          type: String,
          value: 'id'
        },

        /**
         * Property in the data objects containing the link to display.
         */
        dataLinkProperty: {
          type: String,
          value: 'link'
        },

        /**
         * Property in the data objects containing the max to display.
         */
        dataMaxProperty: {
          type: String,
          value: 'max'
        },

        /**
         * Property in the data objects containing the style class to display.
         */
        dataStyleClassProperty: {
          type: String,
          value: 'styleClass'
        },

        /**
         * Property in the data objects containing the text to display.
         */
        dataTextProperty: {
          type: String,
          value: 'text'
        },

        /**
         * The property with the header in the transform results object.
         */
        headerProperty: {
          type: String,
          value: 'header'
        },

        /**
         * The header from the transform results object.
         */
        header: {
          notify: true,
          type: String,
          computed: '_getHeader(_transformResults, headerProperty)'
        },

        /**
         * The type of the data.
         */
        dataType: {
          type: String
        },

        /**
         * The header data name.
         */
        headerDataName: {
          type: String
        },

        /**
         * The header counts name.
         */
        headerCountsName: {
          type: String
        },

        /**
         * The header entity name.
         */
        headerEntityName: {
          type: String
        },

        /**
         * Whether the element is small.
         */
        small: {
          type: Boolean,
          value: false
        },

        /**
         * Whether or not to display checkboxes in the bar chart.
         */
        showCheckboxes: {
          type: Boolean,
          value: false
        },

        /**
         * Whether to show the double-bar-chart element.
         */
        showDoubleBarChart: {
          type: Boolean,
          value: false
        },

        /**
         * The elasticjs aggregation created by this component.
         */
        _aggregation: {
          type: Object
        },

        /**
         * The results of the query run by this component.
         */
        _queryResults: {
          type: Object
        },

        /**
         * The results of the transform run by this component.
         */
        _transformResults: {
          type: Object
        }
      },

      _createConfig: function(aggregationName, dataType, ignoreId) {
        return {
          ignoreId: ignoreId,
          property: aggregationName,
          type: dataType
        };
      },

      _exists: function(aggregationName, dataType) {
        return !!aggregationName && !!dataType;
      },

      _getData: function(data, property) {
        return property ? data[property] : data;
      },

      _getHeader: function(data, property) {
        return property ? (data[property] || '') : '';
      }
    });
  })();
  </script>
</dom-module>
