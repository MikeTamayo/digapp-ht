<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/elastic-search/elastic-search.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../annotate-record/annotate-record.html">

<dom-module id="single-record">
  <template>
    <style include="icon-styles"></style>
    <style>
      :host {
        display: block;
      }

      .record-head {
        padding: 0 10px;
      }

      .record-head {
        box-shadow: none;
      }

      .record-head.opened,
      .record-head:hover {
        background-color: rgba(0,0,0,0.1);
      }

      paper-icon-item[clickable] {
        cursor: pointer;
      }

      paper-item,
      paper-icon-item {
        --paper-item-focused-before: {
          background: initial;
        }
      }

      paper-icon-item {
        /* Use the width of iron-icon-big */
        --paper-item-icon-width: 36px;
        --paper-item-icon: {
          margin-right: 15px;
        }
      }

      iron-icon.closed-icon,
      iron-icon.opened-icon,
      paper-icon-item[clickable]:hover iron-icon {
        display: none;
      }

      .record-head.closed:hover iron-icon.closed-icon,
      .record-head.opened:hover iron-icon.opened-icon {
        display: block;
      }

      .entity-icon {
        /* Add margin so the entity icon is as wide as iron-icon-big */
        margin: 0 6px;
      }

      .record-image {
        background: var(--disabled-text-color);
        margin-right: 15px;
        height: 50px;
        width: 50px;
      }

      .record-head-text {
        margin-right: 15px;
        min-height: 100px;
      }

      .record-link {
        color: var(--primary-text-color);;
        font-size: 14px;
        text-decoration: none;
      }

      .record-button {
        @apply(--shadow-elevation-4dp);
      }

      .record-button:hover {
        @apply(--shadow-elevation-8dp);
      }

      .record-head-link {
        visibility: hidden;
      }

      .record-head:hover .record-head-link {
        visibility: visible;
      }

      .record-body {
        margin-bottom: 10px;
        padding: 20px 10px;
      }

      .record-body-data {
        --paper-item-min-height: 25px;
        font-size: 14px;
        padding: 0 10px;
      }

      .record-body-button {
        margin-top: 10px;
      }

      .capitalize {
        text-transform: capitalize;
      }

      /* Needed to fix layout issues in newer versions of chrome and firefox. */
      paper-item-body,
      paper-item-body > * {
        white-space: normal;
      }

      /* Needed to fix layout issues in newer versions of chrome and firefox. */
      .lineclamp {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 1; /* number of lines to show */
        -webkit-box-orient: vertical;
      }

      .lineclamp.three-line {
        -webkit-line-clamp: 3;
      }
    </style>

    <elastic-search
      client="[[client]]"
      index="[[index]]"
      elastic-type="[[indexTypes]]"
      query="[[imageQuery]]"
      results="{{imageQueryResults}}"
      last-error="{{error}}">
    </elastic-search>

    <div>
      <paper-material class$="record-head [[getHeaderClass(opened)]]" on-tap="toggleRecord">
        <paper-icon-item clickable$="[[showDetails]]">
          <iron-icon class$="entity-icon [[getIconClass(item._type)]]" icon$="[[getIcon(item._type)]]" item-icon></iron-icon>

          <template is="dom-if" if="[[showDetails]]">
            <iron-icon class="iron-icon-big closed-icon" icon="icons:expand-more" item-icon></iron-icon>
            <iron-icon class="iron-icon-big opened-icon" icon="icons:expand-less" item-icon></iron-icon>
          </template>

          <template is="dom-if" if="[[imageSrc]]">
            <iron-image class$="record-image [[getBlurClass(blur)]]" sizing="contain" src="[[imageSrc]]"></iron-image>
          </template>

          <paper-item-body class="record-head-text">
            <div class="lineclamp" title$="[[item.title]]"><strong>[[item.title]]</strong></div>

            <template is="dom-if" if="[[item.subtitle]]">
              <div class="lineclamp three-line" title="[[getSubtitleTooltip(item.subtitle)]]" secondary>
                <template is="dom-repeat" items="[[getSubtitleArray(item.subtitle)]]" as="value">
                  <div><strong>[[value]]</strong></div>
                </template>
              </div>
            </template>
          </paper-item-body>

          <!-- annotation controls -->
          <annotate-record client="[[client]]" annotation-index="[[annotationIndex]]"
            annotation-type="[[annotationType]]" query-template="{{annotationQueryTemplate}}"
            item="{{item}}">
          </annotate-record>

          <!-- secondary actions -->
          <a class="record-link record-head-link" target="[[getTarget(newTab)]]" href$="[[createURL(item._type, item._id, '_id', blur)]]">
            <paper-button class="record-button">{{getButtonText(item._type)}}</paper-button>
          </a>
        </paper-icon-item>
      </paper-material>

      <template is="dom-if" if="[[showDetails]]">
        <iron-collapse class="record-detail">
          <paper-material class="record-body">
            <template is="dom-repeat" items="[[getDetailKeysArray(item.details)]]" as="key">
              <paper-item class="record-body-data">
                <paper-item-body>
                  <span>
                    <strong class="capitalize">[[replaceCamelCaseText(key)]]:</strong>
                    <template is="dom-repeat" items="[[getDetailArrayForKey(item.details, key)]]" as="value">
                      <span>[[value]]</span>
                    </template>
                  </span>
                </paper-item-body>
              </paper-item>
            </template>

            <template is="dom-if" if="[[item.imageUrls]]">
              <image-viewer images="[[item.imageUrls]]"></image-viewer>
            </template>

            <template is="dom-if" if="[[imageUrls]]">
              <image-viewer images="[[imageUrls]]"></image-viewer>
            </template>

            <a class="record-link" target="[[getTarget(newTab)]]" href$="[[createURL(item._type, item._id, '_id', blur)]]">
              <paper-button class="record-button record-body-button" raised>{{getButtonText(item._type)}}</paper-button>
            </a>
          </paper-material>
        </iron-collapse>
      </template>
    </div>
  </template>

  <script>
  (function() {
    /* globals _, Mustache */
    'use strict';

    Polymer({
      is: 'single-record',

      properties: {
        /**
         * The item represented by this single record.
         */
        item: {
          type: Object,
          notify: true
        },

        /**
         * an instance of elasticsearch.Client which is connected to
         * an elasticsearch server
         */
        client: {
          type: Object
        },

        /**
         * the annotation index (database name)
         */
        annotationIndex: {
          type: String
        },

        /**
         * the annotation type
         */
        annotationType: {
          type: String
        },

        /**
         * query template to find existing annotations
         */
        annotationQueryTemplate: {
          type: Object
        },

        /**
         * The elasticsearch index.
         */
        index: {
          type: String
        },

        /**
         * The array of elasticsearch index types.
         */
        indexTypes: {
          type: Array
        },

        /**
         * The query template to find images.
         */
        imageQueryTemplate: {
          type: Object
        },

        /**
         * The field of the image query template.
         */
        imageQueryField: {
          type: String
        },

        /**
         * The field of the item for the value of the image query template.
         */
        imageQueryValue: {
          type: String
        },

        /**
         * The query to find images.
         */
        imageQuery: {
          type: Object
        },

        /**
         * The results of the query to find images.
         */
        imageQueryResults: {
          type: Object
        },

        /**
         * The src for the iron-image in the record header.
         */
        imageSrc: {
          type: String,
          value: '',
          notify: true
        },

        /**
         * The image URLs for the item used instead of an image query.
         */
        imageUrls: {
          type: Array,
          notify: true
        },

        /**
         * Whether to blur the images.
         */
        blur: {
          type: Boolean,
          value: false
        },

        /**
         * Whether links should be opened in new tabs.
         */
        newTab: {
          type: Object,
          value: false,
          notify: true
        },

        /**
         * Whether the details are opened.
         */
        opened: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * Whether details should be available.
         */
        showDetails: {
          type: Boolean,
          value: false,
          notify: true
        },

        error: {
          type: Object
        }
      },

      observers: [
          'createImageQuery(item, imageQueryTemplate, imageQueryField, imageQueryValue)',
          'findSrcInImageQueryResults(item, imageQueryResults)',
          'onItemChange(item.*)',
          'updateImageSrcFromItemUrls(item.imageUrls.splices)',
          'updateImageSrcFromPropertyUrls(imageUrls.splices)',
          'updateShowDetails(item.details)'
      ],

      ready: function() {
        var blur = true;
        window.location.search.slice(1, window.location.search.length).split('&').forEach(function(parameter) {
          var parameterPair = parameter.split('=');
          if(parameterPair[0] === 'blur' && parameterPair[1] === 'false') {
            blur = false;
          }
        });
        this.set('blur', blur);
      },

      /**
       * Sets this.imageQuery using the given variables.
       */
      createImageQuery: function(item, imageQueryTemplate, imageQueryField, imageQueryValue) {
        if(!this.imageUrls || !this.imageUrls.length) {
          var view = {
            field: imageQueryField,
            value: item[imageQueryValue]
          };
          this.imageQuery = JSON.parse(decodeURIComponent(Mustache.render(JSON.stringify(imageQueryTemplate), view)));
        }
      },

      createURL: function(type, value, field, blur) {
        return '/' + type + '.html?value=' + value + '&field=' + field + '&blur=' + blur;
      },

      /**
       * Adds the image URLs from the hits in the given image query results to item.imageUrls.
       */
      findSrcInImageQueryResults: function(item, imageQueryResults) {
        if(imageQueryResults) {
          this.set('item.imageUrls', []);
          var self = this;
          imageQueryResults.hits.hits.forEach(function(hit) {
            self.push('item.imageUrls', hit._source.url);
          });
        }
      },

      getBlurClass: function(blur) {
        return (blur ? 'small-blur' : '');
      },

      getButtonText: function(type) {
        if(type === 'offer') {
          return 'open ad';
        }
        return 'open ' + type;
      },

      getDetailArrayForKey: function(details, key) {
        if(details && details[key]) {
          return (_.isArray(details[key]) ? details[key] : [details[key]]);
        }
        return [];
      },

      getDetailKeysArray: function(details) {
        if(details) {
          return (details._sortedKeys ? details._sortedKeys : _.keys(details)).filter(function(key) {
            return details[key];
          });
        }
        return [];
      },

      getHeaderClass: function(opened) {
        return (opened ? 'opened' : 'closed');
      },

      getIconClass: function(type) {
        if(type === 'provider') {
          return 'entity-person-font';
        }
        return 'entity-' + type + '-font';
      },

      getIcon: function(type) {
        switch(type) {
          case 'email': return 'communication:email';
          case 'offer': return 'maps:local-offer';
          case 'person': return 'icons:account-circle';
          case 'phone': return 'communication:phone';
          case 'provider': return 'icons:account-circle';
          case 'seller': return 'editor:attach-money';
          case 'webpage': return 'av:web';
        }
      },

      getSubtitleArray: function(subtitle) {
        if(subtitle) {
          return (_.isArray(subtitle) ? subtitle : [subtitle]);
        }
        return [];
      },

      getSubtitleTooltip: function(subtitle) {
        return this.getSubtitleArray(subtitle).join(', ');
      },

      getTarget: function(newTab) {
        return (newTab ? '_blank' : '_self');
      },

      /**
       * Handles any needed behavior when the item is changed.
       */
      onItemChange: function() {
        // Close the details panel of the new record.
        var recordDetail = this.$$('.record-detail');
        var classList = recordDetail ? recordDetail.classList : undefined;
        if(classList && classList.contains('iron-collapse-opened')) {
          recordDetail.toggle();
          this.set('opened', !this.opened);
        }
      },

      replaceCamelCaseText: function(key) {
        return key.replace(/([A-Z])/g, ' $1');
      },

      /**
       * Expands or collapses this record if its item has any details and the event was not triggered by clicking on a button.
       */
      toggleRecord: function(event) {
        // Do not open a record with no details.
        if(this.showDetails) {
          // Do not open the record if the user clicked on a button inside the record.
          if(event.target.localName !== 'paper-button' && !event.target.classList.contains('paper-icon-button')) {
            this.set('opened', !this.opened);
            this.$$('.record-detail').toggle();
          }
        }
      },

      /**
       * Sets the src for the iron-image in the record header with the first url in the item if available.
       */
      updateImageSrcFromItemUrls: function() {
        this.updateImageSrcFromUrls(this.item.imageUrls);
      },

      /**
       * Sets the src for the iron-image in the record header with the first url in the given list if available.
       */
      updateImageSrcFromUrls: function(urls) {
        if(urls && urls.length) {
          this.set('imageSrc', urls[0]);
          this.set('showDetails', true);
        } else if(urls) {
          // Set the src to a truthy value so the gray iron-image is displayed.
          this.set('imageSrc', 'blank');
        }
      },

      /**
       * Sets the src for the iron-image in the record header with the first url in the property if available.
       */
      updateImageSrcFromPropertyUrls: function() {
        this.updateImageSrcFromUrls(this.imageUrls);
      },

      /**
       * Sets whether to show details based on the existence of the given details object.
       */
      updateShowDetails: function(details) {
        this.set('showDetails', !!details);
      }
    });
  })();
  </script>
</dom-module>
