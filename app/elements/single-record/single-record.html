<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/button-link/button-link.html">
<link rel="import" href="../../bower_components/icon-label/icon-label.html">
<link rel="import" href="../../bower_components/image-gallery/image-gallery.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/modal-icon/modal-icon.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/highlighted-text/highlighted-text.html">
<link rel="import" href="../../bower_components/fontawesome-iconset/fa-all.html">
<link rel="import" href="../../styles/single-item-styles.html">
<link rel="import" href="../annotate-record/annotate-record.html">
<link rel="import" href="../image-query/image-query.html">
<link rel="import" href="../lodash.html">

<dom-module id="single-record">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors"></style>
    <style include="single-item-styles"></style>

    <style>
      :host {
        display: block;
      }

      modal-icon ::content .entity-offer-font {
        /* Hide the offer icons because users didn't like them. */
        visibility: hidden;
      }

      modal-icon ::content paper-icon-button[icon*="icons:expand"] {
        /* Remove the padding to make the expand icons bigger because they look better that way. */
        padding: 0;
      }

      .icon-margin {
        /* Margin between the header text and the icons. */
        margin-left: 15px;
      }

      .rank {
        background-color:  var(--paper-grey-400);
        border-radius: 4px;
        margin-bottom: 10px;
        padding: 0 5px;
      }

      .risk {
        background-color:  var(--paper-red-200);
        border-radius: 4px;
        margin-bottom: 10px;
        padding: 0 5px;
      }

      .extractions {
        font-size: 14px;
        line-height: 25px;
        min-height: 25px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        word-break: break-word;
        -webkit-line-clamp: 5;
        -webkit-box-orient: vertical;
      }

      .extractions > div {
        width: 50%;
      }

      .confidence-icon {
        /* Hide the confidence icons for now until both strict and relaxed extractions are shown. */
        display: none;
        --iron-icon-width: 18px;
        --iron-icon-height: 18px;
        /* Align with text. */
        margin-top: 2px;
        margin-right: 10px;
      }

      .high-confidence {
        color: var(--paper-green-600);
      }

      .low-confidence {
        color: var(--paper-orange-600);
      }

      annotate-record,
      modal-icon,
      paper-icon-button {
        --paper-icon-button: {
          height: 35px;
          width: 35px;
          padding: 5px;
        };
      }

      .tiny-icon {
        --paper-icon-button: {
          height: 20px;
          width: 20px;
          padding: 0;
        };
      }

      .single-record-text {
        min-height: 25px;
        line-height: 25px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        -webkit-line-clamp: 5;
        -webkit-box-orient: vertical;
      }

      .body button-link ::content paper-button {
        /* Needed to make the button look nice. */
        margin-top: 10px;
      }

      icon-label {
        display: inline-block;
        border-radius: 4px;
        margin-right: 5px;
        padding: 0 5px;

        --icon-label-text: {
          color: var(--secondary-text-color);
          @apply(--extraction-text);
        };

        --icon-label-link-hover: {
          color: var(--primary-text-color);
        };
      }

      .highlight {
        background-color: yellow;
      }

      .padded {
        padding: 0 5px;
      }

      .hide {
        display: none;
      }

      .show {
        display: inline-block;
      }

      .yellowgreen {
        color: yellowgreen;
      }

      .entity-page-link {
        color: var(--primary-text-color);
        text-decoration: none;
      }

      .entity-page-link:hover {
        color: var(--secondary-text-color);
      }
    </style>

    <image-query
      aggregation-field="[[imageAggregationField]]"
      aggregation-name="[[imageAggregationName]]"
      client="[[client]]"
      images="{{images}}"
      index-name="[[imageIndexName]]"
      index-type="[[imageIndexType]]"
      query-field="[[imageQueryField]]"
      query-value="[[itemId]]"
      transform-function="[[imageTransformFunction]]">
    </image-query>

    <paper-material class$="layout horizontal flex head [[_getHeaderStyleClass(_open)]]" clickable$="[[_showDetails]]" on-mouseover="startHover" on-mouseout="endHover" on-tap="toggleRecord">

      <div class="layout vertical center image-container">
        <template is="dom-if" if="[[rank]]">
          <div class="rank text" title$="Search Result Score:  [[rank]]">
            <strong>[[rank]]</strong>
          </div>
        </template>
        <iron-image class$="[[_getBlurStyleClass(blur)]] hide [[_showImageSpace(images)]]" src="[[_imageSource]]"></iron-image>
      </div>

      <div class="layout vertical flex center-justified vertical-text">
        <div class="layout horizontal">
          <template is="dom-if" if="[[highRisk]]">
            <div class="risk text" title="High Risk Search Result">
              <strong>High Risk</strong>
            </div>
          </template>
          <div class="text" title$="[[text]]">
            <strong>
              <highlighted-text tags="[[highlightTags]]" text="[[_getHeaderText(text, highlightedText)]]"></highlighted-text>
            </strong>
          </div>
        </div>

        <div class="layout horizontal extractions wrap">
          <template is="dom-repeat" items="[[headExtractions]]">
            <div class="vertical layout">
              <template is="dom-if" if="[[_getProperty(item, extractionNameProperty)]]">
                <div>
                  <strong>[[_getPropertyWithColon(item, extractionNameProperty)]]</strong>
                </div>
              </template>
              <template is="dom-if" if="[[!_getLength(item, extractionDataProperty)]]">
                <div class="padded" secondary>None</div>
              </template>
              <template is="dom-if" if="[[_getLength(item, extractionDataProperty)]]">
                <template is="dom-repeat" items="[[_getList(item, extractionDataProperty)]]" as="extraction">
                  <div class="layout horizontal" secondary>
                    <icon-label class$="[[_isHighlighted(extraction, extractionHighlightProperty)]]"
                      title="Open [[_getProperty(extraction, extractionTextProperty)]]"
                      icon="[[_getProperty(extraction, extractionIconProperty)]]"
                      icon-style-class="[[_getProperty(extraction, extractionStyleClassProperty)]]"
                      link="[[_getProperty(extraction, extractionLinkProperty)]]"
                      target="[[_getTarget(newTab)]]"
                      text="[[_getProperty(extraction, extractionTextProperty)]]">
                    </icon-label>
                    <iron-icon icon="fa:circle"
                      class$="confidence-icon [[_getConfidenceLevelClass(extraction)]]"
                      title$="[[_getConfidenceLevelText(extraction)]]">
                    </iron-icon>
                    <template is="dom-if" if="[[_getProperty(extraction, extractionAnnotateProperty)]]">
                      <annotate-record class="tiny-icon"
                        annotation-manager="[[annotationManager]]"
                        client="[[client]]"
                        item-id="[[_getProperty(extraction, extractionIdProperty)]]"
                        item-type="[[_getTypeTextWithProperty(extraction, extractionTypeProperty)]]"
                        noink>
                      </annotate-record>
                    </template>
                  </div>
                </template>
              </template>
            </div>
          </template>
        </div>
      </div>

      <template is="dom-if" if="[[_isDefined(notificationQueryDate)]]" restamp="true">
        <div class="layout vertical center-justified">
          <iron-icon class$="[[_getNewIconDivClass(extractions, extractionTextProperty, extractionTypeProperty, notificationQueryDate)]] yellowgreen" icon="av:fiber-new"></iron-icon>
        </div>
      </template>

      <annotate-record class="layout vertical center-justified icon-margin"
        client="[[client]]"
        annotation-manager="[[annotationManager]]"
        item-id="{{itemId}}"
        item-type="[[_getTypeText(type)]]">
      </annotate-record>

      <div class="layout vertical center-justified">
        <a class="entity-page-link" href$="[[link]]" target="[[_getTarget(newTab)]]" title="Open [[_getTypeText(type)]]">
          <paper-icon-button icon="open-in-new" noink></paper-icon-button>
        </a>
      </div>

      <modal-icon
        icon="[[icon]]"
        icon-style-class="[[styleClass]]"
        show-icon="[[!_hovering]]"
        openable="[[_showDetails]]"
        open="[[_open]]">
      </modal-icon>

    </paper-material>

    <template is="dom-if" if="[[_showDetails]]">
      <iron-collapse id="recordDetail">
        <div>
          <paper-material class="body">
            <template is="dom-repeat" items="[[details]]" as="detail">
              <div class="text">
                <strong>[[_getPropertyWithColon(detail, detailNameProperty)]]</strong>
                <template is="dom-if" if="[[_getProperty(detail, detailLinkProperty)]]">
                  <a target="_blank" href$="[[_getProperty(detail, detailLinkProperty)]]">[[_getProperty(detail, detailTextProperty)]]</a>
                </template>
                <template is="dom-if" if="[[!_getProperty(detail, detailLinkProperty)]]">
                  <highlighted-text tags="[[highlightTags]]" text="[[_getDetailText(detail, detailHighlightedTextProperty, detailTextProperty)]]"></highlighted-text>
                </template>
              </div>
            </template>

            <div class="layout horizontal extractions wrap">
              <template is="dom-repeat" items="[[bodyExtractions]]">
                <div class="vertical layout">
                  <template is="dom-if" if="[[_getProperty(item, extractionNameProperty)]]">
                    <div>
                      <strong>[[_getPropertyWithColon(item, extractionNameProperty)]]</strong>
                    </div>
                  </template>
                  <template is="dom-if" if="[[!_getLength(item, extractionDataProperty)]]">
                    <div class="padded" secondary>None</div>
                  </template>
                  <template is="dom-if" if="[[_getLength(item, extractionDataProperty)]]">
                    <template is="dom-repeat" items="[[_getList(item, extractionDataProperty)]]" as="extraction">
                      <div secondary>
                        <icon-label class$="[[_isHighlighted(extraction, extractionHighlightProperty)]]"
                          title="Open [[_getProperty(extraction, extractionTextProperty)]]"
                          icon="[[_getProperty(extraction, extractionIconProperty)]]"
                          icon-style-class="[[_getProperty(extraction, extractionStyleClassProperty)]]"
                          link="[[_getProperty(extraction, extractionLinkProperty)]]"
                          target="[[_getTarget(newTab)]]"
                          text="[[_getProperty(extraction, extractionTextProperty)]]">
                        </icon-label>
                        <iron-icon icon="fa:circle"
                          class$="confidence-icon [[_getConfidenceLevelClass(extraction)]]"
                          title$="[[_getConfidenceLevelText(extraction)]]">
                        </iron-icon>
                        <template is="dom-if" if="[[_getProperty(extraction, extractionAnnotateProperty)]]">
                          <annotate-record class="tiny-icon"
                            annotation-manager="[[annotationManager]]"
                            client="[[client]]"
                            item-id="[[_getProperty(extraction, extractionIdProperty)]]"
                            item-type="[[_getTypeTextWithProperty(extraction, extractionTypeProperty)]]"
                            noink>
                          </annotate-record>
                        </template>
                      </div>
                    </template>
                  </template>
                </div>
              </template>
            </div>

            <button-link
              link="[[_getProperty(item, itemLinkProperty)]]"
              target="[[_getTarget(newTab)]]"
              text="open [[_getTypeText(type)]]"
              show>
            </button-link>

            <template is="dom-if" if="[[images]]">
              <image-gallery
                images="[[images]]"
                image-link-property="[[imageLinkProperty]]"
                image-source-property="[[imageSourceProperty]]"
                new-tab="[[newTab]]"
                blur="[[blur]]">
              </image-gallery>
            </template>
          </paper-material>
        </div>
      </iron-collapse>
    </template>
  </template>

  <script>
  (function() {
    'use strict';
    /* globals _ */

    Polymer({
      is: 'single-record',

      properties: {
        /**
         * The highlighted text (if any).
         */
        highlightedText: {
          type: String,
          value: ''
        },

        /**
         * Whether the record is high risk.
         */
        highRisk: {
          type: Boolean,
          value: false
        },

        /**
         * The icon.
         */
        icon: {
          type: String,
          value: ''
        },

        /**
         * The link.
         */
        link: {
          type: String,
          value: ''
        },

        /**
         * The rank.
         */
        rank: {
          type: Number,
          value: 0
        },

        /**
         * The style class.
         */
        styleClass: {
          type: String,
          value: ''
        },

        /**
         * The text.
         */
        text: {
          type: String,
          value: ''
        },

        /**
         * The type.
         */
        type: {
          type: String,
          value: ''
        },

        /**
         * The extractions to show in the header.
         */
        headExtractions: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * The extractions to show in the body.
         */
        bodyExtractions: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * The property for whether to annotate an item in the extraction data.
         */
        extractionAnnotateProperty: {
          type: String,
          value: 'annotate'
        },

        /**
         * The property for the data in the extractions.
         */
        extractionDataProperty: {
          type: String,
          value: 'data'
        },

        /**
         * The property for the highlight status of each item in the extraction data.
         */
        extractionHighlightProperty: {
          type: String,
          value: 'highlight'
        },

        /**
         * The property for the icon of each item in the extraction data.
         */
        extractionIconProperty: {
          type: String,
          value: 'icon'
        },

        /**
         * The property for the ID of each item in the extraction data.
         */
        extractionIdProperty: {
          type: String,
          value: 'id'
        },

        /**
         * The property for the link of each item in the extraction data.
         */
        extractionLinkProperty: {
          type: String,
          value: 'link'
        },

        /**
         * The property for the name in the extractions.
         */
        extractionNameProperty: {
          type: String,
          value: 'name'
        },

        /**
         * The property for the style class of each item in the extraction data.
         */
        extractionStyleClassProperty: {
          type: String,
          value: 'styleClass'
        },

        /**
         * The property for the text of each item in the extraction data.
         */
        extractionTextProperty: {
          type: String,
          value: 'text'
        },

        /**
         * The property for the type of each item in the extraction data.
         */
        extractionTypeProperty: {
          type: String,
          value: 'type'
        },

        /**
         * The details.
         */
        details: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * The property for the highlighted text in the details.
         */
        detailHighlightedTextProperty: {
          type: String,
          value: 'highlightedText'
        },

        /**
         * The property for the link in the details.
         */
        detailLinkProperty: {
          type: String,
          value: 'link'
        },

        /**
         * The property for the name in the details.
         */
        detailNameProperty: {
          type: String,
          value: 'name'
        },

        /**
         * The property for the text in the details.
         */
        detailTextProperty: {
          type: String,
          value: 'text'
        },

        /**
         * The images.
         */
        images: {
          notify: true,
          type: Array
        },

        /**
         * The property for the link in the images.
         */
        imageLinkProperty: {
          type: String,
          value: 'link'
        },

        /**
         * The property for the source in the images.
         */
        imageSourceProperty: {
          type: String,
          value: 'source'
        },

        imageAggregationField: {
          type: String
        },

        imageAggregationName: {
          type: String
        },

        imageIndexName: {
          type: String
        },

        imageIndexType: {
          type: String
        },

        imageQueryField: {
          type: String
        },

        imageTransformFunction: {
          type: Object
        },

        /**
         * The annotation manager.
         */
        annotationManager: {
          type: Object
        },

        /**
         * an instance of elasticsearch.Client which is connected to
         * an elasticsearch server
         */
        client: {
          type: Object
        },

        /**
         * Whether to blur the images.
         */
        blur: {
          type: Boolean,
          value: true,
          notify: true
        },

        /**
         * The highlight tags.
         */
        highlightTags: {
          type: String,
          value: 'em'
        },

        /**
         * Whether to open a link in a new tab.
         */
        newTab: {
          type: Boolean,
          value: false
        },

        /**
         * Whether a notification query is being viewed and the notification date associated with that query.
         */
        notificationQueryDate: {
          type: Object,
          notify: true
        },

        /**
         * Whether the user is hovering over the record.
         */
        _hovering: {
          type: Boolean,
          value: false
        },

        /**
         * The source for the iron-image in the record header.
         */
        _imageSource: {
          type: String,
          value: ''
        },

        /**
         * Whether the details are opened.
         */
        _open: {
          type: Boolean,
          value: false
        },

        /**
         * Whether details should be shown.
         */
        _showDetails: {
          type: Boolean,
          value: false
        }
      },

      observers: [
          '_updateImageSrcFromImages(images, imageSourceProperty)',
          '_updateShowDetails(details)'
      ],

      _getNewIconDivClass: function(extractions, textProperty, typeProperty, notificationQueryDate) {
        if(notificationQueryDate) {
          return _.some(extractions, function(extraction) {
            return extraction[typeProperty] === 'date' && (new Date(extraction[textProperty]).getTime() > notificationQueryDate.getTime());
          }) ? '' : 'hidden';
        }
        return 'hidden';
      },

      _getBlurStyleClass: function(blur) {
        return (blur ? 'small-blur' : '');
      },

      _getConfidenceLevelClass: function(item) {
        return item.confidence === 'strict' ? 'high-confidence' : 'low-confidence';
      },

      _getConfidenceLevelText: function(item) {
        return (item.confidence === 'strict' ? 'High' : 'Low') + ' Confidence Extraction';
      },

      _getDetailText: function(detail, highlightedTextProperty, textProperty) {
        return (detail ? (detail[highlightedTextProperty] || detail[textProperty]) : '') || 'None';
      },

      _getHeaderStyleClass: function(open) {
        return (open ? 'opened' : 'closed');
      },

      _getHeaderText: function(text, highlightedText) {
        return highlightedText || text;
      },

      _getLength: function(item, property) {
        return item && item[property] ? item[property].length : undefined;
      },

      _getList: function(item, property) {
        return item ? item[property] : [];
      },

      _getProperty: function(item, property) {
        return item ? item[property] : undefined;
      },

      _getPropertyWithColon: function(item, property) {
        return this._getProperty(item, property) + ':';
      },

      _getTarget: function(newTab) {
        return (newTab ? '_blank' : '_self');
      },

      /**
       * Returns the text for the given type.
       */
      _getTypeText: function(type) {
        if(type === 'offer') {
          return 'Ad';
        }
        if(type === 'email') {
          return 'Email Address';
        }
        if(type === 'phone') {
          return 'Telephone Number';
        }
        return type.charAt(0).toUpperCase() + type.slice(1);
      },

      /**
       * Returns the text for the type in the given item with the given property.
       */
      _getTypeTextWithProperty: function(item, typeProperty) {
        return item && item[typeProperty] ? this._getTypeText(item[typeProperty]) : '';
      },

      _isHighlighted: function(item, property) {
        if(_.isArray(item)) {
          return item.length && item[0][property] ? 'highlight' : '';
        }
        return item[property] ? 'highlight' : '';
      },

      _isDefined: function(input) {
        return !!input;
      },

      /**
       * Whether or not to show the initial iron-image element.
       */
      _showImageSpace: function(images) {
        return images ? 'show' : '';
      },

      /**
       * Sets the source for the iron-image in the record header with the first image in the given list if available.
       */
      _updateImageSrcFromImages: function(images, property) {
        if(images && images.length && property) {
          this.set('_imageSource', images[0][property]);
          this.set('_showDetails', true);
        } else if(images) {
          this.set('_imageSource', undefined);
        }
      },

      /**
       * Sets whether to show details based on the existence of the given details object.
       */
      _updateShowDetails: function(details) {
        this.set('_showDetails', (!!details && !!details.length));
      },

      endHover: function() {
        this._hovering = false;
      },

      startHover: function() {
        this._hovering = true;
      },

      /**
       * Expands or collapses this record if its item has any details and the event was not triggered by clicking on a button.
       */
      toggleRecord: function(event) {
        // Do not open a record with no details.
        if(this._showDetails) {
          var isAnnotation = (event.target.parentElement && event.target.parentElement.classList.contains('annotate-record'));
          var isButton = (event.target.localName === 'paper-button');
          var isOpenInNewButton = (event.target.parentElement && event.target.parentElement.localName === 'paper-icon-button' && event.target.parentElement.getAttribute('icon') === 'open-in-new');
          var isLink = (event.target.localName === 'a' || (event.target.parentElement && event.target.parentElement.localName === 'a'));
          // Do not open the record if the user clicked on a button or link inside the record (including the annotation).
          if(!isAnnotation && !isButton && !isOpenInNewButton && !isLink) {
            this.set('_open', !this._open);
            this.$$('#recordDetail').toggle();
          }
        }
      }
    });
  })();
  </script>
</dom-module>
