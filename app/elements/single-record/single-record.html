<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../annotate-record/annotate-record.html">
<link rel="import" href="../dig-behaviors/create-link-behavior.html">
<link rel="import" href="../dig-behaviors/data-type-behavior.html">

<dom-module id="single-record">
  <template>
    <style include="icon-styles"></style>
    <style include="icon-with-text-styles"></style>
    <style include="list-item-styles"></style>

    <style>
      :host {
        display: block;
      }

      .entity-offer-font {
        /* Hide the offer icons because users have said they are confusing */
        display: none;
      }

      annotate-record {
        /* Margin between annotation icon and text (left) / 'open' button (right). */
        margin: 0 15px;
      }

      .list-item-body {
        padding: 20px;
      }

      .list-item-body .list-item-button {
        margin: 10px 0;
      }

      .icon-with-text {
        /* Margin between descriptors. */
        margin-right: 5px;
      }
    </style>

    <div class="record">
      <paper-material class$="list-item-head [[getHeaderClass(opened)]]" clickable$="[[showDetails]]" on-tap="toggleRecord">
        <paper-icon-item>
          <iron-icon class$="list-item-icon [[getItemTypeStyleClass(item, '_type')]]" icon$="[[getItemTypeIronIcon(item, '_type')]]" item-icon></iron-icon>

          <template is="dom-if" if="[[showDetails]]">
            <iron-icon class="closed-icon" icon="icons:expand-more" item-icon></iron-icon>
            <iron-icon class="opened-icon" icon="icons:expand-less" item-icon></iron-icon>
          </template>

          <template is="dom-if" if="[[imageSource]]">
            <iron-image class$="list-item-image [[getBlurClass(blur)]]" sizing="contain" src="[[imageSource]]"></iron-image>
          </template>

          <paper-item-body two-line>
            <div title$="[[item.title]]"><strong>[[item.title]]</strong></div>

            <template is="dom-if" if="[[item.descriptors.length]]">
              <div secondary>
                <template is="dom-repeat" items="[[item.descriptors]]" as="descriptor">
                  <template is="dom-if" if="[[descriptor.id]]">
                    <a class="icon-with-text" target="[[getTarget(newTab)]]" href$="[[createIdLink(descriptor, 'type', 'id')]]" title="Open [[descriptor.text]]">
                      <iron-icon class$="iron-icon-small [[getTypeStyleClass(descriptor.type)]]" icon$="[[getTypeIronIcon(descriptor.type)]]"></iron-icon>
                      <strong>[[descriptor.text]]</strong>
                    </a>
                  </template>
                  <template is="dom-if" if="[[!descriptor.id]]">
                    <span class="icon-with-text" title="[[descriptor.text]]">
                      <iron-icon class$="iron-icon-small [[getTypeStyleClass(descriptor.type)]]" icon$="[[getTypeIronIcon(descriptor.type)]]"></iron-icon>
                      <strong>[[descriptor.text]]</strong>
                    </span>
                  </template>
                </template>
              </div>
            </template>
          </paper-item-body>

          <!-- annotation controls -->
          <template is="dom-if" if="[[showAnnotation(item)]]">
            <annotate-record client="[[client]]"
              annotation-index="[[annotationIndex]]"
              annotation-type="[[annotationType]]"
              annotation-relevant="[[annotationRelevant]]"
              item="{{item}}"
              item-type="[[getItemTypeText(item, '_type', 'true')]]"
              current-user="[[currentUser]]">
            </annotate-record>
          </template>

          <!-- secondary actions -->
          <a class="list-item-link" target="[[getTarget(newTab)]]" href$="[[createIdLink(item, '_type', '_id')]]">
            <paper-button class="list-item-button">open {{getItemTypeText(item, '_type')}}</paper-button>
          </a>
        </paper-icon-item>
      </paper-material>

      <template is="dom-if" if="[[showDetails]]">
        <iron-collapse id="recordDetail">
          <paper-material class="list-item-collapse-body list-item-body">
            <template is="dom-repeat" items="[[getDetailKeysArray(item.details)]]" as="key">
              <paper-item>
                <paper-item-body>
                  <span>
                    <strong class="capitalize">[[replaceCamelCaseText(key)]]:</strong>
                    <template is="dom-repeat" items="[[getDetailArrayForKey(item.details, key)]]" as="value">
                      <span>[[value]]</span>
                    </template>
                  </span>
                </paper-item-body>
              </paper-item>
            </template>

            <template is="dom-if" if="[[item.images]]">
              <image-viewer images="[[item.images]]" blur="[[blur]]"></image-viewer>
            </template>

            <template is="dom-if" if="[[images]]">
              <image-viewer images="[[images]]" blur="[[blur]]"></image-viewer>
            </template>

            <a class="list-item-link" target="[[getTarget(newTab)]]" href$="[[createIdLink(item, '_type', '_id')]]">
              <paper-button class="list-item-button" raised>open {{getItemTypeText(item, '_type')}}</paper-button>
            </a>
          </paper-material>
        </iron-collapse>
      </template>
    </div>
  </template>

  <script>
  (function() {
    /* globals _, DigBehaviors */
    'use strict';

    Polymer({
      is: 'single-record',

      behaviors: [DigBehaviors.CreateLinkBehavior, DigBehaviors.DataTypeBehavior],

      properties: {
        /**
         * The item represented by this single record.
         */
        item: {
          type: Object,
          notify: true
        },

        /**
         * an instance of elasticsearch.Client which is connected to
         * an elasticsearch server
         */
        client: {
          type: Object
        },

        /**
         * the annotation index (database name)
         */
        annotationIndex: {
          type: String
        },

        /**
         * the annotation type
         */
        annotationType: {
          type: String
        },

        /**
         * the annotation relevant
         */
        annotationRelevant: {
          type: String
        },

        /**
         * The source for the iron-image in the record header.
         */
        imageSource: {
          type: String,
          value: '',
          notify: true
        },

        /**
         * The image URLs for the item used instead of an image query.
         */
        images: {
          type: Array,
          notify: true
        },

        /**
         * Whether to blur the images.
         */
        blur: {
          type: Boolean,
          value: true,
          notify: true
        },

        /**
          * User currently logged in.
          */
        currentUser: {
          type: String,
          notify: true
        },

        /**
         * Whether links should be opened in new tabs.
         */
        newTab: {
          type: Object,
          value: false,
          notify: true
        },

        /**
         * Whether the details are opened.
         */
        opened: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * Whether details should be available.
         */
        showDetails: {
          type: Boolean,
          value: false,
          notify: true
        },

        error: {
          type: Object
        }
      },

      observers: [
          'updateImageSrcFromItemImages(item.images.splices)',
          'updateImageSrcFromPropertyImages(images.splices)',
          'updateShowDetails(item.details)'
      ],

      getBlurClass: function(blur) {
        return (blur ? 'small-blur' : '');
      },

      getDetailArrayForKey: function(details, key) {
        if(details && details[key]) {
          return (_.isArray(details[key]) ? details[key] : [details[key]]);
        }
        return [];
      },

      getDetailKeysArray: function(details) {
        if(details) {
          return (details._sortedKeys ? details._sortedKeys : _.keys(details)).filter(function(key) {
            return details[key];
          });
        }
        return [];
      },

      getHeaderClass: function(opened) {
        return (opened ? 'opened' : 'closed');
      },

      getTarget: function(newTab) {
        return (newTab ? '_blank' : '_self');
      },

      replaceCamelCaseText: function(key) {
        return key.replace(/([A-Z])/g, ' $1');
      },

      showAnnotation: function(item) {
        return item && item._type !== 'seller';
      },

      /**
       * Expands or collapses this record if its item has any details and the event was not triggered by clicking on a button.
       */
      toggleRecord: function(event) {
        // Do not open a record with no details.
        if(this.showDetails) {
          // Do not open the record if the user clicked on a button or link inside the record.
          if(event.target.localName !== 'paper-button' && event.target.localName !== 'paper-icon-button' && !event.target.classList.contains('paper-icon-button') &&
              event.target.localName !== 'a' && (!event.target.parentElement || event.target.parentElement.localName !== 'a')) {
            this.set('opened', !this.opened);
            this.$$('#recordDetail').toggle();
          }
        }
      },

      /**
       * Sets the source for the iron-image in the record header with the first image in the item if available.
       */
      updateImageSrcFromItemImages: function() {
        this.updateImageSrcFromImages(this.item.images);
      },

      /**
       * Sets the source for the iron-image in the record header with the first image in the given list if available.
       */
      updateImageSrcFromImages: function(images) {
        if(images && images.length) {
          this.set('imageSource', images[0].source);
          this.set('showDetails', true);
        } else if(images) {
          // Set the source to a truthy value so the gray iron-image is displayed.
          this.set('imageSource', 'blank');
        }
      },

      /**
       * Sets the source for the iron-image in the record header with the first image in the property if available.
       */
      updateImageSrcFromPropertyImages: function() {
        this.updateImageSrcFromImages(this.images);
      },

      /**
       * Sets whether to show details based on the existence of the given details object.
       */
      updateShowDetails: function(details) {
        this.set('showDetails', !!details);
      }
    });
  })();
  </script>
</dom-module>
