<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/button-link/button-link.html">
<link rel="import" href="../../bower_components/icon-label/icon-label.html">
<link rel="import" href="../../bower_components/image-gallery/image-gallery.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/modal-icon/modal-icon.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/highlighted-text/highlighted-text.html">
<link rel="import" href="../../bower_components/fontawesome-iconset/fa-all.html">
<link rel="import" href="../../styles/list-styles.html">
<link rel="import" href="../annotate-record/annotate-record.html">

<dom-module id="single-record">
  <template>
    <style include="list-styles"></style>

    <style>
      :host {
        display: block;
      }

      modal-icon ::content .entity-offer-font {
        /* Hide the offer icons because users didn't like them. */
        visibility: hidden;
      }

      .head annotate-record {
        /* Margin between the text and the annotation icon. */
        margin-left: 15px;
      }

      .descriptor {
        display: inline;
        margin-right: 20px;
      }

      icon-label {
        display: inline-block;
        margin-right: 5px;

        --icon-label-text: {
          color: var(--secondary-text-color);
        };

        --icon-label-link-hover: {
          color: var(--primary-text-color);
        };
      }

      iron-icon {
        vertical-align: text-bottom;
      }

      .iron-icon-small {
        --iron-icon-height: 18px;
        --iron-icon-width: 18px;
      }

      .hidden {
        visibility: hidden;
      }

      .show {
        visibility: visible;
      }

      .yellowgreen {
        color: yellowgreen;
      }

      .entity-page-link {
        color: var(--primary-text-color);
        text-decoration: none;
        padding: 5px;
      }

      .entity-page-link:hover {
        color: var(--secondary-text-color);
      }
    </style>

    <paper-material class$="layout horizontal flex head [[getHeaderStyleClass(open)]]" clickable$="[[showDetails]]" on-mouseover="startHover" on-mouseout="endHover" on-tap="toggleRecord">

      <template is="dom-if" if="[[!modalIconLast]]">
        <modal-icon
          icon="[[item.icon]]"
          icon-style-class="[[item.styleClass]]"
          show-icon="[[!hovering]]"
          openable="[[showDetails]]"
          open="[[open]]">
        </modal-icon>
      </template>

      <template is="dom-if" if="[[imageSource]]">
        <iron-image class$="layout vertical center-justified [[getBlurStyleClass(blur)]]" sizing="contain" src="[[imageSource]]"></iron-image>
      </template>

      <div class="layout vertical flex center-justified vertical-text">
        <div class="text" title$="[[item.name]]">
          <strong>
            <highlighted-text text="[[getHeaderText(item)]]"></highlighted-text>
          </strong>
        </div>

        <template is="dom-if" if="[[item.descriptors.length]]">
          <div class="text wrap" secondary>
            <template is="dom-repeat" items="[[item.descriptors]]" as="descriptor">
              <div class="descriptor">
                <icon-label title="Open [[descriptor.text]]"
                  icon="[[descriptor.icon]]"
                  icon-style-class="[[descriptor.styleClass]]"
                  link="[[descriptor.link]]"
                  target="[[getTarget(newTab)]]"
                  text="[[descriptor.text]]">
                </icon-label>
                <template is="dom-if" if="[[descriptor.annotate]]">
                  <iron-icon class="iron-icon-small" icon="fa:flag"></iron-icon>
                </template>
              </div>
            </template>
          </div>
        </template>
      </div>

      <template is="dom-if" if="[[_hasNotificationDate(notificationQueryDate)]]" restamp="true">
        <div class="layout vertical center-justified">
          <iron-icon class$="[[getNewIconDivClass(item, notificationQueryDate)]] yellowgreen" icon="av:fiber-new"></iron-icon>
        </div>
      </template>

      <template is="dom-if" if="[[showAnnotation(item)]]">
        <annotate-record class="layout vertical center-justified"
          client="[[client]]"
          annotation-manager="[[annotationManager]]"
          item="{{item}}"
          item-type="[[getTypeText(item, 'true')]]">
        </annotate-record>
      </template>

      <div class="layout vertical center-justified">
        <a class$="[[_showOrHide(showLinks)]] entity-page-link" href$="[[item.link]]" target="[[getTarget(newTab)]]"
          title="Open [[getTypeText(item)]]">
          <iron-icon icon="open-in-new"></iron-icon>
        </a>
      </div>

      <template is="dom-if" if="[[modalIconLast]]">
        <modal-icon
          icon="[[item.icon]]"
          icon-style-class="[[item.styleClass]]"
          show-icon="[[!hovering]]"
          openable="[[showDetails]]"
          open="[[open]]">
        </modal-icon>
      </template>

    </paper-material>

    <template is="dom-if" if="[[showDetails]]">
      <iron-collapse id="recordDetail">
        <div>
          <paper-material class="body">
            <template is="dom-repeat" items="[[item.details]]" as="detail">
              <div class="text">
                <strong>[[cleanCamelCase(detail.name)]]</strong>
                <template is="dom-if" if="[[detail.link]]">
                  <a target="_blank" href$="[[detail.link]]">[[detail.text]]</a>
                </template>
                <template is="dom-if" if="[[!detail.link]]">
                  <highlighted-text text="[[getDetailText(detail)]]"></highlighted-text>
                </template>
              </div>
            </template>

            <button-link
              link="[[item.link]]"
              target="[[getTarget(newTab)]]"
              text="open [[getTypeText(item)]]"
              show="[[showLinks]]">
            </button-link>

            <template is="dom-if" if="[[item.images]]">
              <image-gallery images="[[item.images]]" new-tab="[[newTab]]" blur="[[blur]]"></image-gallery>
            </template>

            <template is="dom-if" if="[[images]]">
              <image-gallery images="[[images]]" new-tab="[[newTab]]" blur="[[blur]]"></image-gallery>
            </template>
          </paper-material>
        </div>
      </iron-collapse>
    </template>
  </template>

  <script>
  (function() {
    'use strict';
    /* globals _ */

    Polymer({
      is: 'single-record',

      properties: {
        /**
         * The item represented by this single record.
         */
        item: {
          type: Object,
          notify: true
        },

        /**
         * an instance of elasticsearch.Client which is connected to
         * an elasticsearch server
         */
        client: {
          type: Object
        },

        /**
         * The annotation manager.
         */
        annotationManager: {
          type: Object
        },

        /**
         * The source for the iron-image in the record header.
         */
        imageSource: {
          type: String,
          value: '',
          notify: true
        },

        /**
         * The image URLs for the item used instead of an image query.
         */
        images: {
          type: Array,
          notify: true
        },

        /**
         * Whether to blur the images.
         */
        blur: {
          type: Boolean,
          value: true,
          notify: true
        },

        /**
         * Whether to open a link in a new tab.
         */
        newTab: {
          type: Boolean,
          value: false
        },

        /**
         * Whether the details are opened.
         */
        open: {
          type: Boolean,
          value: false
        },

        /**
         * Whether details should be shown.
         */
        showDetails: {
          type: Boolean,
          value: false
        },

        /**
         * Whether links should be shown.
         */
        showLinks: {
          type: Boolean,
          value: false
        },

        /**
         * Whether the user is hovering over the record.
         */
        hovering: {
          type: Boolean,
          value: false
        },

        error: {
          type: Object
        },

        /**
         * Whether a notification query is being viewed and the notification date associated with that query.
         */
        notificationQueryDate: {
          type: Object,
          notify: true
        },

        /**
         * Where to put modal icon for record (will default to being first on the left)
         */
        modalIconLast: {
          type: Boolean,
          value: false
        }
      },

      observers: [
          'updateImageSrcFromItemImages(item.images.splices)',
          'updateImageSrcFromPropertyImages(images.splices)',
          'updateShowDetails(item.details)'
      ],

      getNewIconDivClass: function(item, notificationQueryDate) {
        if(notificationQueryDate) {
          var t = _.some(item.descriptors, function(descriptor) {
            return descriptor.type === 'date' && (new Date(descriptor.text) > notificationQueryDate);
          }) ? '' : 'hidden';
          console.log('date ' + item.descriptors[0].text + ' nqd ' + notificationQueryDate + ' result ' + t);
          return t;
        }
        return 'hidden';
      },

      getBlurStyleClass: function(blur) {
        return (blur ? 'small-blur' : '');
      },

      getDetailText: function(detail) {
        return (detail ? (detail.highlightedText || detail.text) : '') || 'None';
      },

      getHeaderStyleClass: function(open) {
        return (open ? 'opened' : 'closed');
      },

      getHeaderText: function(item) {
        return item.highlightedText || item.name;
      },

      getTarget: function(newTab) {
        return (newTab ? '_blank' : '_self');
      },

      /**
       * Returns the text for the given item (and returns long text if specified).
       */
      getTypeText: function(item, longText) {
        if(item.type === 'offer') {
          return 'ad';
        }
        if(item.type === 'seller') {
          return 'email/phone cluster';
        }
        if(longText && item.type === 'email') {
          return 'email address';
        }
        if(longText && item.type === 'phone') {
          return 'telephone number';
        }
        return item.type;
      },

      _hasNotificationDate: function(date) {
        return !!date;
      },

      cleanCamelCase: function(key) {
        return (key || '').replace(/([A-Z])/g, ' $1').replace(/\w\S*/g, function(word) {
          return word.charAt(0).toUpperCase() + word.substr(1);
        }) + ':';
      },

      showAnnotation: function(item) {
        return item && item.type !== 'seller';
      },

      startHover: function() {
        this.hovering = true;
        this.showLinks = true;
      },

      endHover: function() {
        this.hovering = false;
        this.showLinks = this.open;
      },

      /**
       * Expands or collapses this record if its item has any details and the event was not triggered by clicking on a button.
       */
      toggleRecord: function(event) {
        // Do not open a record with no details.
        if(this.showDetails) {
          var isAnnotation = (event.target.parentElement && event.target.parentElement.classList.contains('annotate-record'));
          var isButton = (event.target.localName === 'paper-button');
          var isLink = (event.target.localName === 'a' || (event.target.parentElement && event.target.parentElement.localName === 'a'));
          // Do not open the record if the user clicked on a button or link inside the record (including the annotation).
          if(!isAnnotation && !isButton && !isLink) {
            this.set('open', !this.open);
            this.$$('#recordDetail').toggle();
          }
        }
      },

      /**
       * Sets the source for the iron-image in the record header with the first image in the item if available.
       */
      updateImageSrcFromItemImages: function() {
        this.updateImageSrcFromImages(this.item.images);
      },

      /**
       * Sets the source for the iron-image in the record header with the first image in the given list if available.
       */
      updateImageSrcFromImages: function(images) {
        if(images && images.length) {
          this.set('imageSource', images[0].source);
          this.set('showDetails', true);
        } else if(images) {
          // Set the source to a truthy value so the gray iron-image is displayed.
          this.set('imageSource', 'blank');
        }
      },

      /**
       * Sets the source for the iron-image in the record header with the first image in the property if available.
       */
      updateImageSrcFromPropertyImages: function() {
        this.updateImageSrcFromImages(this.images);
      },

      /**
       * Sets whether to show details based on the existence of the given details object.
       */
      updateShowDetails: function(details) {
        this.set('showDetails', (!!details && !!details.length));
      },

      /**
       * Determine whether to show or hide an element.
       */
      _showOrHide: function(show) {
        return show ? 'show' : 'hidden';
      }
    });
  })();
  </script>
</dom-module>
