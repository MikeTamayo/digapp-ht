
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../elements/elasticjs.html">

<dom-module id="elastic-date-range-filter">
  <template>
    <style>
      :host {
        display: block;
        padding-top: 10px;
      }
      iron-icon {
        --iron-icon-height: 18px;
        --iron-icon-width: 18px;
        padding-right: 5px;
      }
      paper-button.date-select {
        padding: 8px;
        text-transform: none;
        background-color: var(--paper-blue-grey-200);
        vertical-align: middle;
        @apply(--layout-flex);
        justify-content: flex-start;
      }
      .h-divider {
        height: 10px;
      }
    </style>
    <div class="vertical layout">
      <div class="horizontal layout">
        <paper-button class="date-select" on-tap="_openBeginDateDialog">
          <iron-icon icon="icons:date-range"></iron-icon>{{beginDateLabel}}
        </paper-button>
        <paper-dialog id="beginDateDialog" class="paper-date-picker-dialog" modal on-iron-overlay-closed="_closeBeginDateDialog">
          <paper-date-picker id="beginDatePicker" heading-format="MMMM Do" force-narrow></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm>OK</paper-button>
          </div>
        </paper-dialog>
      </div>
      <div class="h-divider"></div>
      <div class="horizontal layout">
        <paper-button class="date-select" on-tap="_openEndDateDialog">
          <iron-icon icon="icons:date-range"></iron-icon>{{endDateLabel}}
        </paper-button>
        <paper-dialog id="endDateDialog" class="paper-date-picker-dialog" modal on-iron-overlay-closed="_closeEndDateDialog">
          <paper-date-picker id="endDatePicker" heading-format="MMMM Do" force-narrow></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm>OK</paper-button>
          </div>
        </paper-dialog>
      </div>
    </div>
  </template>
  <script>
  (function() {
    'use strict';
    /* globals ejs, moment, _ */

    Polymer({
      is: 'elastic-date-range-filter',

      properties: {
        /**
         * Start date for the range filter.
         */
        beginDate: {
          type: Date,
          value: null,
          notify: true,
          observer: '_updateBeginDateFacetSelection'
        },
        /**
         * End date for the range filter.
         */
        endDate: {
          type: Date,
          value: null,
          notify: true,
          observer: '_updateEndDateFacetSelection'
        },
        /**
         * Format for date stored in facetSelection
         */
        facetLabelFormat: {
          type: String,
          value: 'MM/DD/YYYY'
        },
        /**
         * The resulting elasticjs filter
        */
        ejsFilter: {
          type: Object,
          notify: true,
          readOnly: true,
          value: function() {
            return ejs.MatchAllFilter();
          }
        },
        /**
         * Field to filter on in elasticsearch.
         */
        field: {
          type: String
        },
        /**
         * Contains state of date facets to persist selection state between queries.
         */
        facetSelection: {
          type: Object,
          value: function() {
            return {};
          },
          notify: true
        },
        /**
         * Label for current beginDate to use on date picker button
         */
        beginDateLabel: {
          computed: 'computeLabel("From", "begin", beginDate)'
        },
        /**
         * Label for current endDate to use on date picker button
         */
        endDateLabel: {
          computed: 'computeLabel("To", "end", endDate)'
        }
      },
      observers: [
        '_createEjsFilter(facetSelection.*)'
      ],
      /**
       * Creates a string representation of a date to display back to the
       * user in the following format: August 2, 2016
       *
       * @param {String} prefixLabel (either "From" or "To")
       * @param {String} dateIdentifier (either "begin" or "end")
       * @param {Date} date
       * @return {String} label to display, empty string if no date exists
       */
      computeLabel: function(prefixLabel, dateIdentifier, date) {
        if(date) {
          return prefixLabel + ': ' + this.formatDate(date, 'LL');
        } else {
          return 'Click to set ' + dateIdentifier + ' date';
        }
      },
      /**
       * Creates a string representation of a date to use to query
       * elasticsearch (ex: '2016-08-02T00:00:00')
       *
       * @param {Date} date
       * @return {String} date as string
       */
      formatDateToESString: function(date) {
        return moment(date).format('YYYY-MM-DD') + 'T00:00:00';
      },
      /**
       * Formats date as string according to format parameter.
       *
       * @param {Date} date
       * @param {String} format
       * @return {String} date as string
       */
      formatDate: function(date, format) {
        return moment(date).format(format);
      },
      /**
       * Updates the facetSelection object to indicate a selected filter
       * based on the parameters.
       *
       * @param {String} dateCategory - identifier to use in facetSelection object,
       * either 'Begin Date' or 'End Date'
       * @param {Date} date - date selected to display back to the user
       */
      updateFacetSelection: function(dateCategory, date) {
        this.facetSelection[dateCategory] = {
          text: this.formatDate(date, this.facetLabelFormat),
          date: this.formatDate(date, this.facetLabelFormat),
          enabled: true,
          category: dateCategory
        };
        this.notifyPath('facetSelection.*', {
          text: this.formatDate(date, this.facetLabelFormat),
          date: this.formatDate(date, this.facetLabelFormat),
          enabled: true,
          category: dateCategory
        });
      },
      /**
       * Check if two dates are equal based on their elasticsearch string represetations.
       *
       * @param {Date} dateA
       * @param {Date} dateB
       * @return {Boolean}
       */
      checkDateEquality: function(dateA, dateB) {
        return this.formatDateToESString(dateA) === this.formatDateToESString(dateB);
      },
      /**
       * Shows date picker in order to select a beginDate
       */
      _openBeginDateDialog: function() {
        this.$.beginDateDialog.toggle();
      },
      /**
       * Shows date picker in order to select an endDate
       */
      _openEndDateDialog: function() {
        this.$.endDateDialog.toggle();
      },
      /**
       * Closes the date picker used to select a beginDate. If a date
       * is confirmed and it is different from the previous beginDate,
       * update beginDate accordingly.
       *
       * @event iron-overlay-closed
       */
      _closeBeginDateDialog: function(event) {
        if(event.detail.confirmed) {
          var newDate = this.$.beginDatePicker.date;

          if(this.beginDate && this.checkDateEquality(this.beginDate, newDate)) {
            return;
          }

          this.beginDate = newDate;
        }
      },
      /**
       * Closes the date picker used to select an endDate. If a date
       * is confirmed and it is different from the previous endDate,
       * update endDate accordingly.
       *
       * @event iron-overlay-closed
       */
      _closeEndDateDialog: function(event) {
        if(event.detail.confirmed) {
          var newDate = this.$.endDatePicker.date;

          if(this.endDate && this.checkDateEquality(this.endDate, newDate)) {
            return;
          }
          this.endDate = newDate;
        }
      },
      /**
       * Sets the ejsFilter property by creating an ejs.RangeFilter object,
       * and adds the range based on the state of facetSelection.
       */
      _createEjsFilter: function() {
        var me = this;
        if(!this.field || _.isEqual(this.facetSelection, {})) {
          return;
        }

        var filter = ejs.RangeFilter(this.field);

        _.each(_.keys(me.facetSelection), function(key) {
          if(key === 'Begin Date') {
            if(me.facetSelection[key].enabled) {
              filter = filter.gte(me.formatDateToESString(me.beginDate));
            } else {
              me.beginDate = null;
            }
          } else if(key === 'End Date') {
            if(me.facetSelection[key].enabled) {
              filter = filter.lte(me.formatDateToESString(me.endDate));
            } else {
              me.endDate = null;
            }
          }
        });

        this._setEjsFilter(filter);
      },
      /**
       * Adds the beginDate to the facetSelection object by calling updateFacetSelection.
       */
      _updateBeginDateFacetSelection: function() {
        if(this.beginDate) {
          this.updateFacetSelection('Begin Date', this.beginDate);
        }
      },
      /**
       * Adds the endDate to the facetSelection object by calling updateFacetSelection.
       */
      _updateEndDateFacetSelection: function() {
        if(this.endDate) {
          this.updateFacetSelection('End Date', this.endDate);
        }
      }
    });
  })();
  </script>
</dom-module>