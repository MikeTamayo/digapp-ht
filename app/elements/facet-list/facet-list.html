<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/aggregation-dialog/aggregation-dialog.html">
<link rel="import" href="../../bower_components/aggregation-display/aggregation-display.html">
<link rel="import" href="../../bower_components/aggregation-sort/aggregation-sort.html">
<link rel="import" href="../../bower_components/elastic-error/elastic-error.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/select-all/select-all.html">
<link rel="import" href="../../bower_components/terms-transformer/terms-transformer.html">
<link rel="import" href="../../bower_components/facet-aggregation-query/facet-aggregation-query.html">
<link rel="import" href="../../styles/facet-styles.html">

<dom-module id="facet-list">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style include="facet-styles"></style>
    <style>
      :host {
        display: block;
      }

      aggregation-dialog ::content .bar,
      aggregation-display ::content .bar {
        background-color: var(--facet-background-color);
      }

      aggregation-dialog ::content .bar-count,
      aggregation-display ::content .bar-count {
        color: var(--primary-text-color);
        font-weight: normal;
      }
    </style>

    <!-- title section of facet list -->
    <div id="header" class="layout horizontal facet filter-header" title="Toggle [[title]]" on-tap="toggleList">
      <span class="flex">[[_getTitleAndCount(title, limit, _resultList.length)]]</span>
      <iron-icon id="list-status-icon" icon$="[[_getToggleIcon(opened)]]"></iron-icon>
    </div>

    <!-- subheading with different options (sorting, select all, etc) along with query for facets list -->
    <facet-aggregation-query
      name="[[name]]"
      query-builder-config="[[queryBuilderConfig]]"
      search-parameters="[[searchParameters]]"
      match-all="[[demandSearch]]"
      client="[[client]]"
      index="[[index]]"
      index-types="[[indexTypes]]"
      last-error="{{_error}}"
      loading="{{_loading}}"
      process-request="{{processRequest}}"
      field="[[aggField]]"
      count="{{_aggCount}}"
      sort-order="{{_sortOrder}}"
      result-list="{{_resultList}}"
      combine-function="[[combineFunction]]">
    </facet-aggregation-query>

    <elastic-error error="[[_error]]" message="{{_errorMessage}}"></elastic-error>

    <!-- transform the selected facets to the selected ids in the facets list and vice versa -->
    <terms-transformer
      category="[[title]]"
      list="{{_selectedList}}"
      object="{{searchParamSubset}}">
    </terms-transformer>

    <!-- display of results from aggregation query that user can check/uncheck -->
    <iron-collapse id="list" class="filter-list" opened="{{opened}}">
      <div class="horizontal layout">
        <div class="flex self-start">
          <aggregation-dialog
            text-property="[[textProperty]]"
            data="[[_resultList]]"
            dialog-header="[[_getTitleAndCount(title, _aggCount, _resultList.length)]]"
            error-message="[[_errorMessage]]"
            loading="[[_loading]]"
            header-data-name="[[title]]"
            header-counts-name="[[headerCountsName]]"
            show-checkboxes
            checkbox-name="Search"
            limit="{{_aggCount}}"
            order-by="{{_sortOrder}}"
            selected-ids="{{_selectedList}}">
          </aggregation-dialog>
        </div>
        <div class="self-end">
          <template is="dom-if" if="[[_resultList.length]]">
            <aggregation-sort order-by="{{_sortOrder}}"></aggregation-sort>
          </template>
        </div>
      </div>

      <select-all
        list="[[_resultList]]"
        loading="[[_loading]]"
        selected="{{_selectedList}}">
      </select-all>

      <aggregation-display
        small
        hide-show-more
        show-checkboxes
        checkbox-name="Search"
        text-property="[[textProperty]]"
        data="[[_resultList]]"
        limit="[[limit]]"
        error-message="[[_errorMessage]]"
        loading="[[_loading]]"
        selected-ids="{{_selectedList}}">
      </aggregation-display>
    </iron-collapse>

  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'facet-list',

      properties: {
        /**
         * The elasticsearch client.
         */
        client: {
          type: Object,
        },
        /**
         * The elasticsearch index to query.
         */
        index: {
          type: String
        },
        /**
         * The elasticsearch index types to query.
         */
        indexTypes: {
          type: Array
        },
        /**
         * Name to use in facet-aggregation-query.
         */
        name: {
          type: String
        },
        /**
         * Title to display in header.
         */
        title: {
          type: String
        },
        /**
         * The query builder config.
         */
        queryBuilderConfig: {
          type: Object
        },
        /**
         * The parameters for the query in facet-aggregation-query.
         */
        searchParameters: {
          type: Object
        },
        /**
         * Subset of searchParameters to pass along to the terms-transformer.
         */
        searchParamSubset: {
          notify: true,
          type: Object
        },
        /**
         * Function used to create final _resultList.
         */
        combineFunction: {
          type: Object
        },
        /**
         * Field to aggregate on.
         */
        aggField: {
          type: String
        },
        /**
         * Whether or not all properties are ready to create the elasticsearch query.
         */
        processRequest: {
          notify: true,
          type: Boolean
        },
        /**
         * Text property to specify for the bar chart.
         */
        textProperty: {
          type: String
        },
        /**
         * Image style class for aggregation-dialog (if any).
         */
        imageStyleClass: {
          type: String
        },
        /**
         * Max number shown in list of facets.
         */
        limit: {
          type: Number,
          value: 10
        },
        /**
         * Icon to use for when list of facets is opened.
         */
        openedIcon: {
          type: String,
          value: 'icons:expand-less'
        },
        /**
         * Icon to use for when list of facets is collapsed.
         */
        closedIcon: {
          type: String,
          value: 'icons:expand-more'
        },
        /**
         * Whether or not to perform a query when searchParameters are empty.
         */
        demandSearch: {
          type: Boolean,
          value: false
        },
        /**
         * Whether or not the list of facets is opened.
         */
        opened: {
          notify: true,
          type: Boolean,
          value: true
        },
        /**
         * Count type to pass along to aggregation-dialog for text display.
         */
        headerCountsName: {
          type: String,
          value: 'Ads'
        },
        /**
         * Resulting list of items to show in list after combine function is applied to
         * original results returned from elasticsearch.
         */
        _resultList: {
          type: Array
        },
        /**
         * List of checked items.
         */
        _selectedList: {
          type: Array
        },
        /**
         * Whether or not the query is loading.
         */
        _loading: {
          type: Boolean
        },
        /**
         * Number of results from aggregation query to obtain from elasticsearch.
         */
        _aggCount: {
          type: Number
        },
        /**
         * Error returned by elasticsearch (if any).
         */
        _error: {
          type: Object
        },
        /**
         * String representation of error message returned by elasticsearch (if any).
         */
        _errorMessage: {
          type: String
        },
        /**
         * Order in which to sort items shown in list (either default sorting of relevance or alphabetical).
         */
        _sortOrder: {
          type: String,
          value: ''
        }
      },

      toggleList: function() {
        this.$$('#list').toggle();
      },

      _getTitleAndCount: function(title, limit, count) {
        return title + (count ? (count >= limit ? ' (Top ' + limit + ')' : ' (' + count + ')') : '');
      },

      _getToggleIcon: function(opened) {
        return opened === false ? this.closedIcon : this.openedIcon;
      }
    });
  })();
  </script>
</dom-module>
