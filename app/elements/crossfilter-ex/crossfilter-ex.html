<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../bower_components/crossfilter/crossfilter.js" charset="utf-8"></script>
<dom-module id="crossfilter-ex">
  <template>
    <style>
      :host {
        display: block;
      }

    </style>
    <div class="layout horizontal">
      <bar-chart data="{{chartData}}" chart-filter="{{chartFilter}}"></bar-chart>
      <div id="mapDiv"></div>
    </div>
  </template>
  <script>
  (function() {
    'use strict';
    /* globals crossfilter */

    Polymer({
      is: 'crossfilter-ex',
      properties: {
        offers: {
          type: Array,
          notify: true,
          observer: 'offerGroupCounts'
        },
        records: {
          type: Object,
          value: function() {
            return {};
          },
          notify: true
        },
        mapData: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        chartFilter: {
          type: Object, 
          value: {begin: null, end: null},
          notify: true,
          observer: 'applyChartFilter'
        }
      },
      renderMap: function() {
        var children = Polymer.dom(this.$.mapDiv).children;
        var el = document.createElement('leaflet-wrapper');

        el.mapData = this.mapData;

        // delete previous nodes if they exist
        for(var i = 0; i < children.length; i++) {
          Polymer.dom(this.$.mapDiv).removeChild(children[i]);
        }

        Polymer.dom(this.$.mapDiv).appendChild(el);
      },
      applyChartFilter: function() {
        var self = this;
        if(self.byDate) {
          self.byDate.filter(function(d) {
            var date = new Date(d);
            var beginDate = new Date(self.chartFilter.start);
            var endDate = new Date(self.chartFilter.end);
            return date >= beginDate && date <= endDate;
          });
          self.renderMap();
        }
      },
      offerGroupCounts: function() {
        if(this.offers) {
          this.crossFilterOffers = crossfilter(this.offers);

          this.byDate = this.crossFilterOffers.dimension(function(result) {
            return result._source.validFrom.substring(0, 10);
          });

          // define custom object and override valueOf for location dimension:
          // https://github.com/square/crossfilter/wiki/API-Reference#dimension
          var Location = function(address, geo) {
            this.address = address;
            this.geo = geo;
          };

          Location.prototype.valueOf = function() {
            return this.address[0].addressLocality; 
          }; 

          this.byLocations = this.crossFilterOffers.dimension(function(result) {
            return new Location(result._source.availableAtOrFrom.address, 
              result._source.availableAtOrFrom.geo);
          });

          var Offer = function(result) {
            this.result = result;
          };

          Offer.prototype.valueOf = function() {
            return this.result._id;
          };

          this.fullOfferList = this.crossFilterOffers.dimension(function(result) {
            return new Offer(result);
          });

          this.records = {offer: this.fullOfferList.top(Infinity)};
          this.mapData = this.byLocations.group().reduceCount().all();
          this.chartData = this.byDate.group().reduceCount().all();

          this.renderMap();
        }
      }
    });
  })();
  </script>
</dom-module>
