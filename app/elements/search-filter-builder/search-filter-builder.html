<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/elastic-client-filter-builder/elastic-client-filter-builder.html">

<dom-module id="search-filter-builder">
  <template>
    <elastic-client-filter-builder id="builder"></elastic-client-filter-builder>
  </template>

  <script>
  (function() {
    /* globals _ */
    'use strict';

    Polymer({
      is: 'search-filter-builder',

      properties: {
        /**
         * The object containing the lists of terms for the annotations filters.
         */
        annotations: {
          type: Object,
          value: function() {
            return {};
          }
        },

        /**
         * Contains state of facet checkboxes
         */
        searchParameters: {
          type: Object
        },

        /**
         * Array of ejs filter objects to pass to elastic-client-search
         */
        filterList: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true,
          computed: '_buildFilterList(annotations, searchParameters.*)'
        }
      },

      _buildAndOrFilter: function(filters, name) {
        return (filters.length ? this.$$('#builder').buildFilter(this._getCombinationType(), false, this._getAggregationName(name), null, filters) : undefined);
      },

      _buildAnnotationsFilter: function(group, field, annotations) {
        var filter;
        // The showRelevant filter overrides the hideNotRelevant filter.
        if(group.showRelevant && group.showRelevant.enabled && annotations.relevant) {
          filter = this.$$('#builder').buildFilter('terms', false, '', field, annotations.relevant, true);
        } else if(group.hideNotRelevant && group.hideNotRelevant.enabled && annotations.notRelevant) {
          filter = this.$$('#builder').buildFilter('terms', true, '', field, annotations.notRelevant, true);
        }
        return filter ? filter.name('annotationsFilter') : undefined;
      },

      _buildDateRangeEjsFilter: function(group, field) {
        if(!field || _.isEqual(group, {})) {
          return;
        }

        var values = [undefined, undefined];
        _.each(_.keys(group), function(key) {
          if(key === 'Begin Date' && group[key].enabled) {
            values[1] = group[key].date;
          }
          if(key === 'End Date' && group[key].enabled) {
            values[0] = group[key].date;
          }
        });

        return this.$$('#builder').buildFilter('range', false, '', field, values);
      },

      _buildFilterList: function() {
        var me = this;
        var filters = [];

        _.each(_.keys(me.searchParameters), function(name) {
          var field = me._getFilterField(name);
          var filter;
          if(field) {
            if(name === 'annotationsFilter') {
              filter = me._buildAnnotationsFilter(me.searchParameters.annotationsFilter, field, me.annotations);
            } else if(name === 'dateCreated') {
              filter = me._buildDateRangeEjsFilter(me.searchParameters.dateCreated, field);
            } else if(name === 'hasImage') {
              filter = me._buildHasImageFilter(me.searchParameters.hasImage, field);
            } else {
              filter = me._buildAndOrFilter(me._buildTermFilterList(me.searchParameters[name], field), name);
            }
          }
          if(filter) {
            filters.push(filter);
          }
        });

        var difference = filters.length !== this.filterList.length || filters.some(function(filter, index) {
          return !_.isEqual(filter.toJSON(), me.filterList[index].toJSON());
        });
        return difference ? filters : this.filterList;
      },

      _buildHasImageFilter: function(group, field) {
        return group.Yes && group.Yes.enabled ? this.$$('#builder').buildFilter('exists', false, '', field, []) : undefined;
      },

      _buildTermFilterList: function(group, field) {
        var me = this;
        var filters = [];
        _.each(_.keys(group), function(key) {
          if(group[key].enabled) {
            filters.push(me.$$('#builder').buildFilter('term', false, '', field, key));
          }
        });
        return filters;
      },

      _getAggregationName: function(name) {
        switch(name) {
          case 'country':
            return 'country';
          case 'region':
            return 'region';
          case 'city':
            return 'city';
          case 'phone':
            return 'phone';
          case 'email':
            return 'email';
          case 'website':
            return 'publisher';
          case 'name':
            return 'name';
          case 'age':
            return 'age';
          case 'ethnicity':
            return 'ethnicity';
          case 'height':
            return 'height';
          case 'weight':
            return 'weight';
          case 'hairColor':
            return 'hairColor';
          case 'eyeColor':
            return 'eyeColor';
          case 'image':
            return 'image';
        }
        return undefined;
      },

      _getCombinationType: function() {
        return 'or';
      },

      _getFilterField: function(name) {
        switch(name) {
          case 'country':
            return 'fields.country.relaxed.key';
          case 'region':
            return 'fields.state.relaxed.key';
          case 'city':
            return 'fields.city.relaxed.key';
          case 'phone':
            return 'fields.phone.relaxed.key';
          case 'email':
            return 'fields.email.relaxed.key';
          case 'website':
            return 'tld';
          case 'name':
            return 'fields.name.relaxed.key';
          case 'age':
            return 'fields.age.relaxed.key';
          case 'ethnicity':
            return 'fields.ethnicity.relaxed.key';
          case 'height':
            return 'fields.height.relaxed.key';
          case 'weight':
            return 'fields.weight.relaxed.key';
          case 'hairColor':
            return 'fields.hair-color.relaxed.key';
          case 'eyeColor':
            return 'fields.eye-color.relaxed.key';
          case 'dateCreated':
            return 'fields.posting-date.relaxed.key';
          case 'image':
            return 'fields.image.relaxed.key';
        }
        // Remember to ignore other properties (like the text) from the search parameters so they are not included in the filters!
        return undefined;
      }
    });
  })();
  </script>
</dom-module>
