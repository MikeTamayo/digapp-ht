<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<script src="../../scripts/google-analytics.js"></script>

<dom-module id="load-user-info">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <!-- find user if record exists -- TODO: rename find-or-create-user/get-user-info -->
    <template is="dom-if" if="{{_userTypeAsArray}}">
      <elastic-client-query-builder
        type="term"
        field="username"
        values="[[username]]"
        ejs-query="{{_userQuery}}">
      </elastic-client-query-builder>

      <elastic-client-search
        client="[[client]]"
        index="[[userIndex]]"
        elastic-types="[[_userTypeAsArray]]"
        query="[[_userQuery]]"
        sort-field="dateCreated"
        sort-order="desc"
        aggregations="[]"
        filters="[]"
        results="{{_userSearchResult}}"
        last-error="{{error}}">
      </elastic-client-search>
    </template>

    <save-search
      client="[[client]]"
      username="[[username]]"
      user-id="[[_userId]]"
      existing-searches="{{_searches}}"
      search-text="[[searchText]]"
      facets="[[facets]]"
      es-request="[[esRequest]]"
      user-index="[[userIndex]]"
      user-type="[[userType]]"
      show-save-btn="[[showSaveBtn]]"
      user-record-exists="[[_userRecordExists]]">
    </save-search>

    <!-- User preferences dialog -->
    <user-preferences show-search
      preferences="{{_preferences}}"
      client="[[client]]"
      user-id="[[_userId]]"
      loading="[[loading]]"
      username="[[username]]"
      advanced-search="{{advancedSearch}}"
      blur-images="{{blurImages}}"
      search-text="{{searchText}}"
      facets="{{facets}}"
      es-request="{{esRequest}}"
      user-index="[[userIndex]]"
      user-type="[[userType]]"
      user-record-exists="[[_userRecordExists]]">
    </user-preferences>

    <!-- if no user record found, create it -->
    <elastic-create
      client="[[client]]"
      index="[[userIndex]]"
      elastic-type="[[userType]]"
      body='{{_userCreateBody}}'
      results="{{_createdUser}}"
      last-error="{{createError}}">
    </elastic-create>

  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'load-user-info',

      properties: {
        /**
         * The name of this user.
         */
        username: {
          type: String,
          notify: true,
          observer: '_usernameObserver'
        },

        /**
         * an instance of elasticsearch.Client which is connected to
         * an elasticsearch server
         */
        client: {
          type: Object
        },

        /**
         * The index where users are stored
         */
        userIndex: {
          type: String,
          notify: true
        },

        /**
         * The user type
         */
        userType: {
          type: String,
          notify: true
        },

        /**
         * Whether to show search options.
         */
        showSearch: {
          type: Boolean,
          value: false
        },

        /**
         * The text on which to search.
         */
        searchText: {
          type: String,
          notify: true
        },

        /**
         * The facets used (if any) along with searchText.
         */
        facets: {
          type: Object,
          notify: true
        },

        /**
         * Whether or not to show save search button.
         */
        showSaveBtn: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * Most recent request to elasticsearch.
         */
        esRequest: {
          type: Object,
          notify: true
        },

        /**
         * Boolean to track when associated elastic-client-search query has finished loading.
         */
        loading: {
          type: Boolean,
          notify: true
        },

        /**
         * Whether advanced search is enabled.
         */
        advancedSearch: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * Whether image blurring is enabled.
         */
        blurImages: {
          type: Boolean,
          value: true,
          notify: true
        },

        /**
         * Existing user preferences (if any).
         */
        _preferences: {
          type: Object,
          notify: true
        },
        /**
         * The query to use to find if user record exists already or needs to be created.
         */
        _userQuery: {
          type: Object
        },
        /**
         * Search result from elastic-client-search query if user record already exists.
         */
        _userSearchResult: {
          type: Object,
          observer: '_transformUserSearchResult'
        },
        /**
         * userType variable converted to an array for elastic-client-search
         */
        _userTypeAsArray: {
          type: Array,
          computed: '_computeTypeArray(userType)'
        },
        /**
         * Boolean variable to track if/when user record is created in elasticsearch.
         */
        _userRecordExists: {
          type: Boolean,
          value: undefined,
          notify: true
        },
        /**
         * Document info to pass into the elastic-create component
         */
        _userCreateBody: {
          type: Object,
          readOnly: true
        },
        /**
         * _id from existing user record (used to make updates)
         */
        _userId: {
          type: String
        },
        /**
         * Result from elastic-create.
         */
        _createdUser: {
          type: Object,
          notify: true,
          observer: '_getUserId'
        }
      },
      observers: [
        '_createUserRecord(_userRecordExists, username, advancedSearch, blurImages)'
      ],

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */

      /**
       * If user record does not exist, create it.
       */
      _createUserRecord: function() {
        var self = this;

        if(this._userRecordExists === false) {
          this._set_userCreateBody({
            username: self.username,
            advancedSearch: self.advancedSearch,
            blurImages: self.blurImages,
            dateCreated: new Date(),
            notificationFrequency: 'never',
            lastRunDate: new Date(),
            notificationDate: new Date(),
            notificationHasRun: false,
          });
        }
      },

      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      /**
       * Observes and logs changes to the username.
       */
      _usernameObserver: function() {
        /* jshint ignore:start */
        ga('set', 'dimension1', window.btoa(this.username));
        ga('set', 'userId', window.btoa(this.username));
        ga('send', 'pageview');
        /* jshint ignore:end */
      },
      /**
       * Create type array for elastic-client-search.
       */
      _computeTypeArray: function(userType) {
        return [userType];
      },
      /**
       * Get _id from user record.
       */
      _getUserId: function(userRecord) {
        if(userRecord && userRecord._id) {
          this._userRecordExists = true;
          this._userId = userRecord._id;
        }
      },
      /**
       * Populate properties based on search results.
       */
      _transformUserSearchResult: function() {
        if(this._userSearchResult) {
          if(this._userSearchResult.hits.hits.length > 0) {
            /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
            this._getUserId(this._userSearchResult.hits.hits[0]);
            this.set('_preferences', this._userSearchResult.hits.hits[0]._source);
            /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */
          } else {
            this._userRecordExists = false;
          }
        }
      }
    });
  })();
  </script>
</dom-module>
