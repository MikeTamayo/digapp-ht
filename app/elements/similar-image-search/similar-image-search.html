<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/button-action/button-action.html">
<link rel="import" href="../../bower_components/file-upload/file-upload.html">
<link rel="import" href="../../bower_components/paginated-image-gallery/paginated-image-gallery.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/image-thumbnail/image-thumbnail.html">
<link rel="import" href="../../styles/user-dialog-styles.html">
<link rel="import" href="../lodash.html">

<dom-module id="similar-image-search">
  <template>
    <style include="user-dialog-styles"></style>

    <style>
      :host {
        display: block;
      }

      .settings > .margin-top {
        margin-top: 20px;
      }

      .add-padding {
        /* Add padding to the query image so it matches the padding in the image results list. */
        padding: 10px;
      }

      .previous-searches {
        margin-left: 10px;
        width: 300px;
      }

      paginated-image-gallery {
        --paginated-image-gallery-max-height: none;
      }
    </style>

    <paper-dialog id="similarImageSearchDialog" modal entry-animation="fade-in-animation" exit-animation="fade-out-animation">
      <div class="settings layout vertical">
        <div class="layout horizontal">
          <span class="bold tall flex">Upload an Image or Enter a URL</span>
          <paper-icon-button icon="clear" dialog-confirm title="Close"></paper-icon-button>
        </div>

        <div class="divider"></div>

        <span class="text">Please enter or paste an image URL in the text box below or upload your own image.</span>

        <div class="layout horizontal">
          <span class="text right-space">Restrict search to near-duplicate results?</span>
          <span class="text right-space">[[_yesOrNo(nearDuplicates)]]</span>
          <paper-toggle-button checked="{{nearDuplicates}}" title="Restrict search to near-duplicate results"></paper-toggle-button>
        </div>

        <div class="layout horizontal">
          <paper-input class="flex right-space" label="Enter or Paste Image URL" value="{{_urlInput}}" no-label-float></paper-input>
          <button-action disabled="[[!_urlInput]]" text="Search on URL" click-listener="[[_createSearchOnUrlListener()]]"></button-action>
        </div>

        <div class="layout horizontal center">
          <file-upload
            id="fileUpload"
            accept="image/*"
            droppable
            method="POST"
            raised
            target="/uploadImage"
            on-before-upload="_clearFileList"
            on-error="_setUploadErrorMessage"
            on-success="_setRequestImageToFile">Upload Image...
          </file-upload>

          <span class="text">[[_uploadText]]</span>
        </div>

        <div class="layout horizontal">
          <button-action class="right-space" disabled="[[!_uploadedImage]]" text="Search on Upload" click-listener="[[_createSearchOnUploadListener()]]"></button-action>
          <button-action id="clearAll" class="right-space" text="Clear" click-listener="[[_createClearListener()]]"></button-action>
        </div>

        <iron-ajax
          id="xhr"
          handle-as="json"
          with-credentials="true"
          loading="{{loading}}"
          on-response="_handleImageServiceResponse">
        </iron-ajax>

        <div class="divider margin-top"></div>

        <div class="layout horizontal">
          <div class="padded layout vertical flex">
            <span class="bold tall">Your Image</span>

            <template is="dom-if" if="[[!_requestImage]]">
              <span class="text tall">None</span>
            </template>

            <template is="dom-if" if="[[_requestImage]]">
              <image-thumbnail
                class="add-padding"
                source="[[_requestImage]]"
                style-class="[[_getBlurStyleClass(blur)]]">
              </image-thumbnail>
            </template>

            <span class="bold tall">[[_getImageResultsTitle(_imageResults.length)]]</span>

            <paginated-image-gallery
              blur="[[blur]]"
              new-tab
              loading="[[loading]]"
              load-type="Similar Images"
              image-items="[[_imageResults]]"
              total-items="[[_imageResults.length]]">
            </paginated-image-gallery>
          </div>

          <div class="padded layout vertical previous-searches">
            <span class="bold tall">Your Previous Searches</span>

            <template is="dom-repeat" items="[[_previousSearches]]">
              <div class="layout horizontal center">
                <image-thumbnail
                  class="add-padding"
                  source="[[item.image]]"
                  style-class="[[_getBlurStyleClass(blur)]]">
                </image-thumbnail>

                <div class="layout vertical center flex">
                  <button-action
                    class="add-padding"
                    text="Show Results"
                    click-listener="[[_createShowImageResultsListener(item)]]">
                  </button-action>

                  <div class="add-padding">
                    <template is="dom-if" if="[[item.options.nearDuplicates]]">
                      Near-Duplicates:  ON
                    </template>

                    <template is="dom-if" if="[[!item.options.nearDuplicates]]">
                      Near-Duplicates:  OFF
                    </template>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </paper-dialog>

    <paper-dialog id="errorDialog" class="small" modal entry-animation="fade-in-animation" exit-animation="fade-out-animation">
      <div class="layout vertical">
        <div class="layout horizontal">
          <span class="bold tall flex">Image service incorrectly configured.  Please contact an administrator.</span>
          <paper-icon-button icon="clear" dialog-confirm title="Close"></paper-icon-button>
        </div>
      </div>
    </paper-dialog>
  </template>

  <script>
  (function() {
    'use strict';

    /* globals _ */
    Polymer({
      is: 'similar-image-search',

      properties: {
        /**
         * Blur class
         */
        blur: {
          type: Boolean
        },

        /**
         * Auth for the image service.
         */
        imageServiceAuth: {
          type: String
        },

        /**
         * Host for the image service.
         */
        imageServiceHost: {
          type: String
        },

        /**
         * A function that, given an image ID, returns a link for that image.
         */
        linkFunction: {
          type: Function
        },

        /**
         * Whether the search request is running.
        */
        loading: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * Whether to search for only near-duplicate similar image results.
         */
        nearDuplicates: {
          type: Boolean,
          value: true
        },

        /**
         * The threshold for similar image results.
         */
        imageThreshold: {
          type: Number,
          value: 0.6
        },

        /**
         * The list of images returned by the search request.
         */
        _imageResults: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },

        /**
         * The list of previous searches which are objects containing the request "image", the similar image "results", and "options.nearDuplicates".
         */
        _previousSearches: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * The uploaded image or URL input used by the search request.
         */
        _requestImage: {
          type: String,
          value: ''
        },

        /**
         * The image uploaded by the user.
         */
        _uploadedImage: {
          type: String,
          value: ''
        },

        /**
         * The text to show about a file upload.
         */
        _uploadText: {
          type: String,
          value: ''
        },

        /**
         * The image URL entered by the user.
         */
        _urlInput: {
          type: String,
          value: ''
        }
      },

      /**
       * Clears the uploaded file list.
       *
       * @event before-upload
       * @private
       */
      _clearFileList: function() {
        this.$$('#fileUpload').clear();
      },

      _clearImageInputAndResults: function() {
        this.set('_imageResults', []);
        this.set('_requestImage', '');
        this.set('_uploadedImage', '');
        this.set('_uploadText', '');
        this.set('_urlInput', '');
        this.$$('#fileUpload').clear();
      },

      _createSearchOnUploadListener: function() {
        var self = this;
        return {
          onClick: function() {
            self.$.xhr.body = {};
            self.$.xhr.params = {};
            if(self._uploadedImage) {
              self._requestImage = self._uploadedImage;
              self.$.xhr.body = {
                data: self._uploadedImage
              };
              if(!self.nearDuplicates) {
                self.$.xhr.body.options = '{"near_dup":0}';
              }
              self.$.xhr.contentType = 'application/x-www-form-urlencoded';
              self.$.xhr.method = 'POST';
              self._sendXhrRequest('base64');
            }
          }
        };
      },

      _createSearchOnUrlListener: function() {
        var self = this;
        return {
          onClick: function() {
            self.$.xhr.body = {};
            self.$.xhr.params = {};
            if(self._urlInput) {
              self._requestImage = self._urlInput;
              self.$.xhr.params.data = self._urlInput;
              if(!self.nearDuplicates) {
                self.$.xhr.params.options = '{"near_dup":0}';
              }
              self.$.xhr.method = 'GET';
              self._sendXhrRequest('url');
            }
          }
        };
      },

      _createClearListener: function() {
        var self = this;
        return {
          onClick: function() {
            self._clearImageInputAndResults();
          }
        };
      },

      _createShowImageResultsListener: function(search) {
        var self = this;
        return {
          onClick: function() {
            self.nearDuplicates = search.options.nearDuplicates;
            self._requestImage = search.image;
            self._imageResults = search.results;
          }
        };
      },

      _getBlurStyleClass: function(blur) {
        return (blur ? 'small-blur' : '');
      },

      _getRequestAuth: function(imageServiceAuth) {
        var auth = imageServiceAuth ? JSON.parse(imageServiceAuth) : {};
        if(!auth.user || !auth.password) {
          return '';
        }
        return 'Basic ' + btoa(auth.user + ':' + auth.password);
      },

      _getRequestHost: function(imageServiceHost, type) {
        var host = imageServiceHost ? JSON.parse(imageServiceHost) : {};
        return host[type];
      },

      /**
       * Returns the title for the similar image results.
       */
      _getImageResultsTitle: function(number) {
        return (number ? 'Top ' + number + ' ' : 'No ') + 'Similar Image Result' + (number === 1 ? '' : 's');
      },

      _handleImageServiceResponse: function(event) {
        var self = this;
        var response = event.detail.response;
        if(response.images && response.images.length) {
          /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
          var imageUrls = response.images[0].similar_images.cached_image_urls;
          var imageIds = response.images[0].similar_images.sha1;
          var imageDistances = response.images[0].similar_images.distance;
          /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

          imageDistances = imageDistances.filter(function(distance) {
            return _.toNumber(distance) < self.imageThreshold;
          });

          self._imageResults = imageUrls.map(function(url, index) {
            return {
              link: ((self.linkFunction && index < imageIds.length) ? self.linkFunction(imageIds[index]) : ''),
              source: url
            };
          }).slice(0, imageDistances.length);

          // Use this.splice to force the dom-repeat to redraw itself.  Add the latest search to the start of the list.
          self.splice('_previousSearches', 0, 0, {
            image: self._requestImage,
            results: _.cloneDeep(self._imageResults),
            options: {
              nearDuplicates: self.nearDuplicates
            }
          });
        }
      },

      _sendXhrRequest: function(type) {
        this.set('_imageResults', []);
        this.$.xhr.url = this._getRequestHost(this.imageServiceHost, type);
        this.$.xhr.headers.Authorization = this._getRequestAuth(this.imageServiceAuth);
        if(this.$.xhr.headers.Authorization && this.$.xhr.url) {
          this.$.xhr.generateRequest();
        } else {
          this.$$('#errorDialog').open();
        }
      },

      /**
       * Sets the request image to the uploaded file.
       *
       * @event success
       * @private
       */
      _setRequestImageToFile: function(event) {
        if(event.detail && event.detail.xhr && event.detail.xhr.response) {
          var response = JSON.parse(event.detail.xhr.response);
          if(!response.mimeType.startsWith('image')) {
            this._uploadText = 'Image upload failed:  Not an image file!';
            return;
          }
          this._uploadText = 'Image upload successful!';
          this._uploadedImage = 'data:' + response.mimeType + ';base64,' + response.base64;
          this._requestImage = this._uploadedImage;
        }
      },

      /**
       * Sets the upload error message.
       *
       * @event error
       * @private
       */
      _setUploadErrorMessage: function() {
        this._uploadText = 'Image upload failed!';
      },

      _yesOrNo: function(value) {
        return value ? 'Yes' : 'No';
      },

      open: function() {
        this.$$('#similarImageSearchDialog').open();
      }
    });
  })();
  </script>
</dom-module>
