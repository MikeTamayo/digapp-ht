<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>annotate-record</title>

  <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>

  <!-- Step 1: import the element to test -->
  <link rel="import" href="../elements/annotate-record/annotate-record.html">

</head>
<body>

<test-fixture id="annotate-record-fixture">
  <template>
    <annotate-record annotation-index="dig-annotations" annotation-type="annotation"
      query-template='{"query": {"query": {"bool" : {"must" : [{"term" : { "uri" : "" }},
        {"term" : { "user" : "mockUser" }}]}}}, "pathsToValues": ["query.bool.must[0].term.uri"]}'
      item='{"_id": "someidhere"}' current-user="mockUser">
    </annotate-record>
  </template>
</test-fixture>

<script>
  /* globals suite, test, assert, setup, fixture */
  /* jshint -W030 */

  suite('annotate-record tests', function() {
    var element;

    setup(function() {
      element = fixture('annotate-record-fixture');
    });

    test('annotationIndex defined correctly', function() {
      assert.equal(element.annotationIndex, 'dig-annotations');
    });

    test('annotationType defined correctly', function() {
      assert.equal(element.annotationType, 'annotation');
    });

    test('queryTemplate defined correctly', function() {
      assert.isObject(element.queryTemplate.query.query);
      assert.isArray(element.queryTemplate.pathsToValues);
    });

    test('item defined correctly', function() {
      assert.deepEqual(element.item, {_id: 'someidhere'});
    });

    test('isItemOfInterest is zero', function() {
      assert.equal(element.isItemOfInterest, 0);
    });

    test('disableButtons is true', function() {
      assert.isTrue(element.disableButtons);
    });

    test('currentUser is expected value', function() {
      assert.equal(element.currentUser, 'mockUser');
    });

    test('annotationTypeAsArray is expected value', function() {
      assert.deepEqual(element.annotationTypeAsArray, ['annotation']);
    });

    test('getAnnotationId returns correct value for both cases', function() {
      assert.equal(element.getAnnotationId({_id: 'defined'}), 'defined');
      assert.equal(element.getAnnotationId(undefined), undefined);
    });

    test('getAnnotationClass given zero returns an empty string', function() {
      assert.equal(element.getAnnotationClass(0), '');
    });

    test('getAnnotationClass given a positive number returns positive', function() {
      assert.equal(element.getAnnotationClass(1), 'positive');
    });

    test('getAnnotationClass given a negative number returns negative', function() {
      assert.equal(element.getAnnotationClass(-1), 'negative');
    });

    test('getAnnotationLabel returns non-empty strings', function() {
      assert.isString(element.getAnnotationLabel(0));
      assert.isTrue(!!element.getAnnotationLabel(0));
      assert.isString(element.getAnnotationLabel(1));
      assert.isTrue(!!element.getAnnotationLabel(1));
      assert.isString(element.getAnnotationLabel(-1));
      assert.isTrue(!!element.getAnnotationLabel(-1));
    });

    test('getValuesForQuery returns item._id and currentUser in an array', function() {
      assert.deepEqual(element.getValuesForQuery(element.item, element.currentUser), ['someidhere', 'mockUser']);
    });

    test('isSelected given equal values returns selected', function() {
      assert.equal(element.isSelected(1, 1), 'selected');
      assert.equal(element.isSelected(0, 0), 'selected');
      assert.equal(element.isSelected(-1, -1), 'selected');
    });

    test('isSelected given unequal values returns an empty string', function() {
      assert.equal(element.isSelected(1, 0), '');
      assert.equal(element.isSelected(0, 1), '');
      assert.equal(element.isSelected(0, -1), '');
      assert.equal(element.isSelected(-1, 0), '');
      assert.equal(element.isSelected(1, -1), '');
      assert.equal(element.isSelected(-1, 1), '');
    });

    test('openDropdownMenu shows the dropdown menu', function() {
      assert.equal(element.$.dropdownMenu.getAttribute('aria-hidden'), 'true');
      element.openDropdownMenu();
      assert.isNull(element.$.dropdownMenu.getAttribute('aria-hidden'));
    });

    test('buildAnnotationQuery replaces appropriate values in queryTemplate', function() {
      var queryToUse = element.buildAnnotationQuery(element.item, element.queryTemplate, element.currentUser);

      assert.equal(queryToUse.query.bool.must[0].term.uri, element.item._id);
      assert.equal(queryToUse.query.bool.must[1].term.user, element.currentUser);
    });

    test('buildAnnotationQuery returns undefined if an argument is undefined or if item is empty', function() {
      var undefinedItem = element.buildAnnotationQuery(undefined, element.queryTemplate, element.currentUser);
      var emptyItem = element.buildAnnotationQuery({}, element.queryTemplate);

      assert.isUndefined(undefinedItem);
      assert.isUndefined(emptyItem);
    });

    test('buildAnnotationQuery returns undefined if queryTemplate undefined', function() {
      var undefinedTemplate = element.buildAnnotationQuery(element.item, undefined, element.currentUser);
      var undefinedUser = element.buildAnnotationQuery(element.item, element.queryTemplate, undefined);

      assert.isUndefined(undefinedTemplate);
      assert.isUndefined(undefinedUser);
    });

    test('transformOrigResult if originalSearchResult not defined', function() {
      element.transformOrigResult();

      assert.isNull(element.annotationResult);
      assert.equal(element.isItemOfInterest, 0);
      assert.isTrue(element.disableButtons);
    });

    test('transformOrigResult if originalSearchResult not found', function() {
      element.originalSearchResult = {hits: {hits: []}};
      element.transformOrigResult();

      assert.isNull(element.annotationResult);
      assert.equal(element.isItemOfInterest, 0);
      assert.isFalse(element.disableButtons);
    });

    test('saveAnnotation sets create body if annotationResult does not exist', function() {
      element.saveAnnotation();
      assert.deepEqual(element.annotationCreateBody, {uri: element.item._id, user: 'mockUser', interest: 0, justification: ''});
    });

    test('saveAnnotation sets create body with correct interest and justification', function() {
      element.isItemOfInterest = 1;
      element.justification = 'my justification';
      element.saveAnnotation();
      assert.deepEqual(element.annotationCreateBody, {uri: element.item._id, user: 'mockUser', interest: 1, justification: 'my justification'});
    });

    test('transformOrigResult if result found', function() {
      element.originalSearchResult = {hits: {hits: [{_id: 1, _source: {interest: 1, justification: 'my justification'}}]}};

      element.transformOrigResult();

      assert.deepEqual(element.annotationResult, {_id: 1, _source: {interest: 1, justification: 'my justification'}});
      assert.equal(element.isItemOfInterest, 1);
      assert.equal(element.justification, 'my justification');
      assert.isFalse(element.disableButtons);
    });

    test('saveAnnotation sets update body if annotationResult exists', function() {
      element.annotationResult = {_id: 1, _source: {interest: 0, justification: ''}};
      element.saveAnnotation();
      assert.deepEqual(element.annotationUpdateBody, {doc: {interest: 0, justification: ''}});
    });

    test('saveAnnotation sets update body with correct interest and justification', function() {
      element.annotationResult = {_id: 1, _source: {interest: 0, justification: ''}};
      element.isItemOfInterest = 1;
      element.justification = 'my justification';
      element.saveAnnotation();
      assert.deepEqual(element.annotationUpdateBody, {doc: {interest: 1, justification: 'my justification'}});
    });

    test('saveAnnotationAndCloseDropdownMenu sets the annotation body and hides the dropdown menu', function() {
      element.annotationResult = {_id: 1, _source: {interest: 0, justification: ''}};
      element.isItemOfInterest = 1;
      element.justification = 'my justification';
      element.saveAnnotationAndCloseDropdownMenu();
      assert.deepEqual(element.annotationUpdateBody, {doc: {interest: 1, justification: 'my justification'}});
      assert.equal(element.$.dropdownMenu.getAttribute('aria-hidden'), 'true');
    });

    test('selectPositiveAnnotation sets the interest and annotation body', function() {
      element.annotationResult = {_id: 1, _source: {interest: 0, justification: ''}};
      element.selectPositiveAnnotation();
      assert.equal(element.isItemOfInterest, 1);
      assert.deepEqual(element.annotationUpdateBody, {doc: {interest: 1, justification: ''}});
    });

    test('selectNegativeAnnotation sets the interest and annotation body', function() {
      element.annotationResult = {_id: 1, _source: {interest: 0, justification: ''}};
      element.selectNegativeAnnotation();
      assert.equal(element.isItemOfInterest, -1);
      assert.deepEqual(element.annotationUpdateBody, {doc: {interest: -1, justification: ''}});
    });

    test('selectNoAnnotation sets the interest and annotation body', function() {
      element.annotationResult = {_id: 1, _source: {interest: 1, justification: ''}};
      element.isItemOfInterest = 1;
      element.selectNoAnnotation();
      assert.equal(element.isItemOfInterest, 0);
      assert.deepEqual(element.annotationUpdateBody, {doc: {interest: 0, justification: ''}});
    });
  });
</script>

</body>
</html>
