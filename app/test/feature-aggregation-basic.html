<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>feature-aggregation</title>
  <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>
  <script src="../bower_components/test-fixture/test-fixture-mocha.js"></script>
  <link rel="import" href="../bower_components/test-fixture/test-fixture.html">
  <link rel="import" href="../elements/feature-aggregation/feature-aggregation.html">
</head>

<body>
<test-fixture id="feature-aggregation-fixture">
  <template>
    <feature-aggregation></feature-aggregation>
  </template>
</test-fixture>

<script>
  /* globals suite, setup, fixture, expect, test, flush */
  /* jshint -W030 */
  'use strict';

  suite('feature-aggregation basic tests', function() {
    var element;

    setup(function(done) {
      element = fixture('feature-aggregation-fixture');
      element.data = [{
        count: 4,
        id: 1,
        text: 'textA'
      }, {
        count: 3,
        id: 2,
        text: 'textB'
      }];
      element.showCheckboxes = true;
      flush(done);
    });

    test('properties are set correctly', function() {
      expect(element.data).to.deep.equal([{
        count: 4,
        id: 1,
        text: 'textA'
      }, {
        count: 3,
        id: 2,
        text: 'textB'
      }]);
      expect(element.countProperty).to.equal('count');
      expect(element.iconProperty).to.equal('icon');
      expect(element.idProperty).to.equal('id');
      expect(element.linkProperty).to.equal('link');
      expect(element.styleClassProperty).to.equal('styleClass');
      expect(element.textProperty).to.equal('text');
      expect(element.limit).to.equal(10);
      expect(element.headerCountsName).to.equal('');
      expect(element.headerDataName).to.equal('');
      expect(element.headerEntityName).to.equal('');
      expect(element.showCheckboxes).to.be.true;
      expect(element.showDoubleBarChart).to.be.false;
      expect(element.errorMessage).to.equal('');
      expect(element.loading).to.be.false;
      expect(element.small).to.be.false;
      expect(element.selectedIds).to.deep.equal([]);
      expect(element._maxOtherCount).to.deep.equal(0);
      expect(element._showMore).to.be.false;
    });

    test('_aggregationDisplayData is set correctly', function() {
      expect(element._aggregationDisplayData).to.be.an('Array');
      expect(element._aggregationDisplayData).to.deep.equal([{
        count: 4,
        icon: undefined,
        id: 1,
        link: undefined,
        max: 4,
        select: false,
        styleClass: undefined,
        text: 'textA'
      }, {
        count: 3,
        icon: undefined,
        id: 2,
        link: undefined,
        max: 4,
        select: false,
        styleClass: undefined,
        text: 'textB'
      }]);
    });

    test('_barChartData is set correctly', function() {
      expect(element._barChartData).to.be.an('Array');
      expect(element._barChartData).to.deep.equal([{
        count: 4,
        icon: undefined,
        id: 1,
        link: undefined,
        max: 4,
        select: false,
        styleClass: undefined,
        text: 'textA'
      }, {
        count: 3,
        icon: undefined,
        id: 2,
        link: undefined,
        max: 4,
        select: false,
        styleClass: undefined,
        text: 'textB'
      }]);
    });

    test('objects in _aggregationDisplayData are the same objects in _barChartData', function() {
      expect(element._aggregationDisplayData[0]).to.equal(element._barChartData[0]);
      expect(element._aggregationDisplayData[1]).to.equal(element._barChartData[1]);
    });

    test('changing data also changes _aggregationDisplayData', function() {
      element.data = [{
        count: 2,
        id: 3,
        max: 2,
        text: 'textC'
      }];
      expect(element._aggregationDisplayData).to.be.an('Array');
      expect(element._aggregationDisplayData).to.deep.equal([{
        count: 2,
        icon: undefined,
        id: 3,
        link: undefined,
        max: 2,
        select: false,
        styleClass: undefined,
        text: 'textC'
      }]);
    });

    test('changing data also changes _barChartData', function() {
      element.data = [{
        count: 2,
        id: 3,
        max: 2,
        text: 'textC'
      }];
      expect(element._barChartData).to.be.an('Array');
      expect(element._barChartData).to.deep.equal([{
        count: 2,
        icon: undefined,
        id: 3,
        link: undefined,
        max: 2,
        select: false,
        styleClass: undefined,
        text: 'textC'
      }]);
    });

    test('does show a horizontal-bar-chart element', function() {
      expect(element.$$('horizontal-bar-chart')).to.exist;
      expect(element.$$('horizontal-bar-chart').data).to.deep.equal([{
        count: 4,
        icon: undefined,
        id: 1,
        link: undefined,
        max: 4,
        select: false,
        styleClass: undefined,
        text: 'textA'
      }, {
        count: 3,
        icon: undefined,
        id: 2,
        link: undefined,
        max: 4,
        select: false,
        styleClass: undefined,
        text: 'textB'
      }]);
      expect(element.$$('horizontal-bar-chart').checkboxName).to.equal('Filter');
      expect(element.$$('horizontal-bar-chart').selectedIds).to.deep.equal([]);
      expect(element.$$('horizontal-bar-chart').showCheckboxes).to.be.true;
    });

    test('does not show a double-bar-chart element', function() {
      expect(element.$$('double-bar-chart')).to.not.exist;
    });

    test('does show a status-text element', function() {
      expect(element.$$('status-text')).to.exist;
      expect(element.$$('status-text').count).to.equal(2);
      expect(element.$$('status-text').error).to.equal('');
      expect(element.$$('status-text').loading).to.be.false;
      expect(element.$$('status-text').getAttribute('empty')).to.equal('None');
    });

    test('does not show a header', function() {
      expect(element.$$('#header')).to.not.exist;
    });

    test('_getBarChartStyleClass does return correctly', function() {
      expect(element._getBarChartStyleClass).to.be.a('Function');
      expect(element._getBarChartStyleClass(false)).to.equal('');
      expect(element._getBarChartStyleClass(true)).to.equal('small');
    });

    test('_getHeaderStyleClass does return correctly if small=false', function() {
      expect(element._getHeaderStyleClass).to.be.a('Function');
      expect(element._getHeaderStyleClass(0, false)).to.equal('');
      expect(element._getHeaderStyleClass(1, false)).to.equal('');
      expect(element._getHeaderStyleClass(2, false)).to.equal('');
      expect(element._getHeaderStyleClass(20, false)).to.equal('');
      expect(element._getHeaderStyleClass(21, false)).to.equal('scroll-margin');
      expect(element._getHeaderStyleClass(99, false)).to.equal('scroll-margin');
    });

    test('_getHeaderStyleClass does return correctly if small=true', function() {
      expect(element._getHeaderStyleClass).to.be.a('Function');
      expect(element._getHeaderStyleClass(0, true)).to.equal('');
      expect(element._getHeaderStyleClass(1, true)).to.equal('');
      expect(element._getHeaderStyleClass(2, true)).to.equal('');
      expect(element._getHeaderStyleClass(11, true)).to.equal('');
      expect(element._getHeaderStyleClass(12, true)).to.equal('scroll-margin');
      expect(element._getHeaderStyleClass(99, true)).to.equal('scroll-margin');
    });

    test('_getCountsHeader does return correctly', function() {
      expect(element._getCountsHeader).to.be.a('Function');
      expect(element._getCountsHeader('Co-occurring', '', '')).to.equal('Co-occurring');
      expect(element._getCountsHeader('Co-occurring', 'Foo', '')).to.equal('Foo Co-occurring');
      expect(element._getCountsHeader('Co-occurring', '', 'Bar')).to.equal('Co-occurring With Bar');
      expect(element._getCountsHeader('Co-occurring', 'Foo', 'Bar')).to.equal('Foo Co-occurring With Bar');
      expect(element._getCountsHeader('Not Co-occurring', '')).to.equal('Not Co-occurring');
      expect(element._getCountsHeader('Not Co-occurring', 'Foo')).to.equal('Foo Not Co-occurring');
    });
  });

  suite('feature-aggregation with properties tests', function() {
    var element;

    setup(function(done) {
      element = fixture('feature-aggregation-fixture');
      element.countProperty = 'number';
      element.iconProperty = 'symbol';
      element.idProperty = 'uuid';
      element.linkProperty = 'webURL';
      element.styleClassProperty = 'cssClass';
      element.textProperty = 'name';
      element.limit = 2;
      element.small = true;
      element.headerCountsName = 'My Counts';
      element.headerDataName = 'My Data';
      element.headerEntityName = 'My Entity';
      element.showCheckboxes = true;
      element.checkboxName = 'Checkbox';
      element.data = [{
        uuid: 1,
        cssClass: 'styleClassA',
        name: 'textA',
        number: 4,
        symbol: 'iconA',
        webURL: 'linkA'
      }, {
        uuid: 2,
        cssClass: 'styleClassB',
        name: 'textB',
        number: 3,
        symbol: 'iconB',
        webURL: 'linkB'
      }, {
        uuid: 3,
        cssClass: 'styleClassC',
        name: 'itemC',
        number: 2,
        symbol: 'iconC',
        webURL: 'linkC'
      }, {
        uuid: 4,
        cssClass: 'styleClassD',
        name: 'itemD',
        number: 1,
        symbol: 'iconD',
        webURL: 'linkD'
      }, {
        uuid: 5,
        cssClass: 'styleClassE',
        name: 'itemE',
        number: 1,
        symbol: 'iconE',
        webURL: 'linkE'
      }];
      flush(done);
    });

    test('properties are set correctly', function() {
      expect(element.countProperty).to.equal('number');
      expect(element.iconProperty).to.equal('symbol');
      expect(element.idProperty).to.equal('uuid');
      expect(element.linkProperty).to.equal('webURL');
      expect(element.styleClassProperty).to.equal('cssClass');
      expect(element.textProperty).to.equal('name');
      expect(element.limit).to.equal(2);
      expect(element.headerCountsName).to.equal('My Counts');
      expect(element.headerDataName).to.equal('My Data');
      expect(element.headerEntityName).to.equal('My Entity');
      expect(element.small).to.be.true;
      expect(element.errorMessage).to.equal('');
      expect(element.loading).to.be.false;
      expect(element.showCheckboxes).to.be.true;
      expect(element.showDoubleBarChart).to.be.false;
      expect(element.selectedIds).to.deep.equal([]);
      expect(element._maxOtherCount).to.deep.equal(0);
      expect(element._showMore).to.be.true;
      expect(element.data).to.deep.equal([{
        uuid: 1,
        cssClass: 'styleClassA',
        name: 'textA',
        number: 4,
        symbol: 'iconA',
        webURL: 'linkA'
      }, {
        uuid: 2,
        cssClass: 'styleClassB',
        name: 'textB',
        number: 3,
        symbol: 'iconB',
        webURL: 'linkB'
      }, {
        uuid: 3,
        cssClass: 'styleClassC',
        name: 'itemC',
        number: 2,
        symbol: 'iconC',
        webURL: 'linkC'
      }, {
        uuid: 4,
        cssClass: 'styleClassD',
        name: 'itemD',
        number: 1,
        symbol: 'iconD',
        webURL: 'linkD'
      }, {
        uuid: 5,
        cssClass: 'styleClassE',
        name: 'itemE',
        number: 1,
        symbol: 'iconE',
        webURL: 'linkE'
      }]);
    });

    test('_aggregationDisplayData is set correctly', function() {
      expect(element._aggregationDisplayData).to.be.an('Array');
      expect(element._aggregationDisplayData).to.deep.equal([{
        count: 4,
        icon: 'iconA',
        id: 1,
        link: 'linkA',
        max: 4,
        select: false,
        styleClass: 'styleClassA',
        text: 'textA'
      }, {
        count: 3,
        icon: 'iconB',
        id: 2,
        link: 'linkB',
        max: 4,
        select: false,
        styleClass: 'styleClassB',
        text: 'textB'
      }, {
        count: 2,
        icon: 'iconC',
        id: 3,
        link: 'linkC',
        max: 4,
        select: false,
        styleClass: 'styleClassC',
        text: 'itemC'
      }, {
        count: 1,
        icon: 'iconD',
        id: 4,
        link: 'linkD',
        max: 4,
        select: false,
        styleClass: 'styleClassD',
        text: 'itemD'
      }, {
        count: 1,
        icon: 'iconE',
        id: 5,
        link: 'linkE',
        max: 4,
        select: false,
        styleClass: 'styleClassE',
        text: 'itemE'
      }]);
    });

    test('_barChartData is set correctly', function() {
      expect(element._barChartData).to.be.an('Array');
      expect(element._barChartData).to.deep.equal([{
        count: 4,
        icon: 'iconA',
        id: 1,
        link: 'linkA',
        max: 4,
        select: false,
        styleClass: 'styleClassA',
        text: 'textA'
      }, {
        count: 3,
        icon: 'iconB',
        id: 2,
        link: 'linkB',
        max: 4,
        select: false,
        styleClass: 'styleClassB',
        text: 'textB'
      }]);
    });

    test('does show a horizontal-bar-chart element', function() {
      expect(element.$$('horizontal-bar-chart')).to.exist;
      expect(element.$$('horizontal-bar-chart').data).to.deep.equal([{
        count: 4,
        icon: 'iconA',
        id: 1,
        link: 'linkA',
        max: 4,
        select: false,
        styleClass: 'styleClassA',
        text: 'textA'
      }, {
        count: 3,
        icon: 'iconB',
        id: 2,
        link: 'linkB',
        max: 4,
        select: false,
        styleClass: 'styleClassB',
        text: 'textB'
      }]);
      expect(element.$$('horizontal-bar-chart').checkboxName).to.equal('Checkbox');
      expect(element.$$('horizontal-bar-chart').selectedIds).to.deep.equal([]);
      expect(element.$$('horizontal-bar-chart').showCheckboxes).to.be.true;
    });

    test('does show a horizontal-bar-chart header', function() {
      expect(element.$$('#header')).to.exist;
    });

    test('does not show a double-bar-chart element', function() {
      expect(element.$$('double-bar-chart')).to.not.exist;
    });

    test('_createShowMoreListener() does return an object', function() {
      var listener = element._createShowMoreListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
    });

    test('_createShowMoreListener().onClick() does change _barChartData and _showMore', function() {
      element._createShowMoreListener().onClick();
      expect(element._barChartData).to.be.an('Array');
      expect(element._barChartData).to.deep.equal([{
        count: 4,
        icon: 'iconA',
        id: 1,
        link: 'linkA',
        max: 4,
        select: false,
        styleClass: 'styleClassA',
        text: 'textA'
      }, {
        count: 3,
        icon: 'iconB',
        id: 2,
        link: 'linkB',
        max: 4,
        select: false,
        styleClass: 'styleClassB',
        text: 'textB'
      }, {
        count: 2,
        icon: 'iconC',
        id: 3,
        link: 'linkC',
        max: 4,
        select: false,
        styleClass: 'styleClassC',
        text: 'itemC'
      }, {
        count: 1,
        icon: 'iconD',
        id: 4,
        link: 'linkD',
        max: 4,
        select: false,
        styleClass: 'styleClassD',
        text: 'itemD'
      }, {
        count: 1,
        icon: 'iconE',
        id: 5,
        link: 'linkE',
        max: 4,
        select: false,
        styleClass: 'styleClassE',
        text: 'itemE'
      }]);
      expect(element._showMore).to.be.a('Boolean');
      expect(element._showMore).to.be.false;
    });
  });

  suite('feature-aggregation test with other counts', function() {
    var element;

    setup(function(done) {
      element = fixture('feature-aggregation-fixture');
      element.showCheckboxes = true;
      element.showDoubleBarChart = true;
      element.data = [{
        count: 4,
        icon: 'iconA',
        id: 1,
        link: 'linkA',
        styleClass: 'styleClassA',
        text: 'textA'
      }, {
        count: 3,
        id: 2,
        text: 'textB'
      }];
      element.headerDataName = 'My Data';
      flush(done);
    });

    test('properties are set correctly', function() {
      expect(element.data).to.deep.equal([{
        count: 4,
        icon: 'iconA',
        id: 1,
        link: 'linkA',
        styleClass: 'styleClassA',
        text: 'textA'
      }, {
        count: 3,
        id: 2,
        text: 'textB'
      }]);
      expect(element.countProperty).to.equal('count');
      expect(element.iconProperty).to.equal('icon');
      expect(element.idProperty).to.equal('id');
      expect(element.linkProperty).to.equal('link');
      expect(element.styleClassProperty).to.equal('styleClass');
      expect(element.textProperty).to.equal('text');
      expect(element.limit).to.equal(10);
      expect(element.headerCountsName).to.equal('');
      expect(element.headerDataName).to.equal('My Data');
      expect(element.headerEntityName).to.equal('');
      expect(element.showCheckboxes).to.be.true;
      expect(element.showDoubleBarChart).to.be.true;
      expect(element.errorMessage).to.equal('');
      expect(element.loading).to.be.false;
      expect(element.small).to.be.false;
      expect(element.selectedIds).to.deep.equal([]);
      expect(element._maxOtherCount).to.deep.equal(0);
      expect(element._showMore).to.be.false;
    });

    test('does show a double-bar-chart element', function() {
      expect(element.$$('double-bar-chart')).to.exist;
      expect(element.$$('double-bar-chart').data).to.deep.equal([{
        count: 4,
        icon: 'iconA',
        id: 1,
        link: 'linkA',
        max: 4,
        select: false,
        styleClass: 'styleClassA',
        text: 'textA'
      }, {
        count: 3,
        icon: undefined,
        id: 2,
        link: undefined,
        max: 4,
        select: false,
        styleClass: undefined,
        text: 'textB'
      }]);
      expect(element.$$('double-bar-chart').checkboxName).to.equal('Filter');
      expect(element.$$('double-bar-chart').maxOtherCount).to.equal(0);
      expect(element.$$('double-bar-chart').selectedIds).to.deep.equal([]);
      expect(element.$$('double-bar-chart').showCheckboxes).to.be.true;
    });

    test('does show a double-bar-chart header', function() {
      expect(element.$$('#header')).to.exist;
    });

    test('does not show a horizontal-bar-chart element', function() {
      expect(element.$$('horizontal-bar-chart')).to.not.exist;
    });
  });
</script>
</body>
</html>
