<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>feature-aggregation</title>

  <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>
  <script src="../bower_components/test-fixture/test-fixture-mocha.js"></script>
  <link rel="import" href="../bower_components/test-fixture/test-fixture.html">

  <!-- Step 1: import the element to test -->
  <link rel="import" href="../elements/feature-aggregation/feature-aggregation.html">

</head>
<body>

<test-fixture id="feature-aggregation-fixture">
  <template>
    <feature-aggregation></feature-aggregation>
  </template>
</test-fixture>

<script>
  /* globals suite, setup, fixture, expect, test */
  /* jshint -W030 */
  'use strict';

  suite('feature-aggregation basic tests', function() {
    var component;

    setup(function() {
      component = fixture('feature-aggregation-fixture');
      component.data = [{
        id: 1,
        text: 'a',
        count: 4
      }, {
        id: 2,
        text: 'b',
        count: 3
      }];
    });

    test('data is set correctly', function() {
      expect(component.data).to.be.an('array');
      expect(component.data).to.deep.equal([{
        id: 1,
        text: 'a',
        count: 4
      }, {
        id: 2,
        text: 'b',
        count: 3
      }]);
    });

    test('properties are set to defaults correctly', function() {
      expect(component.dataId).to.be.a('string');
      expect(component.dataId).to.equal('id');
      expect(component.dataText).to.be.a('string');
      expect(component.dataText).to.equal('text');
      expect(component.dataCount).to.be.a('string');
      expect(component.dataCount).to.equal('count');
      expect(component.limit).to.be.a('number');
      expect(component.limit).to.equal(10);
      expect(component.loading).to.be.a('boolean');
      expect(component.loading).to.be.false;
      expect(component.showMore).to.be.a('boolean');
      expect(component.showMore).to.be.false;
      expect(component.showLink).to.be.a('boolean');
      expect(component.showLink).to.be.false;
      expect(component.linkType).to.equal(undefined);
      expect(component.linkField).to.equal(undefined);
      expect(component.small).to.be.a('boolean');
      expect(component.small).to.be.false;
      expect(component.featureTitle).to.be.a('string');
      expect(component.featureTitle).to.equal('Features');
      expect(component.filterValues).to.be.an('array');
      expect(component.filterValues).to.deep.equal([]);
      expect(component.selectedItems).to.be.an('array');
      expect(component.selectedItems).to.deep.equal([]);
    });

    test('displayAggregations is set correctly', function() {
      expect(component.displayAggregations).to.be.an('array');
      expect(component.displayAggregations).to.deep.equal([{
        id: 1,
        text: 'a',
        count: 4
      }, {
        id: 2,
        text: 'b',
        count: 3
      }]);
    });

    test('changing data also changes displayAggregations', function() {
      component.data = [{
        id: 3,
        text: 'c',
        count: 2
      }];
      expect(component.displayAggregations).to.be.an('array');
      expect(component.displayAggregations).to.deep.equal([{
        id: 3,
        text: 'c',
        count: 2
      }]);
    });

    test('doesOverflow returns overflow if data length is greater than limit', function() {
      expect(component.doesOverflow(3, 2)).to.equal('overflow');
    });

    test('doesOverflow returns empty if data length is less than or equal to limit', function() {
      expect(component.doesOverflow(0, 2)).to.equal('');
      expect(component.doesOverflow(1, 2)).to.equal('');
      expect(component.doesOverflow(2, 2)).to.equal('');
    });

    test('doesShowNoAggregationsText returns true with no data', function() {
      expect(component.doesShowNoAggregationsText(0, false)).to.be.true;
    });

    test('doesShowNoAggregationsText returns false if loading or with data', function() {
      expect(component.doesShowNoAggregationsText(0, true)).to.be.false;
      expect(component.doesShowNoAggregationsText(2, false)).to.be.false;
    });

    test('isSmall returns small if small is true', function() {
      expect(component.isSmall(true)).to.equal('small');
    });

    test('isSmall returns empty if small is false', function() {
      expect(component.isSmall(false)).to.equal('');
    });

    test('getProperty returns correct values', function() {
      var item = {
        id: 1,
        text: 'a',
        count: 4
      };
      expect(component.getProperty(item, component.dataId)).to.equal(1);
      expect(component.getProperty(item, component.dataText)).to.equal('a');
      expect(component.getProperty(item, component.dataCount)).to.equal(4);
    });

    test('getWidth returns correct widths based on the data', function() {
      expect(component.getWidth({
        count: 4
      }, 'count')).to.equal('width: 100%;');
      expect(component.getWidth({
        count: 3
      }, 'count')).to.equal('width: 75%;');
      expect(component.getWidth({
        count: 2
      }, 'count')).to.equal('width: 50%;');
      expect(component.getWidth({
        count: 1
      }, 'count')).to.equal('width: 25%;');
    });

    test('adding selectedItems adds to filterValues', function() {
      component.selectedItems = [{
        id: 1,
        text: 'a',
        count: 4
      }];
      expect(component.filterValues).to.deep.equal([1]);
      component.selectedItems = component.data;
      expect(component.filterValues).to.deep.equal([1, 2]);
    });

    test('toggleItem selects the item', function() {
      expect(component.data[1].selected).to.be.undefined;

      component.toggleItem({
        model: {
          item: component.data[1]
        }
      });
      expect(component.data[1].selected).to.be.true;
      expect(component.selectedItems).to.deep.equal([{
        selected: true,
        id: 2,
        text: 'b',
        count: 3
      }]);
      expect(component.filterValues).to.deep.equal([2]);
    });

    test('toggleItem deselects the item', function() {
      component.data[1].selected = true;
      component.selectedItems = [component.data[1]];

      component.toggleItem({
        model: {
          item: component.data[1]
        }
      });
      expect(component.data[1].selected).to.be.false;
      expect(component.selectedItems).to.deep.equal([]);
      expect(component.filterValues).to.deep.equal([]);
    });
  });

  suite('feature-aggregation with properties tests', function() {
    var component;

    setup(function() {
      component = fixture('feature-aggregation-fixture');
      component.dataId = 'uuid';
      component.dataText = 'name';
      component.dataCount = 'number';
      component.limit = 2;
      component.small = true;
      component.featureTitle = 'Test';
      component.data = [{
        uuid: 1,
        name: 'a',
        number: 4
      }, {
        uuid: 2,
        name: 'b',
        number: 3
      }, {
        uuid: 3,
        name: 'c',
        number: 2
      }, {
        uuid: 4,
        name: 'd',
        number: 2
      }, {
        uuid: 5,
        name: 'e',
        number: 1
      }];
    });

    test('dataId, dataText, dataCount, limit, small, featureTitle, and data are set correctly', function() {
      expect(component.dataId).to.be.a('string');
      expect(component.dataId).to.equal('uuid');
      expect(component.dataText).to.be.a('string');
      expect(component.dataText).to.equal('name');
      expect(component.dataCount).to.be.a('string');
      expect(component.dataCount).to.equal('number');
      expect(component.limit).to.be.a('number');
      expect(component.limit).to.equal(2);
      expect(component.small).to.be.a('boolean');
      expect(component.small).to.be.true;
      expect(component.featureTitle).to.be.a('string');
      expect(component.featureTitle).to.equal('Test');
      expect(component.data).to.be.an('array');
      expect(component.data).to.deep.equal([{
        uuid: 1,
        name: 'a',
        number: 4
      }, {
        uuid: 2,
        name: 'b',
        number: 3
      }, {
        uuid: 3,
        name: 'c',
        number: 2
      }, {
        uuid: 4,
        name: 'd',
        number: 2
      }, {
        uuid: 5,
        name: 'e',
        number: 1
      }]);
    });

    test('properties are set to defaults correctly', function() {
      expect(component.loading).to.be.a('boolean');
      expect(component.loading).to.be.false;
      expect(component.showLink).to.be.a('boolean');
      expect(component.showLink).to.be.false;
      expect(component.linkType).to.equal(undefined);
      expect(component.linkField).to.equal(undefined);
      expect(component.filterValues).to.be.an('array');
      expect(component.filterValues).to.deep.equal([]);
      expect(component.selectedItems).to.be.an('array');
      expect(component.selectedItems).to.deep.equal([]);
    });

    test('displayAggregations is set correctly', function() {
      expect(component.displayAggregations).to.be.an('array');
      expect(component.displayAggregations).to.deep.equal([{
        uuid: 1,
        name: 'a',
        number: 4
      }, {
        uuid: 2,
        name: 'b',
        number: 3
      }]);
    });

    test('showMore is set to true', function() {
      expect(component.showMore).to.be.a('boolean');
      expect(component.showMore).to.be.true;
    });

    test('showMoreAggregations changes displayAggregations and showMore', function() {
      component.showMoreAggregations();
      expect(component.displayAggregations).to.be.an('array');
      expect(component.displayAggregations).to.deep.equal(component.data);
      expect(component.showMore).to.be.a('boolean');
      expect(component.showMore).to.be.false;
    });
  });

  suite('feature-aggregation test -- edge cases for width of bar', function() {
    var component;

    setup(function() {
      component = fixture('feature-aggregation-fixture');
      component.data = [{
        count: 300
      }, {
        count: 1
      }, {
        count: 0
      }];
    });

    test('getWidth returns correct width if calculated width is 0 but count is not', function() {
      var item = component.data[1];
      var result = component.getWidth(item, 'count');
      var calculatedWidth = Math.round((item.count / component.data[0].count) * 100);

      expect(result).to.be.a('string');
      expect(calculatedWidth).to.be.equal(0);
      expect(result).to.deep.equal('width: 1%;');
    });

    test('getWidth returns correct width if item.count is 0', function() {
      var item = component.data[2];
      var result = component.getWidth(item, 'count');
      var calculatedWidth = Math.round((item.count / component.data[0].count) * 100);

      expect(result).to.be.a('string');
      expect(calculatedWidth).to.be.equal(0);
      expect(result).to.deep.equal('width: 0%;');
    });
  });

  suite('feature-aggregation test -- if showLink enabled and linkType/linkField present', function() {
    var component;

    setup(function() {
      component = fixture('feature-aggregation-fixture');
      component.data = [{
        age: 24,
        count: 4
      }, {
        age: 18,
        count: 3
      }];
      component.showLink = true;
      component.linkType = 'provider';
      component.linkField = 'age';
    });

    test('showLink is set correctly', function() {
      expect(component.showLink).to.be.a('boolean');
      expect(component.showLink).to.be.equal(true);
    });

    test('linkType is set correctly', function() {
      expect(component.linkType).to.be.a('string');
      expect(component.linkType).to.be.equal('provider');
    });

    test('linkField is set correctly', function() {
      expect(component.linkField).to.be.a('string');
      expect(component.linkField).to.be.equal('age');
    });
  });
</script>

</body>
</html>
