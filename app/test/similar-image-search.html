<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>similar-image-search</title>
  <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>
  <script src="../bower_components/test-fixture/test-fixture-mocha.js"></script>
  <link rel="import" href="../bower_components/test-fixture/test-fixture.html">
  <link rel="import" href="../elements/similar-image-search/similar-image-search.html">
</head>

<body>
<test-fixture id="similar-image-search-fixture">
  <template>
    <similar-image-search></similar-image-search>
  </template>
</test-fixture>

<script>
  /* globals suite, test, expect, setup, fixture, flush */
  /* jshint -W030 */
  suite('<similar-image-search> default tests', function() {
    var component;

    setup(function() {
      component = fixture('similar-image-search-fixture');
      component.linkFunction = function(id) {
        return 'http://' + id;
      };
    });

    test('properties are correct default values', function() {
      expect(component.loading).to.be.false;
      expect(component.nearDuplicates).to.be.true;
      expect(component.imageThreshold).to.equal(0.6);
      expect(component._imageResults).to.deep.equal([]);
      expect(component._previousSearches).to.deep.equal([]);
      expect(component._requestImage).to.equal('');
      expect(component._uploadedImage).to.equal('');
      expect(component._uploadText).to.equal('');
      expect(component._urlInput).to.equal('');
    });

    test('does have expected elements', function() {
      expect(component.$$('paper-icon-button')).to.exist;
      expect(component.$$('#similarImageSearchDialog')).to.exist;
      expect(component.$$('#errorDialog')).to.exist;
      expect(component.$$('file-upload')).to.exist;
      expect(component.$$('file-upload').id).to.equal('fileUpload');
      expect(component.$$('iron-ajax')).to.exist;
      expect(component.$$('iron-ajax').id).to.equal('xhr');
      expect(component.$$('paginated-image-gallery')).to.exist;
    });

    test('_clearImageInputAndResults does clear input and results', function() {
      component._imageResults = [{
        link: 'link',
        source: 'source'
      }];
      component._requestImage = 'test';
      component._uploadedImage = 'test';
      component._uploadText = 'test';
      component._urlInput = 'test';
      expect(component._clearImageInputAndResults).to.be.a('Function');
      component._clearImageInputAndResults();
      expect(component._imageResults).to.deep.equal([]);
      expect(component._requestImage).to.equal('');
      expect(component._uploadedImage).to.equal('');
      expect(component._uploadText).to.equal('');
      expect(component._urlInput).to.equal('');
    });

    test('_getBlurStyleClass returns the correct values', function() {
      expect(component._getBlurStyleClass).to.be.a('Function');
      expect(component._getBlurStyleClass(true)).to.equal('small-blur');
      expect(component._getBlurStyleClass(false)).to.equal('');
    });

    test('_getRequestAuth returns the correct values', function() {
      expect(component._getRequestAuth).to.be.a('Function');
      expect(component._getRequestAuth('')).to.equal('');
      expect(component._getRequestAuth('{"user":"testUser"}')).to.equal('');
      expect(component._getRequestAuth('{"password":"testPassword"}')).to.equal('');
      expect(component._getRequestAuth('{"user":"testUser","password":"testPassword"}')).to.equal('Basic ' + btoa('testUser:testPassword'));
    });

    test('_getRequestHost returns the correct values', function() {
      expect(component._getRequestHost).to.be.a('Function');
      expect(component._getRequestHost('', '')).to.not.exist;
      expect(component._getRequestHost('{"type":"http://type"}', 'unknownType')).not.exist;
      expect(component._getRequestHost('{"uri":"http://uri"}', 'uri')).to.equal('http://uri');
      expect(component._getRequestHost('{"base64":"http://base64"}', 'base64')).to.equal('http://base64');
    });

    test('_createSearchOnUploadListener.onClick does nothing if _uploadedImage is blank', function() {
      var listener = component._createSearchOnUploadListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
      expect(component.$$('#xhr').body).to.be.empty;
    });

    test('_createSearchOnUploadListener.onClick does set request properties', function(done) {
      component._uploadedImage = 'testImage';
      component.$.xhr = {
        headers: {},
        generateRequest: function() {
          expect(component.$.xhr.body).to.be.an('Object');
          expect(component.$.xhr.body.data).to.equal('testImage');
          expect(component.$.xhr.contentType).to.equal('application/x-www-form-urlencoded');
          expect(component.$.xhr.method).to.equal('POST');
          expect(component.$.xhr.url).to.equal('testUploadHost');
          expect(component.$.xhr.headers.Authorization).to.be.a('String');
          done();
        }
      };

      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testUrlHost", "base64": "testUploadHost"}';

      var listener = component._createSearchOnUploadListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
    });

    test('_createSearchOnUrlListener.onClick does nothing if _urlInput is blank', function() {
      var listener = component._createSearchOnUrlListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
      expect(component.$$('#xhr').body).to.be.empty;
    });

    test('_createSearchOnUrlListener.onClick does set request properties', function(done) {
      component._urlInput = 'testImage';
      component.$.xhr = {
        params: {},
        headers: {},
        generateRequest: function() {
          expect(component.$.xhr.params).to.be.an('Object');
          expect(component.$.xhr.params.data).to.equal('testImage');
          expect(component.$.xhr.method).to.equal('GET');
          expect(component.$.xhr.url).to.equal('testUrlHost');
          expect(component.$.xhr.headers.Authorization).to.be.a('String');
          done();
        }
      };

      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testUrlHost", "base64": "testUploadHost"}';

      var listener = component._createSearchOnUrlListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
    });

    test('_createClearListener.onClick does clear input and results', function() {
      component._imageResults = [{
        link: 'link',
        source: 'source'
      }];
      component._requestImage = 'test';
      component._uploadedImage = 'test';
      component._urlInput = 'test';

      var listener = component._createClearListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();

      expect(component._imageResults).to.deep.equal([]);
      expect(component._requestImage).to.equal('');
      expect(component._uploadedImage).to.equal('');
      expect(component._urlInput).to.equal('');
    });

    test('_createShowImageResultsListener.onClick does set nearDuplicates, _imageResults, and _requestImage', function() {
      var listener = component._createShowImageResultsListener({
        image: 'testImage',
        results: ['testResults'],
        options: {
          nearDuplicates: false
        }
      });
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();

      expect(component.nearDuplicates).to.be.false;
      expect(component._imageResults).to.deep.equal(['testResults']);
      expect(component._requestImage).to.equal('testImage');
    });

    test('_handleImageServiceResponse with images sets _imageResults and _previousSearches', function() {
      component._requestImage = 'testImage1';
      expect(component._handleImageServiceResponse).to.be.a('Function');

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
      component._handleImageServiceResponse({
        detail: {
          response: {
            images: [{
              similar_images: {
                cached_image_urls: ['testUrl1', 'testUrl2'],
                sha1: ['testId1', 'testId2'],
                distance: ['0.1', '0.3']
              }
            }]
          }
        }
      });
      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      expect(component._imageResults).to.deep.equal([{
        link: 'http://testId1',
        source: 'testUrl1'
      }, {
        link: 'http://testId2',
        source: 'testUrl2'
      }]);
      expect(component._previousSearches).to.deep.equal([{
        image: 'testImage1',
        results: [{
          link: 'http://testId1',
          source: 'testUrl1'
        }, {
          link: 'http://testId2',
          source: 'testUrl2'
        }],
        options: {
          nearDuplicates: true
        }
      }]);
    });

    test('_handleImageServiceResponse adds to _previousSearches', function() {
      component._previousSearches = [{
        image: 'testImage0',
        results: [{
          link: 'http://testId0',
          source: 'testUrl0'
        }],
        options: {
          nearDuplicates: false
        }
      }];
      component._requestImage = 'testImage1';
      expect(component._handleImageServiceResponse).to.be.a('Function');

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
      component._handleImageServiceResponse({
        detail: {
          response: {
            images: [{
              similar_images: {
                cached_image_urls: ['testUrl1', 'testUrl2'],
                sha1: ['testId1', 'testId2'],
                distance: ['0.1', '0.3']
              }
            }]
          }
        }
      });
      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      expect(component._imageResults).to.deep.equal([{
        link: 'http://testId1',
        source: 'testUrl1'
      }, {
        link: 'http://testId2',
        source: 'testUrl2'
      }]);
      expect(component._previousSearches).to.deep.equal([{
        image: 'testImage1',
        results: [{
          link: 'http://testId1',
          source: 'testUrl1'
        }, {
          link: 'http://testId2',
          source: 'testUrl2'
        }],
        options: {
          nearDuplicates: true
        }
      }, {
        image: 'testImage0',
        results: [{
          link: 'http://testId0',
          source: 'testUrl0'
        }],
        options: {
          nearDuplicates: false
        }
      }]);
    });

    test('_handleImageServiceResponse with images sets _imageResults to images under imageThreshold', function() {
      component.imageThreshold = 0.2;
      expect(component._handleImageServiceResponse).to.be.a('Function');

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
      component._handleImageServiceResponse({
        detail: {
          response: {
            images: [{
              similar_images: {
                cached_image_urls: ['testUrl1', 'testUrl2'],
                sha1: ['testId1', 'testId2'],
                distance: ['0.1', '0.3']
              }
            }]
          }
        }
      });
      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      expect(component._imageResults).to.deep.equal([{
        link: 'http://testId1',
        source: 'testUrl1'
      }]);
    });

    test('_handleImageServiceResponse with no images clears _imageResults', function() {
      component._imageResults = [{
        link: 'link',
        source: 'source'
      }];

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
      component._handleImageServiceResponse({
        detail: {
          response: {
            images: [{
              similar_images: {
                cached_image_urls: [],
                sha1: [],
                distance: []
              }
            }]
          }
        }
      });
      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      expect(component._imageResults).to.deep.equal([]);
    });

    test('_setRequestImageToFile sets the correct values', function() {
      component._setRequestImageToFile({
        detail: {
          xhr: {
            response: '{"base64": "somebase64string", "mimeType": "image/something"}'
          }
        }
      });
      expect(component._uploadedImage).to.equal('data:image/something;base64,somebase64string');
      expect(component._uploadText).to.equal('Image upload successful!');
      expect(component._requestImage).to.equal('data:image/something;base64,somebase64string');
    });

    test('_setRequestImageToFile with non-image mime type sets the correct values', function() {
      component._setRequestImageToFile({
        detail: {
          xhr: {
            response: '{"base64": "somebase64string", "mimeType": "something/something"}'
          }
        }
      });
      expect(component._uploadedImage).to.equal('');
      expect(component._uploadText).to.equal('Image upload failed:  Not an image file!');
      expect(component._requestImage).to.equal('');
    });

    test('_setUploadErrorMessage works', function() {
      component._setUploadErrorMessage();
      expect(component._uploadText).to.equal('Image upload failed!');
    });

    test('_getImageResultsTitle returns the correct values', function() {
      expect(component._getImageResultsTitle).to.be.a('Function');
      expect(component._getImageResultsTitle()).to.equal('No Similar Image Results');
      expect(component._getImageResultsTitle(0)).to.equal('No Similar Image Results');
      expect(component._getImageResultsTitle(1)).to.equal('Top 1 Similar Image Result');
      expect(component._getImageResultsTitle(2)).to.equal('Top 2 Similar Image Results');
    });

    test('_yesOrNo returns the correct values', function() {
      expect(component._yesOrNo).to.be.a('Function');
      expect(component._yesOrNo(true)).to.equal('Yes');
      expect(component._yesOrNo(false)).to.equal('No');
    });

    test('open() opens the dialog', function(done) {
      var dialog = component.$$('#similarImageSearchDialog');
      expect(dialog.style.display).to.equal('none');
      component.open();
      flush(function() {
        expect(dialog.style.display).to.equal('');
        done();
      });
    });
  });
</script>
</body>
</html>
