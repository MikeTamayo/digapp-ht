<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>similar-image-search</title>
  <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>
  <script src="../bower_components/test-fixture/test-fixture-mocha.js"></script>
  <link rel="import" href="../bower_components/test-fixture/test-fixture.html">
  <link rel="import" href="../elements/similar-image-search/similar-image-search.html">
</head>

<body>
<test-fixture id="similar-image-search-fixture">
  <template>
    <similar-image-search></similar-image-search>
  </template>
</test-fixture>

<script>
  /* globals suite, test, expect, setup, fixture, flush */
  /* jshint -W030 */
  suite('<similar-image-search> default tests', function() {
    var component;

    setup(function() {
      component = fixture('similar-image-search-fixture');
    });

    test('properties are correct default values', function() {
      expect(component.blur).to.be.false;
      expect(component.loading).to.be.false;
      expect(component.imageThreshold).to.equal(0.5);
      expect(component._error).to.equal('');
      expect(component._hoveringImageIds).to.deep.equal([]);
      expect(component._images).to.deep.equal([]);
      expect(component._nearDuplicates).to.be.false;
      expect(component._nextInputImageId).to.equal(1);
      expect(component._previousSearches).to.deep.equal([]);
      expect(component._queryIndex).to.deep.equal(-1);
      expect(component._results).to.deep.equal([]);
      expect(component._selectedImageIds).to.deep.equal([]);
      expect(component._selectedResultsIndex).to.equal(0);
      expect(component._urlInput).to.equal('');
    });

    test('does have expected elements', function() {
      expect(component.$$('#similarImageSearchDialog')).to.exist;
      expect(component.$$('#errorDialog')).to.exist;
      expect(component.$$('file-upload')).to.exist;
      expect(component.$$('file-upload').id).to.equal('fileUpload');
      expect(component.$$('iron-ajax')).to.exist;
      expect(component.$$('iron-ajax').id).to.equal('xhr');
    });

    test('_enableSearch does return the correct values', function() {
      expect(component._enableSearch).to.be.a('Function');
      expect(component._enableSearch(false, false)).to.be.false;
      expect(component._enableSearch(true, false)).to.be.false;
      expect(component._enableSearch(false, true)).to.be.true;
      expect(component._enableSearch(true, true)).to.be.false;
    });

    test('_getInputImageLabel does return the correct values', function() {
      expect(component._getInputImageLabel).to.be.a('Function');
      expect(component._getInputImageLabel(0, 'Foo')).to.equal('#1:  Foo');
      expect(component._getInputImageLabel(1, 'Bar')).to.equal('#2:  Bar');
    });

    test('_getInputImageTitle does return the correct values', function() {
      expect(component._getInputImageTitle).to.be.a('Function');
      expect(component._getInputImageTitle(0, 'Foo')).to.equal('Click to Toggle Image #1:  Foo');
      expect(component._getInputImageTitle(1, 'Bar')).to.equal('Click to Toggle Image #2:  Bar');
    });

    test('_getImageResultsHeaderText does return the correct values', function() {
      expect(component._getImageResultsHeaderText).to.be.a('Function');
      expect(component._getImageResultsHeaderText(0, true)).to.equal('No Near-Duplicate Images');
      expect(component._getImageResultsHeaderText(1, true)).to.equal('Top 1 Near-Duplicate Image');
      expect(component._getImageResultsHeaderText(2, true)).to.equal('Top 2 Near-Duplicate Images');
      expect(component._getImageResultsHeaderText(0, false)).to.equal('No Similar Images');
      expect(component._getImageResultsHeaderText(1, false)).to.equal('Top 1 Similar Image');
      expect(component._getImageResultsHeaderText(2, false)).to.equal('Top 2 Similar Images');
    });

    test('_getImageResultsDetailText does return the correct values', function() {
      expect(component._getImageResultsDetailText).to.be.a('Function');
      expect(component._getImageResultsDetailText(0, true)).to.equal('No Near-Duplicates');
      expect(component._getImageResultsDetailText(1, true)).to.equal('1 Near-Duplicate');
      expect(component._getImageResultsDetailText(2, true)).to.equal('2 Near-Duplicates');
      expect(component._getImageResultsDetailText(0, false)).to.equal('No Images');
      expect(component._getImageResultsDetailText(1, false)).to.equal('1 Image');
      expect(component._getImageResultsDetailText(2, false)).to.equal('2 Images');
    });

    test('_getLoadingSpinnerText does return the correct values', function() {
      var images = [{
        id: 0,
        data: 'testLink',
        name: 'testLink',
        selected: true,
        type: 'Link'
      }, {
        id: 1,
        data: 'data:image/uploadType;base64,uploadBase64string',
        name: 'testFile',
        selected: true,
        type: 'File'
      }];

      expect(component._getLoadingSpinnerText).to.be.a('Function');
      expect(component._getLoadingSpinnerText(images, 0, [0])).to.equal('1 More Search Result');
      expect(component._getLoadingSpinnerText(images, 1, [1])).to.equal('1 More Search Result');
      expect(component._getLoadingSpinnerText(images, 0, [0, 1])).to.equal('2 More Search Results');
      expect(component._getLoadingSpinnerText(images, 1, [0, 1])).to.equal('1 More Search Result');
      expect(component._getLoadingSpinnerText(images, 1, [1, 0])).to.equal('2 More Search Results');
      expect(component._getLoadingSpinnerText(images, 0, [1, 0])).to.equal('1 More Search Result');
    });

    test('_getRequestAuth does return the correct values', function() {
      expect(component._getRequestAuth).to.be.a('Function');
      expect(component._getRequestAuth('')).to.equal('');
      expect(component._getRequestAuth('{"user":"testUser"}')).to.equal('');
      expect(component._getRequestAuth('{"password":"testPassword"}')).to.equal('');
      expect(component._getRequestAuth('{"user":"testUser","password":"testPassword"}')).to.equal('Basic ' + btoa('testUser:testPassword'));
    });

    test('_getRequestHost does return the correct values', function() {
      expect(component._getRequestHost).to.be.a('Function');
      expect(component._getRequestHost('', '')).to.not.exist;
      expect(component._getRequestHost('{"type":"http://type"}', 'unknownType')).not.exist;
      expect(component._getRequestHost('{"uri":"http://uri"}', 'uri')).to.equal('http://uri');
      expect(component._getRequestHost('{"base64":"http://base64"}', 'base64')).to.equal('http://base64');
    });

    test('_getSelectedImagesText does return the correct values', function() {
      expect(component._getSelectedImagesText).to.be.a('Function');
      expect(component._getSelectedImagesText(0)).to.equal('No Images Selected');
      expect(component._getSelectedImagesText(1)).to.equal('1 Image Selected');
      expect(component._getSelectedImagesText(2)).to.equal('2 Images Selected');
    });

    test('_hoverStart does set _hoveringImageIds', function() {
      expect(component._hoverStart).to.be.a('Function');
      component._hoverStart({
        model: {
          image: {
            id: 1
          }
        }
      });

      expect(component._hoveringImageIds).to.deep.equal([1]);
    });

    test('_hoverEnd does unset _hoveringImageIds', function() {
      component._hoveringImageIds = [1];
      expect(component._hoverEnd).to.be.a('Function');
      component._hoverEnd();
      expect(component._hoveringImageIds).to.deep.equal([]);
    });

    test('_ifAreEqualThenReturn does return the correct values', function() {
      expect(component._ifAreEqualThenReturn).to.be.a('Function');
      expect(component._ifAreEqualThenReturn(1, 1, 'return1')).to.equal('return1');
      expect(component._ifAreEqualThenReturn(1, 1, 'return2')).to.equal('return2');
      expect(component._ifAreEqualThenReturn(1, 2, 'return2')).to.equal('');
      expect(component._ifAreEqualThenReturn(2, 1, 'return2')).to.equal('');
      expect(component._ifAreEqualThenReturn('a', 'a', 'return3')).to.equal('return3');
      expect(component._ifAreEqualThenReturn('a', 'b', 'return3')).to.equal('');
      expect(component._ifAreEqualThenReturn('b', 'a', 'return3')).to.equal('');
      expect(component._ifAreEqualThenReturn(true, true, 'return4')).to.equal('return4');
      expect(component._ifAreEqualThenReturn(true, false, 'return4')).to.equal('');
      expect(component._ifAreEqualThenReturn(false, true, 'return4')).to.equal('');
    });

    test('_ifIsInListThenReturn does return the correct values', function() {
      expect(component._ifIsInListThenReturn).to.be.a('Function');
      expect(component._ifIsInListThenReturn([], 2, 'return1')).to.equal('');
      expect(component._ifIsInListThenReturn([1], 2, 'return1')).to.equal('');
      expect(component._ifIsInListThenReturn([2], 2, 'return1')).to.equal('return1');
      expect(component._ifIsInListThenReturn([1, 2], 2, 'return1')).to.equal('return1');
      expect(component._ifIsInListThenReturn([2, 3], 2, 'return1')).to.equal('return1');
      expect(component._ifIsInListThenReturn([1, 2, 3], 2, 'return1')).to.equal('return1');
      expect(component._ifIsInListThenReturn(['a'], 'b', 'return2')).to.equal('');
      expect(component._ifIsInListThenReturn(['b'], 'b', 'return2')).to.equal('return2');
      expect(component._ifIsInListThenReturn(['a', 'b'], 'b', 'return2')).to.equal('return2');
      expect(component._ifIsInListThenReturn(['b', 'a'], 'b', 'return2')).to.equal('return2');
    });

    test('_createInputImageObject does return the new image object', function() {
      expect(component._createInputImageObject).to.be.a('Function');

      expect(component._createInputImageObject('id', 'data', 'name', 'type', true)).to.deep.equal({
        id: 'id',
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      });

      expect(component._createInputImageObject('id2', 'data2', 'name2', 'type2', false)).to.deep.equal({
        id: 'id2',
        data: 'data2',
        name: 'name2',
        selected: false,
        type: 'type2'
      });
    });

    test('_saveInputImage does save the new image in _images', function() {
      expect(component._saveInputImage).to.be.a('Function');
      component._saveInputImage('data', 'name', 'type');
      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }]);
      expect(component._nextInputImageId).to.equal(2);
    });

    test('_saveInputImage does save the new image in the correct index of _images', function() {
      component._images = [{
        id: 1,
        data: 'data',
        name: 'a',
        selected: true,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'c',
        selected: true,
        type: 'type'
      }];
      component._nextInputImageId = 3;

      expect(component._saveInputImage).to.be.a('Function');
      component._saveInputImage('data', 'b', 'type');
      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'data',
        name: 'a',
        selected: true,
        type: 'type'
      }, {
        id: 3,
        data: 'data',
        name: 'b',
        selected: true,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'c',
        selected: true,
        type: 'type'
      }]);
      expect(component._nextInputImageId).to.equal(4);
    });

    test('_selectOrDeselectImages does update _images and _selectedImageIds if select=true', function() {
      component._images = [{
        id: 1,
        data: 'data',
        name: 'name',
        selected: false,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }];
      component._selectedImageIds = [2];

      expect(component._selectOrDeselectImages).to.be.a('Function');
      component._selectOrDeselectImages(true);
      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }]);
      expect(component._selectedImageIds).to.deep.equal([1, 2]);
    });

    test('_selectOrDeselectImages does update _images and _selectedImageIds if select=false', function() {
      component._images = [{
        id: 1,
        data: 'data',
        name: 'name',
        selected: false,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }];
      component._selectedImageIds = [2];

      expect(component._selectOrDeselectImages).to.be.a('Function');
      component._selectOrDeselectImages(false);
      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'data',
        name: 'name',
        selected: false,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'name',
        selected: false,
        type: 'type'
      }]);
      expect(component._selectedImageIds).to.deep.equal([]);
    });

    test('_updateSelectedImageIds does set _selectedImageIds', function() {
      component._selectedImageIds = [1];
      component._images = [{
        id: 1,
        data: 'data',
        name: 'name',
        selected: false,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }];

      expect(component._updateSelectedImageIds).to.be.a('Function');
      component._updateSelectedImageIds();
      expect(component._selectedImageIds).to.deep.equal([2]);
    });

    test('_updateSelectedImageIds does not set _selectedImageIds if loading', function() {
      component._images = [{
        id: 1,
        data: 'data',
        name: 'name',
        selected: false,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }];
      component.loading = true;

      expect(component._updateSelectedImageIds).to.be.a('Function');
      component._updateSelectedImageIds();
      expect(component._selectedImageIds).to.deep.equal([]);
    });

    test('_createAddUrlListener.onClick does add the image link to _images and does set _selectedImageIds', function() {
      component._urlInput = 'testLink';

      var listener = component._createAddUrlListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();

      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'testLink',
        name: 'testLink',
        selected: true,
        type: 'Link'
      }]);
      expect(component._selectedImageIds).to.deep.equal([1]);
      expect(component._urlInput).to.equal('');
    });

    test('_createAddUrlListener.onClick does not delete the previous items in _images', function() {
      component._images = [{
        id: 0,
        data: 'previousLink',
        name: 'previousLink',
        selected: true,
        type: 'Link'
      }];
      component._urlInput = 'testLink';

      var listener = component._createAddUrlListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();

      expect(component._images).to.deep.equal([{
        id: 0,
        data: 'previousLink',
        name: 'previousLink',
        selected: true,
        type: 'Link'
      }, {
        id: 1,
        data: 'testLink',
        name: 'testLink',
        selected: true,
        type: 'Link'
      }]);
      expect(component._selectedImageIds).to.deep.equal([0, 1]);
      expect(component._urlInput).to.equal('');
    });

    test('_createAddUrlListener.onClick does add multiple image links to _images', function() {
      component._urlInput = 'testLink1 testLink2\ntestLink3';

      var listener = component._createAddUrlListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();

      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'testLink1',
        name: 'testLink1',
        selected: true,
        type: 'Link'
      }, {
        id: 2,
        data: 'testLink2',
        name: 'testLink2',
        selected: true,
        type: 'Link'
      }, {
        id: 3,
        data: 'testLink3',
        name: 'testLink3',
        selected: true,
        type: 'Link'
      }]);
      expect(component._selectedImageIds).to.deep.equal([1, 2, 3]);
      expect(component._urlInput).to.equal('');
    });

    test('_sendXhrRequest does set XHR authorization headers and URL and call generateRequest if type=base64', function(done) {
      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testGETHost", "base64": "testPOSTHost"}';

      component.$.xhr = {
        generateRequest: function() {
          expect(component.$$('#errorDialog').style.display).to.equal('none');
          expect(component.$.xhr.url).to.equal('testPOSTHost');
          expect(component.$.xhr.headers.Authorization).to.be.a('String');
          expect(component.$.xhr.headers.Authorization.startsWith('Basic ')).to.be.true;
          done();
        }
      };

      expect(component._sendXhrRequest).to.be.a('Function');
      component._sendXhrRequest('base64');
    });

    test('_sendXhrRequest does set XHR authorization headers and URL and call generateRequest if type=url', function(done) {
      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testGETHost", "base64": "testPOSTHost"}';

      component.$.xhr = {
        generateRequest: function() {
          expect(component.$$('#errorDialog').style.display).to.equal('none');
          expect(component.$.xhr.url).to.equal('testGETHost');
          expect(component.$.xhr.headers.Authorization).to.be.a('String');
          expect(component.$.xhr.headers.Authorization.startsWith('Basic ')).to.be.true;
          done();
        }
      };

      expect(component._sendXhrRequest).to.be.a('Function');
      component._sendXhrRequest('url');
    });

    test('_createXhrRequest does set _queryIndex and XHR properties of image files with _nearDuplicates=true', function(done) {
      component._images = [{
        id: 1,
        data: 'testData',
        name: 'testName',
        selected: true,
        type: 'File'
      }];
      component._nearDuplicates = true;
      component._selectedImageIds = [1];

      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testGETHost", "base64": "testPOSTHost"}';

      component.$.xhr = {
        generateRequest: function() {
          expect(component._queryIndex).to.equal(0);
          expect(component.$.xhr.body).to.be.an('Object');
          expect(component.$.xhr.body.data).to.equal('testData');
          expect(component.$.xhr.body.options).to.not.exist;
          expect(component.$.xhr.contentType).to.equal('application/x-www-form-urlencoded');
          expect(component.$.xhr.method).to.equal('POST');
          expect(component.$.xhr.url).to.equal('testPOSTHost');
          expect(component.$.xhr.headers.Authorization).to.be.a('String');
          done();
        }
      };

      expect(component._createXhrRequest).to.be.a('Function');
      component._createXhrRequest(0);
    });

    test('_createXhrRequest does set _queryIndex and XHR properties of image files with _nearDuplicates=false', function(done) {
      component._images = [{
        id: 1,
        data: 'testData',
        name: 'testName',
        selected: true,
        type: 'File'
      }];
      component._nearDuplicates = false;
      component._selectedImageIds = [1];

      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testGETHost", "base64": "testPOSTHost"}';

      component.$.xhr = {
        generateRequest: function() {
          expect(component._queryIndex).to.equal(0);
          expect(component.$.xhr.body).to.be.an('Object');
          expect(component.$.xhr.body.data).to.equal('testData');
          expect(component.$.xhr.body.options).to.equal('{"near_dup":0}');
          expect(component.$.xhr.contentType).to.equal('application/x-www-form-urlencoded');
          expect(component.$.xhr.method).to.equal('POST');
          expect(component.$.xhr.url).to.equal('testPOSTHost');
          expect(component.$.xhr.headers.Authorization).to.be.a('String');
          expect(component.$.xhr.headers.Authorization.startsWith('Basic ')).to.be.true;
          done();
        }
      };

      expect(component._createXhrRequest).to.be.a('Function');
      component._createXhrRequest(0);
    });

    test('_createXhrRequest does set _queryIndex and XHR properties of image links with _nearDuplicates=true', function(done) {
      component._images = [{
        id: 1,
        data: 'testLink',
        name: 'testLink',
        selected: true,
        type: 'Link'
      }];
      component._nearDuplicates = true;
      component._selectedImageIds = [1];

      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testGETHost", "base64": "testPOSTHost"}';

      component.$.xhr = {
        generateRequest: function() {
          expect(component._queryIndex).to.equal(0);
          expect(component.$.xhr.params).to.be.an('Object');
          expect(component.$.xhr.params.data).to.equal('testLink');
          expect(component.$.xhr.params.options).to.not.exist;
          expect(component.$.xhr.method).to.equal('GET');
          expect(component.$.xhr.url).to.equal('testGETHost');
          expect(component.$.xhr.headers.Authorization).to.be.a('String');
          expect(component.$.xhr.headers.Authorization.startsWith('Basic ')).to.be.true;
          done();
        }
      };

      expect(component._createXhrRequest).to.be.a('Function');
      component._createXhrRequest(0);
    });

    test('_createXhrRequest does set _queryIndex and XHR properties of image links with _nearDuplicates=false', function(done) {
      component._images = [{
        id: 1,
        data: 'testLink',
        name: 'testLink',
        selected: true,
        type: 'Link'
      }];
      component._nearDuplicates = false;
      component._selectedImageIds = [1];

      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testGETHost", "base64": "testPOSTHost"}';

      component.$.xhr = {
        generateRequest: function() {
          expect(component._queryIndex).to.equal(0);
          expect(component.$.xhr.params).to.be.an('Object');
          expect(component.$.xhr.params.data).to.equal('testLink');
          expect(component.$.xhr.params.options).to.equal('{"near_dup":0}');
          expect(component.$.xhr.method).to.equal('GET');
          expect(component.$.xhr.url).to.equal('testGETHost');
          expect(component.$.xhr.headers.Authorization).to.be.a('String');
          expect(component.$.xhr.headers.Authorization.startsWith('Basic ')).to.be.true;
          done();
        }
      };

      expect(component._createXhrRequest).to.be.a('Function');
      component._createXhrRequest(0);
    });

    test('_createXhrRequest does set _queryIndex and XHR properties using the input value as the index of _selectedImageIds', function(done) {
      component._images = [{
        id: 1,
        data: 'testData',
        name: 'testName',
        selected: true,
        type: 'File'
      }, {
        id: 2,
        data: 'testLink',
        name: 'testLink',
        selected: true,
        type: 'Link'
      }];
      component._nearDuplicates = true;
      component._selectedImageIds = [1, 2];

      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testGETHost", "base64": "testPOSTHost"}';

      component.$.xhr = {
        generateRequest: function() {
          expect(component._queryIndex).to.equal(1);
          expect(component.$.xhr.params).to.be.an('Object');
          expect(component.$.xhr.params.data).to.equal('testLink');
          expect(component.$.xhr.params.options).to.not.exist;
          expect(component.$.xhr.method).to.equal('GET');
          expect(component.$.xhr.url).to.equal('testGETHost');
          expect(component.$.xhr.headers.Authorization).to.be.a('String');
          expect(component.$.xhr.headers.Authorization.startsWith('Basic ')).to.be.true;
          done();
        }
      };

      expect(component._createXhrRequest).to.be.a('Function');
      component._createXhrRequest(1);
    });

    test('_createXhrRequest does set _queryIndex and XHR properties using the input value as the index of _selectedImageIds even if the IDs are not in order', function(done) {
      component._images = [{
        id: 1,
        data: 'testData',
        name: 'testName',
        selected: true,
        type: 'File'
      }, {
        id: 2,
        data: 'testLink',
        name: 'testLink',
        selected: true,
        type: 'Link'
      }];
      component._nearDuplicates = true;
      component._selectedImageIds = [2, 1];

      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testGETHost", "base64": "testPOSTHost"}';

      component.$.xhr = {
        generateRequest: function() {
          expect(component._queryIndex).to.equal(0);
          expect(component.$.xhr.body).to.be.an('Object');
          expect(component.$.xhr.body.data).to.equal('testData');
          expect(component.$.xhr.body.options).to.not.exist;
          expect(component.$.xhr.contentType).to.equal('application/x-www-form-urlencoded');
          expect(component.$.xhr.method).to.equal('POST');
          expect(component.$.xhr.url).to.equal('testPOSTHost');
          expect(component.$.xhr.headers.Authorization).to.be.a('String');
          expect(component.$.xhr.headers.Authorization.startsWith('Basic ')).to.be.true;
          done();
        }
      };

      expect(component._createXhrRequest).to.be.a('Function');
      component._createXhrRequest(1);
    });

    test('_createXhrRequest with an image file does call logger.log if defined', function(done) {
      component._images = [{
        id: 1,
        data: 'testData',
        name: 'testName',
        selected: true,
        type: 'File'
      }];
      component._nearDuplicates = true;
      component._selectedImageIds = [1];

      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testGETHost", "base64": "testPOSTHost"}';

      component.$.xhr = {
        generateRequest: function() {}
      };

      component.logger = {
        log: function(input1, input2, input3) {
          expect(component._queryIndex).to.equal(0);
          expect(input1).to.equal('SimilarImageSearch-File');
          expect(input2).to.equal('NearDuplicates=TRUE');
          expect(input3).to.equal('');
          done();
        }
      };

      expect(component._createXhrRequest).to.be.a('Function');
      component._createXhrRequest(0);
    });

    test('_createXhrRequest with an image link does call logger.log if defined', function(done) {
      component._images = [{
        id: 1,
        data: 'testLink',
        name: 'testLink',
        selected: true,
        type: 'Link'
      }];
      component._nearDuplicates = false;
      component._selectedImageIds = [1];

      component.imageServiceAuth = '{"user": "testUser", "password": "testPassword"}';
      component.imageServiceHost = '{"url": "testGETHost", "base64": "testPOSTHost"}';

      component.$.xhr = {
        generateRequest: function() {}
      };

      component.logger = {
        log: function(input1, input2, input3) {
          expect(component._queryIndex).to.equal(0);
          expect(input1).to.equal('SimilarImageSearch-Link');
          expect(input2).to.equal('NearDuplicates=FALSE');
          expect(input3).to.equal('testLink');
          done();
        }
      };

      expect(component._createXhrRequest).to.be.a('Function');
      component._createXhrRequest(0);
    });

    test('_createSearchListener.onClick does nothing if _selectedImageIds is empty', function() {
      component._selectedImageIds = [];
      var listener = component._createSearchListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
      expect(component.$$('#xhr').body).to.be.null;
      expect(component.$$('#xhr').params).to.be.empty;
    });

    test('_createSearchListener.onClick does call _createXhrRequest and set _nearDuplicates to false', function(done) {
      component._selectedImageIds = [1];
      component._createXhrRequest = function(input) {
        expect(component._nearDuplicates).to.be.false;
        expect(input).to.equal(0);
        done();
      };

      var listener = component._createSearchListener(false);
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
    });

    test('_createSearchListener.onClick does call _createXhrRequest and set _nearDuplicates to true', function(done) {
      component._selectedImageIds = [1];
      component._createXhrRequest = function(input) {
        expect(component._nearDuplicates).to.be.true;
        expect(input).to.equal(0);
        done();
      };

      var listener = component._createSearchListener(true);
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
    });

    test('_createSelectListener.onClick does update _images and _selectedImageIds if select=true', function() {
      component._images = [{
        id: 1,
        data: 'data',
        name: 'name',
        selected: false,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }];
      component._selectedImageIds = [2];

      var listener = component._createSelectListener(true);
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();

      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }]);
      expect(component._selectedImageIds).to.deep.equal([1, 2]);
    });

    test('_createSelectListener.onClick does update _images and _selectedImageIds if select=false', function() {
      component._images = [{
        id: 1,
        data: 'data',
        name: 'name',
        selected: false,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'name',
        selected: true,
        type: 'type'
      }];
      component._selectedImageIds = [2];

      var listener = component._createSelectListener(false);
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();

      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'data',
        name: 'name',
        selected: false,
        type: 'type'
      }, {
        id: 2,
        data: 'data',
        name: 'name',
        selected: false,
        type: 'type'
      }]);
      expect(component._selectedImageIds).to.deep.equal([]);
    });

    test('_createShowImageResultsListener.onClick does add to _results', function() {
      component._results = [{
        date: 'date1',
        filename: 'name1',
        imageList: ['image1'],
        nearDuplicates: true,
        resultsList: ['results1']
      }];

      var listener = component._createShowImageResultsListener({
        date: 'date2',
        filename: 'name2',
        imageList: ['image2'],
        nearDuplicates: false,
        resultsList: ['results2']
      });
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();

      expect(component._results).to.deep.equal([{
        date: 'date1',
        filename: 'name1',
        imageList: ['image1'],
        nearDuplicates: true,
        resultsList: ['results1']
      }, {
        date: 'date2',
        filename: 'name2',
        imageList: ['image2'],
        nearDuplicates: false,
        resultsList: ['results2']
      }]);
    });

    test('_handleImageServiceResponse with no response images and no other selected IDs does deselect images', function() {
      component._images = [{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }];
      component._queryIndex = 0;
      component._selectedImageIds = [1];

      component._createXhrRequest = function() {
        expect.fail();
      };

      component._handleImageServiceResponse({
        detail: {
          response: {
            images: []
          }
        }
      });

      expect(component._previousSearches).to.deep.equal([]);
      expect(component._results).to.deep.equal([]);
      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: false,
        type: 'File'
      }]);
      expect(component._selectedImageIds).to.deep.equal([]);
    });

    test('_handleImageServiceResponse with response images and no other selected IDs does set _previousSearches and _results and deselect images', function() {
      component._images = [{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }];
      component._queryIndex = 0;
      component._selectedImageIds = [1];

      component._createXhrRequest = function() {
        expect.fail();
      };

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
      component._handleImageServiceResponse({
        detail: {
          response: {
            images: [{
              similar_images: {
                cached_image_urls: ['testUrl1', 'testUrl2'],
                sha1: ['testId1', 'testId2'],
                distance: ['0.1', '0.3']
              }
            }]
          }
        }
      });
      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      expect(component._previousSearches.length).to.equal(1);
      expect(component._previousSearches[0].date).to.be.a('String');
      expect(component._previousSearches[0].filename).to.equal('name1');
      expect(component._previousSearches[0].imageList).to.deep.equal([{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }]);
      expect(component._previousSearches[0].nearDuplicates).to.be.false;
      expect(component._previousSearches[0].resultsList).to.deep.equal([{
        link: '',
        source: 'testUrl1'
      }, {
        link: '',
        source: 'testUrl2'
      }]);

      expect(component._results.length).to.equal(1);
      expect(component._results[0].date).to.be.a('String');
      expect(component._results[0].filename).to.equal('name1');
      expect(component._results[0].imageList).to.deep.equal([{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }]);
      expect(component._results[0].nearDuplicates).to.be.false;
      expect(component._results[0].resultsList).to.deep.equal([{
        link: '',
        source: 'testUrl1'
      }, {
        link: '',
        source: 'testUrl2'
      }]);

      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: false,
        type: 'File'
      }]);
      expect(component._selectedImageIds).to.deep.equal([]);
    });

    test('_handleImageServiceResponse does add to _previousSearches and _results', function() {
      component._images = [{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }];
      component._previousSearches = [{
        date: 'previousDate',
        filename: 'previousFilename',
        imageList: [],
        nearDuplicates: true,
        resultsList: []
      }];
      component._queryIndex = 0;
      component._results = [{
        date: 'previousDate',
        filename: 'previousFilename',
        imageList: [],
        nearDuplicates: true,
        resultsList: []
      }];
      component._selectedImageIds = [1];

      component._createXhrRequest = function() {
        expect.fail();
      };

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
      component._handleImageServiceResponse({
        detail: {
          response: {
            images: [{
              similar_images: {
                cached_image_urls: ['testUrl1', 'testUrl2'],
                sha1: ['testId1', 'testId2'],
                distance: ['0.1', '0.3']
              }
            }]
          }
        }
      });
      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      expect(component._previousSearches.length).to.equal(2);
      expect(component._previousSearches[0].date).to.be.a('String');
      expect(component._previousSearches[0].filename).to.equal('name1');
      expect(component._previousSearches[0].imageList).to.deep.equal([{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }]);
      expect(component._previousSearches[0].nearDuplicates).to.be.false;
      expect(component._previousSearches[0].resultsList).to.deep.equal([{
        link: '',
        source: 'testUrl1'
      }, {
        link: '',
        source: 'testUrl2'
      }]);
      expect(component._previousSearches[1]).to.deep.equal({
        date: 'previousDate',
        filename: 'previousFilename',
        imageList: [],
        nearDuplicates: true,
        resultsList: []
      });

      expect(component._results.length).to.equal(2);
      expect(component._results[0]).to.deep.equal({
        date: 'previousDate',
        filename: 'previousFilename',
        imageList: [],
        nearDuplicates: true,
        resultsList: []
      });
      expect(component._results[1].date).to.be.a('String');
      expect(component._results[1].filename).to.equal('name1');
      expect(component._results[1].imageList).to.deep.equal([{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }]);
      expect(component._results[1].nearDuplicates).to.be.false;
      expect(component._results[1].resultsList).to.deep.equal([{
        link: '',
        source: 'testUrl1'
      }, {
        link: '',
        source: 'testUrl2'
      }]);
    });

    test('_handleImageServiceResponse does ignore image results above imageThreshold', function() {
      component.imageThreshold = 0.2;
      component._images = [{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }];
      component._queryIndex = 0;
      component._selectedImageIds = [1];

      component._createXhrRequest = function() {
        expect.fail();
      };

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
      component._handleImageServiceResponse({
        detail: {
          response: {
            images: [{
              similar_images: {
                cached_image_urls: ['testUrl1', 'testUrl2'],
                sha1: ['testId1', 'testId2'],
                distance: ['0.1', '0.3']
              }
            }]
          }
        }
      });
      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      expect(component._previousSearches.length).to.equal(1);
      expect(component._previousSearches[0].date).to.be.a('String');
      expect(component._previousSearches[0].filename).to.equal('name1');
      expect(component._previousSearches[0].imageList).to.deep.equal([{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }]);
      expect(component._previousSearches[0].nearDuplicates).to.be.false;
      expect(component._previousSearches[0].resultsList).to.deep.equal([{
        link: '',
        source: 'testUrl1'
      }]);

      expect(component._results.length).to.equal(1);
      expect(component._results[0].date).to.be.a('String');
      expect(component._results[0].filename).to.equal('name1');
      expect(component._results[0].imageList).to.deep.equal([{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }]);
      expect(component._results[0].nearDuplicates).to.be.false;
      expect(component._results[0].resultsList).to.deep.equal([{
        link: '',
        source: 'testUrl1'
      }]);
    });

    test('_handleImageServiceResponse with linkFunction does set links in results', function() {
      component.linkFunction = function(id) {
        return 'http://' + id;
      };
      component._images = [{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }];
      component._queryIndex = 0;
      component._selectedImageIds = [1];

      component._createXhrRequest = function() {
        expect.fail();
      };

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
      component._handleImageServiceResponse({
        detail: {
          response: {
            images: [{
              similar_images: {
                cached_image_urls: ['testUrl1', 'testUrl2'],
                sha1: ['testId1', 'testId2'],
                distance: ['0.1', '0.3']
              }
            }]
          }
        }
      });
      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

      expect(component._previousSearches.length).to.equal(1);
      expect(component._previousSearches[0].date).to.be.a('String');
      expect(component._previousSearches[0].filename).to.equal('name1');
      expect(component._previousSearches[0].imageList).to.deep.equal([{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }]);
      expect(component._previousSearches[0].nearDuplicates).to.be.false;
      expect(component._previousSearches[0].resultsList).to.deep.equal([{
        link: 'http://testId1',
        source: 'testUrl1'
      }, {
        link: 'http://testId2',
        source: 'testUrl2'
      }]);

      expect(component._results.length).to.equal(1);
      expect(component._results[0].date).to.be.a('String');
      expect(component._results[0].filename).to.equal('name1');
      expect(component._results[0].imageList).to.deep.equal([{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }]);
      expect(component._results[0].nearDuplicates).to.be.false;
      expect(component._results[0].resultsList).to.deep.equal([{
        link: 'http://testId1',
        source: 'testUrl1'
      }, {
        link: 'http://testId2',
        source: 'testUrl2'
      }]);
    });

    test('_handleImageServiceResponse with response images and other selected IDs does set _previousSearches and _results and call _createXhrRequest', function(done) {
      component._images = [{
        id: 1,
        data: 'data1',
        name: 'name1',
        selected: true,
        type: 'File'
      }, {
        id: 2,
        data: 'data2',
        name: 'name2',
        selected: true,
        type: 'File'
      }, {
        id: 3,
        data: 'data3',
        name: 'name3',
        selected: true,
        type: 'File'
      }];
      component._queryIndex = 1;
      component._selectedImageIds = [1, 2, 3];

      component._createXhrRequest = function(input) {
        expect(component._previousSearches.length).to.equal(1);
        expect(component._previousSearches[0].date).to.be.a('String');
        expect(component._previousSearches[0].filename).to.equal('name2');
        expect(component._previousSearches[0].imageList).to.deep.equal([{
          id: 2,
          data: 'data2',
          name: 'name2',
          selected: true,
          type: 'File'
        }]);
        expect(component._previousSearches[0].nearDuplicates).to.be.false;
        expect(component._previousSearches[0].resultsList).to.deep.equal([{
          link: '',
          source: 'testUrl1'
        }, {
          link: '',
          source: 'testUrl2'
        }]);

        expect(component._results.length).to.equal(1);
        expect(component._results[0].date).to.be.a('String');
        expect(component._results[0].filename).to.equal('name2');
        expect(component._results[0].imageList).to.deep.equal([{
          id: 2,
          data: 'data2',
          name: 'name2',
          selected: true,
          type: 'File'
        }]);
        expect(component._results[0].nearDuplicates).to.be.false;
        expect(component._results[0].resultsList).to.deep.equal([{
          link: '',
          source: 'testUrl1'
        }, {
          link: '',
          source: 'testUrl2'
        }]);

        expect(component._images).to.deep.equal([{
          id: 1,
          data: 'data1',
          name: 'name1',
          selected: true,
          type: 'File'
        }, {
          id: 2,
          data: 'data2',
          name: 'name2',
          selected: true,
          type: 'File'
        }, {
          id: 3,
          data: 'data3',
          name: 'name3',
          selected: true,
          type: 'File'
        }]);
        expect(component._selectedImageIds).to.deep.equal([1, 2, 3]);

        expect(input).to.equal(2);
        done();
      };

      /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
      component._handleImageServiceResponse({
        detail: {
          response: {
            images: [{
              similar_images: {
                cached_image_urls: ['testUrl1', 'testUrl2'],
                sha1: ['testId1', 'testId2'],
                distance: ['0.1', '0.3']
              }
            }]
          }
        }
      });
      /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */
    });

    test('_saveUploadedInputImage does nothing if either filename or xhr is empty', function() {
      expect(component._saveUploadedInputImage).to.be.a('Function');

      component._saveUploadedInputImage({
        detail: {
          xhr: {
            response: '{\"base64\":\"uploadBase64string\",\"mimeType\":\"image/uploadType\"}'
          }
        }
      });
      expect(component._images).to.deep.equal([]);
      expect(component._selectedImageIds).to.deep.equal([]);

      component._saveUploadedInputImage({
        detail: {
          filename: 'testFile'
        }
      });
      expect(component._images).to.deep.equal([]);
      expect(component._selectedImageIds).to.deep.equal([]);
    });

    test('_saveUploadedInputImage does ', function() {
      expect(component._saveUploadedInputImage).to.be.a('Function');
      component._saveUploadedInputImage({
        detail: {
          filename: 'testFile',
          xhr: {
            response: '{\"base64\":\"uploadBase64string\",\"mimeType\":\"image/uploadType\"}'
          }
        }
      });
      expect(component._images).to.deep.equal([{
        id: 1,
        data: 'data:image/uploadType;base64,uploadBase64string',
        name: 'testFile',
        selected: true,
        type: 'File'
      }]);
      expect(component._selectedImageIds).to.deep.equal([1]);
    });

    test('_selectImageResults does set _selectedResultsIndex', function() {
      expect(component._selectImageResults).to.be.a('Function');
      component._selectImageResults({
        model: {
          index: 1
        }
      });
      expect(component._selectedResultsIndex).to.equal(1);
      component._selectImageResults({
        model: {
          index: 2
        }
      });
      expect(component._selectedResultsIndex).to.equal(2);
    });

    test('_setUploadErrorMessage does work', function() {
      component._setUploadErrorMessage({
        detail: {
          filename: 'testName'
        }
      });
      expect(component._error).to.equal('Image Upload Failed (Unknown Error):  testName');
    });

    test('open does open the dialog', function(done) {
      var dialog = component.$$('#similarImageSearchDialog');
      expect(dialog.style.display).to.equal('none');
      component.open();
      flush(function() {
        expect(dialog.style.display).to.equal('');
        done();
      });
    });
  });
</script>
</body>
</html>
