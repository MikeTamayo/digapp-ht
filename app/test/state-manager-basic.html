<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>state-manager</title>
  <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>
  <script src="../bower_components/test-fixture/test-fixture-mocha.js"></script>
  <link rel="import" href="../bower_components/test-fixture/test-fixture.html">
  <link rel="import" href="../elements/state-manager/state-manager.html">
</head>

<body>
<test-fixture id="state-manager-fixture">
  <template>
    <state-manager></state-manager>
  </template>
</test-fixture>

<script>
  /* globals suite, setup, fixture, test, expect, flush */
  /* jshint -W030 */
  suite('state-manager tests', function() {
    var element;

    var DEFAULT_OBJECT_ENTITY_STATE = {
      age: [],
      dates: [],
      email: [],
      ethnicity: [],
      eyeColor: [],
      gender: [],
      hairColor: [],
      height: [],
      image: [],
      location: [],
      name: [],
      phone: [],
      price: [],
      publisher: [],
      review: [],
      services: [],
      social: [],
      weight: []
    };

    var DEFAULT_STRING_ENTITY_STATE = '{\"age\":[],\"dates\":[],\"email\":[],\"ethnicity\":[],\"eyeColor\":[],\"gender\":[],\"hairColor\":[],\"height\":[],\"image\":[],\"location\":[],\"name\":[],\"phone\":[],\"price\":[],\"publisher\":[],\"review\":[],\"services\":[],\"social\":[],\"weight\":[]}';

    var EXAMPLE_OBJECT_ENTITY_STATE = {
      age: ['age1', 'age2'],
      dates: ['date1', 'date2'],
      email: ['email1', 'email2'],
      ethnicity: ['ethnicity1', 'ethnicity2'],
      eyeColor: ['eyeColor1', 'eyeColor2'],
      gender: ['gender1', 'gender2'],
      hairColor: ['hairColor1', 'hairColor2'],
      height: ['height1', 'height2'],
      image: ['image1', 'image2'],
      location: ['location1', 'location2'],
      name: ['name1', 'name2'],
      phone: ['phone1', 'phone2'],
      price: ['price1', 'price2'],
      publisher: ['publisher1', 'publisher2'],
      review: ['review1', 'review2'],
      services: ['services1', 'services2'],
      social: ['social1', 'social2'],
      weight: ['weight1', 'weight2']
    };

    var EXAMPLE_STRING_ENTITY_STATE = '{\"age\":[\"age1\",\"age2\"],\"dates\":[\"date1\",\"date2\"],\"email\":[\"email1\",\"email2\"],\"ethnicity\":[\"ethnicity1\",\"ethnicity2\"],\"eyeColor\":[\"eyeColor1\",\"eyeColor2\"],\"gender\":[\"gender1\",\"gender2\"],\"hairColor\":[\"hairColor1\",\"hairColor2\"],\"height\":[\"height1\",\"height2\"],\"image\":[\"image1\",\"image2\"],\"location\":[\"location1\",\"location2\"],\"name\":[\"name1\",\"name2\"],\"phone\":[\"phone1\",\"phone2\"],\"price\":[\"price1\",\"price2\"],\"publisher\":[\"publisher1\",\"publisher2\"],\"review\":[\"review1\",\"review2\"],\"services\":[\"services1\",\"services2\"],\"social\":[\"social1\",\"social2\"],\"weight\":[\"weight1\",\"weight2\"]}';

    var DEFAULT_OBJECT_SEARCH_STATE = {
      age: {},
      city: {},
      country: {},
      description: {},
      email: {},
      ethnicity: {},
      eyeColor: {},
      gender: {},
      hairColor: {},
      height: {},
      image: {},
      location: {},
      name: {},
      phone: {},
      postingDate: {},
      price: {},
      region: {},
      review: {},
      services: {},
      social: {},
      title: {},
      website: {},
      weight: {},
      sort: ''
    };

    var DEFAULT_STRING_SEARCH_STATE = '{\"age\":{},\"city\":{},\"country\":{},\"description\":{},\"email\":{},\"ethnicity\":{},\"eyeColor\":{},\"gender\":{},\"hairColor\":{},\"height\":{},\"image\":{},\"location\":{},\"name\":{},\"phone\":{},\"postingDate\":{},\"price\":{},\"region\":{},\"review\":{},\"services\":{},\"social\":{},\"title\":{},\"website\":{},\"weight\":{},\"sort\":\"\"}';

    var EXAMPLE_OBJECT_SEARCH_STATE = {
      age: {
        term: {
          key: 'age'
        }
      },
      city: {
        term: {
          key: 'city'
        }
      },
      country: {
        term: {
          key: 'country'
        }
      },
      description: {
        term: {
          key: 'description'
        }
      },
      email: {
        term: {
          key: 'email'
        }
      },
      ethnicity: {
        term: {
          key: 'ethnicity'
        }
      },
      eyeColor: {
        term: {
          key: 'eyeColor'
        }
      },
      gender: {
        term: {
          key: 'gender'
        }
      },
      hairColor: {
        term: {
          key: 'hairColor'
        }
      },
      height: {
        term: {
          key: 'height'
        }
      },
      image: {
        term: {
          key: 'image'
        }
      },
      location: {
        term: {
          key: 'location'
        }
      },
      name: {
        term: {
          key: 'name'
        }
      },
      phone: {
        term: {
          key: 'phone'
        }
      },
      postingDate: {
        dateEnd: {
          key: 'dateEnd'
        },
        dateStart: {
          key: 'dateStart'
        }
      },
      price: {
        term: {
          key: 'price'
        }
      },
      region: {
        term: {
          key: 'region'
        }
      },
      review: {
        term: {
          key: 'review'
        }
      },
      services: {
        term: {
          key: 'services'
        }
      },
      social: {
        term: {
          key: 'social'
        }
      },
      title: {
        term: {
          key: 'title'
        }
      },
      website: {
        term: {
          key: 'website'
        }
      },
      weight: {
        term: {
          key: 'weight'
        }
      },
      sort: 'sort'
    };

    var EXAMPLE_STRING_SEARCH_STATE = '{\"age\":{\"term\":{\"key\":\"age\"}},\"city\":{\"term\":{\"key\":\"city\"}},\"country\":{\"term\":{\"key\":\"country\"}},\"description\":{\"term\":{\"key\":\"description\"}},\"email\":{\"term\":{\"key\":\"email\"}},\"ethnicity\":{\"term\":{\"key\":\"ethnicity\"}},\"eyeColor\":{\"term\":{\"key\":\"eyeColor\"}},\"gender\":{\"term\":{\"key\":\"gender\"}},\"hairColor\":{\"term\":{\"key\":\"hairColor\"}},\"height\":{\"term\":{\"key\":\"height\"}},\"image\":{\"term\":{\"key\":\"image\"}},\"location\":{\"term\":{\"key\":\"location\"}},\"name\":{\"term\":{\"key\":\"name\"}},\"phone\":{\"term\":{\"key\":\"phone\"}},\"postingDate\":{\"dateEnd\":{\"key\":\"dateEnd\"},\"dateStart\":{\"key\":\"dateStart\"}},\"price\":{\"term\":{\"key\":\"price\"}},\"region\":{\"term\":{\"key\":\"region\"}},\"review\":{\"term\":{\"key\":\"review\"}},\"services\":{\"term\":{\"key\":\"services\"}},\"social\":{\"term\":{\"key\":\"social\"}},\"title\":{\"term\":{\"key\":\"title\"}},\"website\":{\"term\":{\"key\":\"website\"}},\"weight\":{\"term\":{\"key\":\"weight\"}},\"sort\":\"sort\"}';

    setup(function() {
      element = fixture('state-manager-fixture');
    });

    test('default properties are set correctly', function() {
      expect(element.client).to.not.exist;
      expect(element.filterCollection).to.not.exist;
      expect(element.stateId).to.not.exist;
      expect(element.stateIndex).to.not.exist;
      expect(element.stateType).to.not.exist;
      expect(element.pageType).to.equal('entity');
      expect(element.format).to.equal('hh:mm:ss A');
      expect(element.searchHistory).to.deep.equal([]);
      expect(element.hasHistory).to.be.false;
      expect(element._creationBody).to.not.exist;
      expect(element._creationResults).to.not.exist;
      expect(element._stateIdQuery).to.not.exist;
      expect(element._stateIdResults).to.not.exist;
      expect(element._stringifiedState).to.not.exist;
      expect(element._stringifiedStateQuery).to.not.exist;
      expect(element._stringifiedStateResults).to.not.exist;
      expect(element._link).to.not.exist;
      expect(element._validateId).to.be.false;
    });

    test('does have expected elements', function() {
      expect(element.$$('paper-icon-button')).to.exist;
      expect(element.$$('#linkDialog')).to.exist;
      expect(element.$$('#searchHistoryDialog')).to.exist;
    });

    test('openSearchHistory() opens the correct dialog', function(done) {
      expect(element.$$('#searchHistoryDialog').opened).to.be.false;
      element.openSearchHistory();

      flush(function() {
        expect(element.$$('#searchHistoryDialog').opened).to.be.true;
        done();
      });
    });

    test('_createStringifiedState with entity page type does return entity page JSON strings', function() {
      expect(element._createStringifiedState({}, 'entity')).to.equal(DEFAULT_STRING_ENTITY_STATE);
      expect(element._createStringifiedState(EXAMPLE_OBJECT_ENTITY_STATE, 'entity')).to.equal(EXAMPLE_STRING_ENTITY_STATE);
    });

    test('_createStringifiedState with search page type does return search page JSON strings', function() {
      expect(element._createStringifiedState({}, 'search')).to.equal(DEFAULT_STRING_SEARCH_STATE);
      expect(element._createStringifiedState(EXAMPLE_OBJECT_SEARCH_STATE, 'search')).to.equal(EXAMPLE_STRING_SEARCH_STATE);
    });

    test('_generateId does return strings', function() {
      expect(element._generateId()).to.be.a('String');
    });

    test('_isEmptyState does return correct values', function() {
      expect(element._isEmptyState({})).to.be.true;
      expect(element._isEmptyState({
        key: []
      })).to.be.true;
      expect(element._isEmptyState({
        key: {}
      })).to.be.true;
      expect(element._isEmptyState({
        key: 'value'
      })).to.be.false;
      expect(element._isEmptyState({
        key: ['value']
      })).to.be.false;
      expect(element._isEmptyState({
        key: {
          value: {}
        }
      })).to.be.false;
    });

    test('_populateCreationBody with entity page type does set _creationBody and _link', function() {
      element._populateCreationBody('id1', EXAMPLE_OBJECT_ENTITY_STATE, 'entity');
      expect(element._creationBody).to.deep.equal({
        id: 'id1',
        state: EXAMPLE_STRING_ENTITY_STATE
      });
      expect(element._link.endsWith('state=id1')).to.be.true;
    });

    test('_populateCreationBody with search page type does set _creationBody and _link', function() {
      element._populateCreationBody('id1', EXAMPLE_OBJECT_SEARCH_STATE, 'search');
      expect(element._creationBody).to.deep.equal({
        id: 'id1',
        state: EXAMPLE_STRING_SEARCH_STATE
      });
      expect(element._link.endsWith('state=id1')).to.be.true;
    });

    test('_populateCreationBody with entity type does set _creationBody and _link using defaults if state is empty', function() {
      element._populateCreationBody('id1', {}, 'entity');
      expect(element._creationBody).to.deep.equal({
        id: 'id1',
        state: DEFAULT_STRING_ENTITY_STATE
      });
      expect(element._link.endsWith('state=id1')).to.be.true;
    });

    test('_populateCreationBody with search type does set _creationBody and _link using defaults if state is empty', function() {
      element._populateCreationBody('id1', {}, 'search');
      expect(element._creationBody).to.deep.equal({
        id: 'id1',
        state: DEFAULT_STRING_SEARCH_STATE
      });
      expect(element._link.endsWith('state=id1')).to.be.true;
    });

    test('_updateFilterCollection with empty object and entity page type does set filterCollection', function() {
      element._updateFilterCollection('{}', 'entity');
      expect(element.filterCollection).to.deep.equal(DEFAULT_OBJECT_ENTITY_STATE);
    });

    test('_updateFilterCollection with non-empty object and entity page type sets filterCollection', function() {
      element._updateFilterCollection(EXAMPLE_STRING_ENTITY_STATE, 'entity');
      expect(element.filterCollection).to.deep.equal(EXAMPLE_OBJECT_ENTITY_STATE);
    });

    test('_updateFilterCollection with empty object and search page type does set filterCollection', function() {
      element._updateFilterCollection('{}', 'search');
      expect(element.filterCollection).to.deep.equal(DEFAULT_OBJECT_SEARCH_STATE);
    });

    test('_updateFilterCollection with non-empty object and search page type sets filterCollection', function() {
      element._updateFilterCollection(EXAMPLE_STRING_SEARCH_STATE, 'search');
      expect(element.filterCollection).to.deep.equal(EXAMPLE_OBJECT_SEARCH_STATE);
    });

    test('_updateUrlAndShowDialog does set _link', function() {
      element._updateUrlAndShowDialog('id1');
      expect(element._link.endsWith('state=id1')).to.be.true;
    });

    test('generateLink does set _stringifiedState', function() {
      element.filterCollection = EXAMPLE_OBJECT_ENTITY_STATE;
      element.generateLink();
      expect(element._stringifiedState).to.equal(EXAMPLE_STRING_ENTITY_STATE);
    });

    test('setting _stateIdQuery does set _creationBody, _link, and _validateId if _validateId is true and hits is empty', function() {
      element.stateId = 'id1';
      element.filterCollection = {};
      element._validateId = true;
      element._stateIdQuery = {};
      element._stateIdResults = {
        hits: {
          hits: []
        }
      };

      expect(element._validateId).to.be.false;
      expect(element._creationBody).to.deep.equal({
        id: 'id1',
        state: DEFAULT_STRING_ENTITY_STATE
      });
      expect(element._link.endsWith('state=id1')).to.be.true;
    });

    test('setting _stateIdQuery and _stateIdResults does set stateId if _validateId is true', function() {
      element.stateId = 'id1';
      element._validateId = true;
      element._stateIdQuery = {};
      element._stateIdResults = {
        hits: {
          hits: [{
            _source: {
              state: '{}'
            }
          }]
        }
      };

      expect(element.stateId).to.not.equal('id1');
      expect(element.stateId).to.be.a('String');
      expect(element._validateId).to.be.true;
    });

    test('setting _stateIdQuery and _stateIdResults does set filterCollection if _validateId is false', function() {
      element._stateIdQuery = {};
      element._stateIdResults = {
        hits: {
          hits: [{
            _source: {
              state: EXAMPLE_STRING_ENTITY_STATE
            }
          }]
        }
      };
      expect(element.filterCollection).to.deep.equal(EXAMPLE_OBJECT_ENTITY_STATE);
    });

    test('setting _stateIdQuery and _stateIdResults does set filterCollection using defaults if _validateId is false and state is empty', function() {
      element._stateIdQuery = {};
      element._stateIdResults = {
        hits: {
          hits: [{
            _source: {
              state: '{}'
            }
          }]
        }
      };
      expect(element.filterCollection).to.deep.equal(DEFAULT_OBJECT_ENTITY_STATE);
    });

    test('setting _stringifiedStateQuery and _stringifiedStateResults does set stateId and _validateId if hits is empty', function() {
      element._stringifiedStateQuery = {};
      element._stringifiedStateResults = {
        hits: {
          hits: []
        }
      };

      expect(element.stateId).to.be.a('String');
      expect(element._validateId).to.be.true;
    });

    test('setting _stringifiedStateQuery and _stringifiedStateResults does set _link', function() {
      element._stringifiedStateQuery = {};
      element._stringifiedStateResults = {
        hits: {
          hits: [{
            _source: {
              id: 'id1'
            }
          }]
        }
      };

      expect(element._link.endsWith('state=id1')).to.be.true;
      expect(element.stateId).to.not.exist;
      expect(element._validateId).to.be.false;
    });

    test('_addToHistory() will not call generateLink if showLinkDialog is true', function(done) {
      var linkGenerated = false;
      element.generateLink = function() {
        linkGenerated = true;
      };
      element.pageType = 'search';
      element._addToHistory();

      flush(function() {
        expect(linkGenerated).to.be.false;
        done();
      });
    });

    test('_addToHistory() will not call generateLink if processRequest is false', function(done) {
      var linkGenerated = false;
      element.generateLink = function() {
        linkGenerated = true;
      };
      element.pageType = 'search';
      element.showLinkDialog = false;
      element._addToHistory();

      flush(function() {
        expect(linkGenerated).to.be.false;
        done();
      });
    });

    test('_addToHistory() will not call generateLink if filterCollection is empty', function(done) {
      var linkGenerated = false;
      element.generateLink = function() {
        linkGenerated = true;
      };
      element.pageType = 'search';
      element.showLinkDialog = false;
      element.processRequest = true;
      element._addToHistory();

      flush(function() {
        expect(linkGenerated).to.be.false;
        done();
      });
    });

    test('_addToHistory() calls generateLink when appropriate conditions met', function(done) {
      var linkGenerated = false;
      element.generateLink = function() {
        linkGenerated = true;
      };
      element.pageType = 'search';
      element.filterCollection = {age: {term: {key: '21', enabled: true}}};
      element.processRequest = true;
      element.showLinkDialog = false;
      element._addToHistory();

      flush(function() {
        expect(linkGenerated).to.be.true;
        done();
      });
    });

    test('_addToHistory() works as observer', function(done) {
      var linkGenerated = false;
      element.generateLink = function() {
        linkGenerated = true;
      };
      element.pageType = 'search';
      element.filterCollection = {age: {term: {key: '21', enabled: true}}};
      element.processRequest = true;
      element.showLinkDialog = false;

      flush(function() {
        expect(linkGenerated).to.be.true;
        done();
      });
    });

    test('if state matches existing _stringifiedState, generateLink() opens dialog when showLinkDialog is true', function(done) {
      expect(element.$$('#linkDialog').opened).to.be.false;
      element.filterCollection = {age: {term: {key: '21', enabled: true}}};
      element.pageType = 'search';
      element._stringifiedState = element._createStringifiedState(element.filterCollection, element.pageType);
      element.generateLink();

      flush(function() {
        expect(element.$$('#linkDialog').opened).to.be.true;
        done();
      });
    });

    test('if state matches existing _stringifiedState but showLinkDialog is false, generateLink() will not open dialog', function(done) {
      expect(element.$$('#linkDialog').opened).to.be.false;
      element.filterCollection = {age: {term: {key: '21', enabled: true}}};
      element.pageType = 'search';
      element.showLinkDialog = false;
      element._stringifiedState = element._createStringifiedState(element.filterCollection, element.pageType);
      element.generateLink();

      flush(function() {
        expect(element.$$('#linkDialog').opened).to.be.false;
        done();
      });
    });

    test('_runSearch() sets searchParameters to the value of the clicked search history item, moves items in searchHistory and closes dialog', function() {
      element.$$('#searchHistoryDialog').opened = true;
      element.set('searchHistory', [
        {id: 'someString1', searchParameters: {filter: 'some param'}, time: 'string value'},
        {id: 'someString2', searchParameters: {filter: 'new parameters'}, time: 'some other time'}
      ]);
      element._runSearch({model: {index: 1, item: {id: 'someString2', searchParameters: {filter: 'new parameters'}, time: 'some other time'}}});

      expect(element.filterCollection).to.deep.equal({filter: 'new parameters'});
      expect(element.searchHistory.length).to.deep.equal(2);
      expect(element.searchHistory[0].id).to.deep.equal('someString2');
      expect(element.searchHistory[0].searchParameters).to.deep.equal({filter: 'new parameters'});
      expect(element.searchHistory[1].id).to.deep.equal('someString1');
      expect(element.searchHistory[1].searchParameters).to.deep.equal({filter: 'some param'});
      expect(element.$$('#searchHistoryDialog').opened).to.be.false;
      expect(window.location.search).to.deep.equal('?state=someString2');
    });

    test('_copyFilterCollection() returns a copy of argument passed in', function() {
      var filterCollection = {text: 'some string here'};
      var filterCollectionCopy = element._copyFilterCollection(filterCollection);

      expect(filterCollection).to.not.equal(filterCollectionCopy);
      expect(filterCollection).to.deep.equal(filterCollectionCopy);
    });

    test('_unshiftSearchHistoryItem() correctly adds item to the beginning of the searchHistory array', function() {
      element.set('searchHistory', [{id: 'someid', searchParameters: 'some param', time: 'string value'}]);
      element._unshiftSearchHistoryItem({searchParameters: 'some string here'}, 'newid');

      expect(element.searchHistory.length).to.deep.equal(2);
      expect(Object.keys(element.searchHistory[0])).to.deep.equal(['searchParameters', 'id', 'time']);
      expect(element.searchHistory[0].id).to.deep.equal('newid');
      expect(element.searchHistory[0].searchParameters).to.deep.equal({searchParameters: 'some string here'});
      expect(element.searchHistory[0].time).to.be.a('String');
      expect(element.searchHistory[1]).to.deep.equal({id: 'someid', searchParameters: 'some param', time: 'string value'});
    });

    test('_checkHistory() correctly sets hasHistory to true when searchHistory array is populated', function() {
      element.set('searchHistory', [{hasObject: true}]);
      element._checkHistory();
      expect(element.hasHistory).to.be.true;
    });

    test('_checkHistory() correctly sets hasHistory to false when searchHistory array is empty', function() {
      element.set('searchHistory', []);
      element._checkHistory();
      expect(element.hasHistory).to.be.false;
    });

    test('_checkHistory() works as observer', function(done) {
      element.set('searchHistory', [{hasObject: true}]);

      flush(function() {
        expect(element.hasHistory).to.be.true;
        element.set('searchHistory', []);
        done();
      });
    });

    test('_updateUrlAndShowDialog opens link dialog if showLinkDialog is true', function() {
      element._updateUrlAndShowDialog('id1');
      expect(element.$$('#linkDialog').opened).to.be.true;
    });

    test('_updateUrlAndShowDialog updates current state if showLinkDialog is false', function() {
      element.showLinkDialog = false;
      element.filterCollection = {age: {term: {key: '21', enabled: true}}};
      element._updateUrlAndShowDialog('id1');
      expect(element.$$('#linkDialog').opened).to.be.false;
      expect(window.location.search).to.deep.equal('?state=id1');
    });
  });
</script>
</body>
</html>
