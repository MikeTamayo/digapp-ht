<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>state-manager</title>
  <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>
  <script src="../bower_components/test-fixture/test-fixture-mocha.js"></script>
  <link rel="import" href="../bower_components/test-fixture/test-fixture.html">
  <link rel="import" href="../elements/state-manager/state-manager.html">
</head>

<body>
<test-fixture id="state-manager-fixture">
  <template>
    <state-manager></state-manager>
  </template>
</test-fixture>

<script>
  /* globals suite, setup, fixture, test, expect */
  /* jshint -W030 */
  suite('state-manager tests', function() {
    var component;

    var DEFAULT_OBJECT_ENTITY_STATE = {
      age: [],
      email: [],
      ethnicity: [],
      eyeColor: [],
      gender: [],
      hairColor: [],
      height: [],
      location: [],
      name: [],
      phone: [],
      price: [],
      publisher: [],
      services: [],
      weight: []
    };

    var DEFAULT_STRING_ENTITY_STATE = '{\"age\":[],\"email\":[],\"ethnicity\":[],\"eyeColor\":[],\"gender\":[],\"hairColor\":[],\"height\":[],\"location\":[],\"name\":[],\"phone\":[],\"price\":[],\"publisher\":[],\"services\":[],\"weight\":[]}';

    var EXAMPLE_OBJECT_ENTITY_STATE = {
      age: ['age1', 'age2'],
      email: ['email1', 'email2'],
      ethnicity: ['ethnicity1', 'ethnicity2'],
      eyeColor: ['eyeColor1', 'eyeColor2'],
      gender: ['gender1', 'gender2'],
      hairColor: ['hairColor1', 'hairColor2'],
      height: ['height1', 'height2'],
      location: ['location1', 'location2'],
      name: ['name1', 'name2'],
      phone: ['phone1', 'phone2'],
      price: ['price1', 'price2'],
      publisher: ['publisher1', 'publisher2'],
      services: ['services1', 'services2'],
      weight: ['weight1', 'weight2']
    };

    var EXAMPLE_STRING_ENTITY_STATE = '{\"age\":[\"age1\",\"age2\"],\"email\":[\"email1\",\"email2\"],\"ethnicity\":[\"ethnicity1\",\"ethnicity2\"],\"eyeColor\":[\"eyeColor1\",\"eyeColor2\"],\"gender\":[\"gender1\",\"gender2\"],\"hairColor\":[\"hairColor1\",\"hairColor2\"],\"height\":[\"height1\",\"height2\"],\"location\":[\"location1\",\"location2\"],\"name\":[\"name1\",\"name2\"],\"phone\":[\"phone1\",\"phone2\"],\"price\":[\"price1\",\"price2\"],\"publisher\":[\"publisher1\",\"publisher2\"],\"services\":[\"services1\",\"services2\"],\"weight\":[\"weight1\",\"weight2\"]}';

    var DEFAULT_OBJECT_SEARCH_STATE = {
      age: {},
      city: {},
      country: {},
      description: {},
      email: {},
      ethnicity: {},
      eyeColor: {},
      gender: {},
      hairColor: {},
      height: {},
      image: {},
      location: {},
      name: {},
      phone: {},
      postingDate: {},
      price: {},
      region: {},
      services: {},
      title: {},
      website: {},
      weight: {},
      sort: ''
    };

    var DEFAULT_STRING_SEARCH_STATE = '{\"age\":{},\"city\":{},\"country\":{},\"description\":{},\"email\":{},\"ethnicity\":{},\"eyeColor\":{},\"gender\":{},\"hairColor\":{},\"height\":{},\"image\":{},\"location\":{},\"name\":{},\"phone\":{},\"postingDate\":{},\"price\":{},\"region\":{},\"services\":{},\"title\":{},\"website\":{},\"weight\":{},\"sort\":\"\"}';

    var EXAMPLE_OBJECT_SEARCH_STATE = {
      age: {
        term: {
          key: 'age'
        }
      },
      city: {
        term: {
          key: 'city'
        }
      },
      country: {
        term: {
          key: 'country'
        }
      },
      description: {
        term: {
          key: 'description'
        }
      },
      email: {
        term: {
          key: 'email'
        }
      },
      ethnicity: {
        term: {
          key: 'ethnicity'
        }
      },
      eyeColor: {
        term: {
          key: 'eyeColor'
        }
      },
      gender: {
        term: {
          key: 'gender'
        }
      },
      hairColor: {
        term: {
          key: 'hairColor'
        }
      },
      height: {
        term: {
          key: 'height'
        }
      },
      image: {
        term: {
          key: 'image'
        }
      },
      location: {
        term: {
          key: 'location'
        }
      },
      name: {
        term: {
          key: 'name'
        }
      },
      phone: {
        term: {
          key: 'phone'
        }
      },
      postingDate: {
        dateEnd: {
          key: 'dateEnd'
        },
        dateStart: {
          key: 'dateStart'
        }
      },
      price: {
        term: {
          key: 'price'
        }
      },
      region: {
        term: {
          key: 'region'
        }
      },
      services: {
        term: {
          key: 'services'
        }
      },
      title: {
        term: {
          key: 'title'
        }
      },
      website: {
        term: {
          key: 'website'
        }
      },
      weight: {
        term: {
          key: 'weight'
        }
      },
      sort: 'sort'
    };

    var EXAMPLE_STRING_SEARCH_STATE = '{\"age\":{\"term\":{\"key\":\"age\"}},\"city\":{\"term\":{\"key\":\"city\"}},\"country\":{\"term\":{\"key\":\"country\"}},\"description\":{\"term\":{\"key\":\"description\"}},\"email\":{\"term\":{\"key\":\"email\"}},\"ethnicity\":{\"term\":{\"key\":\"ethnicity\"}},\"eyeColor\":{\"term\":{\"key\":\"eyeColor\"}},\"gender\":{\"term\":{\"key\":\"gender\"}},\"hairColor\":{\"term\":{\"key\":\"hairColor\"}},\"height\":{\"term\":{\"key\":\"height\"}},\"image\":{\"term\":{\"key\":\"image\"}},\"location\":{\"term\":{\"key\":\"location\"}},\"name\":{\"term\":{\"key\":\"name\"}},\"phone\":{\"term\":{\"key\":\"phone\"}},\"postingDate\":{\"dateEnd\":{\"key\":\"dateEnd\"},\"dateStart\":{\"key\":\"dateStart\"}},\"price\":{\"term\":{\"key\":\"price\"}},\"region\":{\"term\":{\"key\":\"region\"}},\"services\":{\"term\":{\"key\":\"services\"}},\"title\":{\"term\":{\"key\":\"title\"}},\"website\":{\"term\":{\"key\":\"website\"}},\"weight\":{\"term\":{\"key\":\"weight\"}},\"sort\":\"sort\"}';

    setup(function() {
      component = fixture('state-manager-fixture');
    });

    test('default properties are set correctly', function() {
      expect(component.client).to.not.exist;
      expect(component.filterCollection).to.not.exist;
      expect(component.stateId).to.not.exist;
      expect(component.stateIndex).to.not.exist;
      expect(component.stateType).to.not.exist;
      expect(component.pageType).to.equal('entity');
      expect(component._creationBody).to.not.exist;
      expect(component._creationResults).to.not.exist;
      expect(component._stateIdQuery).to.not.exist;
      expect(component._stateIdResults).to.not.exist;
      expect(component._stringifiedState).to.not.exist;
      expect(component._stringifiedStateQuery).to.not.exist;
      expect(component._stringifiedStateResults).to.not.exist;
      expect(component._link).to.not.exist;
      expect(component._validateId).to.be.false;
    });

    test('does have expected components', function() {
      expect(component.$$('paper-icon-button')).to.exist;
      expect(component.$$('paper-dialog')).to.exist;
      expect(component.$$('paper-dialog').id).to.equal('linkDialog');
    });

    test('_createStringifiedState with entity page type does return entity page JSON strings', function() {
      expect(component._createStringifiedState({}, 'entity')).to.equal(DEFAULT_STRING_ENTITY_STATE);
      expect(component._createStringifiedState(EXAMPLE_OBJECT_ENTITY_STATE, 'entity')).to.equal(EXAMPLE_STRING_ENTITY_STATE);
    });

    test('_createStringifiedState with search page type does return search page JSON strings', function() {
      expect(component._createStringifiedState({}, 'search')).to.equal(DEFAULT_STRING_SEARCH_STATE);
      expect(component._createStringifiedState(EXAMPLE_OBJECT_SEARCH_STATE, 'search')).to.equal(EXAMPLE_STRING_SEARCH_STATE);
    });

    test('_generateId does return strings', function() {
      expect(component._generateId()).to.be.a('String');
    });

    test('_isEmptyState does return correct values', function() {
      expect(component._isEmptyState({})).to.be.true;
      expect(component._isEmptyState({
        key: []
      })).to.be.true;
      expect(component._isEmptyState({
        key: {}
      })).to.be.true;
      expect(component._isEmptyState({
        key: 'value'
      })).to.be.false;
      expect(component._isEmptyState({
        key: ['value']
      })).to.be.false;
      expect(component._isEmptyState({
        key: {
          value: {}
        }
      })).to.be.false;
    });

    test('_populateCreationBody with entity page type does set _creationBody and _link', function() {
      component._populateCreationBody('id1', EXAMPLE_OBJECT_ENTITY_STATE, 'entity');
      expect(component._creationBody).to.deep.equal({
        id: 'id1',
        state: EXAMPLE_STRING_ENTITY_STATE
      });
      expect(component._link.endsWith('?state=id1')).to.be.true;
    });

    test('_populateCreationBody with search page type does set _creationBody and _link', function() {
      component._populateCreationBody('id1', EXAMPLE_OBJECT_SEARCH_STATE, 'search');
      expect(component._creationBody).to.deep.equal({
        id: 'id1',
        state: EXAMPLE_STRING_SEARCH_STATE
      });
      expect(component._link.endsWith('?state=id1')).to.be.true;
    });

    test('_populateCreationBody with entity type does set _creationBody and _link using defaults if state is empty', function() {
      component._populateCreationBody('id1', {}, 'entity');
      expect(component._creationBody).to.deep.equal({
        id: 'id1',
        state: DEFAULT_STRING_ENTITY_STATE
      });
      expect(component._link.endsWith('?state=id1')).to.be.true;
    });

    test('_populateCreationBody with search type does set _creationBody and _link using defaults if state is empty', function() {
      component._populateCreationBody('id1', {}, 'search');
      expect(component._creationBody).to.deep.equal({
        id: 'id1',
        state: DEFAULT_STRING_SEARCH_STATE
      });
      expect(component._link.endsWith('?state=id1')).to.be.true;
    });

    test('_updateFilterCollection with empty object and entity page type does set filterCollection', function() {
      component._updateFilterCollection('{}', 'entity');
      expect(component.filterCollection).to.deep.equal(DEFAULT_OBJECT_ENTITY_STATE);
    });

    test('_updateFilterCollection with non-empty object and entity page type sets filterCollection', function() {
      component._updateFilterCollection(EXAMPLE_STRING_ENTITY_STATE, 'entity');
      expect(component.filterCollection).to.deep.equal(EXAMPLE_OBJECT_ENTITY_STATE);
    });

    test('_updateFilterCollection with empty object and search page type does set filterCollection', function() {
      component._updateFilterCollection('{}', 'search');
      expect(component.filterCollection).to.deep.equal(DEFAULT_OBJECT_SEARCH_STATE);
    });

    test('_updateFilterCollection with non-empty object and search page type sets filterCollection', function() {
      component._updateFilterCollection(EXAMPLE_STRING_SEARCH_STATE, 'search');
      expect(component.filterCollection).to.deep.equal(EXAMPLE_OBJECT_SEARCH_STATE);
    });

    test('_updateUrlAndShowDialog does set _link', function() {
      component._updateUrlAndShowDialog('id1');
      expect(component._link.endsWith('?state=id1')).to.be.true;
    });

    test('generateLink does set _stringifiedState', function() {
      component.filterCollection = EXAMPLE_OBJECT_ENTITY_STATE;
      component.generateLink();
      expect(component._stringifiedState).to.equal(EXAMPLE_STRING_ENTITY_STATE);
    });

    test('setting _stateIdQuery does set _creationBody, _link, and _validateId if _validateId is true and hits is empty', function() {
      component.stateId = 'id1';
      component.filterCollection = {};
      component._validateId = true;
      component._stateIdQuery = {};
      component._stateIdResults = {
        hits: {
          hits: []
        }
      };

      expect(component._validateId).to.be.false;
      expect(component._creationBody).to.deep.equal({
        id: 'id1',
        state: DEFAULT_STRING_ENTITY_STATE
      });
      expect(component._link.endsWith('?state=id1')).to.be.true;
    });

    test('setting _stateIdQuery and _stateIdResults does set stateId if _validateId is true', function() {
      component.stateId = 'id1';
      component._validateId = true;
      component._stateIdQuery = {};
      component._stateIdResults = {
        hits: {
          hits: [{
            _source: {
              state: '{}'
            }
          }]
        }
      };

      expect(component.stateId).to.not.equal('id1');
      expect(component.stateId).to.be.a('String');
      expect(component._validateId).to.be.true;
    });

    test('setting _stateIdQuery and _stateIdResults does set filterCollection if _validateId is false', function() {
      component._stateIdQuery = {};
      component._stateIdResults = {
        hits: {
          hits: [{
            _source: {
              state: EXAMPLE_STRING_ENTITY_STATE
            }
          }]
        }
      };
      expect(component.filterCollection).to.deep.equal(EXAMPLE_OBJECT_ENTITY_STATE);
    });

    test('setting _stateIdQuery and _stateIdResults does set filterCollection using defaults if _validateId is false and state is empty', function() {
      component._stateIdQuery = {};
      component._stateIdResults = {
        hits: {
          hits: [{
            _source: {
              state: '{}'
            }
          }]
        }
      };
      expect(component.filterCollection).to.deep.equal(DEFAULT_OBJECT_ENTITY_STATE);
    });

    test('setting _stringifiedStateQuery and _stringifiedStateResults does set stateId and _validateId if hits is empty', function() {
      component._stringifiedStateQuery = {};
      component._stringifiedStateResults = {
        hits: {
          hits: []
        }
      };

      expect(component.stateId).to.be.a('String');
      expect(component._validateId).to.be.true;
    });

    test('setting _stringifiedStateQuery and _stringifiedStateResults does set _link', function() {
      component._stringifiedStateQuery = {};
      component._stringifiedStateResults = {
        hits: {
          hits: [{
            _source: {
              id: 'id1'
            }
          }]
        }
      };

      expect(component._link.endsWith('?state=id1')).to.be.true;
      expect(component.stateId).to.not.exist;
      expect(component._validateId).to.be.false;
    });
  });
</script>
</body>
</html>
