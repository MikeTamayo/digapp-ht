<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>batch-phone</title>
  <script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>
  <script src="../bower_components/test-fixture/test-fixture-mocha.js"></script>
  <link rel="import" href="../bower_components/test-fixture/test-fixture.html">
  <link rel="import" href="../elements/batch-phone/batch-phone.html">
</head>

<body>
<test-fixture id="batch-phone-fixture">
  <template>
    <batch-phone></batch-phone>
  </template>
</test-fixture>

<script>
  /* globals suite, test, expect, setup, fixture, flush */
  /* jshint -W030 */
  suite('<batch-phone> default tests', function() {
    var component;

    setup(function() {
      component = fixture('batch-phone-fixture');
      component.searchParameters = {};
    });

    test('default properties are correct', function() {
      expect(component.clearFacets).to.be.true;
      expect(component._phoneInput).to.equal('');
    });

    test('does have expected elements', function() {
      expect(component.$$('paper-icon-button')).to.exist;
      expect(component.$$('paper-dialog')).to.exist;
      expect(component.$$('paper-dialog').id).to.equal('batchPhoneDialog');
      expect(component.$$('file-upload')).to.exist;
      expect(component.$$('file-upload').id).to.equal('fileUpload');
    });

    test('_cleanPhoneInput does not change numbers', function() {
      expect(component._cleanPhoneInput('1234567890')).to.equal('1234567890');
    });

    test('_cleanPhoneInput does replace commas or semicolons with spaces', function() {
      expect(component._cleanPhoneInput('1234567890,8905671234')).to.equal('1234567890 8905671234');
      expect(component._cleanPhoneInput('1234567890;8905671234')).to.equal('1234567890 8905671234');
    });

    test('_cleanPhoneInput does remove punctuation', function() {
      expect(component._cleanPhoneInput('123-456-7890')).to.equal('1234567890');
      expect(component._cleanPhoneInput('123.456.7890')).to.equal('1234567890');
      expect(component._cleanPhoneInput('(123)4567890')).to.equal('1234567890');
      expect(component._cleanPhoneInput('(123)-456-7890')).to.equal('1234567890');
    });

    test('_cleanPhoneInput does remove letters', function() {
      expect(component._cleanPhoneInput('phone1234567890')).to.equal('1234567890');
    });

    test('_createSearchListener.onClick does nothing if _phoneInput is blank', function() {
      component._phoneInput = '';
      var listener = component._createSearchListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
      expect(component.searchParameters.text).to.not.exist;
    });

    test('_createSearchListener.onClick sets searchParameters.text and clears _phoneInput', function() {
      component._phoneInput = '1234567890';
      var listener = component._createSearchListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
      expect(component.searchParameters.text).to.equal('1234567890');
      expect(component._phoneInput).to.equal('');
    });

    test('_createSearchListener.onClick sets searchParameters.text with cleaned input', function() {
      component._phoneInput = '(123)-456-7890';
      var listener = component._createSearchListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
      expect(component.searchParameters.text).to.equal('1234567890');
      expect(component._phoneInput).to.equal('');
    });

    test('_createSearchListener.onClick with clearFacets clears and resets searchParameters except annotationsFilter and sort', function() {
      component.searchParameters = {
        key1: {
          property: 'value1'
        },
        key2: 'value2',
        annotationsFilter: 'filter',
        sort: 'sort'
      };
      component._phoneInput = '1234567890';
      var listener = component._createSearchListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
      expect(component.searchParameters.text).to.equal('1234567890');
      expect(component.searchParameters.sort).to.equal('sort');
      expect(component.searchParameters.annotationsFilter).to.equal('filter');
      expect(component.searchParameters.key1).to.not.exist;
      expect(component.searchParameters.key2).to.not.exist;
      expect(component._phoneInput).to.equal('');
    });

    test('_createSearchListener.onClick without clearFacets only sets searchParameters.text', function() {
      component.clearFacets = false;
      component.searchParameters = {
        key1: {
          property: 'value1'
        },
        key2: 'value2'
      };
      component._phoneInput = '1234567890';
      var listener = component._createSearchListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
      expect(component.searchParameters).to.deep.equal({
        key1: {
          property: 'value1'
        },
        key2: 'value2',
        text: '1234567890'
      });
      expect(component._phoneInput).to.equal('');
    });

    test('_createClearListener.onClick clears _phoneInput', function() {
      component._phoneInput = '1234567890';
      var listener = component._createClearListener();
      expect(listener).to.be.an('Object');
      expect(listener.onClick).to.be.a('Function');
      listener.onClick();
      expect(component._phoneInput).to.equal('');
    });

    test('_setPhoneInputToFileText sets _phoneInput', function() {
      component._setPhoneInputToFileText({
        detail: {
          xhr: {
            response: '1234567890'
          }
        }
      });
      expect(component._phoneInput).to.equal('1234567890');
    });

    test('open() opens the dialog', function(done) {
      var dialog = component.$$('#batchPhoneDialog');
      expect(dialog.style.display).to.equal('none');
      component.open();
      flush(function() {
        expect(dialog.style.display).to.equal('');
        done();
      });
    });
  });
</script>
</body>
</html>
