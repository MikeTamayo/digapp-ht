<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>

<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="generator" content="Polymer Starter Kit" />
  <title>DIG</title>
  <!-- Place favicon.ico in the `app/` directory -->

  <!-- Chrome for Android theme color -->
  <meta name="theme-color" content="#2E3AA1">

  <!-- Web Application Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Tile color for Win8 -->
  <meta name="msapplication-TileColor" content="#3372DF">

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PSK">
  <link rel="icon" sizes="192x192" href="images/touch/chrome-touch-icon-192x192.png">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Polymer Starter Kit">
  <link rel="apple-touch-icon" href="images/touch/apple-touch-icon.png">

  <!-- Tile icon for Win8 (144x144) -->
  <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">

  <!-- build:css styles/main.css -->
  <!-- Must link leaflet css (https://github.com/leaflet-extras/leaflet-map/issues/46) -->
  <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="styles/main.css">
  <!-- endbuild-->

  <!-- build:js bower_components/webcomponentsjs/webcomponents-lite.min.js -->
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <!-- endbuild -->

  <script src="scripts/google-analytics.js"></script>
  
  <!-- will be replaced with elements/elements.vulcanized.html -->
  <link rel="import" href="elements/elements.html">
  <!-- endreplace-->

  <link rel="import" href="styles/custom-icons.html">
  <link rel="import" href="styles/icon-styles.html">
  <style is="custom-style" include="icon-styles"></style>
</head>

<body unresolved class="fullbleed layout vertical">
  <span id="browser-sync-binding"></span>

  <template is="dom-bind" id="app">
    <!-- exposes clientConfig object which is a container for data
      transform functions -->
    <client-config config="{{clientConfig}}"></client-config>

    <!--get app configuration from server -->
    <iron-ajax
      auto
      url="/config"
      handle-as="json"
      last-response="{{config}}">
    </iron-ajax>

    <!--initialize new elastic client connection to server
      esclient can be used throughout the application lifecycle -->
    <elastic-client
      config="[[config.elasticConfig]]"
      client="{{esclient}}">
    </elastic-client>

    <!--TODO: temporarily querying elasticsearch directly -->
    <query-builder
      age-field="[[ageConfig.queryField]]"
      city-field="[[cityConfig.queryField]]"
      country-field="[[countryConfig.queryField]]"
      date-field="fields.posting-date.relaxed.name"
      email-field="[[emailConfig.queryField]]"
      ethnicity-field="[[ethnicityConfig.queryField]]"
      eye-field="[[eyeColorConfig.queryField]]"
      hair-field="[[hairColorConfig.queryField]]"
      height-field="[[heightConfig.queryField]]"
      location-field="[[locationConfig.queryField]]"
      name-field="[[nameConfig.queryField]]"
      phone-field="[[phoneConfig.queryField]]"
      price-field="[[priceConfig.queryField]]"
      region-field="[[regionConfig.queryField]]"
      website-field="[[websiteConfig.queryField]]"
      weight-field="[[weightConfig.queryField]]"
      search-parameters="[[searchParameters]]"
      query="{{ejsQuery}}">
    </query-builder>

    <!-- Main Search Query -->
    <elastic-client-highlight-builder
      fields='["*"]'
      pre-tags="<highlight>"
      post-tags="</highlight>"
      number-of-fragments="0"
      ejs-highlight="{{highlight}}">
    </elastic-client-highlight-builder>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      page="{{pageNum}}"
      page-size="{{pageSize}}"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{searchResults}}"
      last-error="{{searchError}}"
      result-count="{{resultCount}}"
      aggregations="[]"
      filters="[]"
      sort="{{sort}}"
      highlight="[[highlight]]"
      loading="{{loading}}"
      request-as-json="{{esRequest}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <json-transform
      data-in="{{searchResults}}"
      data-out="{{records}}"
      transform-function="[[clientConfig.transforms.offer.offers]]">
    </json-transform>

    <!-- Facets -->
    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{websiteResult}}"
      last-error="{{websiteError}}"
      aggregations="{{buildArray(websiteAgg)}}"
      filters="[]"
      loading="{{websiteLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{countryResult}}"
      last-error="{{countryError}}"
      aggregations="{{buildArray(countryAgg)}}"
      filters="[]"
      loading="{{countryLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{regionResult}}"
      last-error="{{regionError}}"
      aggregations="{{buildArray(regionAgg)}}"
      filters="[]"
      loading="{{regionLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{cityResult}}"
      last-error="{{cityError}}"
      aggregations="{{buildArray(cityAgg)}}"
      filters="[]"
      loading="{{cityLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{phoneResult}}"
      last-error="{{phoneError}}"
      aggregations="{{buildArray(phoneAgg)}}"
      filters="[]"
      loading="{{phoneLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{emailResult}}"
      last-error="{{emailError}}"
      aggregations="{{buildArray(emailAgg)}}"
      filters="[]"
      loading="{{emailLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{priceResult}}"
      last-error="{{priceError}}"
      aggregations="{{buildArray(priceAgg)}}"
      filters="[]"
      loading="{{priceLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{nameResult}}"
      last-error="{{nameError}}"
      aggregations="{{buildArray(nameAgg)}}"
      filters="[]"
      loading="{{nameLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{ageResult}}"
      last-error="{{ageError}}"
      aggregations="{{buildArray(ageAgg)}}"
      filters="[]"
      loading="{{ageLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{ethnicityResult}}"
      last-error="{{ethnicityError}}"
      aggregations="{{buildArray(ethnicityAgg)}}"
      filters="[]"
      loading="{{ethnicityLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{hairColorResult}}"
      last-error="{{hairColorError}}"
      aggregations="{{buildArray(hairColorAgg)}}"
      filters="[]"
      loading="{{hairColorLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{eyeColorResult}}"
      last-error="{{eyeColorError}}"
      aggregations="{{buildArray(eyeColorAgg)}}"
      filters="[]"
      loading="{{eyeColorLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{heightResult}}"
      last-error="{{heightError}}"
      aggregations="{{buildArray(heightAgg)}}"
      filters="[]"
      loading="{{heightLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{weightResult}}"
      last-error="{{weightError}}"
      aggregations="{{buildArray(weightAgg)}}"
      filters="[]"
      loading="{{weightLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{imageResult}}"
      last-error="{{imageError}}"
      aggregations="{{buildArray(imageAgg)}}"
      filters="[]"
      loading="{{imageLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>
    <!-- End Facets -->

    <dig-logger
      es-client="[[esclient]]"
      es-index="[[config.logIndex]]"
      es-type="[[config.logType]]"
      supertype="Search"
      subtype="SubmitQuery"
      value="[[logMessage]]"
      username="[[config.username]]"
      logger="{{logger}}">
    </dig-logger>

    <search-log-message-assembler
      age-selected="[[searchParameters.age]]"
      city-selected="[[searchParameters.city]]"
      country-selected="[[searchParameters.country]]"
      date-end-selected="[[searchParameters.dateEnd]]"
      date-start-selected="[[searchParameters.dateStart]]"
      email-selected="[[searchParameters.email]]"
      ethnicity-selected="[[searchParameters.ethnicity]]"
      eye-selected="[[searchParameters.eyeColor]]"
      hair-selected="[[searchParameters.hairColor]]"
      height-selected="[[searchParameters.height]]"
      image-selected="[[searchParameters.image]]"
      name-selected="[[searchParameters.name]]"
      phone-selected="[[searchParameters.phone]]"
      price-selected="[[searchParameters.price]]"
      region-selected="[[searchParameters.region]]"
      website-selected="[[searchParameters.website]]"
      weight-selected="[[searchParameters.weight]]"
      log-message="{{logMessage}}">
    </search-log-message-assembler>

    <annotation-manager
      client="[[esclient]]"
      annotation-index="[[config.annotationIndex]]"
      annotation-type="[[config.annotationType]]"
      relevant="[[config.annotationRelevant]]"
      username="[[config.username]]"
      annotations="{{annotations}}"
      annotation-manager="{{annotationManager}}">
    </annotation-manager>

    <paper-header-panel class="flex" mode="waterfall">

      <!-- Search toolbar -->
      <paper-toolbar id="navbar">
        <img class="bottom" src="images/dig-logo-original.png" alt="">
        <div class="bottom drawer-spacer"></div>

        <!-- Hide until we can support multiple search types.
        <div class="bottom v-divider"></div>
        <elastic-type-selector class="bottom white-input-container"
          available-types="{{config.elasticTypes}}"
          elastic-types="{{esTypes}}">
        </elastic-type-selector>
        -->

        <div class="bottom v-divider"></div>

        <div class="white-input-container bottom flex">
          <paper-button class="layout horizontal center bottom"
            style$="{{fieldsDropdownBtnStyle(fieldsDropdownOpened)}}" on-tap="toggleSearchFieldsDropdownPanel"
            title="View Search Options">
            <iron-icon icon="search" class="bottom"></iron-icon>
            <span class="search-options-title">View Search Options</span>
          </paper-button>
        </div>

        <a class="bottom" href="." style="color: #ffffff;">
          <paper-icon-button icon="clear" title="Reset Page"></paper-icon-button>
        </a>

        <load-user-info class="bottom"
          show-search
          client="[[esclient]]"
          loading="[[loading]]"
          username="[[config.username]]"
          user-id="{{userId}}"
          user-record-exists="{{userRecordExists}}"
          advanced-search="{{advancedSearch}}"
          blur-images="{{blurImages}}"
          searches="{{userSearches}}"
          search-parameters="{{searchParameters}}"
          es-request="{{esRequest}}"
          user-index="[[config.userIndex]]"
          user-type="[[config.userType]]"
          notification-query-date="{{notificationDate}}"
          sort-newest='Sort("fields.posting-date.relaxed.key").order("desc")'
          current-sort="[[selectedSort]]"
          save-user-data-callback="[[saveUserDataCallback]]"
          run-user-query-callback="{{runUserQueryCallback}}"
          process-request="{{processRequest}}">
        </load-user-info>

        <save-search id="saveSearchDialog"
          client="[[esclient]]"
          username="[[config.username]]"
          user-id="[[userId]]"
          existing-searches="{{userSearches}}"
          search-parameters="[[searchParameters]]"
          es-request="[[esRequest]]"
          user-index="[[config.userIndex]]"
          user-type="[[config.userType]]"
          user-record-exists="[[userRecordExists]]"
          run-user-query-callback="[[runUserQueryCallback]]"
          save-user-data-callback="{{saveUserDataCallback}}">
        </save-search>

        <bulk-search
          id="bulkSearchDialog"
          category="[[phoneConfig.title]]"
          search-parameters="{{searchParameters}}"
          process-request="{{processRequest}}">
        </bulk-search>

        <similar-image-search id="similarImageSearchDialog"
          logger="[[logger]]"
          blur="[[blurImages]]"
          image-service-auth="[[config.imageServiceAuth]]"
          image-service-host="[[config.imageServiceHost]]"
          link-function="[[clientConfig.transforms.image.externalImageLink]]">
        </similar-image-search>

        <search-help id="searchHelpDialog"></search-help>

        <state-manager id="stateManager"
          page-type="search"
          client="[[esclient]]"
          state-index="[[config.filterStatesIndex]]"
          state-type="[[config.filterStatesType]]"
          state-id="[[params.state]]"
          filter-collection="{{searchParameters}}"
          process-request="{{processRequest}}">
        </state-manager>

        <paper-icon-button icon="menu" class="bottom dropdown-trigger" title="More Options" on-tap="toggleMenu"></paper-icon-button>

        <iron-dropdown id="menuDropdown" class="bottom" horizontal-align="right" vertical-align="top" vertical-offset="80">
          <div class="dropdown-content">
            <paper-icon-item title="Show All Results" on-tap="showAll">
              <iron-icon icon="custom-icons:show-all" item-icon></iron-icon>
              Show All Results
            </paper-icon-item>

            <paper-icon-item disabled="[[isSaveButtonDisabled(searchResults, searchError)]]" title="Save the Selected Search Terms" on-tap="openSaveSearchDialog">
              <iron-icon icon="save" item-icon></iron-icon>
              Save Search
            </paper-icon-item>

            <paper-icon-item disabled="[[noSearchParameters(searchParameters.*)]]" title="Generate a Link for this Page with the Selected Search Terms" on-tap="generateLink">
              <iron-icon icon="link" item-icon></iron-icon>
              Generate Link
            </paper-icon-item>

            <paper-icon-item title="Upload or Enter Multiple Telephone Numbers" on-tap="openBatchPhoneSearchDialog">
              <iron-icon icon="file-upload" item-icon></iron-icon>
              Bulk Telephone Search
            </paper-icon-item>

            <paper-icon-item title="Search on an Image URL or Uploaded Image" on-tap="openSimilarImageSearchDialog">
              <iron-icon icon="image:compare" item-icon></iron-icon>
              Similar Image Search
            </paper-icon-item>

            <paper-icon-item active="[[advancedSearch]]" class="toggle" title="[[getAdvancedSearchTitle(advancedSearch)]]" on-tap="toggleAdvancedSearch">
              <iron-icon icon="custom-icons:advanced-search" item-icon></iron-icon>
              Toggle Advanced Search Mode
            </paper-icon-item>

            <paper-icon-item title="Search Help" on-tap="openSearchHelpDialog">
              <iron-icon icon="help" item-icon></iron-icon>
              Search Help
            </paper-icon-item>

            <paper-icon-item title="Contact DIG Support" on-tap="emailSupport">
              <iron-icon icon="communication:contact-mail" item-icon></iron-icon>
              Contact DIG Support
            </paper-icon-item>
          </div>
        </iron-dropdown>
      </paper-toolbar>

      <!-- search fields dropdown panel -->
      <iron-dropdown id="fieldsDropdown"
        class="bottom"
        opened="{{fieldsDropdownOpened}}"
        horizontal-align="right"
        horizontal-offset="150"
        vertical-align="top"
        vertical-offset="80"
        no-cancel-on-esc-key
        no-cancel-on-outside-click
        with-backdrop
        on-opened-changed="toggleProcessRequest">

        <div class="dropdown-content search-options">
          <div class="h-divider"></div>

          <div class="header">Enter text for the fields you would like to search on. For reporting purposes, check each field that you would like included in your reports.</div>

          <div style="horizontal layout wrap flex">
            <template is="dom-repeat" items="[[searchFields]]" as="item">
              <div class="horizontal layout center fields-container">
                <paper-input id$="input_[[item.key]]"
                  label="[[item.title]]"
                  value="{{item.value}}">
                </paper-input>
                <paper-icon-button icon="add" title="Add Search Term" on-tap="addSearchTerm"></paper-icon-button>
                <paper-checkbox noink checked="{{item.includeInReports}}"></paper-checkbox>
              </div>
            </template>
          </div>

          <div class="h-divider"></div>

          <div class="horizontal layout center-justified">
            <button-action text="Search" on-tap="toggleSearchFieldsDropdownPanel"></button-action>
          </div>

          <div class="h-divider"></div>
        </div>
      </iron-dropdown>

      <paper-drawer-panel drawer-width="320px">

        <!-- Sidebar on left side -->
        <paper-header-panel drawer>
          <paper-toolbar class="drawer-header">
            <div class="layout vertical">
              <!--TODO: create different sort for all types + different elastic-client-searches for all types -->
              <elastic-sort-input class="layout horizontal" field="fields.posting-date.relaxed.key" selected="{{searchParameters.sort}}">
              </elastic-sort-input>
              <elastic-sort input-string="[[searchParameters.sort]]" sort="{{sort}}"></elastic-sort>

              <div class="h-divider"></div>

              <template is="dom-if" if="[[noSearchParameters(searchParameters.*)]]">
                <div class="no-selected-facets">No Selected Search Terms</div>
              </template>

              <div class="layout horizontal wrap">
                <selected-facets-display facet-selection="{{searchParameters.dateStart}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.dateEnd}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.website}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.location}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.country}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.region}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.city}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.phone}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.email}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.name}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.age}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.ethnicity}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.height}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.weight}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.hairColor}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.eyeColor}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.image}}"></selected-facets-display>
              </div>

              <div class="h-divider"></div>
            </div>
          </paper-toolbar>

          <iron-pages attr-for-selected="data-type" selected="ads">
            <section data-type="ads">
              <div class="layout horizontal facet filter-header" title="Toggle All Facets" on-tap="toggleAllFacetLists">
                <span class="flex">Facets</span>
                <span>[[getToggleAllFacetsText(facetListsExpanded)]]</span>
                <iron-icon icon="[[getToggleAllFacetsIcon(facetListsExpanded)]]"</iron-icon>
              </div>

              <div class="h-divider"></div>

              <!-- TODO
              <div id="date" class="layout horizontal facet filter-header" title="Toggle Dates" on-tap="toggleList">
                <span class="flex">Date</span>
                <iron-icon id="date-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="date-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <iron-collapse id="date-list" class="filter-list" opened>
                <date-range-display
                  facet-selection="{{searchParameters.dateCreated}}">
                </date-range-display>
              </iron-collapse>

              <div class="h-divider"></div>
              -->

              <div id="website" class="layout horizontal facet filter-header" title="Toggle [[websiteConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(websiteConfig.title, websiteResultList)]]</span>
                <iron-icon id="website-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="website-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[websiteConfig.key]]"
                field="[[websiteConfig.aggregationField]]"
                count="{{websiteCount}}"
                ejs-aggregation="{{websiteAgg}}"
                type="terms"
                order="{{websiteSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[websiteResult]]"
                data-in2="[[websiteConfig.key]]"
                data-out="{{websiteResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[websiteConfig.title]]"
                list="{{websiteSelectedList}}"
                object="{{searchParameters.website}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{websiteCount}}"
                    items="[[websiteResultList]]"
                    error="[[websiteError]]"
                    loading="[[websiteLoading]]"
                    item-type="[[websiteConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{websiteSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[websiteResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{websiteSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="website-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[websiteResultList]]"
                  selected-ids="{{websiteSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[websiteError]]" message="{{websiteErrorMessage}}"></elastic-error>
                <status-text
                  count="[[websiteResultList.length]]"
                  error="[[websiteErrorMessage]]"
                  loading="[[websiteLoading]]"
                  empty="No [[websiteConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="country" class="layout horizontal facet filter-header" title="Toggle [[countryConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(countryConfig.title, countryResultList)]]</span>
                <iron-icon id="country-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="country-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[countryConfig.key]]"
                field="[[countryConfig.aggregationField]]"
                count="{{countryCount}}"
                ejs-aggregation="{{countryAgg}}"
                type="terms"
                order="{{countrySortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[countryResult]]"
                data-in2="[[countryConfig.key]]"
                data-out="{{countryResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[countryConfig.title]]"
                list="{{countrySelectedList}}"
                object="{{searchParameters.country}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{countryCount}}"
                    items="[[countryResultList]]"
                    error="[[countryError]]"
                    loading="[[countryLoading]]"
                    item-type="[[countryConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{countrySortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[countryResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{countrySortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="country-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[countryResultList]]"
                  selected-ids="{{countrySelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[countryError]]" message="{{countryErrorMessage}}"></elastic-error>
                <status-text
                  count="[[countryResultList.length]]"
                  error="[[countryErrorMessage]]"
                  loading="[[countryLoading]]"
                  empty="No [[countryConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="region" class="layout horizontal facet filter-header" title="Toggle [[regionConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(regionConfig.title, regionResultList)]]</span>
                <iron-icon id="region-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="region-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[regionConfig.key]]"
                field="[[regionConfig.aggregationField]]"
                count="{{regionCount}}"
                ejs-aggregation="{{regionAgg}}"
                type="terms"
                order="{{regionSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[regionResult]]"
                data-in2="[[regionConfig.key]]"
                data-out="{{regionResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[regionConfig.title]]"
                list="{{regionSelectedList}}"
                object="{{searchParameters.region}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{regionCount}}"
                    items="[[regionResultList]]"
                    error="[[regionError]]"
                    loading="[[regionLoading]]"
                    item-type="[[regionConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{regionSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[regionResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{regionSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="region-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[regionResultList]]"
                  selected-ids="{{regionSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[regionError]]" message="{{regionErrorMessage}}"></elastic-error>
                <status-text
                  count="[[regionResultList.length]]"
                  error="[[regionErrorMessage]]"
                  loading="[[regionLoading]]"
                  empty="No [[regionConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="city" class="layout horizontal facet filter-header" title="Toggle [[cityConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(cityConfig.title, cityResultList)]]</span>
                <iron-icon id="city-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="city-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[cityConfig.key]]"
                field="[[cityConfig.aggregationField]]"
                count="{{cityCount}}"
                ejs-aggregation="{{cityAgg}}"
                type="terms"
                order="{{citySortOrder}}">
              </elastic-client-aggregation-builder>

              <json-transform
                data-in="{{cityResult}}"
                data-out="{{cityAndStateResult}}"
                transform-function="[[clientConfig.transforms.filterAggs.cities]]">
              </json-transform>

              <json-combine
                data-in1="[[cityAndStateResult]]"
                data-in2="[[cityConfig.key]]"
                data-out="{{cityResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[cityConfig.title]]"
                text-function="[[clientConfig.transforms.filterAggs.cityIdToText]]"
                list="{{citySelectedList}}"
                object="{{searchParameters.city}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{cityCount}}"
                    items="[[cityResultList]]"
                    error="[[cityError]]"
                    loading="[[cityLoading]]"
                    item-type="[[cityConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="text"
                    order-by="{{citySortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[cityResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{citySortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="city-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="text"
                  items="[[cityResultList]]"
                  selected-ids="{{citySelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[cityError]]" message="{{cityErrorMessage}}"></elastic-error>
                <status-text
                  count="[[cityResultList.length]]"
                  error="[[cityErrorMessage]]"
                  loading="[[cityLoading]]"
                  empty="No [[cityConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="phone" class="layout horizontal facet filter-header" title="Toggle [[phoneConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(phoneConfig.title, phoneResultList)]]</span>
                <iron-icon id="phone-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="phone-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[phoneConfig.key]]"
                field="[[phoneConfig.aggregationField]]"
                count="{{phoneCount}}"
                ejs-aggregation="{{phoneAgg}}"
                type="terms"
                order="{{phoneSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[phoneResult]]"
                data-in2="[[phoneConfig.key]]"
                data-out="{{phoneResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[phoneConfig.title]]"
                list="{{phoneSelectedList}}"
                object="{{searchParameters.phone}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{phoneCount}}"
                    items="[[phoneResultList]]"
                    error="[[phoneError]]"
                    loading="[[phoneLoading]]"
                    item-type="[[phoneConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{phoneSortOrder}}">
                  </aggregation-popup>
                </div>
                <div class="self-end">
                  <template is="dom-if" if="[[phoneResultList.length]]">
                    <aggregation-sort order-by="{{phoneSortOrder}}"></aggregation-sort>
                  </template>
                </div>
              </div>

              <iron-collapse id="phone-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  id-property="key"
                  count-property="doc_count"
                  text-property="key"
                  items="[[phoneResultList]]"
                  selected-ids="{{phoneSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[phoneError]]" message="{{phoneErrorMessage}}"></elastic-error>
                <status-text
                  count="[[phoneResultList.length]]"
                  error="[[phoneErrorMessage]]"
                  loading="[[phoneLoading]]"
                  empty="No [[phoneConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="email" class="layout horizontal facet filter-header" title="Toggle [[emailConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(emailConfig.title, emailResultList)]]</span>
                <iron-icon id="email-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="email-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[emailConfig.key]]"
                field="[[emailConfig.aggregationField]]"
                count="{{emailCount}}"
                ejs-aggregation="{{emailAgg}}"
                type="terms"
                order="{{emailSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[emailResult]]"
                data-in2="[[emailConfig.key]]"
                data-out="{{emailResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[emailConfig.title]]"
                list="{{emailSelectedList}}"
                object="{{searchParameters.email}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{emailCount}}"
                    items="[[emailResultList]]"
                    error="[[emailError]]"
                    loading="[[emailLoading]]"
                    item-type="[[emailConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{emailSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[emailResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{emailSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="email-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[emailResultList]]"
                  selected-ids="{{emailSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[emailError]]" message="{{emailErrorMessage}}"></elastic-error>
                <status-text
                  count="[[emailResultList.length]]"
                  error="[[emailErrorMessage]]"
                  loading="[[emailLoading]]"
                  empty="No [[emailConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="price" class="layout horizontal facet filter-header" title="Toggle [[priceConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(priceConfig.title, priceResultList)]]</span>
                <iron-icon id="price-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="price-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[priceConfig.key]]"
                field="[[priceConfig.aggregationField]]"
                count="{{priceCount}}"
                ejs-aggregation="{{priceAgg}}"
                type="terms"
                order="{{priceSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[priceResult]]"
                data-in2="[[priceConfig.key]]"
                data-out="{{priceResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[priceConfig.title]]"
                list="{{priceSelectedList}}"
                object="{{searchParameters.price}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{priceCount}}"
                    items="[[priceResultList]]"
                    error="[[priceError]]"
                    loading="[[priceLoading]]"
                    item-type="[[priceConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{priceSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[priceResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{priceSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="price-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[priceResultList]]"
                  selected-ids="{{priceSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[priceError]]" message="{{priceErrorMessage}}"></elastic-error>
                <status-text
                  count="[[priceResultList.length]]"
                  error="[[priceErrorMessage]]"
                  loading="[[priceLoading]]"
                  empty="No [[priceConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="name" class="layout horizontal facet filter-header" title="Toggle [[nameConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(nameConfig.title, nameResultList)]]</span>
                <iron-icon id="name-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="name-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[nameConfig.key]]"
                field="[[nameConfig.aggregationField]]"
                count="{{nameCount}}"
                ejs-aggregation="{{nameAgg}}"
                type="terms"
                order="{{nameSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[nameResult]]"
                data-in2="[[nameConfig.key]]"
                data-out="{{nameResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[nameConfig.title]]"
                list="{{nameSelectedList}}"
                object="{{searchParameters.name}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{nameCount}}"
                    items="[[nameResultList]]"
                    error="[[nameError]]"
                    loading="[[nameLoading]]"
                    item-type="[[nameConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{nameSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[nameResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{nameSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="name-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[nameResultList]]"
                  selected-ids="{{nameSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[nameError]]" message="{{nameErrorMessage}}"></elastic-error>
                <status-text
                  count="[[nameResultList.length]]"
                  error="[[nameErrorMessage]]"
                  loading="[[nameLoading]]"
                  empty="No [[nameConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="age" class="layout horizontal facet filter-header" title="Toggle [[ageConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(ageConfig.title, ageResultList)]]</span>
                <iron-icon id="age-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="age-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[ageConfig.key]]"
                field="[[ageConfig.aggregationField]]"
                count="{{ageCount}}"
                ejs-aggregation="{{ageAgg}}"
                type="terms"
                order="{{ageSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[ageResult]]"
                data-in2="[[ageConfig.key]]"
                data-out="{{ageResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[ageConfig.title]]"
                list="{{ageSelectedList}}"
                object="{{searchParameters.age}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{ageCount}}"
                    items="[[ageResultList]]"
                    error="[[ageError]]"
                    loading="[[ageLoading]]"
                    item-type="[[ageConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{ageSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[ageResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{ageSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="age-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[ageResultList]]"
                  selected-ids="{{ageSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[ageError]]" message="{{ageErrorMessage}}"></elastic-error>
                <status-text
                  count="[[ageResultList.length]]"
                  error="[[ageErrorMessage]]"
                  loading="[[ageLoading]]"
                  empty="No [[ageConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="ethnicity" class="layout horizontal facet filter-header" title="Toggle [[ethnicityConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(ethnicityConfig.title, ethnicityResultList)]]</span>
                <iron-icon id="ethnicity-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="ethnicity-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[ethnicityConfig.key]]"
                field="[[ethnicityConfig.aggregationField]]"
                count="{{ethnicityCount}}"
                ejs-aggregation="{{ethnicityAgg}}"
                type="terms"
                order="{{ethnicitySortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[ethnicityResult]]"
                data-in2="[[ethnicityConfig.key]]"
                data-out="{{ethnicityResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[ethnicityConfig.title]]"
                list="{{ethnicitySelectedList}}"
                object="{{searchParameters.ethnicity}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{ethnicityCount}}"
                    items="[[ethnicityResultList]]"
                    error="[[ethnicityError]]"
                    loading="[[ethnicityLoading]]"
                    item-type="[[ethnicityConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{ethnicitySortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[ethnicityResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{ethnicitySortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="ethnicity-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[ethnicityResultList]]"
                  selected-ids="{{ethnicitySelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[ethnicityError]]" message="{{ethnicityErrorMessage}}"></elastic-error>
                <status-text
                  count="[[ethnicityResultList.length]]"
                  error="[[ethnicityErrorMessage]]"
                  loading="[[ethnicityLoading]]"
                  empty="No [[ethnicityConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="eye-color" class="layout horizontal facet filter-header" title="Toggle [[eyeColorConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(eyeColorConfig.title, eyeColorResultList)]]</span>
                <iron-icon id="eye-color-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="eye-color-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[eyeColorConfig.key]]"
                field="[[eyeColorConfig.aggregationField]]"
                count="{{eyeColorCount}}"
                ejs-aggregation="{{eyeColorAgg}}"
                type="terms"
                order="{{eyeColorSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[eyeColorResult]]"
                data-in2="[[eyeColorConfig.key]]"
                data-out="{{eyeColorResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[eyeColorConfig.title]]"
                list="{{eyeColorSelectedList}}"
                object="{{searchParameters.eyeColor}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{eyeColorCount}}"
                    items="[[eyeColorResultList]]"
                    error="[[eyeColorError]]"
                    loading="[[eyeColorLoading]]"
                    item-type="[[eyeColorConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{eyeColorSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[eyeColorResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{eyeColorSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="eye-color-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[eyeColorResultList]]"
                  selected-ids="{{eyeColorSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[eyeColorError]]" message="{{eyeColorErrorMessage}}"></elastic-error>
                <status-text
                  count="[[eyeColorResultList.length]]"
                  error="[[eyeColorErrorMessage]]"
                  loading="[[eyeColorLoading]]"
                  empty="No [[eyeColorConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="hair-color" class="layout horizontal facet filter-header" title="Toggle [[hairColorConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(hairColorConfig.title, hairColorResultList)]]</span>
                <iron-icon id="hair-color-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="hair-color-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[hairColorConfig.key]]"
                field="[[hairColorConfig.aggregationField]]"
                count="{{hairColorCount}}"
                ejs-aggregation="{{hairColorAgg}}"
                type="terms"
                order="{{hairColorSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[hairColorResult]]"
                data-in2="[[hairColorConfig.key]]"
                data-out="{{hairColorResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[hairColorConfig.title]]"
                list="{{hairColorSelectedList}}"
                object="{{searchParameters.hairColor}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{hairColorCount}}"
                    items="[[hairColorResultList]]"
                    error="[[hairColorError]]"
                    loading="[[hairColorLoading]]"
                    item-type="[[hairColorConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{hairColorSortOrder}}">
                  </aggregation-popup>
                </div>
                <div class="self-end">
                  <template is="dom-if" if="[[hairColorResultList.length]]">
                    <aggregation-sort order-by="{{hairColorSortOrder}}"></aggregation-sort>
                  </template>
                </div>
              </div>

              <iron-collapse id="hair-color-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[hairColorResultList]]"
                  selected-ids="{{hairColorSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[hairColorError]]" message="{{hairColorErrorMessage}}"></elastic-error>
                <status-text
                  count="[[hairColorResultList.length]]"
                  error="[[hairColorErrorMessage]]"
                  loading="[[hairColorLoading]]"
                  empty="No [[hairColorConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="height" class="layout horizontal facet filter-header" title="Toggle [[heightConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(heightConfig.title, heightResultList)]]</span>
                <iron-icon id="height-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="height-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[heightConfig.key]]"
                field="[[heightConfig.aggregationField]]"
                count="{{heightCount}}"
                ejs-aggregation="{{heightAgg}}"
                type="terms"
                order="{{heightSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[heightResult]]"
                data-in2="[[heightConfig.key]]"
                data-out="{{heightResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[heightConfig.title]]"
                list="{{heightSelectedList}}"
                object="{{searchParameters.height}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{heightCount}}"
                    items="[[heightResultList]]"
                    error="[[heightError]]"
                    loading="[[heightLoading]]"
                    item-type="[[heightConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{heightSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[heightResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{heightSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="height-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[heightResultList]]"
                  selected-ids="{{heightSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[heightError]]" message="{{heightErrorMessage}}"></elastic-error>
                <status-text
                  count="[[heightResultList.length]]"
                  error="[[heightErrorMessage]]"
                  loading="[[heightLoading]]"
                  empty="No [[heightConfig.title]]">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="weight" class="layout horizontal facet filter-header" title="Toggle [[weightConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(weightConfig.title, weightResultList)]]</span>
                <iron-icon id="weight-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="weight-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="[[weightConfig.key]]"
                field="[[weightConfig.aggregationField]]"
                count="{{weightCount}}"
                ejs-aggregation="{{weightAgg}}"
                type="terms"
                order="{{weightSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[weightResult]]"
                data-in2="[[weightConfig.key]]"
                data-out="{{weightResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[weightConfig.title]]"
                list="{{weightSelectedList}}"
                object="{{searchParameters.weight}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{weightCount}}"
                    items="[[weightResultList]]"
                    error="[[weightError]]"
                    loading="[[weightLoading]]"
                    item-type="[[weightConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{weightSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[weightResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{weightSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="weight-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[weightResultList]]"
                  selected-ids="{{weightSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[weightError]]" message="{{weightErrorMessage}}"></elastic-error>
                <status-text
                  count="[[weightResultList.length]]"
                  error="[[weightErrorMessage]]"
                  loading="[[weightLoading]]"
                  empty="No [[weightConfig.title]]">
                </status-text>
              </iron-collapse>

              <!-- TODO
              <div class="h-divider"></div>

              <div id="image" class="layout horizontal facet filter-header" title="Toggle [[imageConfig.title]]" on-tap="toggleList">
                <span class="flex">[[getLabelAndCount(imageConfig.title, imageResultList)]]</span>
                <iron-icon id="image-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="image-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="image"
                field="fields.image.relaxed.key"
                count="{{imageCount}}"
                ejs-aggregation="{{imageAgg}}"
                type="terms"
                order="{{imageSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[imageResult]]"
                data-in2="image"
                data-out="{{imageResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <terms-transformer
                category="[[imageConfig.title]]"
                list="{{imageSelectedList}}"
                object="{{searchParameters.image}}">
              </terms-transformer>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{imageCount}}"
                    items="[[imageResultList]]"
                    image-style-class="[[getBlurStyleClass(blurImages)]]"
                    error="[[imageError]]"
                    loading="[[imageLoading]]"
                    item-type="[[imageConfig.title]]"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{imageSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[imageResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{imageSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="image-list" class="filter-list" opened>
                <feature-aggregation show-checkboxes
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[imageResultList]]"
                  selected-ids="{{imageSelectedList}}">
                </feature-aggregation>
                <elastic-error error="[[imageError]]" message="{{imageErrorMessage}}"></elastic-error>
                <status-text
                  count="[[imageResultList.length]]"
                  error="[[imageErrorMessage]]"
                  loading="[[imageLoading]]"
                  empty="No [[imageConfig.title]]">
                </status-text>
              </iron-collapse>
              -->
            </section>

            <section data-type="image"></section>
          </iron-pages>
        </paper-header-panel>

        <!-- Main content on right side -->
        <paper-header-panel main id="searchPanel">
          <div id="searchTitle" class="layout horizontal">
            <template is="dom-if" if="[[!searchError]]">
              <div class="paper-font-title flex">[[recordsListTitle]]</div>
            </template>

            <template is="dom-if" if="[[searchError]]">
              <elastic-error error="[[searchError]]" message="{{searchErrorMessage}}"></elastic-error>
              <div class="paper-font-title flex">
                [[searchErrorMessage]]
              </div>
            </template>

            <export-button
              data="[[shownRecords]]"
              transform-function="[[clientConfig.transforms.offer.createExportData]]">
            </export-button>
          </div>

          <records-list id="searchResults"
            client="[[esclient]]"
            annotation-manager="[[annotationManager]]"
            new-tab="true"
            item-name-property="title"
            query-results="{{records.data}}"
            total-results="{{records.count}}"
            shown-results="{{shownRecords}}"
            page="{{pageNum}}"
            page-size="[[pageSize]]"
            loading="{{loading}}"
            type="Result"
            records-list-title="{{recordsListTitle}}"
            current-user="[[config.username]]"
            blur="[[blurImages]]"
            notification-query-date="{{notificationDate}}">
          </records-list>
        </paper-header-panel>

      </paper-drawer-panel>

    </paper-header-panel>

  </template>

  <!-- Need to include dependencies here for IE -->
  <script src="bower_components/lodash/dist/lodash.js"></script>
  <script src="behaviors/array-behavior.js"></script>
  <script src="behaviors/browser-behavior.js"></script>
  <script src="behaviors/state-behavior.js"></script>

  <script>
    (function(document) {
      /* globals _, DigBehaviors */
      var app = document.querySelector('#app');

      app.facetListsExpanded = true;

      app.searchParameters = DigBehaviors.StateBehavior.buildSearchStateForUI({});

      app.params = DigBehaviors.BrowserBehavior.getUrlParameters(window.location.search);

      DigBehaviors.BrowserBehavior.removeStateParameter(window.history, window.location);

      app.buildArray = DigBehaviors.ArrayBehavior.buildArray;

      app.ageConfig = {
        key: 'age',
        title: 'Provider Age',
        queryField: 'fields.age.relaxed.name',
        aggregationField: 'fields.age.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.cityConfig = {
        key: 'city',
        title: 'City',
        queryField: 'fields.city.relaxed.key',
        aggregationField: 'fields.city.relaxed.key',
        value: ''
      };
      app.countryConfig = {
        key: 'country',
        title: 'Country',
        queryField: 'fields.country.relaxed.name',
        aggregationField: 'fields.country.relaxed.key',
        value: ''
      };
      app.dateEndConfig = {
        key: 'dateEnd',
        title: 'Posted Before (Date)',
        queryField: 'fields.posting-date.relaxed.name',
        aggregationField: 'fields.posting-date.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.dateStartConfig = {
        key: 'dateStart',
        title: 'Posted After (Date)',
        queryField: 'fields.posting-date.relaxed.name',
        aggregationField: 'fields.posting-date.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.emailConfig = {
        key: 'email',
        title: 'Email Address',
        queryField: 'fields.email.relaxed.name',
        aggregationField: 'fields.email.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.ethnicityConfig = {
        key: 'ethnicity',
        title: 'Provider Ethnicity',
        queryField: 'fields.ethnicty.relaxed.name',
        aggregationField: 'fields.ethnicty.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.eyeColorConfig = {
        key: 'eyeColor',
        title: 'Provider Eye Color',
        queryField: 'fields.eye-color.relaxed.name',
        aggregationField: 'fields.eye-color.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.hairColorConfig = {
        key: 'hairColor',
        title: 'Provider Hair Color',
        queryField: 'fields.hair-color.relaxed.name',
        aggregationField: 'fields.hair-color.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.heightConfig = {
        key: 'height',
        title: 'Provider Height (cm)',
        queryField: 'fields.height.relaxed.name',
        aggregationField: 'fields.height.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.imageConfig = {
        key: 'image',
        title: 'Image',
        queryField: 'fields.image.relaxed.name',
        aggregationField: 'fields.image.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.locationConfig = {
        key: 'location',
        title: 'Location',
        queryField: 'fields.city.relaxed.name',
        value: '',
        includeInReports: false
      };
      app.nameConfig = {
        key: 'name',
        title: 'Provider Name',
        queryField: 'fields.name.relaxed.name',
        aggregationField: 'fields.name.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.phoneConfig = {
        key: 'phone',
        title: 'Telephone Number',
        queryField: 'fields.phone.relaxed.name',
        aggregationField: 'fields.phone.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.priceConfig = {
        key: 'price',
        title: 'Price',
        queryField: 'fields.price.relaxed.name',
        aggregationField: 'fields.price.relaxed.key',
        value: '',
        includeInReports: false
      };
      app.regionConfig = {
        key: 'region',
        title: 'State/Region',
        queryField: 'fields.state.relaxed.name',
        aggregationField: 'fields.state.relaxed.key',
        value: ''
      };
      app.websiteConfig = {
        key: 'website',
        title: 'Website',
        queryField: 'tld',
        aggregationField: 'tld',
        value: '',
        includeInReports: false
      };
      app.weightConfig = {
        key: 'weight',
        title: 'Provider Weight (kg)',
        queryField: 'fields.weight.relaxed.name',
        aggregationField: 'fields.weight.relaxed.key',
        value: '',
        includeInReports: false
      };

      app.searchFields = [
        //dateEndConfig,
        //dateStartConfig,
        app.websiteConfig,
        app.locationConfig,
        app.phoneConfig,
        app.emailConfig,
        app.priceConfig,
        app.nameConfig,
        app.ageConfig,
        app.ethnicityConfig,
        app.eyeColorConfig,
        app.hairColorConfig,
        app.heightConfig,
        app.weightConfig
      ];

      app.addSearchTerm = function(event) {
        var item = event.model.item;
        if(item.value) {
          var index = _.findIndex(app.searchFields, {
            key: item.key
          });

          app.set(['searchParameters', item.key, item.value], {
            category: item.title,
            enabled: true,
            key: item.value,
            text: item.value
          });

          // Clear the value and the input element.  (Must do both!)
          app.set(['searchFields', index, 'value'], '');
          document.querySelector('#input_' + item.key).value = '';
        }
      };

      app.toggleSearchFieldsDropdownPanel = function() {
        this.fieldsDropdownOpened = !this.fieldsDropdownOpened;
      };

      app.fieldsDropdownBtnStyle = function(opened) {
        return opened ? 'color: yellowgreen;' : '';
      };
      /* end search dropdown panel code */

      app.emailSupport = function() {
        window.open('mailto:dig-support@nextcentury.com');
      };

      app.generateLink = function() {
        this.$.menuDropdown.close();
        this.$.stateManager.generateLink();
      };

      app.getAdvancedSearchTitle = function(advancedSearch) {
        return 'Click to ' + (advancedSearch ? 'Deactivate' : 'Activate') + ' Advanced Search Mode';
      };

      app.getBlurStyleClass = function(blurImages) {
        return blurImages ? 'small-blur' : '';
      };

      app.getElasticTypes = function() {
        return ['ads'];
      };

      app.isSaveButtonDisabled = function(searchResults, searchError) {
        return !(searchResults !== null && searchError === null);
      };

      app.noSearchParameters = function() {
        return _.keys(app.searchParameters).every(function(facet) {
          if(facet === 'sort' || _.isEmpty(app.searchParameters[facet])) {
            return true;
          }
          return _.keys(app.searchParameters[facet]).every(function(key) {
            return !app.searchParameters[facet][key].enabled;
          });
        });
      };

      app.openBatchPhoneSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.bulkSearchDialog.open();
      };

      app.openSaveSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.saveSearchDialog.open();
      };

      app.openSearchHelpDialog = function() {
        this.$.menuDropdown.close();
        this.$.searchHelpDialog.open();
      };

      app.openSimilarImageSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.similarImageSearchDialog.open();
      };

      app.showAll = function() {
        this.$.menuDropdown.close();
        app.set('searchParameters', DigBehaviors.StateBehavior.buildSearchStateForUI({}));
      };

      app.toggleMenu = function() {
        if(this.$.menuDropdown.style.display === 'none') {
          this.$.menuDropdown.open();
        } else {
          this.$.menuDropdown.close();
        }
      };

      app.toggleAdvancedSearch = function() {
        document.querySelector('load-user-info')._toggleAdvancedSearch();
      };

      /**
       * Opens or closes the facet list corresponding to the ID of the element that triggered the event.
       */
      app.toggleList = function(event) {
        if(event.target.parentElement && event.target.parentElement.id) {
          var type = event.target.parentElement.id;
          if(this.$[type + '-list']) {
            this.$[type + '-list'].toggle();
            this.$[type + '-icon-closed'].style.display = (this.$[type + '-icon-closed'].style.display !== 'none' ? 'none' : '');
            this.$[type + '-icon-opened'].style.display = (this.$[type + '-icon-opened'].style.display !== 'none' ? 'none' : '');
          }
        }
      };

      app.toggleAllFacetLists = function() {
        app.facetListsExpanded = !app.facetListsExpanded;
        // All facet lists should have the class 'facet' and an id
        var allFacetListNames = document.querySelectorAll('.facet');

        for(var i = 0, length = allFacetListNames.length; i < length; i++) {
          if(allFacetListNames[i].id) {
            var name = allFacetListNames[i].id;
            this.$[name + '-list'].opened = app.facetListsExpanded;
            this.$[name + '-icon-closed'].style.display = app.facetListsExpanded ? 'none' : '';
            this.$[name + '-icon-opened'].style.display = (!app.facetListsExpanded) ? 'none' : '';
          }
        }
      };

      app.getToggleAllFacetsText = function() {
        return (app.facetListsExpanded ? 'Collapse' : 'Expand') + ' All';
      };

      app.getToggleAllFacetsIcon = function() {
        return (app.facetListsExpanded ? 'icons:expand-less' : 'icons:expand-more');
      };

      app.generateListFromQueryResults = function(results, property) {
        var list = [];
        if(results && results.aggregations && results.aggregations[property] && results.aggregations[property][property] && results.aggregations[property][property].buckets) {
          list = list.concat(results.aggregations[property][property].buckets);
        }
        return list;
      };

      app.getLabelAndCount = function(name, list) {
        return name + (list.length ? (list.length >= 10 ? ' (Top 10)' : ' (' + list.length + ')') : '');
      };

      app.toggleProcessRequest = function() {
        app.processRequest = !app.fieldsDropdownOpened;
      };
    })(document);
  </script>
</body>

</html>
