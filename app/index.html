<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>

<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="generator" content="Polymer Starter Kit" />
  <title>DIG</title>
  <!-- Place favicon.ico in the `app/` directory -->

  <!-- Chrome for Android theme color -->
  <meta name="theme-color" content="#2E3AA1">

  <!-- Web Application Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Tile color for Win8 -->
  <meta name="msapplication-TileColor" content="#3372DF">

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PSK">
  <link rel="icon" sizes="192x192" href="images/touch/chrome-touch-icon-192x192.png">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Polymer Starter Kit">
  <link rel="apple-touch-icon" href="images/touch/apple-touch-icon.png">

  <!-- Tile icon for Win8 (144x144) -->
  <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">

  <!-- build:css styles/main.css -->
  <!-- Must link leaflet css (https://github.com/leaflet-extras/leaflet-map/issues/46) -->
  <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="styles/main.css">
  <!-- endbuild-->

  <!-- build:js bower_components/webcomponentsjs/webcomponents-lite.min.js -->
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <!-- endbuild -->

  <script src="scripts/google-analytics.js"></script>
  
  <!-- will be replaced with elements/elements.vulcanized.html -->
  <link rel="import" href="elements/elements.html">
  <!-- endreplace-->

  <link rel="import" href="styles/custom-icons.html">
  <link rel="import" href="styles/icon-styles.html">
  <style is="custom-style" include="icon-styles"></style>
</head>

<body unresolved class="fullbleed layout vertical">
  <span id="browser-sync-binding"></span>

  <template is="dom-bind" id="app">
    <client-config config="[[config]]" transforms="{{transforms}}"></client-config>

    <!--get app configuration from server -->
    <iron-ajax
      auto
      url="/config"
      handle-as="json"
      last-response="{{config}}">
    </iron-ajax>

    <!--initialize new elastic client connection to server
      esclient can be used throughout the application lifecycle -->
    <elastic-client
      config="[[config.elasticConfig]]"
      client="{{esclient}}">
    </elastic-client>

    <query-transformer
      error="{{searchError}}"
      loading="{{searchLoading}}"
      page="{{pageNum}}"
      page-size="25"
      process-request="[[processRequest]]"
      result-function="[[transforms.search.adResults]]"
      results="{{searchResults}}"
      total="{{recordsTotalCount}}"
      search-parameters="[[searchParameters]]"
      search-function="[[transforms.search.adQuery]]"
      url="[[config.queryUrl]]">
    </query-transformer>

    <json-transform
      data-in="{{searchResults}}"
      data-out="{{records}}"
      transform-function="[[transforms.offer.queryResults]]">
    </json-transform>

    <!-- Logger for Page View -->
    <dig-logger log-page-view
      es-client="[[esclient]]"
      es-index="[[config.logIndex]]"
      es-type="[[config.logType]]"
      type="Search-Open"
      data=""
      username="[[config.username]]"
      logger="{{logger}}">
    </dig-logger>

    <!-- Logger for Search Terms -->
    <dig-logger
      es-client="[[esclient]]"
      es-index="[[config.logIndex]]"
      es-type="[[config.logType]]"
      type="Search-SubmitSearch"
      data="[[logMessage]]"
      username="[[config.username]]">
    </dig-logger>

    <!-- Logger for Pagination -->
    <dig-logger
      es-client="[[esclient]]"
      es-index="[[config.logIndex]]"
      es-type="[[config.logType]]"
      type="Search-ShowResultPageNumber"
      data="[[pageNum]]"
      username="[[config.username]]">
    </dig-logger>

    <!-- logging: single top level object referenced for start and end dates
         internal component logic figures out which date is which -->
    <create-log-message
      age-selected="[[searchParameters.age]]"
      city-selected="[[searchParameters.city]]"
      country-selected="[[searchParameters.country]]"
      date-end-selected="[[searchParameters.postingDate]]"
      date-start-selected="[[searchParameters.postingDate]]"
      description-selected="[[searchParameters.description]]"
      email-selected="[[searchParameters.email]]"
      ethnicity-selected="[[searchParameters.ethnicity]]"
      eye-selected="[[searchParameters.eyeColor]]"
      gender-selected="[[searchParameters.gender]]"
      hair-selected="[[searchParameters.hairColor]]"
      height-selected="[[searchParameters.height]]"
      image-selected="[[searchParameters.image]]"
      name-selected="[[searchParameters.name]]"
      phone-selected="[[searchParameters.phone]]"
      price-selected="[[searchParameters.price]]"
      region-selected="[[searchParameters.region]]"
      review-selected="[[searchParameters.review]]"
      services-selected="[[searchParameters.services]]"
      social-selected="[[searchParameters.social]]"
      title-selected="[[searchParameters.title]]"
      website-selected="[[searchParameters.website]]"
      weight-selected="[[searchParameters.weight]]"
      log-message="{{logMessage}}">
    </create-log-message>

    <annotation-manager
      dev="[[config.dev]]"
      show="[[annotationsDarpa]]"
      client="[[esclient]]"
      annotation-index="[[config.annotationIndex]]"
      annotation-type="[[config.annotationType]]"
      relevant="[[config.annotationRelevant]]"
      username="[[config.username]]"
      annotations="{{annotations}}"
      annotation-manager="{{annotationManager}}">
    </annotation-manager>

    <classification-manager
      dev="[[config.dev]]"
      show="[[annotationsIsi]]"
      entity-url="[[config.classificationEntityUrl]]"
      extraction-url="[[config.classificationExtractionUrl]]"
      flag-url="[[config.classificationFlagUrl]]"
      flag="[[classificationFlag]]"
      flag-list="{{classificationFlagList}}"
      classification-manager="{{classificationManager}}">
    </classification-manager>

    <paper-header-panel class="flex" mode="waterfall">

      <!-- Search toolbar -->
      <paper-toolbar id="navbar">
        <img class="bottom" src="images/dig-logo-original.png" alt="">
        <div class="bottom drawer-spacer"></div>

        <div class="white-input-container bottom flex">
          <search-fields-dialog
            opened="{{searchFieldsDialogOpened}}"
            search-parameters="{{searchParameters}}"
            date-start-config="{{dateStartConfig}}"
            date-end-config="{{dateEndConfig}}"
            ordered-search-field-group-keys="{{searchFieldGroups}}"
            search-fields="{{searchFields}}"
            process-request="{{processRequest}}"
            user-canceled="{{userCanceled}}">
          </search-fields-dialog>
        </div>

        <a class="bottom" href="." style="color: #ffffff;">
          <paper-icon-button icon="clear" title="Reset Page"></paper-icon-button>
        </a>

        <load-user-info class="bottom"
          show-search
          dev="[[config.dev]]"
          client="[[esclient]]"
          loading="[[searchLoading]]"
          username="[[config.username]]"
          user-id="{{userId}}"
          user-record-exists="{{userRecordExists}}"
          annotations-darpa="{{annotationsDarpa}}"
          annotations-isi="{{annotationsIsi}}"
          blur-images="{{blurImages}}"
          classification-flag-list="[[classificationFlagList]]"
          classification-flag="{{classificationFlag}}"
          searches="{{userSearches}}"
          entities="{{userEntities}}"
          search-parameters="{{searchParameters}}"
          user-index="[[config.userIndex]]"
          user-type="[[config.userType]]"
          notification-query-date="{{notificationDate}}"
          sort-newest="[[sortString]]"
          current-sort="[[selectedSort]]"
          save-user-data-callback="[[saveUserDataCallback]]"
          run-user-query-callback="{{runUserQueryCallback}}"
          user-update-body="{{userUpdateBody}}"
          process-request="{{processRequest}}">
        </load-user-info>

        <query-builder
          callback="[[queryBuilderCallback]]"
          config="[[queryBuilderConfig]]"
          data="[[searchParameters]]"
          query="{{wholeQuery}}">
        </query-builder>

        <save-search id="saveSearchDialog"
          client="[[esclient]]"
          username="[[config.username]]"
          user-id="[[userId]]"
          existing-searches="{{userSearches}}"
          search-parameters="[[searchParameters]]"
          es-query="[[wholeQuery]]"
          user-index="[[config.userIndex]]"
          user-type="[[config.userType]]"
          user-record-exists="[[userRecordExists]]"
          run-user-query-callback="[[runUserQueryCallback]]"
          save-user-data-callback="{{saveUserDataCallback}}">
        </save-search>

        <bulk-search
          id="bulkSearchDialog"
          category="[[phoneConfig.title]]"
          search-parameters="{{searchParameters}}"
          process-request="{{processRequest}}">
        </bulk-search>

        <similar-image-search id="similarImageSearchDialog"
          logger="[[logger]]"
          blur="[[blurImages]]"
          image-service-auth="[[config.imageServiceAuth]]"
          image-service-host="[[config.imageServiceHost]]"
          link-function="[[transforms.image.externalImageLink]]">
        </similar-image-search>

        <entity-list-dialog id="entityListDialog"
          annotation-ids="[[annotations.all]]"
          annotation-manager="[[annotationManager]]"
          client="[[esclient]]"
          index-name="[[config.elasticIndex]]"
          email-field="[[emailConfig.aggregationField]]"
          image-field="[[imageConfig.aggregationField]]"
          offer-field="doc_id"
          phone-field="[[phoneConfig.aggregationField]]"
          transform-function="[[transforms.entity.entities]]"
          entities="{{userEntities}}"
          user-update-body="{{userUpdateBody}}">
        </entity-list-dialog>

        <state-manager id="stateManager"
          page-type="search"
          client="[[esclient]]"
          state-index="[[config.filterStatesIndex]]"
          state-type="[[config.filterStatesType]]"
          state-id="[[params.state]]"
          filter-collection="{{searchParameters}}"
          process-request="{{processRequest}}">
        </state-manager>

        <paper-icon-button icon="menu" class="bottom dropdown-trigger" title="More Options" on-tap="toggleMenu"></paper-icon-button>

        <iron-dropdown id="menuDropdown" class="bottom" horizontal-align="right" vertical-align="top" vertical-offset="80">
          <div class="dropdown-content">
            <paper-icon-item disabled="[[isSaveButtonDisabled(searchResults, searchError)]]" title="Save the Selected Search Terms" on-tap="openSaveSearchDialog">
              <iron-icon icon="save" item-icon></iron-icon>
              Save Search
            </paper-icon-item>

            <paper-icon-item disabled="[[noSearchParameters(searchParameters.*)]]" title="Generate a Link for this Page with the Selected Search Terms" on-tap="generateLink">
              <iron-icon icon="link" item-icon></iron-icon>
              Generate Link
            </paper-icon-item>

            <paper-icon-item title="Upload or Enter Multiple Telephone Numbers" on-tap="openBatchPhoneSearchDialog">
              <iron-icon icon="file-upload" item-icon></iron-icon>
              Bulk Telephone Search
            </paper-icon-item>

            <paper-icon-item title="Search on an Image URL or Uploaded Image" on-tap="openSimilarImageSearchDialog">
              <iron-icon icon="image:compare" item-icon></iron-icon>
              Similar Image Search
            </paper-icon-item>

            <paper-icon-item title="View Annotated & Saved Pages" on-tap="openEntityListDialog">
              <iron-icon icon="pageview" item-icon></iron-icon>
              View Annotated & Saved Pages
            </paper-icon-item>

            <paper-icon-item title="Open DIG Search in a New Tab" on-tap="openNewTab">
              <iron-icon icon="open-in-new" item-icon></iron-icon>
              Open DIG Search in a New Tab
            </paper-icon-item>

            <paper-icon-item title="Contact DIG Support" on-tap="emailSupport">
              <iron-icon icon="communication:contact-mail" item-icon></iron-icon>
              Contact DIG Support
            </paper-icon-item>
          </div>
        </iron-dropdown>
      </paper-toolbar>

      <paper-drawer-panel drawer-width="320px">

        <!-- Sidebar on left side -->
        <paper-header-panel drawer>
          <paper-toolbar class="drawer-header">
            <div class="layout vertical">
              <!-- TODO
              <elastic-sort-input class="layout horizontal" field="[[dateStartConfig.queryField]]" selected="{{searchParameters.sort}}">
              </elastic-sort-input>
              <elastic-sort input-string="[[searchParameters.sort]]" sort="{{sort}}"></elastic-sort>
              -->

              <template is="dom-if" if="[[!noSearchParameters(searchParameters.*)]]">
                <div class="selected-facets-header">Search Terms</div>
              </template>

              <template is="dom-if" if="[[noSearchParameters(searchParameters.*)]]">
                <div class="selected-facets-header">No Search Terms</div>
              </template>

              <!-- Ensure that facet interactions still work after user hits cancel in search dialog -->

              <div class="layout horizontal wrap">
                <!-- Nesting keys for start and end dates under postingDate to be consistent with how other -->
                <!-- facetSelections are represented. -->
                <selected-facets-display facet-selection="{{searchParameters.postingDate}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.website}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.title}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.description}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.country}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.region}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.city}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.phone}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.email}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.social}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.services}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.price}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.name}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.gender}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.age}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.ethnicity}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.eyeColor}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.hairColor}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.height}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.weight}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.review}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.image}}"></selected-facets-display>
              </div>
            </div>
          </paper-toolbar>

          <iron-pages attr-for-selected="data-type" selected="ads">
            <div data-type="ads">
              <div class="layout horizontal facet expand-collapse-all" title="Toggle All Facets" on-tap="toggleAllFacetLists">
                <span class="flex">Facets</span>
                <span>[[getToggleAllFacetsText(facetListsExpanded)]]</span>
                <iron-icon icon="[[getToggleAllFacetsIcon(facetListsExpanded)]]"></iron-icon>
              </div>

              <info-facets></info-facets>

              <date-range-facet
                class="facet"
                date-start-key="[[dateStartConfig.key]]"
                date-start-title="[[dateStartConfig.title]]"
                date-start-prefix-label="[[dateStartConfig.prefixLabel]]"
                date-start-identifier="[[dateStartConfig.dateIdentifier]]"
                date-end-key="[[dateEndConfig.key]]"
                date-end-title="[[dateEndConfig.title]]"
                date-end-prefix-label="[[dateEndConfig.prefixLabel]]"
                date-end-identifier="[[dateEndConfig.dateIdentifier]]"
                search-param-subset="{{searchParameters.postingDate}}">
              </date-range-facet>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[phoneConfig.key]]"
                title="[[phoneConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.phone}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.phoneAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[emailConfig.key]]"
                title="[[emailConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.email}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.emailAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[socialConfig.key]]"
                title="[[socialConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.social}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.socialMediaAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[reviewConfig.key]]"
                title="[[reviewConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.review}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.compoundExtractionAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[cityConfig.key]]"
                title="[[cityConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.city}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.cityAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[regionConfig.key]]"
                title="[[regionConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.region}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <!-- TODO Hiding country for now...
              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[countryConfig.key]]"
                title="[[countryConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.country}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>
              -->

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[nameConfig.key]]"
                title="[[nameConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.name}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[genderConfig.key]]"
                title="[[genderConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.gender}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[ageConfig.key]]"
                title="[[ageConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.age}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[ethnicityConfig.key]]"
                title="[[ethnicityConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.ethnicity}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[eyeColorConfig.key]]"
                title="[[eyeColorConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.eyeColor}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[hairColorConfig.key]]"
                title="[[hairColorConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.hairColor}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[heightConfig.key]]"
                title="[[heightConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.height}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.compoundExtractionAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[weightConfig.key]]"
                title="[[weightConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.weight}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.compoundExtractionAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[servicesConfig.key]]"
                title="[[servicesConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.services}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[priceConfig.key]]"
                title="[[priceConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.price}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.compoundExtractionAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[websiteConfig.key]]"
                title="[[websiteConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.website}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <!-- TODO
              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[imageConfig.key]]"
                title="[[imageConfig.title]]"
                search-parameters="{{searchParameters}}"
                search-param-subset="{{searchParameters.image}}"
                search-function="[[transforms.search.facetsQuery]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                image-style-class="[[getBlurStyleClass(blurImages)]]"
                process-request="{{processRequest}}">
              </facet-list>
              -->
            </div>

            <div data-type="image"></div>
          </iron-pages>
        </paper-header-panel>

        <!-- Main content on right side -->
        <paper-header-panel main id="searchPanel">
          <div id="searchTitle" class="layout horizontal">
            <template is="dom-if" if="[[!searchError]]">
              <div class="layout horizontal flex">
                <div class="paper-font-title">[[recordsListTitle]]</div>

                <template is="dom-if" if="[[recordsTotalCount]]">
                  <info-search
                    advanced-search="[[advancedSearch]]"
                    search-parameters="[[searchParameters]]">
                  </info-search>
                </template>
              </div>
            </template>

            <template is="dom-if" if="[[searchError]]">
              <elastic-error error="[[searchError]]" message="{{searchErrorMessage}}"></elastic-error>
              <div class="paper-font-title flex">
                [[searchErrorMessage]]
              </div>
            </template>

            <export-button
              client="[[esclient]]"
              data="[[shownRecords]]"
              download-image-url="[[config.downloadImageUrl]]"
              filter-list="[[filterArray]]"
              index-name="[[config.elasticIndex]]"
              index-types="[[getElasticTypes()]]"
              query="[[ejsQuery]]"
              size="[[resultCount]]"
              csv-transform-function="[[transforms.export.createExportDataForCsv]]"
              pdf-transform-function="[[transforms.export.createExportDataForPdf]]"
              query-transform-function="[[transforms.offer.offers]]">
            </export-button>
          </div>

          <records-list id="searchResults"
            dev="[[config.dev]]"
            annotation-manager="[[annotationManager]]"
            classification-manager="[[classificationManager]]"
            client="[[esclient]]"
            image-aggregation-field="url.raw"
            image-aggregation-name="image"
            image-index-name="[[config.elasticIndex]]"
            image-index-type="images"
            image-query-field="isImagePartOf.uri"
            image-transform-function="[[transforms.image.images]]"
            small-image-style-class="[[getBlurStyleClass(blurImages)]]"
            large-image-style-class="[[getBlurStyleClass(blurImages, 'large')]]"
            new-tab="true"
            text-property="title"
            query-results="{{records}}"
            total-results="{{recordsTotalCount}}"
            shown-results="{{shownRecords}}"
            page="{{pageNum}}"
            page-size="25"
            loading="{{searchLoading}}"
            type="Result"
            records-list-title="{{recordsListTitle}}"
            current-user="[[config.username]]"
            notification-query-date="{{notificationDate}}">
          </records-list>
        </paper-header-panel>

      </paper-drawer-panel>

    </paper-header-panel>

  </template>

  <!-- Need to include dependencies here for IE -->
  <script src="bower_components/lodash/dist/lodash.js"></script>
  <script src="bower_components/array-behavior/array-behavior.js"></script>
  <script src="behaviors/browser-behavior.js"></script>
  <script src="behaviors/filter-behavior.js"></script>
  <script src="behaviors/phone-behavior.js"></script>
  <script src="behaviors/state-behavior.js"></script>

  <script>
    (function(document) {
      /* globals DigBehaviors */
      var app = document.querySelector('#app');

      app.facetListsExpanded = true;

      app.searchParameters = DigBehaviors.StateBehavior.buildSearchState({});

      app.params = DigBehaviors.BrowserBehavior.getUrlParameters(window.location.search);

      DigBehaviors.BrowserBehavior.removeStateParameter(window.history, window.location);

      app.buildArray = DigBehaviors.ArrayBehavior.buildArray;
      app.createSingleSearchField = DigBehaviors.StateBehavior.createSingleSearchField;
      app.createDateField = DigBehaviors.StateBehavior.createDateField;
      app.queryBuilderCallback = {
        dates: DigBehaviors.FilterBehavior.getFacetDates,
        terms: DigBehaviors.FilterBehavior.getFacetTerms
      };

      app.ageConfig = app.createSingleSearchField('age', 'Age of Provider', 'knowledge_graph.age.key', 'knowledge_graph.age.value');
      app.cityConfig = app.createSingleSearchField('city', 'City', 'knowledge_graph.city.key', 'knowledge_graph.city.value');
      app.countryConfig = app.createSingleSearchField('country', 'Country', 'knowledge_graph.country.key', 'knowledge_graph.country.value');
      app.dateStartConfig = app.createDateField('dateStart', 'From', 'knowledge_graph.posting_date.key', 'From', 'start');
      app.dateEndConfig = app.createDateField('dateEnd', 'To', 'knowledge_graph.posting_date.key', 'To', 'end');
      app.descriptionConfig = app.createSingleSearchField('description', 'Page', 'content_extraction.content_strict.text');
      app.emailConfig = app.createSingleSearchField('email', 'Email Address', 'knowledge_graph.email.key', 'knowledge_graph.email.value');
      app.ethnicityConfig = app.createSingleSearchField('ethnicity', 'Ethnicity of Provider', 'knowledge_graph.ethnicity.key', 'knowledge_graph.ethnicity.value');
      app.eyeColorConfig = app.createSingleSearchField('eyeColor', 'Eye Color of Provider', 'knowledge_graph.eye_color.key', 'knowledge_graph.eye_color.value');
      app.genderConfig = app.createSingleSearchField('gender', 'Gender of Provider', 'knowledge_graph.gender.key', 'knowledge_graph.gender.value');
      app.hairColorConfig = app.createSingleSearchField('hairColor', 'Hair Color of Provider', 'knowledge_graph.hair_color.key', 'knowledge_graph.hair_color.value');
      app.heightConfig = app.createSingleSearchField('height', 'Height of Provider', 'knowledge_graph.height.key', 'knowledge_graph.height.value');
      app.imageConfig = app.createSingleSearchField('image', 'Image', 'knowledge_graph.image.key', 'knowledge_graph.image.value');
      app.nameConfig = app.createSingleSearchField('name', 'Name of Provider', 'knowledge_graph.name.key', 'knowledge_graph.name.value');
      app.phoneConfig = app.createSingleSearchField('phone', 'Telephone Number', 'knowledge_graph.phone.key', 'knowledge_graph.phone.value');
      app.priceConfig = app.createSingleSearchField('price', 'Price of Provider', 'knowledge_graph.price.key', 'knowledge_graph.price.value');
      app.regionConfig = app.createSingleSearchField('region', 'State/Region', 'knowledge_graph.state.key', 'knowledge_graph.state.value');
      app.reviewConfig = app.createSingleSearchField('review', 'Review ID', 'knowledge_graph.review_id.key', 'knowledge_graph.review_id.value');
      app.servicesConfig = app.createSingleSearchField('services', 'Services Provided', 'knowledge_graph.service.key', 'knowledge_graph.service.value');
      app.socialConfig = app.createSingleSearchField('social', 'Social Media ID', 'knowledge_graph.social_media_id.key', 'knowledge_graph.social_media_id.value');
      app.titleConfig = app.createSingleSearchField('title', 'Title', 'content_extraction.title.text');
      app.websiteConfig = app.createSingleSearchField('website', 'Website', 'tld.raw', 'tld');
      app.weightConfig = app.createSingleSearchField('weight', 'Weight of Provider', 'knowledge_graph.weight.key', 'knowledge_graph.weight.value');

      app.searchFieldGroups = ['identifiers', 'location', 'provider', 'ad'];

      app.searchFields = {
        identifiers: {
          title: 'Identifiers',
          data: app.buildArray(app.phoneConfig, app.emailConfig, app.socialConfig, app.reviewConfig)
        },
        location: {
          title: 'Location',
          data: app.buildArray(app.cityConfig, app.regionConfig)
        },
        provider: {
          title: 'Provider',
          data: app.buildArray(app.nameConfig, app.ageConfig, app.ethnicityConfig, app.eyeColorConfig,
            app.hairColorConfig, app.heightConfig, app.weightConfig, app.servicesConfig, app.priceConfig)
        },
        ad: {
          title: 'Ad',
          data: app.buildArray(app.websiteConfig, app.titleConfig, app.descriptionConfig)
        }
      };

      app.queryBuilderConfig = {
        age: {
          field: app.ageConfig.queryField
        },
        city: {
          field: app.cityConfig.queryField
        },
        country: {
          field: app.countryConfig.queryField
        },
        description: {
          field: app.descriptionConfig.queryField
        },
        email: {
          field: app.emailConfig.queryField
        },
        ethnicity: {
          field: app.ethnicityConfig.queryField
        },
        eyeColor: {
          field: app.eyeColorConfig.queryField
        },
        gender: {
          field: app.genderConfig.queryField
        },
        hairColor: {
          field: app.hairColorConfig.queryField
        },
        height: {
          field: app.heightConfig.queryField
        },
        image: {
          field: app.imageConfig.queryField
        },
        name: {
          field: app.nameConfig.queryField
        },
        phone: {
          field: app.phoneConfig.queryField
        },
        price: {
          field: app.priceConfig.queryField
        },
        region: {
          field: app.regionConfig.queryField
        },
        review: {
          field: app.reviewConfig.queryField
        },
        services: {
          field: app.servicesConfig.queryField
        },
        social: {
          field: app.socialConfig.queryField
        },
        title: {
          field: app.titleConfig.queryField
        },
        website: {
          field: app.websiteConfig.queryField
        },
        weight: {
          field: app.weightConfig.queryField
        },
        postingDate: {
          type: 'date',
          field: app.dateStartConfig.queryField
        }
      };

      app.sortString = 'Sort("' + app.dateStartConfig.queryField + '").order("desc")';

      app.openNewTab = function() {
        window.open('.');
      };

      app.emailSupport = function() {
        window.open('mailto:dig-support@nextcentury.com');
      };

      app.generateLink = function() {
        this.$.menuDropdown.close();
        this.$.stateManager.generateLink();
      };

      app.getBlurStyleClass = function(blur, large) {
        return (blur ? (large ? 'large-blur' : 'small-blur') : '');
      };

      app.getElasticTypes = function() {
        return ['ads'];
      };

      app.isSaveButtonDisabled = function(searchResults, searchError) {
        return !(searchResults !== null && searchError === null);
      };

      app.noSearchParameters = function() {
        return DigBehaviors.FilterBehavior.areAllFacetsDisabled(this.searchParameters, ['sort']);
      };

      app.openBatchPhoneSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.bulkSearchDialog.open();
      };

      app.openSaveSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.saveSearchDialog.open();
      };

      app.openSimilarImageSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.similarImageSearchDialog.open();
      };

      app.openEntityListDialog = function() {
        this.$.menuDropdown.close();
        this.$.entityListDialog.open();
      };

      app.toggleMenu = function() {
        if(this.$.menuDropdown.style.display === 'none') {
          this.$.menuDropdown.open();
        } else {
          this.$.menuDropdown.close();
        }
      };

      app.toggleAllFacetLists = function() {
        app.facetListsExpanded = !app.facetListsExpanded;
        // All facet lists should have the class 'facet'
        var allFacetListNames = document.querySelectorAll('.facet');

        for(var i = 0, length = allFacetListNames.length; i < length; i++) {
          allFacetListNames[i].opened = app.facetListsExpanded;
        }
      };

      app.getToggleAllFacetsText = function() {
        return (app.facetListsExpanded ? 'Collapse' : 'Expand') + ' All';
      };

      app.getToggleAllFacetsIcon = function() {
        return (app.facetListsExpanded ? 'icons:expand-less' : 'icons:expand-more');
      };
    })(document);
  </script>
</body>

</html>
