<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>

<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>DIG 3</title>

  <link rel="icon" href="favicon.ico"/>

  <!-- build:css styles/main.css -->
  <!-- Must link leaflet css (https://github.com/leaflet-extras/leaflet-map/issues/46) -->
  <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="styles/main.css">
  <!-- endbuild-->

  <!-- build:js bower_components/webcomponentsjs/webcomponents-lite.min.js -->
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <!-- endbuild -->

  <script src="scripts/google-analytics.js"></script>
  
  <!-- will be replaced with elements/elements.vulcanized.html -->
  <link rel="import" href="elements/elements.html">
  <!-- endreplace-->

  <link rel="import" href="styles/custom-icons.html">
  <link rel="import" href="styles/icon-styles.html">
  <style is="custom-style" include="icon-styles"></style>
</head>

<body unresolved class="fullbleed layout vertical">
  <span id="browser-sync-binding"></span>

  <template is="dom-bind" id="app">
    <client-config config="[[config]]" transforms="{{transforms}}"></client-config>

    <!--get app configuration from server -->
    <iron-ajax
      auto
      url="/config"
      handle-as="json"
      last-response="{{config}}">
    </iron-ajax>

    <!--initialize new elastic client connection to server
      esclient can be used throughout the application lifecycle -->
    <elastic-client
      config="[[config.elasticConfig]]"
      client="{{esclient}}">
    </elastic-client>

    <query-transformer
      error="{{searchError}}"
      loading="{{searchLoading}}"
      page="{{pageNum}}"
      page-size="25"
      process-request="[[processRequest]]"
      result-config="[[createMainSearchResultConfig(networkExpansionParameters.*)]]"
      result-function="[[transforms.search.adResults]]"
      results="{{searchResults}}"
      search-parameters="[[searchParameters]]"
      search-config="[[networkExpansionParameters]]"
      search-function="[[transforms.search.adQuery]]"
      total-count-function="[[getTotalCountFunction()]]"
      total="{{searchTotal}}"
      url="[[config.queryUrl]]">
    </query-transformer>

    <json-transform
      data-in="{{searchResults}}"
      data-out="{{records}}"
      transform-function="[[transforms.offer.queryResults]]">
    </json-transform>

    <!-- Logger for Page View -->
    <dig-logger log-page-view
      es-client="[[esclient]]"
      es-index="[[config.logIndex]]"
      es-type="[[config.logType]]"
      type="Search-Open"
      data=""
      username="[[config.username]]"
      logger="{{logger}}">
    </dig-logger>

    <!-- Logger for Search Terms -->
    <dig-logger
      es-client="[[esclient]]"
      es-index="[[config.logIndex]]"
      es-type="[[config.logType]]"
      type="Search-SubmitSearch"
      data="[[logMessage]]"
      username="[[config.username]]">
    </dig-logger>

    <!-- Logger for Pagination -->
    <dig-logger
      es-client="[[esclient]]"
      es-index="[[config.logIndex]]"
      es-type="[[config.logType]]"
      type="Search-ShowResultPageNumber"
      data="[[pageNum]]"
      username="[[config.username]]">
    </dig-logger>

    <!-- logging: single top level object referenced for start and end dates
         internal component logic figures out which date is which -->
    <create-log-message
      age-selected="[[searchParameters.age]]"
      city-selected="[[searchParameters.city]]"
      country-selected="[[searchParameters.country]]"
      date-end-selected="[[searchParameters.postingDate]]"
      date-start-selected="[[searchParameters.postingDate]]"
      description-selected="[[searchParameters.description]]"
      email-selected="[[searchParameters.email]]"
      ethnicity-selected="[[searchParameters.ethnicity]]"
      eye-selected="[[searchParameters.eyeColor]]"
      gender-selected="[[searchParameters.gender]]"
      hair-selected="[[searchParameters.hairColor]]"
      height-selected="[[searchParameters.height]]"
      image-selected="[[searchParameters.image]]"
      location-selected="[[searchParameters.location]]"
      name-selected="[[searchParameters.name]]"
      phone-selected="[[searchParameters.phone]]"
      price-selected="[[searchParameters.price]]"
      region-selected="[[searchParameters.region]]"
      review-selected="[[searchParameters.review]]"
      services-selected="[[searchParameters.services]]"
      social-selected="[[searchParameters.social]]"
      title-selected="[[searchParameters.title]]"
      url-selected="[[searchParameters.url]]"
      website-selected="[[searchParameters.website]]"
      weight-selected="[[searchParameters.weight]]"
      log-message="{{logMessage}}">
    </create-log-message>

    <annotation-manager
      dev="[[config.dev]]"
      show="[[annotationsDarpa]]"
      client="[[esclient]]"
      annotation-index="[[config.annotationIndex]]"
      annotation-type="[[config.annotationType]]"
      relevant="[[config.annotationRelevant]]"
      username="[[config.username]]"
      annotations="{{annotations}}"
      annotation-manager="{{annotationManager}}">
    </annotation-manager>

    <classification-manager
      dev="[[config.dev]]"
      show="[[annotationsIsi]]"
      auth="[[config.classificationAuth]]"
      entity-url="[[config.classificationEntityUrl]]"
      extraction-url="[[config.classificationExtractionUrl]]"
      flag-url="[[config.classificationFlagUrl]]"
      flag="[[classificationFlag]]"
      flag-list="{{classificationFlagList}}"
      classification-manager="{{classificationManager}}">
    </classification-manager>

    <paper-header-panel class="flex" mode="waterfall">

      <!-- Search toolbar -->
      <paper-toolbar id="navbar">
        <img class="bottom" src="images/dig-logo.png" alt="">
        <div class="bottom drawer-spacer"></div>

        <div class="bottom flex">
          <search-fields-dialog
            date-config='{"dateStart": "postingDate", "dateEnd": "postingDate"}'
            search-fields-config="[[searchFieldsDialogConfig]]"
            search-parameters="{{searchParameters}}"
            network-expansion-parameters="{{networkExpansionParameters}}"
            process-request="{{processRequest}}">
          </search-fields-dialog>
        </div>

        <a class="bottom" href="." style="color: #ffffff;">
          <paper-icon-button icon="clear" title="Reset Page"></paper-icon-button>
        </a>

        <load-user-info class="bottom"
          show-search
          dev="[[config.dev]]"
          client="[[esclient]]"
          loading="[[searchLoading]]"
          username="[[config.username]]"
          user-id="{{userId}}"
          user-record-exists="{{userRecordExists}}"
          annotations-darpa="{{annotationsDarpa}}"
          annotations-isi="{{annotationsIsi}}"
          blur-images="{{blurImages}}"
          classification-flag-list="[[classificationFlagList]]"
          classification-flag="{{classificationFlag}}"
          searches="{{userSearches}}"
          entities="{{userEntities}}"
          search-parameters="{{searchParameters}}"
          user-index="[[config.userIndex]]"
          user-type="[[config.userType]]"
          notification-query-date="{{notificationDate}}"
          sort-newest="[[sortString]]"
          current-sort="[[selectedSort]]"
          save-user-data-callback="[[saveUserDataCallback]]"
          run-user-query-callback="{{runUserQueryCallback}}"
          user-update-body="{{userUpdateBody}}"
          process-request="{{processRequest}}">
        </load-user-info>

        <query-builder
          callback="[[queryBuilderCallback]]"
          config="[[queryBuilderConfig]]"
          data="[[searchParameters]]"
          query="{{wholeQuery}}">
        </query-builder>

        <save-search id="saveSearchDialog"
          client="[[esclient]]"
          username="[[config.username]]"
          user-id="[[userId]]"
          existing-searches="{{userSearches}}"
          search-parameters="[[searchParameters]]"
          es-query="[[wholeQuery]]"
          user-index="[[config.userIndex]]"
          user-type="[[config.userType]]"
          user-record-exists="[[userRecordExists]]"
          run-user-query-callback="[[runUserQueryCallback]]"
          save-user-data-callback="{{saveUserDataCallback}}">
        </save-search>

        <bulk-search
          id="bulkSearchDialog"
          search-fields="[[bulkSearchFields]]"
          parameter-key="[[phoneConfig.key]]"
          search-parameters="{{searchParameters}}"
          process-request="{{processRequest}}">
        </bulk-search>

        <similar-image-search id="similarImageSearchDialog"
          logger="[[logger]]"
          blur="[[blurImages]]"
          image-service-auth="[[config.imageServiceAuth]]"
          image-service-host="[[config.imageServiceHost]]"
          link-function="[[transforms.image.externalImageLink]]">
        </similar-image-search>

        <entity-list-dialog id="entityListDialog"
          annotation-ids="[[annotations.all]]"
          annotation-manager="[[annotationManager]]"
          client="[[esclient]]"
          index-name="[[config.elasticIndex]]"
          email-field="[[emailConfig.aggregationField]]"
          image-field="[[imageConfig.aggregationField]]"
          offer-field="doc_id"
          phone-field="[[phoneConfig.aggregationField]]"
          transform-function="[[transforms.entity.entities]]"
          entities="{{userEntities}}"
          user-update-body="{{userUpdateBody}}">
        </entity-list-dialog>

        <state-manager id="stateManager"
          build-popup-data-function="[[buildTerms]]"
          build-state-data-function="[[buildState]]"
          client="[[esclient]]"
          state-index="[[config.filterStatesIndex]]"
          state-type="[[config.filterStatesType]]"
          state-id="[[params.state]]"
          collection="{{searchParameters}}"
          process-request="{{processRequest}}"
          state-history="{{stateHistory}}"
          has-history="{{hasHistory}}">
        </state-manager>

        <paper-icon-button icon="menu" class="bottom dropdown-trigger" title="More Options" on-tap="toggleMenu"></paper-icon-button>

        <iron-dropdown id="menuDropdown" class="bottom" horizontal-align="right" vertical-align="top" vertical-offset="60">
          <div class="dropdown-content">
            <paper-icon-item disabled="[[isSaveButtonDisabled(searchResults, searchError)]]" title="Save the Selected Search Terms" on-tap="openSaveSearchDialog">
              <iron-icon icon="save" item-icon></iron-icon>
              Save Search
            </paper-icon-item>

            <paper-icon-item disabled="[[!hasHistory]]" title="View Search State History" on-tap="openStateHistoryDialog">
              <iron-icon icon="history" item-icon></iron-icon>
              View Search State History
            </paper-icon-item>

            <paper-icon-item title="Upload a File with Search Terms or Copy & Paste Text" on-tap="openBulkSearchDialog">
              <iron-icon icon="file-upload" item-icon></iron-icon>
              Bulk Search from File or Text
            </paper-icon-item>

            <paper-icon-item title="Search on an Image URL or Uploaded Image" on-tap="openSimilarImageSearchDialog">
              <iron-icon icon="image:compare" item-icon></iron-icon>
              Similar Image Search
            </paper-icon-item>

            <paper-icon-item title="View Annotated & Saved Pages" on-tap="openEntityListDialog">
              <iron-icon icon="pageview" item-icon></iron-icon>
              View Annotated & Saved Pages
            </paper-icon-item>

            <paper-icon-item title="Open DIG Search in a New Tab" on-tap="openNewTab">
              <iron-icon icon="open-in-new" item-icon></iron-icon>
              Open DIG Search in a New Tab
            </paper-icon-item>

            <paper-icon-item title="Contact DIG Support" on-tap="emailSupport">
              <iron-icon icon="communication:contact-mail" item-icon></iron-icon>
              Contact DIG Support
            </paper-icon-item>
          </div>
        </iron-dropdown>
      </paper-toolbar>

      <paper-drawer-panel drawer-width="320px">

        <!-- Sidebar on left side -->
        <paper-header-panel drawer>
          <paper-toolbar class="drawer-header">
            <div class="layout vertical">
              <template is="dom-if" if="[[!noSearchParameters(searchParameters.*)]]">
                <div class="selected-facets-header">Search Terms</div>
              </template>

              <template is="dom-if" if="[[noSearchParameters(searchParameters.*)]]">
                <div class="selected-facets-header">No Search Terms</div>
              </template>

              <!-- Ensure that facet interactions still work after user hits cancel in search dialog -->

              <div class="layout horizontal wrap">
                <!-- Nesting keys for start and end dates under postingDate to be consistent with how other -->
                <!-- facetSelections are represented. -->
                <selected-facets-display facet-key="postingDate" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="website" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="url" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="title" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="description" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="location" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="city" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="region" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="country" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="phone" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="email" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="social" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="review" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="services" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="price" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="name" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="gender" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="age" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="ethnicity" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="eyeColor" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="hairColor" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="height" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="weight" facets="{{searchParameters}}"></selected-facets-display>
                <selected-facets-display facet-key="image" facets="{{searchParameters}}"></selected-facets-display>
              </div>
            </div>
          </paper-toolbar>

          <iron-pages attr-for-selected="data-type" selected="ads">
            <div data-type="ads">
              <div class="layout horizontal facet expand-collapse-all" title="Toggle All Facets" on-tap="toggleAllFacetLists">
                <span class="flex">Facets</span>
                <span>[[getToggleAllFacetsText(facetListsExpanded)]]</span>
                <iron-icon icon="[[getToggleAllFacetsIcon(facetListsExpanded)]]"></iron-icon>
              </div>

              <info-facets></info-facets>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[phoneConfig.key]]"
                title="[[phoneConfig.title]]"
                search-parameters-property="phone"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(phoneConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.phoneAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[emailConfig.key]]"
                title="[[emailConfig.title]]"
                search-parameters-property="email"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(emailConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.emailAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[socialConfig.key]]"
                title="[[socialConfig.title]]"
                search-parameters-property="social"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(socialConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.socialMediaAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[reviewConfig.key]]"
                title="[[reviewConfig.title]]"
                search-parameters-property="review"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(reviewConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.reviewAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[cityConfig.key]]"
                title="[[cityConfig.title]]"
                search-parameters-property="city"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(cityConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.cityAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[regionConfig.key]]"
                title="[[regionConfig.title]]"
                search-parameters-property="region"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(regionConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[countryConfig.key]]"
                title="[[countryConfig.title]]"
                search-parameters-property="country"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(countryConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[nameConfig.key]]"
                title="[[nameConfig.title]]"
                search-parameters-property="name"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(nameConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[genderConfig.key]]"
                title="[[genderConfig.title]]"
                search-parameters-property="gender"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(genderConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[ageConfig.key]]"
                title="[[ageConfig.title]]"
                search-parameters-property="age"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(ageConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[ethnicityConfig.key]]"
                title="[[ethnicityConfig.title]]"
                search-parameters-property="ethnicity"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(ethnicityConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[eyeColorConfig.key]]"
                title="[[eyeColorConfig.title]]"
                search-parameters-property="eyeColor"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(eyeColorConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[hairColorConfig.key]]"
                title="[[hairColorConfig.title]]"
                search-parameters-property="hairColor"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(hairColorConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[heightConfig.key]]"
                title="[[heightConfig.title]]"
                search-parameters-property="height"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(heightConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.compoundExtractionAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[weightConfig.key]]"
                title="[[weightConfig.title]]"
                search-parameters-property="weight"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(weightConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.compoundExtractionAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[servicesConfig.key]]"
                title="[[servicesConfig.title]]"
                search-parameters-property="services"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(servicesConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[priceConfig.key]]"
                title="[[priceConfig.title]]"
                search-parameters-property="price"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(priceConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.compoundExtractionAggregations]]"
                target="_blank"
                process-request="{{processRequest}}">
              </facet-list>

              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[websiteConfig.key]]"
                title="[[websiteConfig.title]]"
                search-parameters-property="website"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(websiteConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                process-request="{{processRequest}}">
              </facet-list>

              <!-- TODO
              <facet-list
                class="facet"
                query-url="[[config.queryUrl]]"
                name="[[imageConfig.key]]"
                title="[[imageConfig.title]]"
                search-parameters-property="image"
                search-parameters="{{searchParameters}}"
                search-config="[[networkExpansionParameters]]"
                search-function="[[transforms.search.facetsQuery]]"
                result-config="[[createFacetsResultConfig(imageConfig.key, networkExpansionParameters.*)]]"
                result-function="[[transforms.search.filterAggregations]]"
                target="_blank"
                text-property="id"
                image-style-class="[[getBlurStyleClass(blurImages)]]"
                process-request="{{processRequest}}">
              </facet-list>
              -->

              <date-range-facet
                class="facet"
                date-start-key="[[dateStartConfig.key]]"
                date-start-title="[[dateStartConfig.title]]"
                date-end-key="[[dateEndConfig.key]]"
                date-end-title="[[dateEndConfig.title]]"
                search-parameters-property="postingDate"
                search-parameters="{{searchParameters}}">
              </date-range-facet>
            </div>

            <div data-type="image"></div>
          </iron-pages>
        </paper-header-panel>

        <!-- Main content on right side -->
        <paper-header-panel main id="searchPanel">
          <div id="searchTitle" class="layout horizontal">
            <template is="dom-if" if="[[!searchError]]">
              <div class="layout horizontal flex">
                <div class="paper-font-title">[[recordsListTitle]]</div>

                <template is="dom-if" if="[[searchTotal]]">
                  <info-search search-parameters="[[searchParameters]]"></info-search>
                </template>
              </div>
            </template>

            <template is="dom-if" if="[[searchError]]">
              <elastic-error error="[[searchError]]" message="{{searchErrorMessage}}"></elastic-error>
              <div class="paper-font-title flex">
                [[searchErrorMessage]]
              </div>
            </template>

            <export-button
              client="[[esclient]]"
              data="[[shownRecords]]"
              download-image-url="[[config.downloadImageUrl]]"
              filter-list="[[buildArray()]]"
              index-name="[[config.elasticIndex]]"
              index-types="[[getElasticTypes()]]"
              search-fields="[[queryBuilderConfig]]"
              search-parameters="[[searchParameters]]"
              source-include='["content_extraction.content_strict.text", "content_extraction.title.text", "doc_id", "knowledge_graph", "tld", "url"]'
              transform-csv-function="[[transforms.export.createExportDataForCsv]]"
              transform-pdf-function="[[transforms.export.createExportDataForPdf]]"
              transform-search-input-function="[[transforms.export.createBulkSearchData]]"
              transform-search-results-function="[[transforms.offer.offers]]">
            </export-button>
          </div>

          <template is="dom-if" if="[[config.imageConfig]]">
            <elastic-client
              config="[[config.imageConfig]]"
              client="{{imageClient}}">
            </elastic-client>
          </template>

          <records-list id="searchResults"
            dev="[[config.dev]]"
            annotation-manager="[[annotationManager]]"
            classification-manager="[[classificationManager]]"
            client="[[esclient]]"
            image-aggregation-field="url.raw"
            image-aggregation-name="image"
            image-client="[[imageClient]]"
            image-index-name="[[config.imageIndex]]"
            image-index-type="[[config.imageType]]"
            image-query-field="isImagePartOf.uri"
            image-transform-function="[[transforms.image.images]]"
            small-image-style-class="[[getBlurStyleClass(blurImages)]]"
            large-image-style-class="[[getBlurStyleClass(blurImages, 'large')]]"
            new-tab="true"
            text-property="title"
            query-results="{{records}}"
            total-results="{{searchTotal}}"
            shown-results="{{shownRecords}}"
            page="{{pageNum}}"
            page-size="25"
            loading="{{searchLoading}}"
            type="Result"
            records-list-title="{{recordsListTitle}}"
            current-user="[[config.username]]"
            notification-query-date="{{notificationDate}}"
            query-config="[[buildQueryConfig(esclient, config.elasticIndex, transforms.cache.ad)]]">
          </records-list>
        </paper-header-panel>

      </paper-drawer-panel>

    </paper-header-panel>

  </template>

  <!-- Need to include dependencies here for IE -->
  <script src="bower_components/lodash/dist/lodash.js"></script>
  <script src="bower_components/array-behavior/array-behavior.js"></script>
  <script src="behaviors/browser-behavior.js"></script>
  <script src="bower_components/filter-behavior/filter-behavior.js"></script>
  <script src="bower_components/phone-behavior/phone-behavior.js"></script>
  <script src="behaviors/state-behavior.js"></script>

  <script>
    (function(document) {
      /* globals DigBehaviors, _ */
      var app = document.querySelector('#app');

      app.facetListsExpanded = true;
      app.processRequest = false;
      app.networkExpansionParameters = DigBehaviors.StateBehavior.buildNetworkParameters({});

      app.params = DigBehaviors.BrowserBehavior.getUrlParameters(window.location.search);

      if(!app.params.state) {
        app.searchParameters = DigBehaviors.StateBehavior.buildSearchState({});
        app.processRequest = true;
      }

      app.buildArray = DigBehaviors.ArrayBehavior.buildArray;
      app.buildState = DigBehaviors.StateBehavior.buildSearchState;
      app.buildTerms = DigBehaviors.StateBehavior.buildTermsCollectionFromSearchParameters;
      app.createStringField = DigBehaviors.StateBehavior.createStringField;
      app.createDateField = DigBehaviors.StateBehavior.createDateField;
      app.queryBuilderCallback = {
        dates: DigBehaviors.FilterBehavior.getFacetDates,
        terms: DigBehaviors.FilterBehavior.getFacetTerms
      };

      app.ageConfig = app.createStringField('age', 'Age of Provider', 'knowledge_graph.age.key', 'knowledge_graph.age.value');
      app.cityConfig = app.createStringField('city', 'City', 'knowledge_graph.city.key', 'knowledge_graph.city.value');
      app.countryConfig = app.createStringField('country', 'Country', 'knowledge_graph.country.key', 'knowledge_graph.country.value');
      app.dateStartConfig = app.createDateField('dateStart', 'Start Date', 'knowledge_graph.posting_date.key');
      app.dateEndConfig = app.createDateField('dateEnd', 'End Date', 'knowledge_graph.posting_date.key');
      app.descriptionConfig = app.createStringField('description', 'Text', 'content_extraction.content_strict.text');
      app.emailConfig = app.createStringField('email', 'Email Address', 'knowledge_graph.email.key', 'knowledge_graph.email.value', true);
      app.ethnicityConfig = app.createStringField('ethnicity', 'Ethnicity of Provider', 'knowledge_graph.ethnicity.key', 'knowledge_graph.ethnicity.value');
      app.eyeColorConfig = app.createStringField('eyeColor', 'Eye Color of Provider', 'knowledge_graph.eye_color.key', 'knowledge_graph.eye_color.value');
      app.genderConfig = app.createStringField('gender', 'Gender of Provider', 'knowledge_graph.gender.key', 'knowledge_graph.gender.value');
      app.hairColorConfig = app.createStringField('hairColor', 'Hair Color of Provider', 'knowledge_graph.hair_color.key', 'knowledge_graph.hair_color.value');
      app.heightConfig = app.createStringField('height', 'Height of Provider', 'knowledge_graph.height.key', 'knowledge_graph.height.value');
      app.imageConfig = app.createStringField('image', 'Image', 'knowledge_graph.image.key', 'knowledge_graph.image.value');
      app.locationConfig = app.createStringField('location', 'Location', 'knowledge_graph.city.key', 'knowledge_graph.city.key');
      app.nameConfig = app.createStringField('name', 'Name of Provider', 'knowledge_graph.name.key', 'knowledge_graph.name.value');
      app.phoneConfig = app.createStringField('phone', 'Telephone Number', 'knowledge_graph.phone.key', 'knowledge_graph.phone.value', true);
      app.priceConfig = app.createStringField('price', 'Price of Provider', 'knowledge_graph.price.key', 'knowledge_graph.price.value');
      app.regionConfig = app.createStringField('region', 'State/Region', 'knowledge_graph.state.key', 'knowledge_graph.state.value');
      app.reviewConfig = app.createStringField('review', 'Review ID', 'knowledge_graph.review_id.key', 'knowledge_graph.review_id.value', true);
      app.servicesConfig = app.createStringField('services', 'Services Provided', 'knowledge_graph.service.key', 'knowledge_graph.service.value');
      app.socialConfig = app.createStringField('social', 'Social Media ID', 'knowledge_graph.social_media_id.key', 'knowledge_graph.social_media_id.value', true);
      app.titleConfig = app.createStringField('title', 'Title', 'content_extraction.title.text');
      app.urlConfig = app.createStringField('url', 'URL', 'url.raw', 'url');
      app.websiteConfig = app.createStringField('website', 'Website', 'tld.raw', 'tld');
      app.weightConfig = app.createStringField('weight', 'Weight of Provider', 'knowledge_graph.weight.key', 'knowledge_graph.weight.value');

      app.bulkSearchFields = [
        app.ageConfig,
        app.cityConfig,
        app.countryConfig,
        app.emailConfig,
        app.ethnicityConfig,
        app.eyeColorConfig,
        app.genderConfig,
        app.hairColorConfig,
        app.heightConfig,
        app.nameConfig,
        app.phoneConfig,
        app.priceConfig,
        app.regionConfig,
        app.reviewConfig,
        app.servicesConfig,
        app.socialConfig,
        app.weightConfig
      ];

      app.searchFieldsDialogConfig = [{
        name: 'Dates',
        type: 'date',
        data: [app.dateStartConfig, app.dateEndConfig]
      }, {
        name: 'Identifiers',
        data: [app.phoneConfig, app.emailConfig, app.socialConfig, app.reviewConfig]
      }, {
        name: 'Location',
        data: [app.cityConfig, app.regionConfig, app.countryConfig]
      }, {
        name: 'Provider',
        data: [app.nameConfig, app.ageConfig, app.ethnicityConfig, app.genderConfig, app.eyeColorConfig, app.hairColorConfig, app.heightConfig, app.weightConfig, app.servicesConfig, app.priceConfig]
      }, {
        name: 'Ad',
        data: [app.websiteConfig, app.urlConfig, app.titleConfig, app.descriptionConfig]
      }];

      app.queryBuilderConfig = {
        age: {
          field: app.ageConfig.queryField
        },
        city: {
          field: app.cityConfig.queryField
        },
        country: {
          field: app.countryConfig.queryField
        },
        description: {
          field: app.descriptionConfig.queryField
        },
        email: {
          field: app.emailConfig.queryField
        },
        ethnicity: {
          field: app.ethnicityConfig.queryField
        },
        eyeColor: {
          field: app.eyeColorConfig.queryField
        },
        gender: {
          field: app.genderConfig.queryField
        },
        hairColor: {
          field: app.hairColorConfig.queryField
        },
        height: {
          field: app.heightConfig.queryField
        },
        image: {
          field: app.imageConfig.queryField
        },
        location: {
          field: app.locationConfig.queryField
        },
        name: {
          field: app.nameConfig.queryField
        },
        phone: {
          field: app.phoneConfig.queryField
        },
        price: {
          field: app.priceConfig.queryField
        },
        region: {
          field: app.regionConfig.queryField
        },
        review: {
          field: app.reviewConfig.queryField
        },
        services: {
          field: app.servicesConfig.queryField
        },
        social: {
          field: app.socialConfig.queryField
        },
        title: {
          field: app.titleConfig.queryField
        },
        url: {
          field: app.urlConfig.queryField
        },
        website: {
          field: app.websiteConfig.queryField
        },
        weight: {
          field: app.weightConfig.queryField
        },
        postingDate: {
          type: 'date',
          field: app.dateStartConfig.queryField
        }
      };

      app.sortString = 'Sort("' + app.dateStartConfig.queryField + '").order("desc")';

      app.openNewTab = function() {
        window.open('.');
      };

      app.emailSupport = function() {
        window.open('mailto:dig-support@nextcentury.com');
      };

      app.getBlurStyleClass = function(blur, large) {
        return (blur ? (large ? 'large-blur' : 'small-blur') : '');
      };

      app.getElasticTypes = function() {
        return ['ads'];
      };

      app.isSaveButtonDisabled = function(searchResults, searchError) {
        return !(searchResults !== null && searchError === null);
      };

      app.noSearchParameters = function() {
        return DigBehaviors.FilterBehavior.areAllFacetsDisabled(this.searchParameters, ['sort']);
      };

      app.openBulkSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.bulkSearchDialog.open();
      };

      app.openSaveSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.saveSearchDialog.open();
      };

      app.openSimilarImageSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.similarImageSearchDialog.open();
      };

      app.openEntityListDialog = function() {
        this.$.menuDropdown.close();
        this.$.entityListDialog.open();
      };

      app.openStateHistoryDialog = function() {
        this.$.menuDropdown.close();
        this.$.stateManager.openStateHistory();
      };

      app.toggleMenu = function() {
        if(this.$.menuDropdown.style.display === 'none') {
          this.$.menuDropdown.open();
        } else {
          this.$.menuDropdown.close();
        }
      };

      app.toggleAllFacetLists = function() {
        app.facetListsExpanded = !app.facetListsExpanded;
        // All facet lists should have the class 'facet'
        var allFacetListNames = document.querySelectorAll('.facet');

        for(var i = 0, length = allFacetListNames.length; i < length; i++) {
          allFacetListNames[i].opened = app.facetListsExpanded;
        }
      };

      app.getToggleAllFacetsText = function() {
        return (app.facetListsExpanded ? 'Collapse' : 'Expand') + ' All';
      };

      app.getToggleAllFacetsIcon = function() {
        return (app.facetListsExpanded ? 'icons:expand-less' : 'icons:expand-more');
      };

      app.createFacetsResultConfig = function(name) {
        return {
          name: name,
          // True if network expansion is active for any field.
          networkExpansionQuery: _.findKey(app.networkExpansionParameters, function(key) {
            return key;
          }) ? true : false
        };
      };

      app.createMainSearchResultConfig = function() {
        return {
          // True if network expansion is active for any field.
          networkExpansionQuery: _.findKey(app.networkExpansionParameters, function(key) {
            return key;
          }) ? true : false
        };
      };

      app.buildQueryConfig = function(esClient, esIndex, transform) {
        if(esClient && esIndex && transform) {
          return {
            esClient: esClient,
            esIndex: esIndex,
            transform: transform
          };
        }
        return undefined;
      };

      app.getTotalCountFunction = function() {
        return function(response) {
          if(response && response.length && response[0] && response[0].result) {
            if(_.isArray(response[0].result)) {
              return (response[0].result.length && response[0].result[1].hits && response[0].result[1].hits.total ? response[0].result[1].hits.total : 0);
            }
            return (response[0].result.hits && response[0].result.hits.total ? response[0].result.hits.total : 0);
          }
          return 0;
        };
      };

      /************************* START STATE HISTORY *************************/

      window.onpopstate = function() {
        // TODO: refreshing for now. Need to address issues with interrupting logging entries -- perhaps a better
        // approach would to be not to reload the page, but to rerun the query with the changed parameters + make
        // sure logging is done correctly in this case, which may involve adding processRequest to create-log-message.
        window.location.reload();
      };

      window.onload = function() {
        if(window.history.state && window.history.state.stateHistory) {
          app.stateHistory = window.history.state.stateHistory;
        }
      };

      /************************** END STATE HISTORY **************************/
    })(document);
  </script>
</body>

</html>
