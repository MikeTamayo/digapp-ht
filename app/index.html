<!doctype html>

<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="generator" content="Polymer Starter Kit" />
  <title>DIG</title>

  <!-- Chrome for Android theme color -->
  <meta name="theme-color" content="#2E3AA1">

  <!-- build:css styles/main.css -->
  <link rel="stylesheet" href="styles/main.css">
  <!-- endbuild-->

  <!-- build:js bower_components/webcomponentsjs/webcomponents-lite.min.js -->
  <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <!-- endbuild -->

  <!-- will be replaced with elements/elements.vulcanized.html -->
  <link rel="import" href="elements/elements.html">
  <!-- endreplace-->

  <!-- For shared styles, shared-styles.html import in elements.html -->
  <style is="custom-style" include="shared-styles"></style>
  <style is="custom-style" include="search-styles"></style>

</head>

<body unresolved class="fullbleed layout vertical">
  <span id="browser-sync-binding"></span>

  <template is="dom-bind" id="app">
    <!--get app configuration from server -->
    <iron-ajax
      id="ajax"
      auto
      url="/config"
      handle-as="json"
      last-response="{{config}}">
    </iron-ajax>

    <!--initialize new elastic client connection to server
      esclient can be used throughout the application lifecycle -->
    <elastic-client
      config="[[config.elasticConfig]]"
      client="{{esclient}}">
    </elastic-client>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      index-type="[[esType]]"
      query="[[ejsQuery]]"
      results="{{ecsResult}}"
      last-error="{{error}}"
      result-count="{{resultCount}}"
      aggregations="{{buildArray(offerCityAgg, offerNameAgg, offerAgeAgg, offerEyeAgg, offerHairAgg, offerHeightAgg, offerWeightAgg)}}"
      filters="{{buildArray(offerCityFilter)}}"
      >
    </elastic-client-search>

    <results-parser
      es-results="[[ecsResult.hits.hits]]"
      divided-results="{{dividedResult}}"
      formatted-result="{{records}}"
    ></results-parser>

    <paper-header-panel class="flex" mode="waterfall">

      <!-- Search toolbar -->
      <paper-toolbar>
        <img src="images/dig-logo-original.png" alt="">
        <div class="drawer-spacer"></div>
        <iron-icon icon="icons:search"></iron-icon>
        <div class="v-divider"></div>
        <elastic-type-selector
          client="[[esclient]]"
          index="[[config.elasticIndex]]"
          selected-type={{esType}}
        ></elastic-type-selector>
        <div class="v-divider"></div>
        <div class="flex-6">
            <elastic-client-input
              field="_all"
              query="{{ejsQuery}}"
              label="Search"
              autobuild="true"
            >
            </elastic-client-input>
        </div>

        <paper-icon-button icon="clear" onclick="clearSearchInput()"></paper-icon-button>

      </paper-toolbar>

      <paper-drawer-panel>

        <!-- Sidebar on left side -->
        <paper-header-panel drawer>
          <section>
            <h3>Facets</h3>

            <p>
              <h4>City</h4>
              <elastic-client-aggregation-builder
                name="offerCityAgg"
                field="availableAtOrFrom.address.addressLocality"
                ejs-aggregation="{{offerCityAgg}}"
                type="terms">
              </elastic-client-aggregation-builder>

            <elastic-client-checkbox-list
              buckets="[[ecsResult.aggregations.offerCityAgg.buckets]]"
              field="availableAtOrFrom.address.addressLocality"
              ejs-filter="{{offerCityFilter}}"
              combination-type="or">
            </elastic-client-checkbox-list>
            </p>

            <p><h4>Name</h4>
            <elastic-client-aggregation-builder
              name="offerNameAgg"
              field="itemOffered.name"
              ejs-aggregation="{{offerNameAgg}}"
              type="terms">
            </elastic-client-aggregation-builder>

            <elastic-client-checkbox-list
              buckets="[[ecsResult.aggregations.offerNameAgg.buckets]]"
              field="itemOffered.name"
              ejs-filter="{{offerNameFilter}}"
              combination-type="or">
            </elastic-client-checkbox-list>
            </p>

            <p><h4>Age</h4>
            <elastic-client-aggregation-builder
              name="offerAgeAgg"
              field="itemOffered.personAge"
              ejs-aggregation="{{offerAgeAgg}}"
              type="terms">
            </elastic-client-aggregation-builder>

            <elastic-client-checkbox-list
              buckets="[[ecsResult.aggregations.offerAgeAgg.buckets]]"
              field="itemOffered.personAge"
              ejs-filter="{{offerAgeFilter}}"
              combination-type="or">
            </elastic-client-checkbox-list>
            </p>

            <p><h4>Eye Color</h4>
            <elastic-client-aggregation-builder
              name="offerEyeAgg"
              field="itemOffered.eyeColor"
              ejs-aggregation="{{offerEyeAgg}}"
              type="terms">
            </elastic-client-aggregation-builder>

            <elastic-client-checkbox-list
              buckets="[[ecsResult.aggregations.offerEyeAgg.buckets]]"
              field="itemOffered.eyeColor"
              ejs-filter="{{offerEyeFilter}}"
              combination-type="or">
            </elastic-client-checkbox-list>
            </p>

            <p><h4>Hair Color</h4>
            <elastic-client-aggregation-builder
              name="offerHairAgg"
              field="itemOffered.hairColor"
              ejs-aggregation="{{offerHairAgg}}"
              type="terms">
            </elastic-client-aggregation-builder>

            <elastic-client-checkbox-list
              buckets="[[ecsResult.aggregations.offerHairAgg.buckets]]"
              field="itemOffered.hairColor"
              ejs-filter="{{offerHairFilter}}"
              combination-type="or">
            </elastic-client-checkbox-list>
            </p>

            <p><h4>Weight</h4>
            <elastic-client-aggregation-builder
              name="offerWeightAgg"
              field="itemOffered[schema:weight]"
              ejs-aggregation="{{offerWeightAgg}}"
              type="terms">
            </elastic-client-aggregation-builder>

            <elastic-client-checkbox-list
              buckets="[[ecsResult.aggregations.offerWeightAgg.buckets]]"
              field="itemOffered[schema:weight]"
              ejs-filter="{{offerWeightFilter}}"
              combination-type="or">
            </elastic-client-checkbox-list>
            </p>

            <p><h4>Height</h4>
            <elastic-client-aggregation-builder
              name="offerHeightAgg"
              field="itemOffered[schema:height]"
              ejs-aggregation="{{offerHeightAgg}}"
              type="terms">
            </elastic-client-aggregation-builder>

            <elastic-client-checkbox-list
              buckets="[[ecsResult.aggregations.offerHeightAgg.buckets]]"
              field="itemOffered[schema:height]"
              ejs-filter="{{offerHeightFilter}}"
              combination-type="or">
            </elastic-client-checkbox-list>
            </p>

          </section>
        </paper-header-panel>

        <!-- Main content on right side -->
        <paper-header-panel main>
          <section>
            <div class="search-results-header">
              <div class="paper-font-title flex">{{resultCount}} results</div>
              <span>{{ejsQuery}}</span>
              <div class="flex-none">
                <!-- Place search controls or view options here -->
              </div>
            </div>
            <div class="h-divider"></div>
            <paper-material>
              <section>
                <records-list
                  records="{{buildRecordsObject(records.email, records.service, records.phone, records.offer, records.seller, records.webpage)}}"
                  new-tab="true">
                </records-list>
              </section>
            </paper-material>
          </section>
        </paper-header-panel>

      </paper-drawer-panel>

    </paper-header-panel>

  </template>

  <script>
    (function(document) {
        var app = document.querySelector('#app');

        app.buildRecordsObject = function(email, service, phone, offer, seller, webpage) {
          return {
            email: email,
            service: service,
            phone: phone,
            offer: offer,
            seller: seller,
            webpage: webpage
          };
        };

        app.buildArray = function() {
          return _.filter(arguments, function(arg) {
            return arg !== undefined;
          });
        };
    })(document);

    var clearSearchInput = function() {
        var input = document.querySelector("elastic-client-input");
        input.clear();
    };
  </script>
</body>

</html>
