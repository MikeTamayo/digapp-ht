<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>

<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="generator" content="Polymer Starter Kit" />
  <title>DIG</title>
  <!-- Place favicon.ico in the `app/` directory -->

  <!-- Chrome for Android theme color -->
  <meta name="theme-color" content="#2E3AA1">

  <!-- Web Application Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Tile color for Win8 -->
  <meta name="msapplication-TileColor" content="#3372DF">

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PSK">
  <link rel="icon" sizes="192x192" href="images/touch/chrome-touch-icon-192x192.png">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Polymer Starter Kit">
  <link rel="apple-touch-icon" href="images/touch/apple-touch-icon.png">

  <!-- Tile icon for Win8 (144x144) -->
  <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">

  <!-- build:css styles/main.css -->
  <!-- Must link leaflet css (https://github.com/leaflet-extras/leaflet-map/issues/46) -->
  <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="styles/main.css">
  <!-- endbuild-->

  <!-- build:js bower_components/webcomponentsjs/webcomponents-lite.min.js -->
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <!-- endbuild -->

  <script src="scripts/google-analytics.js"></script>
  
  <!-- will be replaced with elements/elements.vulcanized.html -->
  <link rel="import" href="elements/elements.html">
  <!-- endreplace-->

  <link rel="import" href="styles/custom-icons.html">
  <link rel="import" href="styles/icon-styles.html">
  <style is="custom-style" include="icon-styles"></style>
</head>

<body unresolved class="fullbleed layout vertical">
  <span id="browser-sync-binding"></span>

  <template is="dom-bind" id="app">
    <!-- exposes clientConfig object which is a container for data
      transform functions -->
    <client-config config="{{clientConfig}}"></client-config>

    <!--get app configuration from server -->
    <iron-ajax
      auto
      url="/config"
      handle-as="json"
      last-response="{{config}}">
    </iron-ajax>

    <!--initialize new elastic client connection to server
      esclient can be used throughout the application lifecycle -->
    <elastic-client
      config="[[config.elasticConfig]]"
      client="{{esclient}}">
    </elastic-client>

    <!-- Main Search Query -->
    <elastic-client-highlight-builder
      fields='["*"]'
      pre-tags="<highlight>"
      post-tags="</highlight>"
      number-of-fragments="0"
      ejs-highlight="{{highlight}}">
    </elastic-client-highlight-builder>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      page="{{pageNum}}"
      page-size="{{pageSize}}"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{searchResults}}"
      last-error="{{searchError}}"
      result-count="{{resultCount}}"
      aggregations="[]"
      filters="[[filterArray]]"
      sort="{{sort}}"
      highlight="[[highlight]]"
      loading="{{loading}}"
      request-as-json="{{esRequest}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <json-transform
      data-in="{{searchResults}}"
      data-out="{{records}}"
      transform-function="[[clientConfig.transforms.offer.offers]]">
    </json-transform>

    <!-- Facets -->
    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{countryResult}}"
      last-error="{{countryError}}"
      aggregations="{{buildArray(countryAgg)}}"
      filters="[[filterArray]]"
      loading="{{countryLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{regionResult}}"
      last-error="{{regionError}}"
      aggregations="{{buildArray(regionAgg)}}"
      filters="[[filterArray]]"
      loading="{{regionLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{cityResult}}"
      last-error="{{cityError}}"
      aggregations="{{buildArray(cityAgg)}}"
      filters="[[filterArray]]"
      loading="{{cityLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{phoneResult}}"
      last-error="{{phoneError}}"
      aggregations="{{buildArray(phoneAgg)}}"
      filters="[[filterArray]]"
      loading="{{phoneLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{emailResult}}"
      last-error="{{emailError}}"
      aggregations="{{buildArray(emailAgg)}}"
      filters="[[filterArray]]"
      loading="{{emailLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{publisherResult}}"
      last-error="{{publisherError}}"
      aggregations="{{buildArray(publisherAgg)}}"
      filters="[[filterArray]]"
      loading="{{publisherLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{nameResult}}"
      last-error="{{nameError}}"
      aggregations="{{buildArray(nameAgg)}}"
      filters="[[filterArray]]"
      loading="{{nameLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{ageResult}}"
      last-error="{{ageError}}"
      aggregations="{{buildArray(ageAgg)}}"
      filters="[[filterArray]]"
      loading="{{ageLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{ethnicityResult}}"
      last-error="{{ethnicityError}}"
      aggregations="{{buildArray(ethnicityAgg)}}"
      filters="[[filterArray]]"
      loading="{{ethnicityLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{heightResult}}"
      last-error="{{heightError}}"
      aggregations="{{buildArray(heightAgg)}}"
      filters="[[filterArray]]"
      loading="{{heightLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{weightResult}}"
      last-error="{{weightError}}"
      aggregations="{{buildArray(weightAgg)}}"
      filters="[[filterArray]]"
      loading="{{weightLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{hairColorResult}}"
      last-error="{{hairColorError}}"
      aggregations="{{buildArray(hairColorAgg)}}"
      filters="[[filterArray]]"
      loading="{{hairColorLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{eyeColorResult}}"
      last-error="{{eyeColorError}}"
      aggregations="{{buildArray(eyeColorAgg)}}"
      filters="[[filterArray]]"
      loading="{{eyeColorLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>

    <elastic-client-search
      client="[[esclient]]"
      index="[[config.elasticIndex]]"
      elastic-types="[[getElasticTypes()]]"
      query="[[ejsQuery]]"
      results="{{imageResult}}"
      last-error="{{imageError}}"
      aggregations="{{buildArray(imageAgg)}}"
      filters="[[filterArray]]"
      loading="{{imageLoading}}"
      properties-ready="{{processRequest}}">
    </elastic-client-search>
    <!-- End Facets -->

    <dig-logger
      es-client="[[esclient]]"
      es-index="[[config.logIndex]]"
      es-type="[[config.logType]]"
      supertype="Search"
      subtype="SubmitQuery"
      value="[[logMessage]]"
      username="[[config.username]]"
      logger="{{logger}}">
    </dig-logger>

    <search-log-message-assembler
      query-value="[[searchParameters.text]]"
      age-facet-selection="[[searchParameters.age]]"
      city-facet-selection="[[searchParameters.city]]"
      country-facet-selection="[[searchParameters.country]]"
      date-facet-selection="[[searchParameters.dateCreated]]"
      email-facet-selection="[[searchParameters.email]]"
      ethnicity-facet-selection="[[searchParameters.ethnicity]]"
      eye-facet-selection="[[searchParameters.eyeColor]]"
      hair-facet-selection="[[searchParameters.hairColor]]"
      height-facet-selection="[[searchParameters.height]]"
      name-facet-selection="[[searchParameters.name]]"
      phone-facet-selection="[[searchParameters.phone]]"
      publisher-facet-selection="[[searchParameters.website]]"
      region-facet-selection="[[searchParameters.region]]"
      weight-facet-selection="[[searchParameters.weight]]"
      image-facet-selection="[[searchParameters.image]]"
      annotations-filter-option-selection="[[searchParameters.annotationsFilter]]"
      log-message="{{logMessage}}">
    </search-log-message-assembler>

    <annotation-manager
      client="[[esclient]]"
      annotation-index="[[config.annotationIndex]]"
      annotation-type="[[config.annotationType]]"
      relevant="[[config.annotationRelevant]]"
      username="[[config.username]]"
      annotations="{{annotations}}"
      annotation-manager="{{annotationManager}}">
    </annotation-manager>

    <paper-header-panel class="flex" mode="waterfall">

      <!-- Search toolbar -->
      <paper-toolbar id="navbar">
        <img class="bottom" src="images/dig-logo-original.png" alt="">
        <div class="bottom drawer-spacer"></div>

        <!-- Hide until we can support multiple search types.
        <div class="bottom v-divider"></div>
        <elastic-type-selector class="bottom white-input-container"
          available-types="{{config.elasticTypes}}"
          elastic-types="{{esTypes}}">
        </elastic-type-selector>
        -->

        <div class="bottom v-divider"></div>
        <div class="bottom flex">
          <elastic-client-input class="white-input-container"
            field="_all"
            value="{{searchParameters.text}}"
            query="{{ejsQuery}}"
            label="[[createSearchInputLabel(advancedSearch)]]"
            advanced="[[advancedSearch]]">
          </elastic-client-input>
        </div>

        <a class="bottom" href="." style="color: #ffffff;">
          <paper-icon-button icon="clear" title="Reset Page"></paper-icon-button>
        </a>

        <load-user-info class="bottom"
          show-search
          client="[[esclient]]"
          loading="[[loading]]"
          username="[[config.username]]"
          user-id="{{userId}}"
          user-record-exists="{{userRecordExists}}"
          advanced-search="{{advancedSearch}}"
          blur-images="{{blurImages}}"
          searches="{{userSearches}}"
          search-parameters="{{searchParameters}}"
          es-request="{{esRequest}}"
          user-index="[[config.userIndex]]"
          user-type="[[config.userType]]"
          notification-query-date="{{notificationDate}}"
          sort-newest='Sort("dateCreated").order("desc")'
          current-sort="[[selectedSort]]"
          save-user-data-callback="[[saveUserDataCallback]]"
          run-user-query-callback="{{runUserQueryCallback}}"
          process-request="{{processRequest}}">
        </load-user-info>

        <save-search id="saveSearchDialog"
          client="[[esclient]]"
          username="[[config.username]]"
          user-id="[[userId]]"
          existing-searches="{{userSearches}}"
          search-parameters="[[searchParameters]]"
          es-request="[[esRequest]]"
          user-index="[[config.userIndex]]"
          user-type="[[config.userType]]"
          user-record-exists="[[userRecordExists]]"
          run-user-query-callback="[[runUserQueryCallback]]"
          save-user-data-callback="{{saveUserDataCallback}}">
        </save-search>

        <bulk-search id="bulkSearchDialog" search-parameters="{{searchParameters}}" process-request="{{processRequest}}"></bulk-search>

        <similar-image-search id="similarImageSearchDialog"
          logger="[[logger]]"
          blur="[[blurImages]]"
          query-value="[[searchParameters.text]]"
          image-service-auth="[[config.imageServiceAuth]]"
          image-service-host="[[config.imageServiceHost]]"
          link-function="[[clientConfig.transforms.image.externalImageLink]]">
        </similar-image-search>

        <search-help id="searchHelpDialog"></search-help>

        <search-filter-builder
          annotations="[[annotations]]"
          search-parameters="{{searchParameters}}"
          filter-list="{{filterArray}}">
        </search-filter-builder>

        <state-manager id="stateManager"
          page-type="search"
          client="[[esclient]]"
          state-index="[[config.filterStatesIndex]]"
          state-type="[[config.filterStatesType]]"
          state-id="[[params.state]]"
          filter-collection="{{searchParameters}}"
          process-request="{{processRequest}}">
        </state-manager>

        <paper-icon-button icon="menu" class="bottom dropdown-trigger" title="More Options" on-tap="toggleMenu"></paper-icon-button>

        <iron-dropdown id="menuDropdown" class="bottom" horizontal-align="right" vertical-align="top" vertical-offset="80">
          <div class="dropdown-content">
            <paper-icon-item title="Show All Results for the Selected Facets" on-tap="showAll">
              <iron-icon icon="custom-icons:show-all" item-icon></iron-icon>
              Show All Results
            </paper-icon-item>

            <paper-icon-item disabled="[[isSaveButtonDisabled(searchResults, searchError)]]" title="Save the Search Keywords and Selected Facets" on-tap="openSaveSearchDialog">
              <iron-icon icon="save" item-icon></iron-icon>
              Save Search
            </paper-icon-item>

            <paper-icon-item disabled="[[noSearchParameters(searchParameters.*)]]" title="Generate a Link for this Page with the Search Keywords and Selected Facets" on-tap="generateLink">
              <iron-icon icon="link" item-icon></iron-icon>
              Generate Link
            </paper-icon-item>

            <paper-icon-item title="Upload or Enter Multiple Telephone Numbers" on-tap="openBatchPhoneSearchDialog">
              <iron-icon icon="file-upload" item-icon></iron-icon>
              Bulk Telephone Search
            </paper-icon-item>

            <paper-icon-item title="Search on an Image URL or Uploaded Image" on-tap="openSimilarImageSearchDialog">
              <iron-icon icon="image:compare" item-icon></iron-icon>
              Similar Image Search
            </paper-icon-item>

            <paper-icon-item active="[[advancedSearch]]" class="toggle" title="[[getAdvancedSearchTitle(advancedSearch)]]" on-tap="toggleAdvancedSearch">
              <iron-icon icon="custom-icons:advanced-search" item-icon></iron-icon>
              Toggle Advanced Search Mode
            </paper-icon-item>

            <paper-icon-item title="Search Help" on-tap="openSearchHelpDialog">
              <iron-icon icon="help" item-icon></iron-icon>
              Search Help
            </paper-icon-item>

            <paper-icon-item title="Contact DIG Support" on-tap="emailSupport">
              <iron-icon icon="communication:contact-mail" item-icon></iron-icon>
              Contact DIG Support
            </paper-icon-item>
          </div>
        </iron-dropdown>
      </paper-toolbar>

      <paper-drawer-panel drawer-width="320px">

        <!-- Sidebar on left side -->
        <paper-header-panel drawer>
          <paper-toolbar class="drawer-header">
            <div class="layout vertical">
              <!--TODO: create different sort for all types + different elastic-client-searches for all types -->
              <elastic-sort-input class="layout horizontal" field="dateCreated" selected="{{searchParameters.sort}}">
              </elastic-sort-input>
              <elastic-sort input-string="[[searchParameters.sort]]" sort="{{sort}}"></elastic-sort>

              <div class="h-divider"></div>

              <!-- TODO
              <template is="dom-if" if="[[noFacets(searchParameters.*)]]">
                <div class="no-selected-facets">No Selected Facets</div>
              </template>

              <div class="layout horizontal wrap">
                <selected-facets-display facet-selection="{{searchParameters.dateCreated}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.country}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.region}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.city}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.phone}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.email}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.website}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.name}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.age}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.ethnicity}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.height}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.weight}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.hairColor}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.eyeColor}}"></selected-facets-display>
                <selected-facets-display facet-selection="{{searchParameters.image}}"></selected-facets-display>
              </div>

              <div class="h-divider"></div>

              <div id="annotation-options" class="layout horizontal filter-header" title="Toggle Annotation Options" on-tap="toggleList">
                <span class="flex">Annotation Options</span>
                <iron-icon id="annotation-options-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="annotation-options-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <iron-collapse id="annotation-options-list" class="filter-list" opened>
                <checkbox-list-display
                  buckets="[[createAnnotationOptionsBuckets()]]"
                  facet-selection="{{searchParameters.annotationsFilter}}"
                  category="Annotations">
                </checkbox-list-display>
              </iron-collapse>

              <div class="h-divider"></div>
              -->
            </div>
          </paper-toolbar>

          <iron-pages attr-for-selected="data-type" selected="ads">
            <section data-type="ads">
              <div class="layout horizontal facet filter-header" title="Toggle All Facets" on-tap="toggleAllFacetLists">
                <span class="flex">Facets</span>
                <span>[[getToggleAllFacetsText(facetListsExpanded)]]</span>
                <iron-icon icon="[[getToggleAllFacetsIcon(facetListsExpanded)]]"</iron-icon>
              </div>

              <div class="h-divider"></div>

              <!-- TODO
              <div id="date" class="layout horizontal facet filter-header" title="Toggle Dates" on-tap="toggleList">
                <span class="flex">Date</span>
                <iron-icon id="date-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="date-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <iron-collapse id="date-list" class="filter-list" opened>
                <date-range-display
                  facet-selection="{{searchParameters.dateCreated}}">
                </date-range-display>
              </iron-collapse>

              <div class="h-divider"></div>
              -->

              <div id="country" class="layout horizontal facet filter-header" title="Toggle Countries" on-tap="toggleList">
                <span class="flex">Country [[getCount(countryResultList)]]</span>
                <iron-icon id="country-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="country-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="country"
                field="fields.country.relaxed.key"
                count="{{countryCount}}"
                ejs-aggregation="{{countryAgg}}"
                type="terms"
                order="{{countrySortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[countryResult]]"
                data-in2="country"
                data-out="{{countryResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{countryCount}}"
                    items="[[countryResultList]]"
                    error="[[countryError]]"
                    loading="[[countryLoading]]"
                    item-type="Countries"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{countrySortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[countryResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{countrySortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="country-list" class="filter-list" opened>
                <feature-aggregation
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[countryResultList]]">
                </feature-aggregation>
                <elastic-error error="[[countryError]]" message="{{countryErrorMessage}}"></elastic-error>
                <status-text
                  count="[[countryResultList.length]]"
                  error="[[countryErrorMessage]]"
                  loading="[[countryLoading]]"
                  empty="No Countries">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="region" class="layout horizontal facet filter-header" title="Toggle States/Regions" on-tap="toggleList">
                <span class="flex">State/Region [[getCount(regionResultList)]]</span>
                <iron-icon id="region-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="region-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="region"
                field="fields.state.relaxed.key"
                count="{{regionCount}}"
                ejs-aggregation="{{regionAgg}}"
                type="terms"
                order="{{regionSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[regionResult]]"
                data-in2="region"
                data-out="{{regionResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{regionCount}}"
                    items="[[regionResultList]]"
                    error="[[regionError]]"
                    loading="[[regionLoading]]"
                    item-type="States/Regions"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{regionSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[regionResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{regionSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="region-list" class="filter-list" opened>
                <feature-aggregation
                  hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[regionResultList]]">
                </feature-aggregation>
                <elastic-error error="[[regionError]]" message="{{regionErrorMessage}}"></elastic-error>
                <status-text
                  count="[[regionResultList.length]]"
                  error="[[regionErrorMessage]]"
                  loading="[[regionLoading]]"
                  empty="No States/Regions">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="city" class="layout horizontal facet filter-header" title="Toggle Cities" on-tap="toggleList">
                <span class="flex">City [[getCount(cityResultList)]]</span>
                <iron-icon id="city-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="city-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="city"
                field="fields.city.relaxed.key"
                count="{{cityCount}}"
                ejs-aggregation="{{cityAgg}}"
                type="terms"
                order="{{citySortOrder}}">
              </elastic-client-aggregation-builder>

              <json-transform
                data-in="{{cityResult}}"
                data-out="{{cityAndStateResult}}"
                transform-function="[[clientConfig.transforms.filterAggs.cities]]">
              </json-transform>

              <json-combine
                data-in1="[[cityAndStateResult]]"
                data-in2="city"
                data-out="{{cityResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{cityCount}}"
                    items="[[cityResultList]]"
                    error="[[cityError]]"
                    loading="[[cityLoading]]"
                    item-type="Cities"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="text"
                    order-by="{{citySortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[cityResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{citySortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="city-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="text"
                  items="[[cityResultList]]">
                </feature-aggregation>
                <elastic-error error="[[cityError]]" message="{{cityErrorMessage}}"></elastic-error>
                <status-text
                  count="[[cityResultList.length]]"
                  error="[[cityErrorMessage]]"
                  loading="[[cityLoading]]"
                  empty="No Cities">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="phone" class="layout horizontal facet filter-header" title="Toggle Telephone Numbers" on-tap="toggleList">
                <span class="flex">Telephone Number [[getCount(phoneResultList)]]</span>
                <iron-icon id="phone-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="phone-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="phone"
                field="fields.phone.relaxed.key"
                count="{{phoneCount}}"
                ejs-aggregation="{{phoneAgg}}"
                type="terms"
                order="{{phoneSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[phoneResult]]"
                data-in2="phone"
                data-out="{{phoneResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{phoneCount}}"
                    items="[[phoneResultList]]"
                    error="[[phoneError]]"
                    loading="[[phoneLoading]]"
                    item-type="Telephone Numbers"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{phoneSortOrder}}">
                  </aggregation-popup>
                </div>
                <div class="self-end">
                  <template is="dom-if" if="[[phoneResultList.length]]">
                    <aggregation-sort order-by="{{phoneSortOrder}}"></aggregation-sort>
                  </template>
                </div>
              </div>

              <iron-collapse id="phone-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  id-property="key"
                  count-property="doc_count"
                  text-property="key"
                  items="[[phoneResultList]]">
                </feature-aggregation>
                <elastic-error error="[[phoneError]]" message="{{phoneErrorMessage}}"></elastic-error>
                <status-text
                  count="[[phoneResultList.length]]"
                  error="[[phoneErrorMessage]]"
                  loading="[[phoneLoading]]"
                  empty="No Telephone Numbers">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="email" class="layout horizontal facet filter-header" title="Toggle Email Addresses" on-tap="toggleList">
                <span class="flex">Email Address [[getCount(emailResultList)]]</span>
                <iron-icon id="email-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="email-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="email"
                field="fields.email.relaxed.key"
                count="{{emailCount}}"
                ejs-aggregation="{{emailAgg}}"
                type="terms"
                order="{{emailSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[emailResult]]"
                data-in2="email"
                data-out="{{emailResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{emailCount}}"
                    items="[[emailResultList]]"
                    error="[[emailError]]"
                    loading="[[emailLoading]]"
                    item-type="Email Addresses"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{emailSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[emailResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{emailSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="email-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[emailResultList]]">
                </feature-aggregation>
                <elastic-error error="[[emailError]]" message="{{emailErrorMessage}}"></elastic-error>
                <status-text
                  count="[[emailResultList.length]]"
                  error="[[emailErrorMessage]]"
                  loading="[[emailLoading]]"
                  empty="No Email Addresses">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="website" class="layout horizontal facet filter-header" title="Toggle Websites" on-tap="toggleList">
                <span class="flex">Website [[getCount(publisherResultList)]]</span>
                <iron-icon id="website-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="website-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="publisher"
                field="tld"
                count="{{publisherCount}}"
                ejs-aggregation="{{publisherAgg}}"
                type="terms"
                order="{{publisherSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[publisherResult]]"
                data-in2="publisher"
                data-out="{{publisherResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{publisherCount}}"
                    items="[[publisherResultList]]"
                    error="[[publisherError]]"
                    loading="[[publisherLoading]]"
                    item-type="Websites"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{publisherSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[publisherResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{publisherSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="website-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[publisherResultList]]">
                </feature-aggregation>
                <elastic-error error="[[publisherError]]" message="{{publisherErrorMessage}}"></elastic-error>
                <status-text
                  count="[[publisherResultList.length]]"
                  error="[[publisherErrorMessage]]"
                  loading="[[publisherLoading]]"
                  empty="No Websites">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="name" class="layout horizontal facet filter-header" title="Toggle Names" on-tap="toggleList">
                <span class="flex">Name [[getCount(nameResultList)]]</span>
                <iron-icon id="name-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="name-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="name"
                field="fields.name.relaxed.key"
                count="{{nameCount}}"
                ejs-aggregation="{{nameAgg}}"
                type="terms"
                order="{{nameSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[nameResult]]"
                data-in2="name"
                data-out="{{nameResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{nameCount}}"
                    items="[[nameResultList]]"
                    error="[[nameError]]"
                    loading="[[nameLoading]]"
                    item-type="Names"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{nameSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[nameResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{nameSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="name-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[nameResultList]]">
                </feature-aggregation>
                <elastic-error error="[[nameError]]" message="{{nameErrorMessage}}"></elastic-error>
                <status-text
                  count="[[nameResultList.length]]"
                  error="[[nameErrorMessage]]"
                  loading="[[nameLoading]]"
                  empty="No Names">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="age" class="layout horizontal facet filter-header" title="Toggle Ages" on-tap="toggleList">
                <span class="flex">Age [[getCount(ageResultList)]]</span>
                <iron-icon id="age-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="age-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="age"
                field="fields.age.relaxed.key"
                count="{{ageCount}}"
                ejs-aggregation="{{ageAgg}}"
                type="terms"
                order="{{ageSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[ageResult]]"
                data-in2="age"
                data-out="{{ageResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{ageCount}}"
                    items="[[ageResultList]]"
                    error="[[ageError]]"
                    loading="[[ageLoading]]"
                    item-type="Ages"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{ageSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[ageResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{ageSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="age-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[ageResultList]]">
                </feature-aggregation>
                <elastic-error error="[[ageError]]" message="{{ageErrorMessage}}"></elastic-error>
                <status-text
                  count="[[ageResultList.length]]"
                  error="[[ageErrorMessage]]"
                  loading="[[ageLoading]]"
                  empty="No Ages">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="ethnicity" class="layout horizontal facet filter-header" title="Toggle Ethnicities" on-tap="toggleList">
                <span class="flex">Ethnicity [[getCount(ethnicityResultList)]]</span>
                <iron-icon id="ethnicity-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="ethnicity-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="ethnicity"
                field="fields.ethnicity.relaxed.key"
                count="{{ethnicityCount}}"
                ejs-aggregation="{{ethnicityAgg}}"
                type="terms"
                order="{{ethnicitySortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[ethnicityResult]]"
                data-in2="ethnicity"
                data-out="{{ethnicityResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{ethnicityCount}}"
                    items="[[ethnicityResultList]]"
                    error="[[ethnicityError]]"
                    loading="[[ethnicityLoading]]"
                    item-type="Ethnicities"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{ethnicitySortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[ethnicityResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{ethnicitySortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="ethnicity-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[ethnicityResultList]]">
                </feature-aggregation>
                <elastic-error error="[[ethnicityError]]" message="{{ethnicityErrorMessage}}"></elastic-error>
                <status-text
                  count="[[ethnicityResultList.length]]"
                  error="[[ethnicityErrorMessage]]"
                  loading="[[ethnicityLoading]]"
                  empty="No Ethnicities">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="height" class="layout horizontal facet filter-header" title="Toggle Heights" on-tap="toggleList">
                <span class="flex">Height (cm) [[getCount(heightResultList)]]</span>
                <iron-icon id="height-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="height-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="height"
                field="fields.height.relaxed.key"
                count="{{heightCount}}"
                ejs-aggregation="{{heightAgg}}"
                type="terms"
                order="{{heightSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[heightResult]]"
                data-in2="height"
                data-out="{{heightResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{heightCount}}"
                    items="[[heightResultList]]"
                    error="[[heightError]]"
                    loading="[[heightLoading]]"
                    item-type="Heights (cm)"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{heightSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[heightResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{heightSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="height-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[heightResultList]]">
                </feature-aggregation>
                <elastic-error error="[[heightError]]" message="{{heightErrorMessage}}"></elastic-error>
                <status-text
                  count="[[heightResultList.length]]"
                  error="[[heightErrorMessage]]"
                  loading="[[heightLoading]]"
                  empty="No Heights">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="weight" class="layout horizontal facet filter-header" title="Toggle Weights" on-tap="toggleList">
                <span class="flex">Weight (kg) [[getCount(weightResultList)]]</span>
                <iron-icon id="weight-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="weight-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="weight"
                field="fields.weight.relaxed.key"
                count="{{weightCount}}"
                ejs-aggregation="{{weightAgg}}"
                type="terms"
                order="{{weightSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[weightResult]]"
                data-in2="weight"
                data-out="{{weightResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{weightCount}}"
                    items="[[weightResultList]]"
                    error="[[weightError]]"
                    loading="[[weightLoading]]"
                    item-type="Weights (kg)"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{weightSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[weightResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{weightSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="weight-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[weightResultList]]">
                </feature-aggregation>
                <elastic-error error="[[weightError]]" message="{{weightErrorMessage}}"></elastic-error>
                <status-text
                  count="[[weightResultList.length]]"
                  error="[[weightErrorMessage]]"
                  loading="[[weightLoading]]"
                  empty="No Weights">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="hair-color" class="layout horizontal facet filter-header" title="Toggle Hair Colors" on-tap="toggleList">
                <span class="flex">Hair Color [[getCount(hairColorResultList)]]</span>
                <iron-icon id="hair-color-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="hair-color-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="hair"
                field="fields.hair-color.relaxed.key"
                count="{{hairColorCount}}"
                ejs-aggregation="{{hairColorAgg}}"
                type="terms"
                order="{{hairColorSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[hairColorResult]]"
                data-in2="hair"
                data-out="{{hairColorResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{hairColorCount}}"
                    items="[[hairColorResultList]]"
                    error="[[hairColorError]]"
                    loading="[[hairColorLoading]]"
                    item-type="Hair Colors"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{hairColorSortOrder}}">
                  </aggregation-popup>
                </div>
                <div class="self-end">
                  <template is="dom-if" if="[[hairColorResultList.length]]">
                    <aggregation-sort order-by="{{hairColorSortOrder}}"></aggregation-sort>
                  </template>
                </div>
              </div>

              <iron-collapse id="hair-color-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[hairColorResultList]]">
                </feature-aggregation>
                <elastic-error error="[[hairColorError]]" message="{{hairColorErrorMessage}}"></elastic-error>
                <status-text
                  count="[[hairColorResultList.length]]"
                  error="[[hairColorErrorMessage]]"
                  loading="[[hairColorLoading]]"
                  empty="No Hair Colors">
                </status-text>
              </iron-collapse>

              <div class="h-divider"></div>

              <div id="eye-color" class="layout horizontal facet filter-header" title="Toggle Eye Colors" on-tap="toggleList">
                <span class="flex">Eye Color [[getCount(eyeColorResultList)]]</span>
                <iron-icon id="eye-color-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="eye-color-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="eye"
                field="fields.eye-color.relaxed.key"
                count="{{eyeColorCount}}"
                ejs-aggregation="{{eyeColorAgg}}"
                type="terms"
                order="{{eyeColorSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[eyeColorResult]]"
                data-in2="eye"
                data-out="{{eyeColorResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{eyeColorCount}}"
                    items="[[eyeColorResultList]]"
                    error="[[eyeColorError]]"
                    loading="[[eyeColorLoading]]"
                    item-type="Eye Colors"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{eyeColorSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[eyeColorResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{eyeColorSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="eye-color-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[eyeColorResultList]]">
                </feature-aggregation>
                <elastic-error error="[[eyeColorError]]" message="{{eyeColorErrorMessage}}"></elastic-error>
                <status-text
                  count="[[eyeColorResultList.length]]"
                  error="[[eyeColorErrorMessage]]"
                  loading="[[eyeColorLoading]]"
                  empty="No Eye Colors">
                </status-text>
              </iron-collapse>

              <!-- TODO
              <div class="h-divider"></div>

              <div id="image" class="layout horizontal facet filter-header" title="Toggle Images" on-tap="toggleList">
                <span class="flex">Image [[getCount(imageResultList)]]</span>
                <iron-icon id="image-icon-opened" icon="icons:expand-less"></iron-icon>
                <iron-icon id="image-icon-closed" icon="icons:expand-more" style="display: none;"></iron-icon>
              </div>

              <elastic-client-aggregation-builder
                name="image"
                field="fields.image.relaxed.key"
                count="{{imageCount}}"
                ejs-aggregation="{{imageAgg}}"
                type="terms"
                order="{{imageSortOrder}}">
              </elastic-client-aggregation-builder>

              <json-combine
                data-in1="[[imageResult]]"
                data-in2="image"
                data-out="{{imageResultList}}"
                combine-function="[[generateListFromQueryResults]]">
              </json-combine>

              <div class="horizontal layout">
                <div class="flex self-start">
                  <aggregation-popup
                    aggregation-count="{{imageCount}}"
                    items="[[imageResultList]]"
                    image-style-class="[[getBlurStyleClass(blurImages)]]"
                    error="[[imageError]]"
                    loading="[[imageLoading]]"
                    item-type="Images"
                    count-type="Ads"
                    count-property="doc_count"
                    id-property="key"
                    text-property="key"
                    order-by="{{imageSortOrder}}">
                  </aggregation-popup>
                </div>
                <template is="dom-if" if="[[imageResultList.length]]">
                  <div class="self-end">
                    <aggregation-sort order-by="{{imageSortOrder}}"></aggregation-sort>
                  </div>
                </template>
              </div>

              <iron-collapse id="image-list" class="filter-list" opened>
                <feature-aggregation hide-no-data-text hide-show-more small
                  count-property="doc_count"
                  id-property="key"
                  text-property="key"
                  items="[[imageResultList]]">
                </feature-aggregation>
                <elastic-error error="[[imageError]]" message="{{imageErrorMessage}}"></elastic-error>
                <status-text
                  count="[[imageResultList.length]]"
                  error="[[imageErrorMessage]]"
                  loading="[[imageLoading]]"
                  empty="No Images">
                </status-text>
              </iron-collapse>
              -->
            </section>

            <section data-type="phone">phone</section>
            <section data-type="image">seller</section>
            <section data-type="email">email</section>
            <section data-type="adultservice">provider</section>
            <section data-type=''>ALL</section>
          </iron-pages>
        </paper-header-panel>

        <!-- Main content on right side -->
        <paper-header-panel main id="searchPanel">
          <div id="searchTitle" class="layout horizontal">
            <template is="dom-if" if="[[!searchError]]">
              <div class="paper-font-title flex">[[recordsListTitle]]</div>
            </template>

            <template is="dom-if" if="[[searchError]]">
              <elastic-error error="[[searchError]]" message="{{searchErrorMessage}}"></elastic-error>
              <div class="paper-font-title flex">
                [[searchErrorMessage]]
              </div>
            </template>

            <export-button
              data="[[shownRecords]]"
              transform-function="[[clientConfig.transforms.offer.createExportData]]">
            </export-button>
          </div>

          <records-list id="searchResults"
            client="[[esclient]]"
            annotation-manager="[[annotationManager]]"
            new-tab="true"
            item-name-property="title"
            query-results="{{records.data}}"
            total-results="{{records.count}}"
            shown-results="{{shownRecords}}"
            page="{{pageNum}}"
            page-size="[[pageSize]]"
            loading="{{loading}}"
            type="Result"
            records-list-title="{{recordsListTitle}}"
            current-user="[[config.username]]"
            blur="[[blurImages]]"
            notification-query-date="{{notificationDate}}">
          </records-list>
        </paper-header-panel>

      </paper-drawer-panel>

    </paper-header-panel>

  </template>

  <!-- Need to include dependencies here for IE -->
  <script src="bower_components/lodash/dist/lodash.js"></script>
  <script src="behaviors/array-behavior.js"></script>
  <script src="behaviors/browser-behavior.js"></script>
  <script src="behaviors/state-behavior.js"></script>

  <script>
    (function(document) {
      /* globals _, DigBehaviors */
      var app = document.querySelector('#app');

      app.facetListsExpanded = true;

      app.searchParameters = DigBehaviors.StateBehavior.buildSearchStateForUI({});

      app.params = DigBehaviors.BrowserBehavior.getUrlParameters(window.location.search);

      DigBehaviors.BrowserBehavior.removeStateParameter(window.history, window.location);

      app.buildArray = DigBehaviors.ArrayBehavior.buildArray;

      app.createAnnotationOptionsBuckets = function() {
        return [{
          key: 'showRelevant',
          text: 'Show Only "Relevant" Ads'
        }, {
          key: 'hideNotRelevant',
          text: 'Hide "Not Relevant" Ads'
        }];
      };

      app.createSearchInputLabel = function(advancedSearch) {
        return advancedSearch ? 'Enter Keywords (Advanced Search On)' : 'Enter Keywords';
      };

      app.emailSupport = function() {
        window.open('mailto:dig-support@nextcentury.com');
      };

      app.generateLink = function() {
        this.$.menuDropdown.close();
        this.$.stateManager.generateLink();
      };

      app.getAdvancedSearchTitle = function(advancedSearch) {
        return 'Click to ' + (advancedSearch ? 'Deactivate' : 'Activate') + ' Advanced Search Mode';
      };

      app.getBlurStyleClass = function(blurImages) {
        return blurImages ? 'small-blur' : '';
      };

      app.getElasticTypes = function() {
        return ['ads'];
      };

      app.isSaveButtonDisabled = function(searchResults, searchError) {
        return !(searchResults !== null && searchError === null);
      };

      app.noFacets = function() {
        return _.keys(app.searchParameters).every(function(facet) {
          if(facet === 'annotationsFilter' || facet === 'sort' || facet === 'text' || _.isEmpty(app.searchParameters[facet])) {
            return true;
          }
          return _.keys(app.searchParameters[facet]).every(function(key) {
            return !app.searchParameters[facet][key].enabled;
          });
        });
      };

      app.noSearchParameters = function() {
        return _.keys(app.searchParameters).every(function(facet) {
          return facet === 'sort' || _.isEmpty(app.searchParameters[facet]);
        });
      };

      app.openBatchPhoneSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.bulkSearchDialog.open();
      };

      app.openSaveSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.saveSearchDialog.open();
      };

      app.openSearchHelpDialog = function() {
        this.$.menuDropdown.close();
        this.$.searchHelpDialog.open();
      };

      app.openSimilarImageSearchDialog = function() {
        this.$.menuDropdown.close();
        this.$.similarImageSearchDialog.open();
      };

      app.showAll = function() {
        this.$.menuDropdown.close();
        app.set('searchParameters.text', null);
      };

      app.toggleMenu = function() {
        if(this.$.menuDropdown.style.display === 'none') {
          this.$.menuDropdown.open();
        } else {
          this.$.menuDropdown.close();
        }
      };

      app.toggleAdvancedSearch = function() {
        document.querySelector('load-user-info')._toggleAdvancedSearch();
      };

      /**
       * Opens or closes the facet list corresponding to the ID of the element that triggered the event.
       */
      app.toggleList = function(event) {
        if(event.target.parentElement && event.target.parentElement.id) {
          var type = event.target.parentElement.id;
          if(this.$[type + '-list']) {
            this.$[type + '-list'].toggle();
            this.$[type + '-icon-closed'].style.display = (this.$[type + '-icon-closed'].style.display !== 'none' ? 'none' : '');
            this.$[type + '-icon-opened'].style.display = (this.$[type + '-icon-opened'].style.display !== 'none' ? 'none' : '');
          }
        }
      };

      app.toggleAllFacetLists = function() {
        app.facetListsExpanded = !app.facetListsExpanded;
        // All facet lists should have the class 'facet' and an id
        var allFacetListNames = document.querySelectorAll('.facet');

        for(var i = 0, length = allFacetListNames.length; i < length; i++) {
          if(allFacetListNames[i].id) {
            var name = allFacetListNames[i].id;
            this.$[name + '-list'].opened = app.facetListsExpanded;
            this.$[name + '-icon-closed'].style.display = app.facetListsExpanded ? 'none' : '';
            this.$[name + '-icon-opened'].style.display = (!app.facetListsExpanded) ? 'none' : '';
          }
        }
      };

      app.getToggleAllFacetsText = function() {
        return (app.facetListsExpanded ? 'Collapse' : 'Expand') + ' All';
      };

      app.getToggleAllFacetsIcon = function() {
        return (app.facetListsExpanded ? 'icons:expand-less' : 'icons:expand-more');
      };

      app.generateListFromQueryResults = function(results, property) {
        var list = [];
        if(results && results.aggregations && results.aggregations[property] && results.aggregations[property][property] && results.aggregations[property][property].buckets) {
          list = list.concat(results.aggregations[property][property].buckets);
        }
        return list;
      };

      app.getCount = function(list) {
        return list.length ? (list.length >= 10 ? '(Top 10)' : '(' + list.length + ')') : '';
      };
    })(document);
  </script>
</body>

</html>
